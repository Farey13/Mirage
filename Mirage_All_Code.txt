========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\admin role check.sql
========================================
USE MirageDB;
GO

IF NOT EXISTS (SELECT 1 FROM Roles WHERE RoleName = 'Admin')
BEGIN
    INSERT INTO Roles (RoleName) VALUES ('Admin');
END

IF NOT EXISTS (SELECT 1 FROM UserRoles WHERE UserID = 1 AND RoleID = (SELECT RoleID FROM Roles WHERE RoleName = 'Admin'))
BEGIN
    INSERT INTO UserRoles (UserID, RoleID) VALUES (1, (SELECT RoleID FROM Roles WHERE RoleName = 'Admin'));
END
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\adminlistitem query.sql
========================================
USE MirageDB;
GO

-- First, drop the table if it exists from a partial creation
IF OBJECT_ID('dbo.AdminListItems', 'U') IS NOT NULL
  DROP TABLE dbo.AdminListItems;
GO

-- Now, create the table with all the correct columns
CREATE TABLE AdminListItems (
    ItemID INT IDENTITY(1,1) PRIMARY KEY,
    ListType NVARCHAR(100) NOT NULL,
    ItemValue NVARCHAR(255) NOT NULL,
    Description NVARCHAR(500) NULL,
    IsActive BIT NOT NULL DEFAULT 1
);
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\deactication option query for all tables.sql
========================================
USE MirageDB;
GO

-- Add columns to CalibrationLogs
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'IsActive' AND Object_ID = Object_ID(N'CalibrationLogs'))
BEGIN
    ALTER TABLE CalibrationLogs
    ADD IsActive BIT NOT NULL DEFAULT 1,
        DeactivationReason NVARCHAR(MAX) NULL,
        DeactivatedByUserID INT NULL,
        DeactivationDateTime DATETIME2 NULL;
END
GO

-- Add columns to KitValidations
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'IsActive' AND Object_ID = Object_ID(N'KitValidations'))
BEGIN
    ALTER TABLE KitValidations
    ADD IsActive BIT NOT NULL DEFAULT 1,
        DeactivationReason NVARCHAR(MAX) NULL,
        DeactivatedByUserID INT NULL,
        DeactivationDateTime DATETIME2 NULL;
END
GO

-- Add columns to Handovers
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'IsActive' AND Object_ID = Object_ID(N'Handovers'))
BEGIN
    ALTER TABLE Handovers
    ADD IsActive BIT NOT NULL DEFAULT 1,
        DeactivationReason NVARCHAR(MAX) NULL,
        DeactivatedByUserID INT NULL,
        DeactivationDateTime DATETIME2 NULL;
END
GO

-- Add columns to MachineBreakdowns
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'IsActive' AND Object_ID = Object_ID(N'MachineBreakdowns'))
BEGIN
    ALTER TABLE MachineBreakdowns
    ADD IsActive BIT NOT NULL DEFAULT 1,
        DeactivationReason NVARCHAR(MAX) NULL,
        DeactivatedByUserID INT NULL,
        DeactivationDateTime DATETIME2 NULL;
END
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\deactivate sample storage.sql
========================================
USE MirageDB;
GO

-- Note: We already added IsActive. This script adds the other required columns.
ALTER TABLE SampleStorage
ADD DeactivationReason NVARCHAR(MAX) NULL,
    DeactivatedByUserID INT NULL,
    DeactivationDateTime DATETIME2 NULL;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\hand over table update query.sql
========================================
USE MirageDB;
GO

ALTER TABLE Handovers
ADD Priority NVARCHAR(50) NOT NULL DEFAULT 'Normal';

ALTER TABLE Handovers
ADD Shift NVARCHAR(50) NOT NULL DEFAULT 'N/A';
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\machine break down added query.sql
========================================
USE MirageDB;
GO

ALTER TABLE MachineBreakdowns
ADD ResolutionNotes NVARCHAR(MAX) NULL;

ALTER TABLE MachineBreakdowns
ADD DowntimeMinutes INT NULL;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\media sterility deactivation fature query.sql
========================================
USE MirageDB;
GO

ALTER TABLE MediaSterilityChecks
ADD IsActive BIT NOT NULL DEFAULT 1,
    DeactivationReason NVARCHAR(MAX) NULL,
    DeactivatedByUserID INT NULL,
    DeactivationDateTime DATETIME2 NULL;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\new query daily task.sql
========================================
USE MirageDB;
GO

-- 1. Create a new table to define shifts
CREATE TABLE Shifts (
    ShiftID INT IDENTITY(1,1) PRIMARY KEY,
    ShiftName NVARCHAR(100) NOT NULL UNIQUE,
    StartTime TIME NOT NULL,
    EndTime TIME NOT NULL,
    GracePeriodHours INT NOT NULL DEFAULT 2,
    IsActive BIT NOT NULL DEFAULT 1
);
GO

-- 2. Update the Tasks table to use the new Shifts table
ALTER TABLE Tasks
ADD ShiftID INT NULL;
GO

ALTER TABLE Tasks
ADD CONSTRAINT FK_Tasks_Shifts FOREIGN KEY (ShiftID) REFERENCES Shifts(ShiftID);
GO

-- (Optional but recommended) Remove the old TaskCategory column after migrating data
-- ALTER TABLE Tasks DROP COLUMN TaskCategory;
-- GO

-- 3. Update the DailyTaskLogs table for the admin override feature
ALTER TABLE DailyTaskLogs
ADD LockOverrideUntil DATETIME2 NULL,
    LockOverrideReason NVARCHAR(MAX) NULL,
    LockOverrideByUserID INT NULL;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\normal user query.sql
========================================
USE MirageDB;
GO

-- 1. Create a 'Technician' role if it doesn't exist
IF NOT EXISTS (SELECT 1 FROM Roles WHERE RoleName = 'Technician')
BEGIN
    INSERT INTO Roles (RoleName) VALUES ('Technician');
END
GO

-- 2. Create a new user named 'normaluser'
--    This user's ID will be 2 (since testuser is 1)
IF NOT EXISTS (SELECT 1 FROM Users WHERE Username = 'normaluser')
BEGIN
    -- NOTE: We are storing a HASH of the password 'Password456!', not the password itself.
    -- This hash is generated by BCrypt.
    INSERT INTO Users (Username, PasswordHash, FullName, IsActive)
    VALUES ('normaluser', '$2a$11$G.7O/V82OD.K.EUyv68.Fe.J42d8aC1xS02/avL8ohG/E5vERk22e', 'Normal User', 1);
END
GO

-- 3. Assign the 'Technician' role to the new user
DECLARE @technicianRoleId INT = (SELECT RoleID FROM Roles WHERE RoleName = 'Technician');
DECLARE @normalUserId INT = (SELECT UserID FROM Users WHERE Username = 'normaluser');

IF NOT EXISTS (SELECT 1 FROM UserRoles WHERE UserID = @normalUserId AND RoleID = @technicianRoleId)
BEGIN
    INSERT INTO UserRoles (UserID, RoleID) VALUES (@normalUserId, @technicianRoleId);
END
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\normal user update1.sql
========================================
USE MirageDB;
GO

UPDATE Users
SET PasswordHash = '$2a$11$W2A.U.z5N23xV.n/iT.xTewhVp2g.Vz4O3E5B.w3w0jK6b8y5y7O6'
WHERE Username = 'normaluser';
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\query for testname in sample storage book.sql
========================================
USE MirageDB;
GO

ALTER TABLE SampleStorage
ADD TestName NVARCHAR(255) NOT NULL DEFAULT 'N/A'; -- Added a default for existing rows
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\repeatsample new query latest.sql
========================================
USE MirageDB;
GO

CREATE TABLE RepeatSampleLog (
    RepeatID INT IDENTITY(1,1) PRIMARY KEY,
    PatientIdCardNumber NVARCHAR(100),
    PatientName NVARCHAR(255) NOT NULL,
    ReasonText NVARCHAR(MAX),
    InformedPerson NVARCHAR(255),
    Department NVARCHAR(50),
    LogDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    LoggedByUserID INT NOT NULL,
    IsActive BIT NOT NULL DEFAULT 1,
    DeactivationReason NVARCHAR(MAX) NULL,
    DeactivatedByUserID INT NULL,
    DeactivationDateTime DATETIME2 NULL,
    FOREIGN KEY (LoggedByUserID) REFERENCES Users(UserID)
);
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\sample storage sample active query.sql
========================================
USE MirageDB;
GO

ALTER TABLE SampleStorage
ADD IsActive BIT NOT NULL DEFAULT 1;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\SQLQuery1Core System Tables.sql
========================================
-- =================================================================
-- Phase 1, Step 1.1 (Part 1): Core System Tables
-- Users, Roles, Permissions, and AuditLog for MirageDB
-- =================================================================

-- 1. Users Table: Stores user login information
CREATE TABLE Users (
    UserID INT IDENTITY(1,1) PRIMARY KEY,
    Username NVARCHAR(100) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(255) NOT NULL,
    FullName NVARCHAR(255) NOT NULL,
    IsActive BIT NOT NULL DEFAULT 1,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE()
);
GO

-- 2. Roles Table: Defines the user roles (e.g., Admin, Technician)
CREATE TABLE Roles (
    RoleID INT IDENTITY(1,1) PRIMARY KEY,
    RoleName NVARCHAR(100) NOT NULL UNIQUE
);
GO

-- 3. UserRoles Table: Links Users to Roles (Many-to-Many)
CREATE TABLE UserRoles (
    UserID INT NOT NULL,
    RoleID INT NOT NULL,
    PRIMARY KEY (UserID, RoleID),
    FOREIGN KEY (UserID) REFERENCES Users(UserID) ON DELETE CASCADE,
    FOREIGN KEY (RoleID) REFERENCES Roles(RoleID) ON DELETE CASCADE
);
GO

-- 4. Permissions Table: Defines individual permissions
CREATE TABLE Permissions (
    PermissionID INT IDENTITY(1,1) PRIMARY KEY,
    PermissionName NVARCHAR(255) NOT NULL UNIQUE -- e.g., 'KitValidation.Create', 'Users.Edit'
);
GO

-- 5. RolePermissions Table: Links Roles to Permissions (Many-to-Many)
CREATE TABLE RolePermissions (
    RoleID INT NOT NULL,
    PermissionID INT NOT NULL,
    PRIMARY KEY (RoleID, PermissionID),
    FOREIGN KEY (RoleID) REFERENCES Roles(RoleID) ON DELETE CASCADE,
    FOREIGN KEY (PermissionID) REFERENCES Permissions(PermissionID) ON DELETE CASCADE
);
GO

-- 6. AuditLog Table: Records all changes to data
CREATE TABLE AuditLog (
    AuditID BIGINT IDENTITY(1,1) PRIMARY KEY,
    UserID INT,
    Timestamp DATETIME2 NOT NULL DEFAULT GETDATE(),
    ActionType NVARCHAR(50) NOT NULL,  -- e.g., 'Create', 'Update', 'Delete', 'Login'
    ModuleName NVARCHAR(100),
    RecordID NVARCHAR(100),
    FieldName NVARCHAR(100),
    OldValue NVARCHAR(MAX),
    NewValue NVARCHAR(MAX),
    FOREIGN KEY (UserID) REFERENCES Users(UserID) ON DELETE SET NULL
);
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\SQLQuery2tables.sql
========================================
-- Select the correct database before running the script
USE MirageDB;
GO

-- =================================================================
-- Phase 1, Step 1.1 (Part 2): Logbook Module Tables
-- =================================================================

-- 1. Repeat Sample Book
CREATE TABLE RepeatSampleLog (
    RepeatID INT IDENTITY(1,1) PRIMARY KEY,
    PatientIdCardNumber NVARCHAR(100),
    PatientName NVARCHAR(255) NOT NULL,
    InformedPersonOrDept NVARCHAR(255),
    ReasonText NVARCHAR(MAX),
    LogDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    LoggedByUserID INT NOT NULL,
    FOREIGN KEY (LoggedByUserID) REFERENCES Users(UserID)
);
GO

-- 2. Kit Validation Book
CREATE TABLE KitValidations (
    ValidationID INT IDENTITY(1,1) PRIMARY KEY,
    KitName NVARCHAR(255) NOT NULL,
    KitLotNumber NVARCHAR(100) NOT NULL,
    KitExpiryDate DATE NOT NULL,
    ValidationStatus NVARCHAR(50) NOT NULL, -- "Accepted", "Rejected"
    Comments NVARCHAR(MAX),
    ValidationDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    ValidatedByUserID INT NOT NULL,
    FOREIGN KEY (ValidatedByUserID) REFERENCES Users(UserID)
);
GO

-- 3. Calibration Log
CREATE TABLE CalibrationLogs (
    CalibrationID INT IDENTITY(1,1) PRIMARY KEY,
    TestName NVARCHAR(255) NOT NULL,
    QcResult NVARCHAR(50) NOT NULL, -- "Passed", "Failed"
    Reason NVARCHAR(MAX),
    CalibrationDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    PerformedByUserID INT NOT NULL,
    FOREIGN KEY (PerformedByUserID) REFERENCES Users(UserID)
);
GO

-- 4. Sample Storage Book
CREATE TABLE SampleStorage (
    StorageID INT IDENTITY(1,1) PRIMARY KEY,
    PatientSampleID NVARCHAR(100) NOT NULL,
    StorageDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    StoredByUserID INT NOT NULL,
    IsTestDone BIT NOT NULL DEFAULT 0,
    TestDoneDateTime DATETIME2 NULL,
    TestDoneByUserID INT NULL,
    FOREIGN KEY (StoredByUserID) REFERENCES Users(UserID),
    FOREIGN KEY (TestDoneByUserID) REFERENCES Users(UserID)
);
GO

-- 5. Handover Book
CREATE TABLE Handovers (
    HandoverID INT IDENTITY(1,1) PRIMARY KEY,
    HandoverNotes NVARCHAR(MAX) NOT NULL,
    GivenDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    GivenByUserID INT NOT NULL,
    IsReceived BIT NOT NULL DEFAULT 0,
    ReceivedDateTime DATETIME2 NULL,
    ReceivedByUserID INT NULL,
    FOREIGN KEY (GivenByUserID) REFERENCES Users(UserID),
    FOREIGN KEY (ReceivedByUserID) REFERENCES Users(UserID)
);
GO

-- 6. Machine Breakdown Log
CREATE TABLE MachineBreakdowns (
    BreakdownID INT IDENTITY(1,1) PRIMARY KEY,
    MachineName NVARCHAR(255) NOT NULL,
    BreakdownReason NVARCHAR(MAX) NOT NULL,
    ReportedDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    ReportedByUserID INT NOT NULL,
    IsResolved BIT NOT NULL DEFAULT 0,
    ResolvedDateTime DATETIME2 NULL,
    ResolvedByUserID INT NULL,
    FOREIGN KEY (ReportedByUserID) REFERENCES Users(UserID),
    FOREIGN KEY (ResolvedByUserID) REFERENCES Users(UserID)
);
GO

-- 7. Media Sterility Book
CREATE TABLE MediaSterilityChecks (
    SterilityCheckID INT IDENTITY(1,1) PRIMARY KEY,
    MediaName NVARCHAR(255) NOT NULL,
    MediaLotNumber NVARCHAR(100) NOT NULL,
    MediaQuantity NVARCHAR(100),
    Result37C NVARCHAR(50) NOT NULL, -- "No Growth", "Growth Seen"
    Result25C NVARCHAR(50) NOT NULL, -- "No Growth", "Growth Seen"
    OverallStatus NVARCHAR(50) NOT NULL, -- "Passed", "Failed"
    Comments NVARCHAR(MAX),
    CheckDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    PerformedByUserID INT NOT NULL,
    FOREIGN KEY (PerformedByUserID) REFERENCES Users(UserID)
);
GO

-- 8. Daily Task Log (Part 1 - The Task Definitions)
CREATE TABLE Tasks (
    TaskID INT IDENTITY(1,1) PRIMARY KEY,
    TaskName NVARCHAR(255) NOT NULL,
    TaskCategory NVARCHAR(50) NOT NULL, -- "Morning", "Evening"
    ScheduleType NVARCHAR(50) NOT NULL, -- "Daily", "Weekly", "Monthly"
    ScheduleValue NVARCHAR(50) NULL, -- For Weekly: "Monday", "Tuesday", etc. For Monthly: "1"-"31"
    IsActive BIT NOT NULL DEFAULT 1
);
GO

-- 9. Daily Task Log (Part 2 - The Daily Records)
CREATE TABLE DailyTaskLogs (
    LogID BIGINT IDENTITY(1,1) PRIMARY KEY,
    TaskID INT NOT NULL,
    LogDate DATE NOT NULL,
    Status NVARCHAR(50) NOT NULL, -- "Pending", "Completed", "Not Available"
    CompletedByUserID INT NULL,
    CompletedDateTime DATETIME2 NULL,
    FOREIGN KEY (TaskID) REFERENCES Tasks(TaskID) ON DELETE CASCADE,
    FOREIGN KEY (CompletedByUserID) REFERENCES Users(UserID)
);
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Database Scripts\test daily log.sql
========================================
USE MirageDB;
GO

INSERT INTO Tasks (TaskName, TaskCategory, ScheduleType, ScheduleValue, IsActive)
VALUES
('Check Refrigerator Temperatures', 'Morning', 'Daily', NULL, 1),
('Perform Weekly Maintenance on Centrifuge', 'Morning', 'Weekly', 'Sunday', 1),
('Monthly Deep Clean of Glassware', 'Evening', 'Monthly', '21', 1);
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Converters\BooleanToVisibilityConverter.cs
========================================
using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace Mirage.UI.Converters;

public class BooleanToVisibilityConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        return value is bool b && b ? Visibility.Visible : Visibility.Collapsed;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Converters\InverseBooleanConverter.cs
========================================
using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace Mirage.UI.Converters;

public class InverseBooleanConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        // This now correctly returns a Visibility value, not a boolean
        return value is bool b && b ? Visibility.Collapsed : Visibility.Visible;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Converters\IsNotNullToBooleanConverter.cs
========================================
using System;
using System.Globalization;
using System.Windows.Data;

namespace Mirage.UI.Converters
{
    public class IsNotNullToBooleanConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            return value != null;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Converters\StringIsNullOrEmptyToVisibilityConverter.cs
========================================
using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;

namespace Mirage.UI.Converters;

public class StringIsNullOrEmptyToVisibilityConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        var s = value as string;
        bool isInverted = parameter as string == "Inverse";

        if (isInverted)
        {
            return string.IsNullOrEmpty(s) ? Visibility.Collapsed : Visibility.Visible;
        }
        return string.IsNullOrEmpty(s) ? Visibility.Visible : Visibility.Collapsed;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Converters\ThemeToBooleanConverter.cs
========================================
using System;
using System.Globalization;
using System.Windows.Data;

namespace Mirage.UI.Converters;

public class ThemeToBooleanConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        // If the theme name is "Dark", the switch is "On" (true)
        return value is string themeName && themeName == "Dark";
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        // If the switch is "On" (true), the theme name is "Dark", otherwise it's "Light"
        return value is bool isChecked && isChecked ? "Dark" : "Light";
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Properties\Settings.Designer.cs
========================================
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Mirage.UI.Properties {
    
    
    [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator", "17.14.0.0")]
    internal sealed partial class Settings : global::System.Configuration.ApplicationSettingsBase {
        
        private static Settings defaultInstance = ((Settings)(global::System.Configuration.ApplicationSettingsBase.Synchronized(new Settings())));
        
        public static Settings Default {
            get {
                return defaultInstance;
            }
        }
        
        [global::System.Configuration.UserScopedSettingAttribute()]
        [global::System.Diagnostics.DebuggerNonUserCodeAttribute()]
        [global::System.Configuration.DefaultSettingValueAttribute("14")]
        public double AppFontSize {
            get {
                return ((double)(this["AppFontSize"]));
            }
            set {
                this["AppFontSize"] = value;
            }
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Services\AuthService.cs
========================================
using PortalMirage.Core.Models;

namespace Mirage.UI.Services
{
    public class AuthService : IAuthService
    {
        private string? _token;

        // Add this property
        public User? CurrentUser { get; private set; }

        public string? GetToken()
        {
            return _token;
        }

        public void SetToken(string? token)
        {
            _token = token;

            // Optional: When token is set, you might want to clear CurrentUser
            // if the token is being cleared (logged out)
            if (string.IsNullOrEmpty(token))
            {
                CurrentUser = null;
            }
        }

        // Optional: Add methods to set and clear CurrentUser
        public void SetCurrentUser(User user)
        {
            CurrentUser = user;
        }

        public void ClearCurrentUser()
        {
            CurrentUser = null;
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Services\IAuthService.cs
========================================
using PortalMirage.Core.Models;

namespace Mirage.UI.Services
{
    public interface IAuthService
    {
        string? GetToken();
        void SetToken(string? token);

        // Add this property
        User? CurrentUser { get; }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Services\IInactivityService.cs
========================================
using System;

namespace Mirage.UI.Services
{
    public interface IInactivityService
    {
        event Action OnInactive;
        void StartTimer(int minutes); // Changed from ResetTimer
        void ResetTimer();
        void StopTimer();
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Services\InactivityService.cs
========================================
using System;
using System.Windows.Threading;

namespace Mirage.UI.Services
{
    public class InactivityService : IInactivityService
    {
        private DispatcherTimer? _inactivityTimer;
        public event Action? OnInactive;

        public void StartTimer(int minutes)
        {
            // Stop any existing timer first
            StopTimer();

            _inactivityTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMinutes(minutes)
            };

            _inactivityTimer.Tick += InactivityTimer_Tick;
            _inactivityTimer.Start();
        }

        private void InactivityTimer_Tick(object? sender, EventArgs e)
        {
            StopTimer();
            OnInactive?.Invoke();
        }

        public void ResetTimer()
        {
            if (_inactivityTimer != null)
            {
                _inactivityTimer.Stop();
                _inactivityTimer.Start();
            }
        }

        public void StopTimer()
        {
            _inactivityTimer?.Stop();
            _inactivityTimer = null;
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Services\IPdfExportService.cs
========================================
using System.Collections.Generic;
using System.Threading.Tasks;

namespace Mirage.UI.Services
{
    public interface IPdfExportService
    {
        Task GenerateReportPdfAsync(string reportTitle, string[] columnHeaders, IEnumerable<object> items);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Services\IPortalMirageApi.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using Refit;
using System;
using System.Collections.Generic;
using System.Net.Http;

namespace Mirage.UI.Services;

public interface IPortalMirageApi
{
    // === Login ===
    [Post("/api/auth/login")]
    System.Threading.Tasks.Task<LoginResponse> LoginAsync([Body] LoginRequest loginRequest);

    // === Calibration Log ===
    [Post("/api/calibrationlogs")]
    System.Threading.Tasks.Task<CalibrationLogResponse> CreateCalibrationLogAsync([Header("Authorization")] string token, [Body] CreateCalibrationLogRequest request);

    [Get("/api/calibrationlogs")]
    System.Threading.Tasks.Task<List<CalibrationLogResponse>> GetCalibrationLogsAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/calibrationlogs/{id}/deactivate")]
    System.Threading.Tasks.Task DeactivateCalibrationLogAsync([Header("Authorization")] string token, int id, [Body] DeactivateCalibrationLogRequest request);

    // === Kit Validation ===
    [Post("/api/kitvalidations")]
    System.Threading.Tasks.Task<KitValidationResponse> CreateKitValidationAsync([Header("Authorization")] string token, [Body] CreateKitValidationRequest request);

    [Get("/api/kitvalidations")]
    System.Threading.Tasks.Task<List<KitValidationResponse>> GetKitValidationsAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/kitvalidations/{id}/deactivate")]
    System.Threading.Tasks.Task DeactivateKitValidationAsync([Header("Authorization")] string token, int id, [Body] DeactivateKitValidationRequest request);

    // === Sample Storage ===
    [Post("/api/samplestorage")]
    System.Threading.Tasks.Task<SampleStorageResponse> CreateSampleAsync([Header("Authorization")] string token, [Body] CreateSampleStorageRequest request);

    [Get("/api/samplestorage/pending")]
    System.Threading.Tasks.Task<List<SampleStorageResponse>> GetPendingSamplesAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Get("/api/samplestorage/completed")]
    System.Threading.Tasks.Task<List<SampleStorageResponse>> GetCompletedSamplesAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/samplestorage/{id}/done")]
    System.Threading.Tasks.Task MarkSampleAsDoneAsync([Header("Authorization")] string token, int id);

    [Put("/api/samplestorage/{id}/deactivate")]
    System.Threading.Tasks.Task DeactivateSampleAsync([Header("Authorization")] string token, int id, [Body] DeactivateSampleStorageRequest request);

    // === Handover Book ===
    [Post("/api/handovers")]
    System.Threading.Tasks.Task<HandoverResponse> CreateHandoverAsync([Header("Authorization")] string token, [Body] CreateHandoverRequest request);

    [Get("/api/handovers/pending")]
    System.Threading.Tasks.Task<List<HandoverResponse>> GetPendingHandoversAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Get("/api/handovers/completed")]
    System.Threading.Tasks.Task<List<HandoverResponse>> GetCompletedHandoversAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/handovers/{id}/receive")]
    System.Threading.Tasks.Task MarkHandoverAsReceivedAsync([Header("Authorization")] string token, int id);

    [Put("/api/handovers/{id}/deactivate")]
    System.Threading.Tasks.Task DeactivateHandoverAsync([Header("Authorization")] string token, int id, [Body] DeactivateHandoverRequest request);

    // === Machine Breakdown ===
    [Post("/api/machinebreakdowns")]
    System.Threading.Tasks.Task<MachineBreakdownResponse> CreateBreakdownAsync([Header("Authorization")] string token, [Body] CreateMachineBreakdownRequest request);

    [Get("/api/machinebreakdowns/pending")]
    System.Threading.Tasks.Task<List<MachineBreakdownResponse>> GetPendingBreakdownsAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Get("/api/machinebreakdowns/resolved")]
    System.Threading.Tasks.Task<List<MachineBreakdownResponse>> GetResolvedBreakdownsAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/machinebreakdowns/{id}/resolve")]
    System.Threading.Tasks.Task MarkBreakdownAsResolvedAsync([Header("Authorization")] string token, int id, [Body] ResolveBreakdownRequest request);

    [Put("/api/machinebreakdowns/{id}/deactivate")]
    System.Threading.Tasks.Task DeactivateBreakdownAsync([Header("Authorization")] string token, int id, [Body] DeactivateMachineBreakdownRequest request);

    // --- Media Sterility ---
    [Post("/api/mediasterilitychecks")]
    System.Threading.Tasks.Task<MediaSterilityCheckResponse> CreateSterilityCheckAsync([Header("Authorization")] string token, [Body] CreateMediaSterilityCheckRequest request);

    [Get("/api/mediasterilitychecks")]
    System.Threading.Tasks.Task<List<MediaSterilityCheckResponse>> GetSterilityChecksAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/mediasterilitychecks/{id}/deactivate")]
    System.Threading.Tasks.Task DeactivateSterilityCheckAsync([Header("Authorization")] string token, int id, [Body] DeactivateMediaSterilityCheckRequest request);

    // --- Repeat Sample Book ---
    [Post("/api/repeatsamples")]
    System.Threading.Tasks.Task<RepeatSampleResponse> CreateRepeatSampleAsync([Header("Authorization")] string token, [Body] CreateRepeatSampleRequest request);

    [Get("/api/repeatsamples")]
    System.Threading.Tasks.Task<List<RepeatSampleResponse>> GetRepeatSamplesAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/repeatsamples/{id}/deactivate")]
    System.Threading.Tasks.Task DeactivateRepeatSampleAsync([Header("Authorization")] string token, int id, [Body] DeactivateRepeatSampleRequest request);

    // --- Daily Task Log ---
    [Get("/api/dailytasklogs")]
    System.Threading.Tasks.Task<List<TaskLogDetailDto>> GetTasksForDateAsync([Header("Authorization")] string token, [Query] DateTime date);

    // FIX: Use [Body] because 415 error proves server wants JSON.
    // We also use the DTO from Core to package the data.
    [Put("/api/dailytasklogs/{logId}/status")]
    Task UpdateTaskStatusAsync(
        [Header("Authorization")] string token,
        long logId,
        [Body] UpdateTaskStatusRequest request
    );

    [Put("/api/dailytasklogs/{id}/extend")]
    System.Threading.Tasks.Task<DailyTaskLog> ExtendTaskDeadlineAsync([Header("Authorization")] string token, long id, [Body] ExtendTaskDeadlineRequest request);

    [Get("/api/dailytasklog/{date}")]
    System.Threading.Tasks.Task<List<TaskLogDetailDto>> GetDailyTaskLogsAsync([Header("Authorization")] string token, DateTime date);

    // --- Admin Panel ---
    [Get("/api/admin/users")]
    System.Threading.Tasks.Task<List<UserResponse>> GetAllUsersAsync([Header("Authorization")] string token);

    [Get("/api/admin/roles")]
    System.Threading.Tasks.Task<List<RoleResponse>> GetAllRolesAsync([Header("Authorization")] string token);

    [Get("/api/shifts")]
    System.Threading.Tasks.Task<List<ShiftResponse>> GetAllShiftsAsync([Header("Authorization")] string token);

    [Post("/api/admin/assign-role")]
    System.Threading.Tasks.Task AssignRoleAsync([Header("Authorization")] string token, [Body] AssignRoleRequest request);

    [Post("/api/admin/remove-role")]
    System.Threading.Tasks.Task RemoveRoleFromUserAsync([Header("Authorization")] string token, [Body] AssignRoleRequest request);

    [Get("/api/admin/users/{username}/roles")]
    System.Threading.Tasks.Task<List<RoleResponse>> GetRolesForUserAsync([Header("Authorization")] string token, string username);

    [Post("/api/shifts")]
    System.Threading.Tasks.Task<ShiftResponse> CreateShiftAsync([Header("Authorization")] string token, [Body] CreateShiftRequest request);

    [Put("/api/shifts/{id}")]
    System.Threading.Tasks.Task<ShiftResponse> UpdateShiftAsync([Header("Authorization")] string token, int id, [Body] UpdateShiftRequest request);

    [Delete("/api/shifts/{id}")]
    System.Threading.Tasks.Task DeactivateShiftAsync([Header("Authorization")] string token, int id);

    // --- Admin Master Lists ---
    [Get("/api/admin/lists")]
    System.Threading.Tasks.Task<List<AdminListItemDto>> GetAllListItemsAsync([Header("Authorization")] string token);

    [Get("/api/admin/lists/types")]
    System.Threading.Tasks.Task<List<string>> GetListTypesAsync([Header("Authorization")] string token);

    // ADD THIS NEW METHOD
    [Get("/api/admin/lists/{listType}")]
    System.Threading.Tasks.Task<List<AdminListItemDto>> GetListItemsByTypeAsync([Header("Authorization")] string token, string listType);

    [Post("/api/admin/lists")]
    System.Threading.Tasks.Task<AdminListItemDto> CreateListItemAsync([Header("Authorization")] string token, [Body] CreateAdminListItemRequest request);

    [Put("/api/admin/lists/{id}")]
    System.Threading.Tasks.Task<AdminListItemDto> UpdateListItemAsync([Header("Authorization")] string token, int id, [Body] UpdateAdminListItemRequest request);

    // === Audit Log ===
    [Get("/api/auditlogs")]
    // This is the correct, final version
    System.Threading.Tasks.Task<List<PortalMirage.Core.Dtos.AuditLogDto>> GetAuditLogsAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    // === Admin User Management ===
    [Post("/api/admin/users/create")]
    System.Threading.Tasks.Task<UserResponse> CreateUserAsync([Header("Authorization")] string token, [Body] CreateUserRequest request);

    [Post("/api/admin/roles")] // ADD THIS
    System.Threading.Tasks.Task<RoleResponse> CreateRoleAsync([Header("Authorization")] string token, [Body] CreateRoleRequest request);

    [Post("/api/admin/users/reset-password")] // ADD THIS
    System.Threading.Tasks.Task ResetPasswordAsync([Header("Authorization")] string token, [Body] ResetPasswordRequest request);

    // === Dashboard ===
    [Get("/api/dashboard/summary")] // ADD THIS ENDPOINT
    System.Threading.Tasks.Task<DashboardSummaryDto> GetDashboardSummaryAsync([Header("Authorization")] string token);

    // --- Task Definitions (Admin) ---
    [Get("/api/tasks")]
    System.Threading.Tasks.Task<List<TaskModel>> GetAllTasksAsync([Header("Authorization")] string token);

    [Post("/api/tasks")]
    System.Threading.Tasks.Task<TaskModel> CreateTaskAsync([Header("Authorization")] string token, [Body] TaskModel task);

    [Delete("/api/tasks/{id}")]
    Task DeactivateTaskAsync([Header("Authorization")] string token, int id);

    // === Reports ===
    [Get("/api/reports/machine-breakdowns")] // ADD THIS
    System.Threading.Tasks.Task<List<MachineBreakdownReportDto>> GetMachineBreakdownReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] string? machineName,
        [Query] string? status);

    [Get("/api/reports/kit-validations")] // ADD THIS NEW METHOD
    System.Threading.Tasks.Task<List<KitValidationReportDto>> GetKitValidationReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] string? kitName,
        [Query] string? status);

    [Get("/api/reports/handovers")] // ADD THIS NEW METHOD
    System.Threading.Tasks.Task<List<HandoverReportDto>> GetHandoverReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] string? shift,
        [Query] string? priority,
        [Query] string? status);

    [Get("/api/reports/repeat-samples")] // ADD THIS NEW METHOD
    System.Threading.Tasks.Task<List<RepeatSampleReportDto>> GetRepeatSampleReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] string? reason,
        [Query] string? department);

    [Get("/api/reports/daily-task-compliance")] // ADD THIS NEW METHOD
    System.Threading.Tasks.Task<DailyTaskComplianceReportDto> GetDailyTaskComplianceReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] int? shiftId,
        [Query] string? status);

    [Get("/api/reports/media-sterility")] // ADD THIS NEW METHOD
    System.Threading.Tasks.Task<List<MediaSterilityReportDto>> GetMediaSterilityReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] string? mediaName,
        [Query] string? status);

    [Get("/api/admin/lists/setting/{itemValue}")]
    System.Threading.Tasks.Task<AdminListItemDto> GetSettingAsync([Header("Authorization")] string token, string itemValue);

    [Get("/api/reports/sample-storage")]
    System.Threading.Tasks.Task<List<SampleStorageReportDto>> GetSampleStorageReportAsync(/*...*/);

    [Get("/api/reports/calibrations")] // ADD THIS NEW METHOD
    System.Threading.Tasks.Task<List<CalibrationReportDto>> GetCalibrationReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] string? testName,
        [Query] string? qcResult);

    [Get("/api/reports/sample-storage")] // ADD THIS NEW METHOD
    System.Threading.Tasks.Task<List<SampleStorageReportDto>> GetSampleStorageReportAsync(
        [Header("Authorization")] string token,
        [Query] DateTime startDate,
        [Query] DateTime endDate,
        [Query] string? testName,
        [Query] string? status);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Services\PdfExportService.cs
========================================
using QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Printing;
using System.Reflection;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.Services;

public class PdfExportService : IPdfExportService
{
    public async Task GenerateReportPdfAsync(string reportTitle, string[] columnHeaders, IEnumerable<object> items)
    {
        if (!items.Any())
        {
            MessageBox.Show("There is no data to export.", "Export Canceled", MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }

        await Task.Run(() =>
        {
            try
            {
                // 1. Define the file path
                var today = DateTime.Today;
                var directoryPath = Path.Combine("C:", "MirageReports", today.ToString("yyyy"), today.ToString("MMMM"), today.ToString("dd"));
                Directory.CreateDirectory(directoryPath);

                var fileName = $"{reportTitle.Replace(' ', '_')}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
                var filePath = Path.Combine(directoryPath, fileName);

                // 2. Create the PDF document definition
                var document = new ReportDocument(reportTitle, columnHeaders, items);

                // 3. Generate the PDF
                document.GeneratePdf(filePath);

                // 4. Notify user and open the file
                Application.Current.Dispatcher.Invoke(() =>
                {
                    var result = MessageBox.Show($"Successfully exported report to:\n{filePath}\n\nWould you like to open the file?", "Export Successful", MessageBoxButton.YesNo, MessageBoxImage.Information);
                    if (result == MessageBoxResult.Yes)
                    {
                        // This opens the file with the default PDF viewer
                        Process.Start(new ProcessStartInfo(filePath) { UseShellExecute = true });
                    }
                });
            }
            catch (Exception ex)
            {
                Application.Current.Dispatcher.Invoke(() =>
                {
                    MessageBox.Show($"An error occurred while generating the PDF: {ex.Message}", "Export Error", MessageBoxButton.OK, MessageBoxImage.Error);
                });
            }
        });
    }
}

public class ReportDocument : IDocument
{
    private readonly string _title;
    private readonly string[] _headers;
    private readonly IEnumerable<object> _items;

    public ReportDocument(string title, string[] headers, IEnumerable<object> items)
    {
        _title = title;
        _headers = headers;
        _items = items;
    }

    public DocumentMetadata GetMetadata() => DocumentMetadata.Default;

    public void Compose(IDocumentContainer container)
    {
        container
            .Page(page =>
            {
                // 1. SET THE PAGE TO LANDSCAPE (HORIZONTAL) ORIENTATION
                page.Size(PageSizes.A4.Landscape());
                page.Margin(40);

                page.Header().Element(ComposeHeader);
                page.Content().Element(ComposeContent);
                page.Footer().AlignCenter().Text(text =>
                {
                    text.CurrentPageNumber();
                    text.Span(" / ");
                    text.TotalPages();
                });
            });
    }

    void ComposeHeader(IContainer container)
    {
        // Header logic remains the same...
        var titleStyle = TextStyle.Default.FontSize(20).SemiBold().FontColor(Colors.Blue.Medium);
        container.Row(row =>
        {
            row.RelativeItem().Column(column =>
            {
                column.Item().Text(_title).Style(titleStyle);
                column.Item().Text($"Date Generated: {DateTime.Now:dd-MMM-yyyy HH:mm}");
                column.Item().LineHorizontal(1).LineColor(Colors.Grey.Lighten2);
            });
        });
    }

    void ComposeContent(IContainer container)
    {
        container.PaddingVertical(20).Table(table =>
        {
            // Column width logic remains the same
            table.ColumnsDefinition(columns =>
            {
                switch (_title)
                {
                    case "Machine Breakdowns":
                        columns.RelativeColumn(1.5f); // Reported On
                        columns.RelativeColumn(2f);   // Machine
                        columns.RelativeColumn(3f);   // Reason
                        columns.RelativeColumn(1.2f); // Reported By
                        columns.RelativeColumn(0.8f); // Is Resolved
                        columns.RelativeColumn(1.5f); // Resolved On
                        columns.RelativeColumn(1.2f); // Resolved By
                        columns.RelativeColumn(3f);   // Resolution
                        columns.RelativeColumn(1f);   // Downtime (Mins)
                        columns.RelativeColumn(1f);   // Downtime
                        break;

                    default:
                        foreach (var header in _headers)
                        {
                            var width = header.Length > 15 ? 2f : 1f;
                            columns.RelativeColumn(width);
                        }
                        break;
                }
            });

            // UPDATED: Header styling
            table.Header(header =>
            {
                foreach (var text in _headers)
                {
                    // 1. Changed AlignCenter to AlignLeft and added FontSize(10)
                    header.Cell().Background(Colors.Grey.Darken2).Padding(5).AlignLeft().Text(text).FontColor(Colors.White).SemiBold().FontSize(10);
                }
            });

            // UPDATED: Data row styling
            if (_items.Any())
            {
                var properties = _items.First().GetType().GetProperties();
                foreach (var (item, index) in _items.Select((value, i) => (value, i)))
                {
                    foreach (var prop in properties)
                    {
                        var value = prop.GetValue(item);
                        var formattedValue = FormatValue(value);
                        var cell = table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten2).Padding(5);

                        if (index % 2 != 0)
                        {
                            cell.Background(Colors.Grey.Lighten4);
                        }

                        // 2. Added AlignLeft to ensure all content is left-aligned
                        cell.AlignLeft().AlignMiddle().Text(formattedValue);
                    }
                }
            }
        });
    }

    // FormatValue helper method remains the same...
    string FormatValue(object? value)
    {
        if (value is null) return "N/A";
        if (value is DateTime dt)
        {
            return dt == default ? "N/A" : dt.ToString("dd/MMM/yy HH:mm");
        }
        if (value is bool b) return b ? "Yes" : "No";
        return value.ToString() ?? string.Empty;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\AdminViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using System.Collections.ObjectModel;

namespace Mirage.UI.ViewModels;

// Helper record to define a tab
public record AdminTabItem(string Header, string Icon, object ViewModel);

public partial class AdminViewModel : ObservableObject
{
    public ObservableCollection<AdminTabItem> TabItems { get; } = new();

    [ObservableProperty]
    private AdminTabItem? _selectedTab;

    // The constructor now receives all the ViewModels for the tabs it will manage
    public AdminViewModel(
        UserManagementViewModel userManagementViewModel,
        ShiftManagementViewModel shiftManagementViewModel,
        MasterListViewModel masterListViewModel,
        AuditLogViewModel auditLogViewModel,
        SystemSettingsViewModel systemSettingsViewModel,
        TaskManagementViewModel taskManagementViewModel) // <--- Add this parameter
    {
        // Create the list of tabs to be displayed
        TabItems.Add(new AdminTabItem("Users", "??", userManagementViewModel));
        TabItems.Add(new AdminTabItem("Daily Tasks", "?", taskManagementViewModel)); // <--- Add this tab
        TabItems.Add(new AdminTabItem("Shifts", "??", shiftManagementViewModel));
        TabItems.Add(new AdminTabItem("Master Lists", "??", masterListViewModel));
        TabItems.Add(new AdminTabItem("Audit Log", "??", auditLogViewModel));
        TabItems.Add(new AdminTabItem("System Settings", "???", systemSettingsViewModel));

        // Select the first tab by default
        _selectedTab = TabItems[0];
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\AuditLogViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.IO;
using System.Text;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class AuditLogViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;
    private List<AuditLogDto> _allLogs = new();

    public ObservableCollection<AuditLogDto> Logs { get; } = new();
    public ObservableCollection<string> AvailableModules { get; } = new();
    public ObservableCollection<string> AvailableActions { get; } = new();

    [ObservableProperty] private string? _selectedModule;
    [ObservableProperty] private string? _selectedAction;
    [ObservableProperty] private DateTime _startDate = DateTime.Today.AddDays(-7);
    [ObservableProperty] private DateTime _endDate = DateTime.Today;
    [ObservableProperty] private bool _isLoading;

    public bool HasNoResults => !IsLoading && !Logs.Any();

    public AuditLogViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
    }

    // --- THIS COMMAND IS NOW RESTORED ---
    [RelayCommand]
    private async System.Threading.Tasks.Task SearchAsync()
    {
        // This command is for the main "Search" button and calls the main loading method.
        await LoadLogsAsync(null);
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task LoadLogsAsync(string? preset)
    {
        IsLoading = true;
        OnPropertyChanged(nameof(HasNoResults));

        if (!string.IsNullOrEmpty(preset)) { SetDatePreset(preset); }

        if (StartDate > EndDate)
        {
            ShowMessageBox("Start date cannot be after end date.", "Invalid Date Range", MessageBoxImage.Warning);
            IsLoading = false;
            OnPropertyChanged(nameof(HasNoResults));
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken))
        {
            ShowMessageBox("Authentication token is missing. Please log in again.", "Auth Error", MessageBoxImage.Error);
            IsLoading = false;
            OnPropertyChanged(nameof(HasNoResults));
            return;
        }

        try
        {
            _allLogs = await _apiClient.GetAuditLogsAsync(authToken, StartDate, EndDate);
            PopulateFilters();
            ApplyFilters();
        }
        catch (ApiException ex) { ShowMessageBox($"API Error: {ex.StatusCode}\n{ex.Message}", "Error", MessageBoxImage.Error); }
        catch (Exception ex) { ShowMessageBox($"An unexpected error occurred: {ex.Message}", "Error", MessageBoxImage.Error); }
        finally
        {
            IsLoading = false;
            OnPropertyChanged(nameof(HasNoResults));
        }
    }

    private void SetDatePreset(string? preset)
    {
        switch (preset?.ToLower())
        {
            case "today": StartDate = DateTime.Today; EndDate = DateTime.Today; break;
            case "week": StartDate = DateTime.Today.AddDays(-7); EndDate = DateTime.Today; break;
            case "month": StartDate = DateTime.Today.AddDays(-30); EndDate = DateTime.Today; break;
        }
    }

    private void PopulateFilters()
    {
        var currentModule = SelectedModule;
        var currentAction = SelectedAction;

        AvailableModules.Clear();
        AvailableActions.Clear();
        AvailableModules.Add("All");
        AvailableActions.Add("All");

        if (_allLogs == null || !_allLogs.Any())
        {
            SelectedModule = "All";
            SelectedAction = "All";
            return;
        }

        var modules = _allLogs.Select(l => l.ModuleName).Where(m => m != null).Distinct().OrderBy(m => m);
        foreach (var module in modules) AvailableModules.Add(module!);

        var actions = _allLogs.Select(l => l.ActionType).Distinct().OrderBy(a => a);
        foreach (var action in actions) AvailableActions.Add(action);

        SelectedModule = currentModule != null && AvailableModules.Contains(currentModule) ? currentModule : "All";
        SelectedAction = currentAction != null && AvailableActions.Contains(currentAction) ? currentAction : "All";
    }

    private void ApplyFilters()
    {
        if (_allLogs == null) return;

        IEnumerable<AuditLogDto> filteredLogs = _allLogs;

        if (!string.IsNullOrEmpty(SelectedModule) && SelectedModule != "All")
        {
            filteredLogs = filteredLogs.Where(l => l.ModuleName == SelectedModule);
        }
        if (!string.IsNullOrEmpty(SelectedAction) && SelectedAction != "All")
        {
            filteredLogs = filteredLogs.Where(l => l.ActionType == SelectedAction);
        }

        Logs.Clear();
        foreach (var log in filteredLogs.OrderByDescending(l => l.Timestamp))
        {
            Logs.Add(log);
        }
        OnPropertyChanged(nameof(HasNoResults));
    }

    partial void OnSelectedModuleChanged(string? value) => ApplyFilters();
    partial void OnSelectedActionChanged(string? value) => ApplyFilters();

    [RelayCommand]
    private void ClearFilters()
    {
        SelectedModule = "All";
        SelectedAction = "All";
    }

    // --- UPDATED EXPORT TO CSV METHOD ---
    [RelayCommand]
    private async System.Threading.Tasks.Task ExportToCsv()
    {
        if (!Logs.Any())
        {
            ShowMessageBox("There is no data to export.", "Export", MessageBoxImage.Information);
            return;
        }

        try
        {
            // 1. Build the CSV content as a string
            var csvBuilder = new StringBuilder();
            csvBuilder.AppendLine("Timestamp,User,Module,Action,RecordID,Details"); // Header row

            foreach (var log in Logs)
            {
                // Helper function to safely format text for CSV
                Func<string?, string> sanitize = value =>
                {
                    if (string.IsNullOrEmpty(value)) return "";
                    var sanitized = value.Replace("\"", "\"\""); // Escape any double quotes
                    return $"\"{sanitized}\""; // Enclose the text in double quotes
                };

                var line = string.Join(",",
                    log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss"),
                    sanitize(log.UserFullName ?? "System"),
                    sanitize(log.ModuleName),
                    sanitize(log.ActionType),
                    log.RecordID,
                    sanitize(log.NewValue)
                );
                csvBuilder.AppendLine(line);
            }

            // 2. Create the folder path (e.g., C:\MirageReports\2025\10\11)
            var today = DateTime.Today;
            var directoryPath = Path.Combine("C:", "MirageReports", today.ToString("yyyy"), today.ToString("MMMM"), today.ToString("dd"));
            Directory.CreateDirectory(directoryPath); // This safely creates folders if they don't exist

            // 3. Create a unique file name
            var fileName = $"Audit_Log_{DateTime.Now:yyyy-MM-dd_HHmmss}.csv";
            var filePath = Path.Combine(directoryPath, fileName);

            // 4. Write the content to the file
            await File.WriteAllTextAsync(filePath, csvBuilder.ToString());

            // 5. Notify the user of success
            ShowMessageBox($"Successfully exported {Logs.Count} records.\n\nFile saved to:\n{filePath}", "Export Successful", MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            ShowMessageBox($"An error occurred during export: {ex.Message}", "Export Error", MessageBoxImage.Error);
        }
    }

    private void ShowMessageBox(string message, string caption, MessageBoxImage image)
    {
        Application.Current.Dispatcher.Invoke(() => { MessageBox.Show(message, caption, MessageBoxButton.OK, image); });
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\CalibrationLogViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class CalibrationLogViewModel : ObservableObject
{
    // 1. Services are now provided by the constructor
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    // All [ObservableProperty] fields remain the same
    [ObservableProperty]
    private string? _selectedTestName;
    [ObservableProperty]
    private string? _selectedQcResult;
    [ObservableProperty]
    private string? _reason;
    [ObservableProperty]
    private DateTime _startDate = DateTime.Today;
    [ObservableProperty]
    private DateTime _endDate = DateTime.Today;
    [ObservableProperty]
    private bool _isDeleteFlyoutOpen;
    [ObservableProperty]
    private CalibrationLogResponse? _selectedLogToDelete;
    [ObservableProperty]
    private string _deactivationReason = string.Empty;

    // DRAFT CONFIGURATION
    private const string DraftFileName = "draft_calibration.json";
    [ObservableProperty] private bool _hasUnsavedDraft;

    public ObservableCollection<CalibrationLogResponse> Logs { get; } = new();
    public ObservableCollection<string> TestNames { get; } = new();
    public ObservableCollection<string> QcResults { get; } = new();

    // 2. The constructor now accepts the services
    public CalibrationLogViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;

        TestNames.Add("Vitros 250");
        TestNames.Add("Abbott Architect");
        TestNames.Add("Glucose Meter QC");
        QcResults.Add("Passed");
        QcResults.Add("Failed");

        // CHECK FOR DRAFT ON STARTUP
        if (File.Exists(DraftFileName))
        {
            try
            {
                var json = File.ReadAllText(DraftFileName);
                // Verify this matches your actual DTO name (e.g., CreateCalibrationRequest)
                var draft = JsonSerializer.Deserialize<CreateCalibrationLogRequest>(json);

                if (draft != null)
                {
                    // Map the draft back to your form properties
                    // UPDATE THESE NAMES to match your actual variables!
                    SelectedTestName = draft.TestName;
                    SelectedQcResult = draft.QcResult;
                    Reason = draft.Reason;

                    HasUnsavedDraft = true;
                    MessageBox.Show("We found an unsaved calibration record and restored it.", "Draft Restored", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch
            {
                try { File.Delete(DraftFileName); }
                catch { }
            }
        }
    }

    [RelayCommand]
    private async Task LoadLogs()
    {
        // 3. Get the token from the service before every API call
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var logs = await _apiClient.GetCalibrationLogsAsync(authToken, StartDate, EndDate);
            Logs.Clear();
            foreach (var log in logs)
            {
                Logs.Add(log);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load logs: {ex.Message}");
        }
    }

    [RelayCommand]
    private async Task Save()
    {
        var authToken = _authService.GetToken();

        // Validate required fields
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrEmpty(SelectedTestName) || string.IsNullOrEmpty(SelectedQcResult))
        {
            MessageBox.Show("Test Name and QC Result are required.");
            return;
        }

        // Create the Request Object
        var request = new CreateCalibrationLogRequest(SelectedTestName, SelectedQcResult, Reason);

        try
        {
            // 1. Try API
            await _apiClient.CreateCalibrationLogAsync(authToken, request);

            // 2. Success: Clear Form & Delete Draft
            Clear();
            if (File.Exists(DraftFileName)) File.Delete(DraftFileName);
            HasUnsavedDraft = false;

            await LoadLogs(); // Refresh the list
            MessageBox.Show("Calibration record saved successfully.", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            // 3. Failure: Save Draft
            try
            {
                var json = JsonSerializer.Serialize(request);
                await File.WriteAllTextAsync(DraftFileName, json);
                HasUnsavedDraft = true;

                MessageBox.Show(
                    $"Connection failed: {ex.Message}\n\n" +
                    "This calibration record has been saved as a draft.\n" +
                    "Please submit it again when the connection is restored.",
                    "Network Error - Draft Saved",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            catch (Exception fileEx)
            {
                MessageBox.Show($"Critical Error: Could not save draft.\n{fileEx.Message}", "Error");
            }
        }
    }

    [RelayCommand]
    private void Clear()
    {
        SelectedTestName = null;
        SelectedQcResult = null;
        Reason = string.Empty;
    }

    [RelayCommand]
    private async Task ClearDraft()
    {
        try
        {
            if (File.Exists(DraftFileName))
            {
                File.Delete(DraftFileName);
                Clear();
                HasUnsavedDraft = false;
                MessageBox.Show("Draft cleared successfully.", "Draft Cleared", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to clear draft: {ex.Message}", "Error");
        }
    }

    [RelayCommand]
    private void ShowDeleteFlyout(CalibrationLogResponse log)
    {
        SelectedLogToDelete = log;
        DeactivationReason = string.Empty;
        IsDeleteFlyoutOpen = true;
    }

    [RelayCommand]
    private async Task ConfirmDeactivation()
    {
        if (SelectedLogToDelete is null || string.IsNullOrWhiteSpace(DeactivationReason))
        {
            MessageBox.Show("A reason is required for deactivation.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new DeactivateCalibrationLogRequest(DeactivationReason);
            await _apiClient.DeactivateCalibrationLogAsync(authToken, SelectedLogToDelete.CalibrationID, request);

            IsDeleteFlyoutOpen = false;
            await LoadLogs();
        }
        // This important error handling is preserved
        catch (ApiException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                MessageBox.Show("You do not have permission to perform this action. Please contact an administrator.", "Authorization Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            else
            {
                MessageBox.Show($"An error occurred communicating with the server: {ex.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"An error occurred: {ex.Message}");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\DailyTaskLogViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Text.Json; // <--- CRITICAL: Required for robust parsing
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class DailyTaskLogViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    [ObservableProperty]
    private DateTime _selectedDate = DateTime.Today;
    [ObservableProperty]
    private bool _isNaFlyoutOpen;
    [ObservableProperty]
    private TaskLogDetailDto? _selectedTaskForNa;
    [ObservableProperty]
    private string _naReason = string.Empty;

    [ObservableProperty]
    private bool _isSaving;

    [ObservableProperty]
    private bool _isSavingNa;

    public ObservableCollection<TaskLogItem> MorningTasks { get; } = new();
    public ObservableCollection<TaskLogItem> EveningTasks { get; } = new();
    public ObservableCollection<TaskLogItem> NightTasks { get; } = new();

    public DailyTaskLogViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
        LoadInitialTasks();
    }

    private async void LoadInitialTasks() => await LoadTasks();

    [RelayCommand]
    private async Task LoadTasks()
    {
        if (IsSaving) return;

        try
        {
            IsSaving = true;

            var token = _authService.GetToken();
            if (string.IsNullOrEmpty(token)) return;

            // === FIXES APPLIED HERE ===
            // 1. Used '_apiClient' (the name defined at the top of your class)
            // 2. Used 'SelectedDate' (Capital 'S', the public property)
            // 3. Formatted date to "yyyy-MM-dd" to fix the 404 error
            // 4. Assigned the result to 'var tasks' so the loop below works
            var tasks = await _apiClient.GetTasksForDateAsync(token, SelectedDate);

            MorningTasks.Clear();
            EveningTasks.Clear();
            NightTasks.Clear();

            if (tasks != null)
            {
                foreach (var t in tasks)
                {
                    var item = new TaskLogItem(t);

                    // Case-insensitive check to be safe
                    if (string.Equals(t.TaskCategory, "Morning", StringComparison.OrdinalIgnoreCase))
                        MorningTasks.Add(item);
                    else if (string.Equals(t.TaskCategory, "Evening", StringComparison.OrdinalIgnoreCase))
                        EveningTasks.Add(item);
                    else
                        NightTasks.Add(item);
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Error loading tasks: {ex.Message}");
        }
        finally
        {
            IsSaving = false;
        }
    }

    [RelayCommand]
    private async Task SaveChanges()
    {
        if (IsSaving) return;

        try
        {
            IsSaving = true;

            var token = _authService.GetToken();
            if (string.IsNullOrEmpty(token))
            {
                MessageBox.Show("Security Token is missing. Please log out and log in again.");
                return;
            }

            // 1. Get User ID
            var userId = _authService.CurrentUser?.UserID ?? 0;
            if (userId <= 0) userId = GetUserIdFromToken(token);

            // Fallback to ID 1 if token parsing fails (prevents 500 error)
            if (userId <= 0) userId = 1;

            var allModified = MorningTasks.Concat(EveningTasks).Concat(NightTasks)
                                          .Where(t => t.IsDirty).ToList();

            if (!allModified.Any())
            {
                MessageBox.Show("No changes to save.");
                return;
            }

            foreach (var item in allModified)
            {
                // FIX: Create the Request Object
                var request = new UpdateTaskStatusRequest
                {
                    Status = item.StatusToSave,
                    UserId = userId,
                    Comment = null
                };

                // FIX: Send 3 arguments (Token, LogID, RequestObject)
                await _apiClient.UpdateTaskStatusAsync(token, item.LogID, request);

                item.MarkAsSaved();
            }
            MessageBox.Show("Changes saved successfully!", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            // === DETAILED ERROR REPORTING ===
            string errorMessage = ex.Message;

            // 1. Check if it's a Refit API Error to get the real message
            if (ex is Refit.ApiException apiEx)
            {
                // Extracts the text I added to the Controller ("CRITICAL FAILURE...")
                errorMessage = $"Server Error ({apiEx.StatusCode}):\n{apiEx.Content}";
            }

            // 2. Show the detailed error
            MessageBox.Show(errorMessage, "Save Failed", MessageBoxButton.OK, MessageBoxImage.Error);
        }
        finally
        {
            IsSaving = false;
        }
    }

    [RelayCommand]
    private void CloseNaFlyout()
    {
        IsNaFlyoutOpen = false;
        NaReason = string.Empty;
    }

    [RelayCommand]
    private void ShowNaFlyout(TaskLogDetailDto task)
    {
        SelectedTaskForNa = task;
        NaReason = string.Empty;
        IsNaFlyoutOpen = true;
    }

    [RelayCommand]
    private async Task ConfirmNa()
    {
        if (IsSavingNa) return;

        try
        {
            IsSavingNa = true;

            if (SelectedTaskForNa is null || string.IsNullOrWhiteSpace(NaReason))
            {
                MessageBox.Show("A reason is required to mark as N/A.");
                return;
            }

            var token = _authService.GetToken();
            if (string.IsNullOrEmpty(token))
            {
                MessageBox.Show("User session invalid.");
                return;
            }

            // 1. Get User ID (Same logic as SaveChanges)
            var userId = _authService.CurrentUser?.UserID ?? 0;
            if (userId <= 0) userId = GetUserIdFromToken(token);

            // Fallback to prevent 0 ID
            if (userId <= 0) userId = 1;

            // 2. Create the Request Object (CRITICAL for Server to receive ID)
            var request = new UpdateTaskStatusRequest
            {
                Status = "Not Available",
                UserId = userId,
                Comment = NaReason
            };

            // 3. Send to API
            await _apiClient.UpdateTaskStatusAsync(token, SelectedTaskForNa.LogID, request);

            // 4. Cleanup UI
            IsNaFlyoutOpen = false;
            NaReason = string.Empty;
            await LoadTasks(); // Refresh list
        }
        catch (Exception ex)
        {
            // === DETAILED ERROR REPORTING ===
            string errorMessage = ex.Message;

            // Check if it's a Refit API Error to get the real message from the Controller
            if (ex is Refit.ApiException apiEx)
            {
                errorMessage = $"Server Error ({apiEx.StatusCode}):\n{apiEx.Content}";
            }

            MessageBox.Show(errorMessage, "N/A Update Failed", MessageBoxButton.OK, MessageBoxImage.Error);
        }
        finally
        {
            IsSavingNa = false;
        }
    }

    // --- ROBUST TOKEN PARSER ---
    private int GetUserIdFromToken(string token)
    {
        if (string.IsNullOrEmpty(token)) return 0;
        try
        {
            // 1. Get Payload
            var parts = token.Split('.');
            if (parts.Length < 2) return 0;

            var payload = parts[1];

            // 2. Fix Base64 Padding
            switch (payload.Length % 4)
            {
                case 2: payload += "=="; break;
                case 3: payload += "="; break;
            }

            // 3. Decode
            var jsonBytes = Convert.FromBase64String(payload.Replace('-', '+').Replace('_', '/'));

            // 4. Parse JSON using System.Text.Json
            using (var doc = JsonDocument.Parse(jsonBytes))
            {
                var root = doc.RootElement;
                JsonElement idElement;

                // Check for common claim names (Long URL is standard for .NET)
                if (root.TryGetProperty("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier", out idElement) ||
                    root.TryGetProperty("nameid", out idElement) ||
                    root.TryGetProperty("sub", out idElement) ||
                    root.TryGetProperty("id", out idElement))
                {
                    if (idElement.ValueKind == JsonValueKind.Number)
                        return idElement.GetInt32();
                    if (idElement.ValueKind == JsonValueKind.String && int.TryParse(idElement.GetString(), out int id))
                        return id;
                }
            }

            // === DEBUGGING BLOCK ===
            // If we get here, we couldn't find the ID. 
            // For debugging, you can uncomment this to see what's in the token:
            // var jsonString = System.Text.Encoding.UTF8.GetString(jsonBytes);
            // MessageBox.Show($"DEBUG: Could not find ID in token.\n\nPayload:\n{jsonString}", "Token Debug");
        }
        catch { /* Ignore errors */ }
        return 0;
    }
}

public class TaskLogItem : ObservableObject
{
    public TaskLogDetailDto Dto { get; }
    private bool _isChecked;

    public TaskLogItem(TaskLogDetailDto dto)
    {
        Dto = dto;
        // FIX: Backend uses "Complete", not "Completed"
        _isChecked = dto.Status == "Complete";
    }

    public long LogID => Dto.LogID;
    public string TaskName => Dto.TaskName;
    public bool IsDirty { get; private set; }

    public bool IsChecked
    {
        get => _isChecked;
        set
        {
            if (SetProperty(ref _isChecked, value))
            {
                IsDirty = true;
            }
        }
    }

    // FIX: Send "Complete" (No 'd') to match the Backend Validation
    public string StatusToSave => IsChecked ? "Complete" : "Pending";

    public void MarkAsSaved() => IsDirty = false;
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\DashboardViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using Mirage.UI.Services;
using Mirage.UI.Views;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Media;

namespace Mirage.UI.ViewModels;

public partial class DashboardItem : ObservableObject
{
    [ObservableProperty]
    private string _label;
    [ObservableProperty]
    private int _count;
    [ObservableProperty]
    private string _icon;
    [ObservableProperty]
    private Brush _accentColor;
    [ObservableProperty]
    private Type _targetView;

    public DashboardItem(string label, string icon, Brush accentColor, Type targetView)
    {
        _label = label;
        _icon = icon;
        _accentColor = accentColor;
        _targetView = targetView;
    }
}

public partial class DashboardViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    [ObservableProperty]
    private bool _isLoading;

    public ObservableCollection<DashboardItem> DashboardItems { get; } = new();

    public DashboardViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
        InitializeDashboardItems();
    }

    private void InitializeDashboardItems()
    {
        DashboardItems.Add(new DashboardItem("Pending Handovers", "\uE8AB", new SolidColorBrush((Color)ColorConverter.ConvertFromString("#007AFF")), typeof(HandoverView)));
        DashboardItems.Add(new DashboardItem("Unresolved Breakdowns", "\uE99A", new SolidColorBrush((Color)ColorConverter.ConvertFromString("#FF9500")), typeof(MachineBreakdownView)));
        DashboardItems.Add(new DashboardItem("Pending Daily Tasks", "\uECC8", new SolidColorBrush((Color)ColorConverter.ConvertFromString("#FF3B30")), typeof(DailyTaskLogView)));
        DashboardItems.Add(new DashboardItem("Pending Samples", "\uE728", new SolidColorBrush((Color)ColorConverter.ConvertFromString("#34C759")), typeof(SampleStorageView)));
    }

    // Using the full namespace as you correctly pointed out
    public async System.Threading.Tasks.Task LoadSummaryAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        IsLoading = true;
        try
        {
            var summary = await _apiClient.GetDashboardSummaryAsync(authToken);
            if (DashboardItems.Count >= 4)
            {
                DashboardItems[0].Count = summary.PendingHandoversCount;
                DashboardItems[1].Count = summary.UnresolvedBreakdownsCount;
                DashboardItems[2].Count = summary.PendingDailyTasksCount;
                DashboardItems[3].Count = summary.PendingSamplesCount;
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load dashboard summary: {ex.Message}", "Error");
        }
        finally
        {
            IsLoading = false;
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\HandoverViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class HandoverViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    // DRAFT CONFIGURATION
    private const string DraftFileName = "draft_handover.json";
    [ObservableProperty] private bool _hasUnsavedDraft;

    [ObservableProperty]
    private string _newHandoverNotes = string.Empty;
    [ObservableProperty]
    private string _selectedPriority = "Normal";
    [ObservableProperty]
    private string _selectedShift = "Morning";
    [ObservableProperty]
    private DateTime _startDate = DateTime.Today;
    [ObservableProperty]
    private DateTime _endDate = DateTime.Today;
    [ObservableProperty]
    private bool _isDeleteFlyoutOpen;
    [ObservableProperty]
    private HandoverResponse? _selectedHandoverToDelete;
    [ObservableProperty]
    private string _deactivationReason = string.Empty;

    private string _activeView = "Pending";
    public bool IsPendingViewActive
    {
        get => _activeView == "Pending";
        set
        {
            if (value)
            {
                _activeView = "Pending";
                OnPropertyChanged(nameof(IsPendingViewActive));
                OnPropertyChanged(nameof(IsCompletedViewActive));
                SearchCommand.Execute(null);
            }
        }
    }
    public bool IsCompletedViewActive
    {
        get => _activeView == "Completed";
        set
        {
            if (value)
            {
                _activeView = "Completed";
                OnPropertyChanged(nameof(IsPendingViewActive));
                OnPropertyChanged(nameof(IsCompletedViewActive));
                SearchCommand.Execute(null);
            }
        }
    }

    public ObservableCollection<HandoverResponse> PendingHandovers { get; } = new();
    public ObservableCollection<HandoverResponse> CompletedHandovers { get; } = new();
    public ObservableCollection<string> Priorities { get; } = new() { "Normal", "Urgent" };
    public ObservableCollection<string> Shifts { get; } = new() { "Morning", "Evening", "Night" };

    public HandoverViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;

        // CHECK FOR DRAFT ON STARTUP
        if (File.Exists(DraftFileName))
        {
            try
            {
                var json = File.ReadAllText(DraftFileName);
                var draft = JsonSerializer.Deserialize<CreateHandoverRequest>(json);

                if (draft != null)
                {
                    NewHandoverNotes = draft.HandoverNotes;
                    SelectedPriority = draft.Priority;
                    SelectedShift = draft.Shift;

                    HasUnsavedDraft = true;
                    MessageBox.Show("We found an unsaved handover from your last session and restored it.", "Draft Restored", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch { try { File.Delete(DraftFileName); } catch { } }
        }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task Search()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            if (_activeView == "Pending")
            {
                var handovers = await _apiClient.GetPendingHandoversAsync(authToken, StartDate, EndDate);
                PendingHandovers.Clear();
                foreach (var handover in handovers) PendingHandovers.Add(handover);
            }
            else // Completed
            {
                var handovers = await _apiClient.GetCompletedHandoversAsync(authToken, StartDate, EndDate);
                CompletedHandovers.Clear();
                foreach (var handover in handovers) CompletedHandovers.Add(handover);
            }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load handovers: {ex.Message}"); }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task Submit()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrEmpty(NewHandoverNotes))
        {
            MessageBox.Show("Handover notes cannot be empty.");
            return;
        }

        var request = new CreateHandoverRequest(NewHandoverNotes, SelectedPriority, SelectedShift);

        try
        {
            // 1. Try API
            await _apiClient.CreateHandoverAsync(authToken, request);

            // 2. Success: Clear Form & Delete Draft
            NewHandoverNotes = string.Empty;
            if (File.Exists(DraftFileName)) File.Delete(DraftFileName);
            HasUnsavedDraft = false;

            await Search();
            MessageBox.Show("Handover submitted successfully.", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception)
        {
            // 3. Failure: Save Draft
            try
            {
                var json = JsonSerializer.Serialize(request);
                await File.WriteAllTextAsync(DraftFileName, json);
                HasUnsavedDraft = true;

                MessageBox.Show(
                    "Connection failed.\n\n" +
                    "Don't worry! Your handover has been safely saved as a draft.\n\n" +
                    "Please check your connection. When you are back online, click 'Submit Handover' again.",
                    "Network Error - Draft Saved",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            catch (Exception fileEx)
            {
                MessageBox.Show($"Critical Error: Could not save draft.\n{fileEx.Message}", "Error");
            }
        }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task Receive(int handoverId)
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            await _apiClient.MarkHandoverAsReceivedAsync(authToken, handoverId);
            var itemToRemove = PendingHandovers.FirstOrDefault(h => h.HandoverID == handoverId);
            if (itemToRemove != null) PendingHandovers.Remove(itemToRemove);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to receive handover: {ex.Message}"); }
    }

    [RelayCommand]
    private void ShowDeleteFlyout(HandoverResponse handover)
    {
        SelectedHandoverToDelete = handover;
        DeactivationReason = string.Empty;
        IsDeleteFlyoutOpen = true;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task ConfirmDeactivation()
    {
        if (SelectedHandoverToDelete is null || string.IsNullOrWhiteSpace(DeactivationReason))
        {
            MessageBox.Show("A reason is required for deactivation.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new DeactivateHandoverRequest(DeactivationReason);
            await _apiClient.DeactivateHandoverAsync(authToken, SelectedHandoverToDelete.HandoverID, request);

            IsDeleteFlyoutOpen = false;
            await Search();
        }
        catch (ApiException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Forbidden ||
                ex.StatusCode == System.Net.HttpStatusCode.InternalServerError)
            {
                MessageBox.Show("You do not have permission to perform this action. Please contact an administrator.", "Authorization Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            else
            {
                MessageBox.Show($"An error occurred communicating with the server: {ex.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"An error occurred: {ex.Message}");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\KitValidationViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class KitValidationViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    [ObservableProperty] private string _kitName = string.Empty;
    [ObservableProperty] private string _kitLotNumber = string.Empty;
    [ObservableProperty] private DateTime? _kitExpiryDate = DateTime.Today.AddMonths(6);
    [ObservableProperty] private string? _selectedValidationStatus;
    [ObservableProperty] private string? _comments;
    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;
    [ObservableProperty] private bool _isDeleteFlyoutOpen;
    [ObservableProperty] private KitValidationResponse? _selectedLogToDelete;
    [ObservableProperty] private string _deactivationReason = string.Empty;

    // DRAFT CONFIGURATION
    private const string DraftFileName = "draft_kitvalidation.json";
    [ObservableProperty] private bool _hasUnsavedDraft;

    public ObservableCollection<KitValidationResponse> Logs { get; } = new();
    public ObservableCollection<string> ValidationStatuses { get; } = new();

    public KitValidationViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
        ValidationStatuses.Add("Accepted");
        ValidationStatuses.Add("Rejected");

        // CHECK FOR DRAFT ON STARTUP
        if (File.Exists(DraftFileName))
        {
            try
            {
                var json = File.ReadAllText(DraftFileName);
                // Verify 'CreateKitValidationRequest' matches your DTO name
                var draft = JsonSerializer.Deserialize<CreateKitValidationRequest>(json);

                if (draft != null)
                {
                    // Map the draft back to your form properties
                    // USING THE CORRECT PROPERTY NAMES FROM CreateKitValidationRequest
                    KitName = draft.KitName;
                    KitLotNumber = draft.KitLotNumber; // Fixed: Use actual property name
                    KitExpiryDate = draft.KitExpiryDate; // Fixed: Use actual property name
                    SelectedValidationStatus = draft.ValidationStatus; // Fixed: Use actual property name
                    Comments = draft.Comments;

                    HasUnsavedDraft = true;
                    MessageBox.Show("We found an unsaved kit validation entry and restored it.", "Draft Restored", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch
            {
                try { File.Delete(DraftFileName); }
                catch { }
            }
        }
    }

    [RelayCommand]
    private async Task LoadLogs()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var logs = await _apiClient.GetKitValidationsAsync(authToken, StartDate, EndDate);
            Logs.Clear();
            foreach (var log in logs) Logs.Add(log);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load logs: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task Save()
    {
        var authToken = _authService.GetToken();

        if (string.IsNullOrEmpty(authToken) || string.IsNullOrEmpty(KitName) || string.IsNullOrEmpty(KitLotNumber) || KitExpiryDate is null || string.IsNullOrEmpty(SelectedValidationStatus))
        {
            MessageBox.Show("All fields except comments are required.");
            return;
        }

        // Create Request - Using the correct property names that match your DTO
        var request = new CreateKitValidationRequest(KitName, KitLotNumber, KitExpiryDate.Value, SelectedValidationStatus, Comments);

        try
        {
            // 1. Try API
            await _apiClient.CreateKitValidationAsync(authToken, request);

            // 2. Success
            Clear();
            if (File.Exists(DraftFileName)) File.Delete(DraftFileName);
            HasUnsavedDraft = false;

            await LoadLogs(); // Refresh the list
            MessageBox.Show("Validation record saved successfully.", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            // 3. Failure: Save Draft
            try
            {
                var json = JsonSerializer.Serialize(request);
                await File.WriteAllTextAsync(DraftFileName, json);
                HasUnsavedDraft = true;

                MessageBox.Show(
                    $"Connection failed: {ex.Message}\n\n" +
                    "This validation record has been saved as a draft.\n" +
                    "Please submit it again when the connection is restored.",
                    "Network Error - Draft Saved",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            catch (Exception fileEx)
            {
                MessageBox.Show($"Critical Error: Could not save draft.\n{fileEx.Message}", "Error");
            }
        }
    }

    [RelayCommand]
    private void Clear()
    {
        KitName = string.Empty;
        KitLotNumber = string.Empty;
        KitExpiryDate = DateTime.Today.AddMonths(6);
        SelectedValidationStatus = null;
        Comments = string.Empty;
    }

    [RelayCommand]
    private async Task ClearDraft()
    {
        try
        {
            if (File.Exists(DraftFileName))
            {
                File.Delete(DraftFileName);
                Clear();
                HasUnsavedDraft = false;
                MessageBox.Show("Draft cleared successfully.", "Draft Cleared", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to clear draft: {ex.Message}", "Error");
        }
    }

    [RelayCommand]
    private void ShowDeleteFlyout(KitValidationResponse log)
    {
        SelectedLogToDelete = log;
        DeactivationReason = string.Empty;
        IsDeleteFlyoutOpen = true;
    }

    [RelayCommand]
    private async Task ConfirmDeactivation()
    {
        if (SelectedLogToDelete is null || string.IsNullOrWhiteSpace(DeactivationReason))
        {
            MessageBox.Show("A reason is required for deactivation.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new DeactivateKitValidationRequest(DeactivationReason);
            await _apiClient.DeactivateKitValidationAsync(authToken, SelectedLogToDelete.ValidationID, request);
            IsDeleteFlyoutOpen = false;
            await LoadLogs();
        }
        catch (ApiException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                MessageBox.Show("You do not have permission to perform this action. Please contact an administrator.", "Authorization Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            else
            {
                MessageBox.Show($"An error occurred communicating with the server: {ex.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"An error occurred: {ex.Message}");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\LogbooksViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;

namespace Mirage.UI.ViewModels;

public partial class LogbooksViewModel : ObservableObject
{
    // This is a placeholder for now.
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\LoginViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using Mirage.UI.Views;
using Microsoft.Extensions.DependencyInjection;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class LoginViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService; // It now uses our service
    private readonly MainViewModel _mainViewModel; // Added for setting current user
    private readonly IInactivityService _inactivityService;

    [ObservableProperty]
    private string _username = string.Empty;

    [ObservableProperty]
    private string _errorMessage = string.Empty;

    [ObservableProperty]
    private bool _isLoginInProgress;

    // The constructor now receives the services it needs
    public LoginViewModel(IPortalMirageApi apiClient, IAuthService authService, MainViewModel mainViewModel, IInactivityService inactivityService)
    {
        _apiClient = apiClient;
        _authService = authService;
        _mainViewModel = mainViewModel; // Store the MainViewModel reference
        _inactivityService = inactivityService;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task LoginAsync(object? parameter)
    {
        if (parameter is not System.Windows.Controls.PasswordBox passwordBox) return;
        var password = passwordBox.Password;

        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(password))
        {
            ErrorMessage = "Username and password are required.";
            return;
        }

        IsLoginInProgress = true;
        ErrorMessage = string.Empty;
        try
        {
            var loginRequest = new LoginRequest(Username, password);
            var loginResponse = await _apiClient.LoginAsync(loginRequest);

            // 1. Set the token and user info first
            _authService.SetToken($"Bearer {loginResponse.Token}");
            _mainViewModel.CurrentUser = loginResponse.User;

            // 2. Get the MainWindow and show it so the UI appears instantly
            var mainWindow = App.ServiceProvider?.GetRequiredService<MainWindow>();
            mainWindow?.Show();

            // --- THIS IS THE CORRECTED BLOCK ---
            try
            {
                // Get the auth token *before* trying to use it
                var authToken = _authService.GetToken();
                if (!string.IsNullOrEmpty(authToken))
                {
                    // Fetch the timeout setting from the API
                    var setting = await _apiClient.GetSettingAsync(authToken, "InactivityTimeoutMinutes");
                    if (int.TryParse(setting.Description, out int timeoutMinutes) && timeoutMinutes > 0)
                    {
                        // Start the timer with the value from the database
                        _inactivityService.StartTimer(timeoutMinutes);
                    }
                    else
                    {
                        // Fallback to 15 minutes if the setting is invalid
                        _inactivityService.StartTimer(15);
                    }
                }
                else
                {
                    // Fallback if token is somehow missing (shouldn't happen here)
                    _inactivityService.StartTimer(15);
                }
            }
            catch
            {
                // If the API call fails for any reason, fallback to a default of 15 minutes
                _inactivityService.StartTimer(15);
            }
            // ------------------------------------

            // 3. NOW, get the DashboardViewModel and tell it to load its data
            var dashboardViewModel = App.ServiceProvider?.GetRequiredService<DashboardViewModel>();
            if (dashboardViewModel != null)
            {
                // We don't wait for this to finish; the UI is already visible and the dashboard will update when ready
                _ = dashboardViewModel.LoadSummaryAsync();
            }

            // 4. Close the login window
            var loginWindow = Application.Current.Windows.OfType<LoginView>().FirstOrDefault();
            loginWindow?.Close();
        }
        catch (ApiException ex)
        {
            ErrorMessage = $"Login failed. Please check your credentials. (Error: {ex.StatusCode})";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoginInProgress = false;
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\MachineBreakdownViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class MachineBreakdownViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    // Draft settings
    private const string DraftFileName = "draft_machine_breakdown.json";
    [ObservableProperty] private bool _hasUnsavedDraft;

    [ObservableProperty] private string? _selectedMachineName;
    [ObservableProperty] private string _breakdownReason = string.Empty;
    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;

    private string _activeView = "Pending";
    public bool IsPendingViewActive
    {
        get => _activeView == "Pending";
        set
        {
            if (value && _activeView != "Pending")
            {
                _activeView = "Pending";
                OnPropertyChanged(nameof(IsPendingViewActive));
                OnPropertyChanged(nameof(IsResolvedViewActive));
                SearchCommand.Execute(null);
            }
        }
    }
    public bool IsResolvedViewActive
    {
        get => _activeView == "Resolved";
        set
        {
            if (value && _activeView != "Resolved")
            {
                _activeView = "Resolved";
                OnPropertyChanged(nameof(IsPendingViewActive));
                OnPropertyChanged(nameof(IsResolvedViewActive));
                SearchCommand.Execute(null);
            }
        }
    }

    [ObservableProperty] private bool _isResolveFlyoutOpen;
    [ObservableProperty] private MachineBreakdownResponse? _selectedBreakdownToResolve;
    [ObservableProperty] private string _resolutionNotes = string.Empty;
    [ObservableProperty] private bool _isDeleteFlyoutOpen;
    [ObservableProperty] private MachineBreakdownResponse? _selectedBreakdownToDelete;
    [ObservableProperty] private string _deactivationReason = string.Empty;

    public ObservableCollection<MachineBreakdownResponse> PendingBreakdowns { get; } = new();
    public ObservableCollection<MachineBreakdownResponse> ResolvedBreakdowns { get; } = new();
    public ObservableCollection<string> MachineNames { get; } = new();

    public MachineBreakdownViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;

        // Check for draft on startup
        if (File.Exists(DraftFileName))
        {
            try
            {
                var json = File.ReadAllText(DraftFileName);
                var draft = JsonSerializer.Deserialize<CreateMachineBreakdownRequest>(json);

                if (draft != null)
                {
                    SelectedMachineName = draft.MachineName;
                    BreakdownReason = draft.BreakdownReason;
                    HasUnsavedDraft = true;
                    MessageBox.Show("We found unsaved work from your last session and restored it.", "Draft Restored", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch
            {
                try
                {
                    File.Delete(DraftFileName);
                }
                catch
                {
                    // Ignore delete errors
                }
            }
        }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task LoadMachineNamesAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var machineNameItems = await _apiClient.GetListItemsByTypeAsync(authToken, "MachineName");

            MachineNames.Clear();
            foreach (var item in machineNameItems)
            {
                if (item.IsActive) // Only add active items to the dropdown
                {
                    MachineNames.Add(item.ItemValue);
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load machine names: {ex.Message}", "Error");
        }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task Search()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            if (_activeView == "Pending")
            {
                var breakdowns = await _apiClient.GetPendingBreakdownsAsync(authToken, StartDate, EndDate);
                PendingBreakdowns.Clear();
                foreach (var b in breakdowns) PendingBreakdowns.Add(b);
            }
            else // Resolved
            {
                var breakdowns = await _apiClient.GetResolvedBreakdownsAsync(authToken, StartDate, EndDate);
                ResolvedBreakdowns.Clear();
                foreach (var b in breakdowns) ResolvedBreakdowns.Add(b);
            }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load breakdowns: {ex.Message}"); }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task Submit()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrEmpty(SelectedMachineName) || string.IsNullOrEmpty(BreakdownReason))
        {
            MessageBox.Show("Machine Name and Reason are required.");
            return;
        }

        var request = new CreateMachineBreakdownRequest(SelectedMachineName, BreakdownReason);

        try
        {
            // 1. Attempt to send to API
            await _apiClient.CreateBreakdownAsync(authToken, request);

            // 2. Success
            SelectedMachineName = null;
            BreakdownReason = string.Empty;

            // Delete the draft file because we succeeded
            if (File.Exists(DraftFileName)) File.Delete(DraftFileName);
            HasUnsavedDraft = false;

            IsPendingViewActive = true;
            MessageBox.Show("Report submitted successfully.", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception)
        {
            // 3. Failure (Network Error) - Save Draft
            try
            {
                var json = JsonSerializer.Serialize(request);
                await File.WriteAllTextAsync(DraftFileName, json);
                HasUnsavedDraft = true;

                MessageBox.Show(
                    "Connection failed.\n\n" +
                    "Don't worry! Your data has been safely saved as a draft.\n\n" +
                    "Please check your internet connection. When you are back online, simply click 'Submit Report' again.",
                    "Network Error - Draft Saved",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            catch (Exception fileEx)
            {
                MessageBox.Show($"Critical Error: Could not save draft. Data may be lost.\n{fileEx.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }

    [RelayCommand]
    private void ShowResolveFlyout(MachineBreakdownResponse breakdown)
    {
        SelectedBreakdownToResolve = breakdown;
        ResolutionNotes = string.Empty;
        IsResolveFlyoutOpen = true;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task ConfirmResolve()
    {
        if (SelectedBreakdownToResolve is null || string.IsNullOrWhiteSpace(ResolutionNotes))
        {
            MessageBox.Show("Resolution notes cannot be empty.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new ResolveBreakdownRequest(ResolutionNotes);
            await _apiClient.MarkBreakdownAsResolvedAsync(authToken, SelectedBreakdownToResolve.BreakdownID, request);
            PendingBreakdowns.Remove(SelectedBreakdownToResolve);
            IsResolveFlyoutOpen = false;
        }
        catch (Exception ex) { MessageBox.Show($"Failed to resolve breakdown: {ex.Message}"); }
    }

    [RelayCommand]
    private void ShowDeleteFlyout(MachineBreakdownResponse breakdown)
    {
        SelectedBreakdownToDelete = breakdown;
        DeactivationReason = string.Empty;
        IsDeleteFlyoutOpen = true;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task ConfirmDeactivation()
    {
        if (SelectedBreakdownToDelete is null || string.IsNullOrWhiteSpace(DeactivationReason))
        {
            MessageBox.Show("A reason is required for deactivation.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new DeactivateMachineBreakdownRequest(DeactivationReason);
            await _apiClient.DeactivateBreakdownAsync(authToken, SelectedBreakdownToDelete.BreakdownID, request);
            IsDeleteFlyoutOpen = false;
            await Search();
        }
        catch (ApiException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Forbidden ||
                ex.StatusCode == System.Net.HttpStatusCode.InternalServerError)
            {
                MessageBox.Show("You do not have permission to perform this action. Please contact an administrator.", "Authorization Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            else
            {
                MessageBox.Show($"An error occurred communicating with the server: {ex.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"An error occurred: {ex.Message}");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\MainViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.Services;
using Mirage.UI.Views;
using PortalMirage.Core.Dtos;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class MainViewModel : ObservableObject
{
    [ObservableProperty]
    private object? _currentView;

    [ObservableProperty]
    private NavigationItem? _selectedMenuItem;

    [ObservableProperty]
    private NavigationItem? _selectedOptionsMenuItem;

    private readonly Dictionary<Type, object> _viewModelInstances = new();
    private readonly IAuthService _authService;
    private readonly IInactivityService _inactivityService;

    public ObservableCollection<NavigationItem> MenuItems { get; } = new();
    public ObservableCollection<NavigationItem> OptionsMenuItems { get; } = new();

    [ObservableProperty]
    private UserResponse? _currentUser;

    public MainViewModel(
        IAuthService authService,
        IInactivityService inactivityService,
        DashboardViewModel dashboardViewModel,
        LogbooksViewModel logbooksViewModel,
        ReportsViewModel reportsViewModel,
        AdminViewModel adminViewModel,
        SettingsViewModel settingsViewModel,
        RepeatSampleViewModel repeatSampleViewModel,
        KitValidationViewModel kitValidationViewModel,
        CalibrationLogViewModel calibrationLogViewModel,
        SampleStorageViewModel sampleStorageViewModel,
        HandoverViewModel handoverViewModel,
        MachineBreakdownViewModel machineBreakdownViewModel,
        MediaSterilityViewModel mediaSterilityViewModel,
        DailyTaskLogViewModel dailyTaskLogViewModel)
    {
        // --- ADD THESE LINES AT THE TOP OF THE CONSTRUCTOR ---
        _authService = authService;
        _inactivityService = inactivityService;
        _inactivityService.OnInactive += Logout;
        // ----------------------------------------------------

        // Add ALL ViewModels to our dictionary
        _viewModelInstances.Add(typeof(DashboardViewModel), dashboardViewModel);
        _viewModelInstances.Add(typeof(LogbooksViewModel), logbooksViewModel);
        _viewModelInstances.Add(typeof(ReportsViewModel), reportsViewModel);
        _viewModelInstances.Add(typeof(AdminViewModel), adminViewModel);
        _viewModelInstances.Add(typeof(SettingsViewModel), settingsViewModel);
        _viewModelInstances.Add(typeof(RepeatSampleViewModel), repeatSampleViewModel);
        _viewModelInstances.Add(typeof(KitValidationViewModel), kitValidationViewModel);
        _viewModelInstances.Add(typeof(CalibrationLogViewModel), calibrationLogViewModel);
        _viewModelInstances.Add(typeof(SampleStorageViewModel), sampleStorageViewModel);
        _viewModelInstances.Add(typeof(HandoverViewModel), handoverViewModel);
        _viewModelInstances.Add(typeof(MachineBreakdownViewModel), machineBreakdownViewModel);
        _viewModelInstances.Add(typeof(MediaSterilityViewModel), mediaSterilityViewModel);
        _viewModelInstances.Add(typeof(DailyTaskLogViewModel), dailyTaskLogViewModel);

        // --- Menu Items ---
        // These emojis should be universally available
        MenuItems.Add(new NavigationItem("???", "Dashboard", typeof(DashboardViewModel)));
        MenuItems.Add(new NavigationItem("??", "Logbooks", typeof(LogbooksViewModel)));
        MenuItems.Add(new NavigationItem("??", "Reports", typeof(ReportsViewModel)));
        MenuItems.Add(new NavigationItem("??", "Admin", typeof(AdminViewModel)));

        OptionsMenuItems.Add(new NavigationItem("??", "Settings", typeof(SettingsViewModel)));

        SelectedMenuItem = MenuItems[0];
    }

    partial void OnSelectedMenuItemChanged(NavigationItem? value)
    {
        if (value != null)
        {
            SelectedOptionsMenuItem = null;
            NavigateToView(value);
        }
    }

    partial void OnSelectedOptionsMenuItemChanged(NavigationItem? value)
    {
        if (value != null)
        {
            SelectedMenuItem = null;
            NavigateToView(value);
        }
    }

    private void NavigateToView(NavigationItem item)
    {
        if (_viewModelInstances.TryGetValue(item.DestinationViewModel, out var vm))
        {
            var viewType = Type.GetType(item.DestinationViewModel.FullName!.Replace("ViewModel", "View"));
            if (viewType != null && Activator.CreateInstance(viewType) is FrameworkElement view)
            {
                view.DataContext = vm;
                CurrentView = view;

                if (vm is DashboardViewModel dvm)
                {
                    _ = dvm.LoadSummaryAsync();
                }
            }
        }
    }

    [RelayCommand]
    private void NavigateTo(Type? viewType)
    {
        if (viewType is null) return;

        // --- THIS IS THE CORRECTED LOGIC ---
        // It correctly converts "Mirage.UI.Views.HandoverView"
        // to "Mirage.UI.ViewModels.HandoverViewModel"
        // without the old bug.
        var tempName = viewType.FullName!.Replace(".Views.", ".ViewModels.");
        var viewModelTypeName = tempName.Substring(0, tempName.Length - "View".Length) + "ViewModel";
        // ------------------------------------

        var viewModelType = Type.GetType(viewModelTypeName);

        if (viewModelType != null && _viewModelInstances.TryGetValue(viewModelType, out var vm))
        {
            if (Activator.CreateInstance(viewType) is FrameworkElement view)
            {
                view.DataContext = vm;
                CurrentView = view;

                SelectedMenuItem = null;
                SelectedOptionsMenuItem = null;
            }
        }
    }

    private void Logout()
    {
        // Make sure we run this on the UI thread
        Application.Current.Dispatcher.Invoke(() =>
        {
            // 1. Stop the timer so it doesn't fire again
            _inactivityService.StopTimer();

            // 2. Clear the authentication token
            _authService.SetToken(null);

            // 3. Open a new login window
            var loginView = App.ServiceProvider?.GetRequiredService<LoginView>();
            loginView?.Show();

            // 4. Find and close the current main window
            var currentMainWindow = Application.Current.Windows.OfType<MainWindow>().FirstOrDefault();
            currentMainWindow?.Close();
        });
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\MasterListViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class MasterListViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    private List<AdminListItemDto> _allItems = new();
    public ObservableCollection<AdminListItemDto> FilteredItems { get; } = new();
    public ObservableCollection<string> ListTypes { get; } = new();

    [ObservableProperty]
    private AdminListItemDto? _selectedItem;
    [ObservableProperty]
    private string? _selectedListType;
    [ObservableProperty]
    private string _searchFilter = string.Empty;
    [ObservableProperty]
    private string _editItemValue = string.Empty;
    [ObservableProperty]
    private string? _editDescription;
    [ObservableProperty]
    private bool _isItemActive = true;
    [ObservableProperty]
    private bool _isEditing;

    public int ItemCount => FilteredItems.Count;

    public MasterListViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task LoadAllItemsAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var itemsTask = _apiClient.GetAllListItemsAsync(authToken);
            var typesTask = _apiClient.GetListTypesAsync(authToken);
            await System.Threading.Tasks.Task.WhenAll(itemsTask, typesTask);

            _allItems = await itemsTask;
            var types = await typesTask;

            ListTypes.Clear();
            foreach (var type in types.OrderBy(t => t))
                ListTypes.Add(type);

            if (SelectedListType is null)
                SelectedListType = ListTypes.FirstOrDefault();
            else
                ApplyFilters();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load lists: {ex.Message}");
        }
    }

    partial void OnSelectedListTypeChanged(string? value)
    {
        SearchFilter = string.Empty;
        ApplyFilters();
        NewItem();
    }

    partial void OnSearchFilterChanged(string value) => ApplyFilters();

    partial void OnSelectedItemChanged(AdminListItemDto? value)
    {
        if (value is not null)
        {
            IsEditing = true;
            EditItemValue = value.ItemValue;
            EditDescription = value.Description;
            IsItemActive = value.IsActive;
        }
        else
        {
            IsEditing = false;
        }
    }

    private void ApplyFilters()
    {
        if (SelectedListType is null) return;

        var filtered = _allItems.Where(i => i.ListType == SelectedListType);

        if (!string.IsNullOrWhiteSpace(SearchFilter))
        {
            filtered = filtered.Where(i =>
                i.ItemValue.Contains(SearchFilter, StringComparison.OrdinalIgnoreCase) ||
                 (i.Description != null && i.Description.Contains(SearchFilter, StringComparison.OrdinalIgnoreCase)));
        }

        FilteredItems.Clear();
        foreach (var item in filtered)
            FilteredItems.Add(item);

        OnPropertyChanged(nameof(ItemCount));
    }

    [RelayCommand]
    private void NewItem()
    {
        SelectedItem = null;
        IsEditing = true;
        EditItemValue = "New Item";
        EditDescription = string.Empty;
        IsItemActive = true;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task SaveItem()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrWhiteSpace(EditItemValue) || SelectedListType is null)
            return;

        try
        {
            if (SelectedItem is null) // Create new
            {
                var request = new CreateAdminListItemRequest(SelectedListType, EditItemValue, EditDescription);
                await _apiClient.CreateListItemAsync(authToken, request);
            }
            else // Update existing
            {
                var request = new UpdateAdminListItemRequest(SelectedItem.ItemID, EditItemValue, EditDescription, IsItemActive);
                await _apiClient.UpdateListItemAsync(authToken, SelectedItem.ItemID, request);
            }
            await LoadAllItemsAsync();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to save item: {ex.Message}");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\MediaSterilityViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class MediaSterilityViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    [ObservableProperty] private string? _selectedMediaName;
    [ObservableProperty] private string _mediaLotNumber = string.Empty;
    [ObservableProperty] private string? _mediaQuantity;
    [ObservableProperty] private string? _selectedResult37C;
    [ObservableProperty] private string? _selectedResult25C;
    [ObservableProperty] private string? _comments;
    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;

    // DRAFT CONFIGURATION
    private const string DraftFileName = "draft_mediasterility.json";
    [ObservableProperty] private bool _hasUnsavedDraft;

    public ObservableCollection<MediaSterilityCheckResponse> Logs { get; } = new();

    [ObservableProperty] private bool _isDeleteFlyoutOpen;
    [ObservableProperty] private MediaSterilityCheckResponse? _selectedLogToDelete;
    [ObservableProperty] private string _deactivationReason = string.Empty;

    public ObservableCollection<string> MediaNames { get; } = new();
    public ObservableCollection<string> GrowthResults { get; } = new() { "No Growth", "Growth Seen" };

    public MediaSterilityViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;

        MediaNames.Add("Blood Agar");
        MediaNames.Add("MacConkey Agar");
        MediaNames.Add("Chocolate Agar");

        // CHECK FOR DRAFT ON STARTUP
        if (File.Exists(DraftFileName))
        {
            try
            {
                var json = File.ReadAllText(DraftFileName);
                // Correct DTO name: CreateMediaSterilityCheckRequest
                var draft = JsonSerializer.Deserialize<CreateMediaSterilityCheckRequest>(json);

                if (draft != null)
                {
                    // Map the draft back to your form properties
                    SelectedMediaName = draft.MediaName;
                    MediaLotNumber = draft.MediaLotNumber;
                    MediaQuantity = draft.MediaQuantity;
                    SelectedResult37C = draft.Result37C;
                    SelectedResult25C = draft.Result25C;
                    Comments = draft.Comments;

                    HasUnsavedDraft = true;
                    MessageBox.Show("We found an unsaved sterility check and restored it.", "Draft Restored", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch
            {
                try { File.Delete(DraftFileName); }
                catch { }
            }
        }
    }

    [RelayCommand]
    private async Task LoadLogs()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var logs = await _apiClient.GetSterilityChecksAsync(authToken, StartDate, EndDate);
            Logs.Clear();
            foreach (var log in logs) Logs.Add(log);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load logs: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task Save()
    {
        var authToken = _authService.GetToken();

        // Validate required fields
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrEmpty(SelectedMediaName) || string.IsNullOrEmpty(MediaLotNumber) || string.IsNullOrEmpty(SelectedResult25C) || string.IsNullOrEmpty(SelectedResult37C))
        {
            MessageBox.Show("Media Name, Lot Number, and both Results are required.");
            return;
        }

        // Create Request using the correct DTO structure
        var request = new CreateMediaSterilityCheckRequest(
            SelectedMediaName,
            MediaLotNumber,
            MediaQuantity,
            SelectedResult37C,
            SelectedResult25C,
            Comments
        );

        try
        {
            // 1. Try API
            await _apiClient.CreateSterilityCheckAsync(authToken, request);

            // 2. Success
            Clear();
            if (File.Exists(DraftFileName)) File.Delete(DraftFileName);
            HasUnsavedDraft = false;

            await LoadLogs(); // Refresh list
            MessageBox.Show("Sterility record saved successfully.", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            // 3. Failure: Save Draft
            try
            {
                var json = JsonSerializer.Serialize(request);
                await File.WriteAllTextAsync(DraftFileName, json);
                HasUnsavedDraft = true;

                MessageBox.Show(
                    $"Connection failed: {ex.Message}\n\n" +
                    "This record has been saved as a draft.\n" +
                    "Please submit it again when the connection is restored.",
                    "Network Error - Draft Saved",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            catch (Exception fileEx)
            {
                MessageBox.Show($"Critical Error: Could not save draft.\n{fileEx.Message}", "Error");
            }
        }
    }

    [RelayCommand]
    private void Clear()
    {
        SelectedMediaName = null;
        MediaLotNumber = string.Empty;
        MediaQuantity = string.Empty;
        SelectedResult25C = null;
        SelectedResult37C = null;
        Comments = string.Empty;
    }

    [RelayCommand]
    private async Task ClearDraft()
    {
        try
        {
            if (File.Exists(DraftFileName))
            {
                File.Delete(DraftFileName);
                Clear();
                HasUnsavedDraft = false;
                MessageBox.Show("Draft cleared successfully.", "Draft Cleared", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to clear draft: {ex.Message}", "Error");
        }
    }

    [RelayCommand]
    private void ShowDeleteFlyout(MediaSterilityCheckResponse log)
    {
        SelectedLogToDelete = log;
        DeactivationReason = string.Empty;
        IsDeleteFlyoutOpen = true;
    }

    [RelayCommand]
    private async Task ConfirmDeactivation()
    {
        if (SelectedLogToDelete is null || string.IsNullOrWhiteSpace(DeactivationReason))
        {
            MessageBox.Show("A reason is required for deactivation.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new DeactivateMediaSterilityCheckRequest(DeactivationReason);
            await _apiClient.DeactivateSterilityCheckAsync(authToken, SelectedLogToDelete.SterilityCheckID, request);

            IsDeleteFlyoutOpen = false;
            await LoadLogs();
        }
        catch (ApiException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                MessageBox.Show("You do not have permission to perform this action. Please contact an administrator.", "Authorization Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            else { MessageBox.Show($"An error occurred communicating with the server: {ex.StatusCode}"); }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to deactivate entry: {ex.Message}"); }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\NavigationItem.cs
========================================
using System;

namespace Mirage.UI.ViewModels;

public record NavigationItem(string Icon, string Label, Type DestinationViewModel)
{
    // This helper property automatically finds the correct View that matches the ViewModel
    // e.g., DashboardViewModel -> DashboardView
    public Type ViewType => Type.GetType(DestinationViewModel.FullName!.Replace("ViewModel", "View"))!;
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\RepeatSampleViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PatientInfo.Api.Sdk;
using PatientInfo.Api.Sdk.Models;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class RepeatSampleViewModel : ObservableObject
{
    private readonly IPortalMirageApi _mirageApiClient;
    private readonly IPatientInfoApi _patientInfoApiClient;
    private readonly IAuthService _authService;

    [ObservableProperty] private string _patientIdCardNumber = string.Empty;
    [ObservableProperty] private string _patientName = string.Empty;
    [ObservableProperty] private string? _selectedReason;
    [ObservableProperty] private string? _informedPerson;
    [ObservableProperty] private string? _selectedDepartment;
    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;
    [ObservableProperty] private bool _isDeleteFlyoutOpen;
    [ObservableProperty] private RepeatSampleResponse? _selectedLogToDelete;
    [ObservableProperty] private string _deactivationReason = string.Empty;

    // DRAFT CONFIGURATION
    private const string DraftFileName = "draft_repeatsample.json";
    [ObservableProperty] private bool _hasUnsavedDraft;

    public ObservableCollection<RepeatSampleResponse> Logs { get; } = new();
    public ObservableCollection<string> Reasons { get; } = new();
    public ObservableCollection<string> Departments { get; } = new() { "OPD", "IPD" };

    public RepeatSampleViewModel(IPortalMirageApi mirageApiClient, IPatientInfoApi patientInfoApiClient, IAuthService authService)
    {
        _mirageApiClient = mirageApiClient;
        _patientInfoApiClient = patientInfoApiClient;
        _authService = authService;

        Reasons.Add("Hemolysis");
        Reasons.Add("Clotted");
        Reasons.Add("Insufficient Quantity");
        Reasons.Add("Instrument Error");

        // CHECK FOR DRAFT ON STARTUP
        if (File.Exists(DraftFileName))
        {
            try
            {
                var json = File.ReadAllText(DraftFileName);
                // Verify 'CreateRepeatSampleRequest' matches your actual DTO name
                var draft = JsonSerializer.Deserialize<CreateRepeatSampleRequest>(json);

                if (draft != null)
                {
                    // Map the draft back to your form properties
                    PatientIdCardNumber = draft.PatientIdCardNumber;
                    PatientName = draft.PatientName;
                    SelectedReason = draft.ReasonText; // Note: Your DTO uses ReasonText, not SelectedReason
                    InformedPerson = draft.InformedPerson;
                    SelectedDepartment = draft.Department;

                    HasUnsavedDraft = true;
                    MessageBox.Show("We found an unsaved repeat sample request and restored it.", "Draft Restored", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch
            {
                try { File.Delete(DraftFileName); }
                catch { }
            }
        }
    }

    [RelayCommand]
    private async Task FindPatient()
    {
        if (string.IsNullOrWhiteSpace(PatientIdCardNumber)) return;

        try
        {
            var nationalId = new NationalId(PatientIdCardNumber);
            var patient = await _patientInfoApiClient.GetByNationalIdAsync(nationalId);
            PatientName = patient?.PatientName ?? "Patient Not Found";
        }
        catch (Exception)
        {
            PatientName = "Error finding patient";
        }
    }

    [RelayCommand]
    private async Task LoadLogs()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var logs = await _mirageApiClient.GetRepeatSamplesAsync(authToken, StartDate, EndDate);
            Logs.Clear();
            foreach (var log in logs) Logs.Add(log);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load logs: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task Save()
    {
        var authToken = _authService.GetToken();

        // Validate required fields based on your DTO
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrEmpty(PatientIdCardNumber) || string.IsNullOrEmpty(PatientName) || PatientName == "Patient Not Found")
        {
            MessageBox.Show("A valid Patient ID and Name are required.");
            return;
        }

        // Create Request (Ensure order matches your DTO constructor)
        var request = new CreateRepeatSampleRequest(
            PatientIdCardNumber,
            PatientName,
            SelectedReason,  // Note: Your DTO constructor expects string? reasonText
            InformedPerson,
            SelectedDepartment
        );

        try
        {
            // 1. Try API
            await _mirageApiClient.CreateRepeatSampleAsync(authToken, request);

            // 2. Success - Clear Form
            Clear();
            if (File.Exists(DraftFileName)) File.Delete(DraftFileName);
            HasUnsavedDraft = false;

            await LoadLogs(); // Refresh list
            MessageBox.Show("Repeat sample request saved successfully.", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            // 3. Failure: Save Draft
            try
            {
                var json = JsonSerializer.Serialize(request);
                await File.WriteAllTextAsync(DraftFileName, json);
                HasUnsavedDraft = true;

                MessageBox.Show(
                    $"Connection failed: {ex.Message}\n\n" +
                    "This request has been saved as a draft.\n" +
                    "Please submit it again when the connection is restored.",
                    "Network Error - Draft Saved",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            catch (Exception fileEx)
            {
                MessageBox.Show($"Critical Error: Could not save draft.\n{fileEx.Message}", "Error");
            }
        }
    }

    [RelayCommand]
    private void Clear()
    {
        PatientIdCardNumber = string.Empty;
        PatientName = string.Empty;
        SelectedReason = null;
        InformedPerson = string.Empty;
        SelectedDepartment = null;
    }

    [RelayCommand]
    private async Task ClearDraft()
    {
        try
        {
            if (File.Exists(DraftFileName))
            {
                File.Delete(DraftFileName);
                Clear();
                HasUnsavedDraft = false;
                MessageBox.Show("Draft cleared successfully.", "Draft Cleared", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to clear draft: {ex.Message}", "Error");
        }
    }

    [RelayCommand]
    private void ShowDeleteFlyout(RepeatSampleResponse log)
    {
        SelectedLogToDelete = log;
        DeactivationReason = string.Empty;
        IsDeleteFlyoutOpen = true;
    }

    [RelayCommand]
    private async Task ConfirmDeactivation()
    {
        if (SelectedLogToDelete is null || string.IsNullOrWhiteSpace(DeactivationReason))
        {
            MessageBox.Show("A reason is required for deactivation.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new DeactivateRepeatSampleRequest(DeactivationReason);
            await _mirageApiClient.DeactivateRepeatSampleAsync(authToken, SelectedLogToDelete.RepeatID, request);
            IsDeleteFlyoutOpen = false;
            await LoadLogs();
        }
        catch (ApiException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                MessageBox.Show("You do not have permission to perform this action. Please contact an administrator.", "Authorization Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            else { MessageBox.Show($"An error occurred communicating with the server: {ex.StatusCode}"); }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to deactivate entry: {ex.Message}"); }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\ReportsViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Threading;

namespace Mirage.UI.ViewModels;

public record ShiftFilterItem(int Id, string Name);

public partial class ReportsViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;
    private readonly IPdfExportService _pdfExportService;
    private readonly DispatcherTimer _timer;

    [ObservableProperty] private string _selectedReport = "Machine Breakdowns";
    public ObservableCollection<string> AvailableReports { get; } = new() { "Machine Breakdowns", "Handover Summary", "Kit Validation Log", "Repeat Sample Log", "Daily Task Compliance", "Media Sterility Log", "Sample Storage Log", "Calibration Log" };
    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;
    [ObservableProperty] private bool _isLoading;

    // Machine Breakdown
    [ObservableProperty] private string? _selectedMachineName;
    [ObservableProperty] private string? _selectedBreakdownStatus = "All";
    public ObservableCollection<MachineBreakdownReportDto> MachineBreakdownReportData { get; } = new();
    public ObservableCollection<string> MachineNames { get; } = new();
    public ObservableCollection<string> BreakdownStatusOptions { get; } = new() { "All", "Pending", "Resolved" };

    // Handover
    [ObservableProperty] private string? _selectedShift;
    [ObservableProperty] private string? _selectedPriority;
    [ObservableProperty] private string? _selectedHandoverStatus = "All";
    public ObservableCollection<HandoverReportDto> HandoverReportData { get; } = new();
    public ObservableCollection<string> HandoverShiftOptions { get; } = new();
    public ObservableCollection<string> PriorityOptions { get; } = new() { "All", "Normal", "Urgent" };
    public ObservableCollection<string> HandoverStatusOptions { get; } = new() { "All", "Pending", "Received" };

    // Kit Validation
    [ObservableProperty] private string? _selectedKitName;
    [ObservableProperty] private string? _selectedKitStatus = "All";
    public ObservableCollection<KitValidationReportDto> KitValidationReportData { get; } = new();
    public ObservableCollection<string> KitNameOptions { get; } = new();
    public ObservableCollection<string> KitStatusOptions { get; } = new() { "All", "Accepted", "Rejected" };

    // Repeat Sample
    [ObservableProperty] private string? _selectedReason;
    [ObservableProperty] private string? _selectedDepartment;
    public ObservableCollection<RepeatSampleReportDto> RepeatSampleReportData { get; } = new();
    public ObservableCollection<string> ReasonOptions { get; } = new();
    public ObservableCollection<string> DepartmentOptions { get; } = new();

    // Daily Task Compliance
    [ObservableProperty] private ShiftFilterItem? _selectedTaskShift;
    [ObservableProperty] private string? _selectedTaskStatus = "All";
    public ObservableCollection<DailyTaskComplianceReportItemDto> DailyTaskReportData { get; } = new();
    public ObservableCollection<ShiftFilterItem> TaskShiftOptions { get; } = new();
    public ObservableCollection<string> TaskStatusOptions { get; } = new() { "All", "Pending", "Completed", "Incomplete", "Not Available" };
    [ObservableProperty] private int _totalTasks;
    [ObservableProperty] private int _completedTasks;
    public double CompletionPercentage => TotalTasks > 0 ? (double)CompletedTasks / TotalTasks * 100 : 0;

    // Media Sterility Report Properties
    [ObservableProperty] private string? _selectedMediaName;
    [ObservableProperty] private string? _selectedMediaStatus = "All";
    public ObservableCollection<MediaSterilityReportDto> MediaSterilityReportData { get; } = new();
    public ObservableCollection<string> MediaNameOptions { get; } = new();
    public ObservableCollection<string> MediaStatusOptions { get; } = new() { "All", "Passed", "Failed" };

    // Sample Storage Report Properties
    [ObservableProperty] private string? _selectedTestName;
    [ObservableProperty] private string? _selectedSampleStatus = "All";
    public ObservableCollection<SampleStorageReportDto> SampleStorageReportData { get; } = new();
    public ObservableCollection<string> TestNameOptions { get; } = new();
    public ObservableCollection<string> SampleStatusOptions { get; } = new() { "All", "Pending", "Test Done" };

    // Calibration Log Report Properties
    [ObservableProperty] private string? _selectedCalibrationTestName;
    [ObservableProperty] private string? _selectedQcResult = "All";
    public ObservableCollection<CalibrationReportDto> CalibrationReportData { get; } = new();
    public ObservableCollection<string> CalibrationTestNameOptions { get; } = new();
    public ObservableCollection<string> QcResultOptions { get; } = new() { "All", "Passed", "Failed" };

    public ReportsViewModel(IPortalMirageApi apiClient, IAuthService authService, IPdfExportService pdfExportService)
    {
        _apiClient = apiClient;
        _authService = authService;
        _pdfExportService = pdfExportService;

        // REMOVED: _ = LoadFilterOptionsAsync();

        _timer = new DispatcherTimer { Interval = TimeSpan.FromMinutes(1) };
        _timer.Tick += Timer_Tick;
        _timer.Start();
    }

    private void Timer_Tick(object? sender, EventArgs e)
    {
        foreach (var item in MachineBreakdownReportData.Where(b => !b.IsResolved))
        {
            item.UpdateCalculatedProperties();
        }
    }

    [RelayCommand] // <-- ADDED THIS ATTRIBUTE
    private async System.Threading.Tasks.Task LoadFilterOptionsAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var machineNameItems = await _apiClient.GetListItemsByTypeAsync(authToken, "MachineName");

            // REMOVED DEBUG LINES:
            // MessageBox.Show($"API returned {machineNameItems?.Count ?? 0} machine name items.", "Debug API Result");
            // MessageBox.Show($"MachineNames collection now has {MachineNames.Count} items.", "Debug Collection Count");

            MachineNames.Clear();
            MachineNames.Add("All"); // Ensure "All" is always first
            if (machineNameItems != null) // Add null check for safety
            {
                foreach (var item in machineNameItems)
                {
                    if (item.IsActive) // Only add active items
                    {
                        MachineNames.Add(item.ItemValue);
                    }
                }
            }

            var shiftItems = await _apiClient.GetAllShiftsAsync(authToken);
            HandoverShiftOptions.Clear();
            HandoverShiftOptions.Add("All");
            TaskShiftOptions.Clear();
            TaskShiftOptions.Add(new ShiftFilterItem(0, "All"));
            foreach (var shift in shiftItems)
            {
                HandoverShiftOptions.Add(shift.ShiftName);
                TaskShiftOptions.Add(new ShiftFilterItem(shift.ShiftID, shift.ShiftName));
            }

            PriorityOptions.Clear();
            PriorityOptions.Add("All");
            PriorityOptions.Add("Normal");
            PriorityOptions.Add("Urgent");

            var kitNameItems = await _apiClient.GetListItemsByTypeAsync(authToken, "KitName");
            KitNameOptions.Clear();
            KitNameOptions.Add("All");
            foreach (var item in kitNameItems)
                KitNameOptions.Add(item.ItemValue);

            var reasonItems = await _apiClient.GetListItemsByTypeAsync(authToken, "RepeatReason");
            ReasonOptions.Clear();
            ReasonOptions.Add("All");
            foreach (var item in reasonItems)
                ReasonOptions.Add(item.ItemValue);

            var departmentItems = await _apiClient.GetListItemsByTypeAsync(authToken, "Department");
            DepartmentOptions.Clear();
            DepartmentOptions.Add("All");
            foreach (var item in departmentItems)
                DepartmentOptions.Add(item.ItemValue);

            var mediaNameItems = await _apiClient.GetListItemsByTypeAsync(authToken, "MediaName");
            MediaNameOptions.Clear();
            MediaNameOptions.Add("All");
            foreach (var item in mediaNameItems)
                MediaNameOptions.Add(item.ItemValue);

            var testNameItems = await _apiClient.GetListItemsByTypeAsync(authToken, "TestName");
            TestNameOptions.Clear();
            TestNameOptions.Add("All");
            foreach (var item in testNameItems)
                TestNameOptions.Add(item.ItemValue);

            var calibrationTestNameItems = await _apiClient.GetListItemsByTypeAsync(authToken, "TestName");
            CalibrationTestNameOptions.Clear();
            CalibrationTestNameOptions.Add("All");
            foreach (var item in calibrationTestNameItems)
                CalibrationTestNameOptions.Add(item.ItemValue);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load filter options: {ex.Message}");
        }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task GenerateReport()
    {
        switch (SelectedReport)
        {
            case "Machine Breakdowns": await GenerateMachineBreakdownReport(); break;
            case "Handover Summary": await GenerateHandoverReport(); break;
            case "Kit Validation Log": await GenerateKitValidationReport(); break;
            case "Repeat Sample Log": await GenerateRepeatSampleReport(); break;
            case "Daily Task Compliance": await GenerateDailyTaskComplianceReport(); break;
            case "Media Sterility Log": await GenerateMediaSterilityReport(); break;
            case "Sample Storage Log": await GenerateSampleStorageReport(); break;
            case "Calibration Log": await GenerateCalibrationReport(); break;
        }
    }

    [RelayCommand]
    private void ClearFilters()
    {
        StartDate = DateTime.Today;
        EndDate = DateTime.Today;

        MachineBreakdownReportData.Clear();
        HandoverReportData.Clear();
        KitValidationReportData.Clear();
        RepeatSampleReportData.Clear();
        DailyTaskReportData.Clear();
        MediaSterilityReportData.Clear();
        SampleStorageReportData.Clear();
        CalibrationReportData.Clear();

        TotalTasks = 0;
        CompletedTasks = 0;
        OnPropertyChanged(nameof(CompletionPercentage));

        SelectedMachineName = "All";
        SelectedBreakdownStatus = "All";
        SelectedShift = "All";
        SelectedPriority = "All";
        SelectedHandoverStatus = "All";
        SelectedKitName = "All";
        SelectedKitStatus = "All";
        SelectedReason = "All";
        SelectedDepartment = "All";
        SelectedTaskShift = TaskShiftOptions.FirstOrDefault();
        SelectedTaskStatus = "All";
        SelectedMediaName = "All";
        SelectedMediaStatus = "All";
        SelectedTestName = "All";
        SelectedSampleStatus = "All";
        SelectedCalibrationTestName = "All";
        SelectedQcResult = "All";
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task PrintReport()
    {
        string reportTitle = SelectedReport;
        string[] headers;
        IEnumerable<object> items;

        // Use a switch to get the correct data and headers for the selected report
        switch (SelectedReport)
        {
            case "Machine Breakdowns":
                headers = new[] { "Reported On", "Machine", "Reason", "Reported By", "Is Resolved", "Resolved On", "Resolved By", "Resolution", "Downtime (Mins)", "Downtime" };
                items = MachineBreakdownReportData;
                break;

            case "Handover Summary":
                headers = new[] { "Given On", "Given By", "Shift", "Priority", "Notes", "Is Received", "Received On", "Received By" };
                items = HandoverReportData;
                break;

            case "Kit Validation Log":
                headers = new[] { "Validated On", "Kit Name", "Lot #", "Expiry", "Status", "Comments", "Validated By" };
                items = KitValidationReportData;
                break;

            case "Repeat Sample Log":
                headers = new[] { "Logged On", "Patient ID", "Patient Name", "Reason", "Department", "Informed", "Logged By" };
                items = RepeatSampleReportData;
                break;

            case "Daily Task Compliance":
                headers = new[] { "Date", "Task Name", "Shift", "Status", "Completed On", "Completed By", "Comments" };
                items = DailyTaskReportData;
                break;

            case "Media Sterility Log":
                headers = new[] { "Checked On", "Media Name", "Lot #", "Quantity", "Result 37C", "Result 25C", "Overall Status", "Comments", "Performed By" };
                items = MediaSterilityReportData;
                break;

            case "Sample Storage Log":
                headers = new[] { "Stored On", "Sample ID", "Test Name", "Stored By", "Is Test Done", "Completed On", "Completed By" };
                items = SampleStorageReportData;
                break;

            case "Calibration Log":
                headers = new[] { "Calibrated On", "Test/Instrument", "QC Result", "Reason", "Performed By" };
                items = CalibrationReportData;
                break;

            default:
                MessageBox.Show("Selected report is not recognized.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                return;
        }

        if (!items.Any())
        {
            MessageBox.Show("There is no data to export.", "Export Canceled", MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }

        await _pdfExportService.GenerateReportPdfAsync(reportTitle, headers, items);
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task ExportToCsv()
    {
        string reportTitle = SelectedReport;
        IEnumerable<object> items;

        // Use a switch to get the correct data collection for the selected report
        switch (SelectedReport)
        {
            case "Machine Breakdowns": items = MachineBreakdownReportData; break;
            case "Handover Summary": items = HandoverReportData; break;
            case "Kit Validation Log": items = KitValidationReportData; break;
            case "Repeat Sample Log": items = RepeatSampleReportData; break;
            case "Daily Task Compliance": items = DailyTaskReportData; break;
            case "Media Sterility Log": items = MediaSterilityReportData; break;
            case "Sample Storage Log": items = SampleStorageReportData; break;
            case "Calibration Log": items = CalibrationReportData; break;
            default:
                MessageBox.Show("Selected report is not recognized.", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                return;
        }

        if (!items.Any())
        {
            MessageBox.Show("There is no data to export.", "Export Canceled", MessageBoxButton.OK, MessageBoxImage.Information);
            return;
        }

        try
        {
            var csvBuilder = new StringBuilder();

            // Get properties from the first item to create the header row
            var properties = items.First().GetType().GetProperties();
            var headers = properties.Select(p => p.Name);
            csvBuilder.AppendLine(string.Join(",", headers));

            // Add the data rows
            foreach (var item in items)
            {
                var values = properties.Select(prop =>
                {
                    var value = prop.GetValue(item);
                    // Sanitize the value for CSV
                    var stringValue = value?.ToString() ?? "";
                    if (stringValue.Contains(',') || stringValue.Contains('"'))
                    {
                        return $"\"{stringValue.Replace("\"", "\"\"")}\"";
                    }
                    return stringValue;
                });
                csvBuilder.AppendLine(string.Join(",", values));
            }

            // Create the file path and save the file
            var today = DateTime.Today;
            var directoryPath = Path.Combine("C:", "MirageReports", today.ToString("yyyy"), today.ToString("MM"), today.ToString("dd"));
            Directory.CreateDirectory(directoryPath);

            var fileName = $"{reportTitle.Replace(' ', '_')}_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            var filePath = Path.Combine(directoryPath, fileName);

            await File.WriteAllTextAsync(filePath, csvBuilder.ToString());

            MessageBox.Show($"Successfully exported {items.Count()} records to:\n{filePath}", "Export Successful", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"An error occurred during export: {ex.Message}", "Export Error", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private async System.Threading.Tasks.Task GenerateMachineBreakdownReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate)
        {
            MessageBox.Show("The start date cannot be after the end date.", "Invalid Date Range", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        IsLoading = true;
        MachineBreakdownReportData.Clear();
        try
        {
            var machineNameFilter = SelectedMachineName == "All" ? null : SelectedMachineName;
            var statusFilter = SelectedBreakdownStatus == "All" ? null : SelectedBreakdownStatus;
            var reportData = await _apiClient.GetMachineBreakdownReportAsync(authToken, StartDate, EndDate, machineNameFilter, statusFilter);
            foreach (var item in reportData)
            {
                MachineBreakdownReportData.Add(item);
            }

            if (!MachineBreakdownReportData.Any())
            {
                MessageBox.Show("No records found for the selected criteria.", "Report Generated", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to generate report: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async System.Threading.Tasks.Task GenerateHandoverReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate)
        {
            MessageBox.Show("Start date cannot be after end date.", "Invalid Date Range");
            return;
        }

        IsLoading = true;
        HandoverReportData.Clear();
        try
        {
            var shiftFilter = SelectedShift == "All" ? null : SelectedShift;
            var priorityFilter = SelectedPriority == "All" ? null : SelectedPriority;
            var statusFilter = SelectedHandoverStatus == "All" ? null : SelectedHandoverStatus;
            var reportData = await _apiClient.GetHandoverReportAsync(authToken, StartDate, EndDate, shiftFilter, priorityFilter, statusFilter);
            foreach (var item in reportData) HandoverReportData.Add(item);
            if (!HandoverReportData.Any())
            {
                MessageBox.Show("No records found for the selected criteria.", "Report Generated");
            }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to generate report: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private async System.Threading.Tasks.Task GenerateKitValidationReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate)
        {
            MessageBox.Show("Start date cannot be after end date.", "Invalid Date Range");
            return;
        }

        IsLoading = true;
        KitValidationReportData.Clear();
        try
        {
            var kitNameFilter = SelectedKitName == "All" ? null : SelectedKitName;
            var statusFilter = SelectedKitStatus == "All" ? null : SelectedKitStatus;
            var reportData = await _apiClient.GetKitValidationReportAsync(authToken, StartDate, EndDate, kitNameFilter, statusFilter);
            foreach (var item in reportData) KitValidationReportData.Add(item);
            if (!KitValidationReportData.Any())
            {
                MessageBox.Show("No records found for the selected criteria.", "Report Generated");
            }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to generate report: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private async System.Threading.Tasks.Task GenerateRepeatSampleReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate)
        {
            MessageBox.Show("Start date cannot be after end date.", "Invalid Date Range");
            return;
        }

        IsLoading = true;
        RepeatSampleReportData.Clear();
        try
        {
            var reasonFilter = SelectedReason == "All" ? null : SelectedReason;
            var departmentFilter = SelectedDepartment == "All" ? null : SelectedDepartment;
            var reportData = await _apiClient.GetRepeatSampleReportAsync(authToken, StartDate, EndDate, reasonFilter, departmentFilter);
            foreach (var item in reportData) RepeatSampleReportData.Add(item);
            if (!RepeatSampleReportData.Any())
            {
                MessageBox.Show("No records found for the selected criteria.", "Report Generated");
            }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to generate report: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private async System.Threading.Tasks.Task GenerateDailyTaskComplianceReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate) { MessageBox.Show("Start date cannot be after end date."); return; }

        IsLoading = true;
        DailyTaskReportData.Clear();
        TotalTasks = 0;
        CompletedTasks = 0;
        try
        {
            var shiftIdFilter = SelectedTaskShift?.Id == 0 ? (int?)null : SelectedTaskShift?.Id;
            var statusFilter = SelectedTaskStatus == "All" ? null : SelectedTaskStatus;
            var reportData = await _apiClient.GetDailyTaskComplianceReportAsync(authToken, StartDate, EndDate, shiftIdFilter, statusFilter);
            foreach (var item in reportData.Items) DailyTaskReportData.Add(item);
            TotalTasks = reportData.TotalTasks;
            CompletedTasks = reportData.CompletedTasks;
            OnPropertyChanged(nameof(CompletionPercentage));

            if (!DailyTaskReportData.Any()) { MessageBox.Show("No records found for the selected criteria."); }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to generate report: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private async System.Threading.Tasks.Task GenerateMediaSterilityReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate) { MessageBox.Show("Start date cannot be after end date."); return; }

        IsLoading = true;
        MediaSterilityReportData.Clear();
        try
        {
            var mediaNameFilter = SelectedMediaName == "All" ? null : SelectedMediaName;
            var statusFilter = SelectedMediaStatus == "All" ? null : SelectedMediaStatus;
            var reportData = await _apiClient.GetMediaSterilityReportAsync(authToken, StartDate, EndDate, mediaNameFilter, statusFilter);
            foreach (var item in reportData) MediaSterilityReportData.Add(item);
            if (!MediaSterilityReportData.Any()) { MessageBox.Show("No records found for the selected criteria."); }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to generate report: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private async System.Threading.Tasks.Task GenerateSampleStorageReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate) { MessageBox.Show("Start date cannot be after end date."); return; }

        IsLoading = true;
        SampleStorageReportData.Clear();
        try
        {
            var testNameFilter = SelectedTestName == "All" ? null : SelectedTestName;
            var statusFilter = SelectedSampleStatus == "All" ? null : SelectedSampleStatus;
            var reportData = await _apiClient.GetSampleStorageReportAsync(authToken, StartDate, EndDate, testNameFilter, statusFilter);
            foreach (var item in reportData) SampleStorageReportData.Add(item);
            if (!SampleStorageReportData.Any()) { MessageBox.Show("No records found for the selected criteria."); }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to generate report: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private async System.Threading.Tasks.Task GenerateCalibrationReport()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (StartDate > EndDate) { MessageBox.Show("Start date cannot be after end date."); return; }

        IsLoading = true;
        CalibrationReportData.Clear();
        try
        {
            var testNameFilter = SelectedCalibrationTestName == "All" ? null : SelectedCalibrationTestName;
            var qcResultFilter = SelectedQcResult == "All" ? null : SelectedQcResult;
            var reportData = await _apiClient.GetCalibrationReportAsync(authToken, StartDate, EndDate, testNameFilter, qcResultFilter);
            foreach (var item in reportData) CalibrationReportData.Add(item);
            if (!CalibrationReportData.Any()) { MessageBox.Show("No records found for the selected criteria."); }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to generate report: {ex.Message}"); }
        finally { IsLoading = false; }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\SampleStorageViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class SampleStorageViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    [ObservableProperty] private string _newPatientSampleId = string.Empty;
    [ObservableProperty] private string _newTestName = string.Empty;
    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;

    // DRAFT CONFIGURATION
    private const string DraftFileName = "draft_samplestorage.json";
    [ObservableProperty] private bool _hasUnsavedDraft;

    private string _activeView = "Pending";
    public bool IsPendingViewActive
    {
        get => _activeView == "Pending";
        set
        {
            if (value && _activeView != "Pending")
            {
                _activeView = "Pending";
                OnPropertyChanged(nameof(IsPendingViewActive));
                OnPropertyChanged(nameof(IsCompletedViewActive));
                SearchCommand.Execute(null);
            }
        }
    }
    public bool IsCompletedViewActive
    {
        get => _activeView == "Completed";
        set
        {
            if (value && _activeView != "Completed")
            {
                _activeView = "Completed";
                OnPropertyChanged(nameof(IsPendingViewActive));
                OnPropertyChanged(nameof(IsCompletedViewActive));
                SearchCommand.Execute(null);
            }
        }
    }

    [ObservableProperty] private bool _isDeleteFlyoutOpen;
    [ObservableProperty] private SampleStorageResponse? _selectedSampleToDelete;
    [ObservableProperty] private string _deactivationReason = string.Empty;

    public ObservableCollection<SampleStorageResponse> PendingSamples { get; } = new();
    public ObservableCollection<SampleStorageResponse> CompletedSamples { get; } = new();

    public SampleStorageViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;

        // CHECK FOR DRAFT ON STARTUP
        if (File.Exists(DraftFileName))
        {
            try
            {
                var json = File.ReadAllText(DraftFileName);
                var draft = JsonSerializer.Deserialize<CreateSampleStorageRequest>(json);

                if (draft != null)
                {
                    // Map the draft back to your form properties
                    NewPatientSampleId = draft.PatientSampleID;
                    NewTestName = draft.TestName;

                    HasUnsavedDraft = true;
                    MessageBox.Show("We found an unsaved sample entry and restored it.", "Draft Restored", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch
            {
                try { File.Delete(DraftFileName); }
                catch { }
            }
        }
    }

    [RelayCommand]
    private async Task Search()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        if (_activeView == "Pending")
        {
            try
            {
                var samples = await _apiClient.GetPendingSamplesAsync(authToken, StartDate, EndDate);
                PendingSamples.Clear();
                foreach (var sample in samples) PendingSamples.Add(sample);
            }
            catch (Exception ex) { MessageBox.Show($"Failed to load pending samples: {ex.Message}"); }
        }
        else // Completed
        {
            try
            {
                var samples = await _apiClient.GetCompletedSamplesAsync(authToken, StartDate, EndDate);
                CompletedSamples.Clear();
                foreach (var sample in samples) CompletedSamples.Add(sample);
            }
            catch (Exception ex) { MessageBox.Show($"Failed to load completed samples: {ex.Message}"); }
        }
    }

    [RelayCommand]
    private async Task Add()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrEmpty(NewPatientSampleId) || string.IsNullOrEmpty(NewTestName))
        {
            MessageBox.Show("Patient Sample ID and Test Name are required.");
            return;
        }

        // Create the Request Object
        var request = new CreateSampleStorageRequest(NewPatientSampleId, NewTestName);

        try
        {
            // 1. Try API
            await _apiClient.CreateSampleAsync(authToken, request);

            // 2. Success: Clear Form & Delete Draft
            NewPatientSampleId = string.Empty;
            NewTestName = string.Empty;
            if (File.Exists(DraftFileName)) File.Delete(DraftFileName);
            HasUnsavedDraft = false;

            await Search(); // Refresh the list
            MessageBox.Show("Sample added successfully.", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            // 3. Failure: Save Draft
            try
            {
                var json = JsonSerializer.Serialize(request);
                await File.WriteAllTextAsync(DraftFileName, json);
                HasUnsavedDraft = true;

                MessageBox.Show(
                    $"Connection failed: {ex.Message}\n\n" +
                    "Your entry has been saved as a draft.\n" +
                    "Click 'Add' again when the connection is restored.",
                    "Network Error - Draft Saved",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            catch (Exception fileEx)
            {
                MessageBox.Show($"Critical Error: Could not save draft.\n{fileEx.Message}", "Error");
            }
        }
    }

    [RelayCommand]
    private async Task MarkAsDone(int storageId)
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            await _apiClient.MarkSampleAsDoneAsync(authToken, storageId);
            var itemToRemove = PendingSamples.FirstOrDefault(s => s.StorageID == storageId);
            if (itemToRemove != null)
            {
                PendingSamples.Remove(itemToRemove);
            }
        }
        catch (Exception ex) { MessageBox.Show($"Failed to mark as done: {ex.Message}"); }
    }

    [RelayCommand]
    private void ShowDeleteFlyout(SampleStorageResponse sample)
    {
        SelectedSampleToDelete = sample;
        DeactivationReason = string.Empty;
        IsDeleteFlyoutOpen = true;
    }

    [RelayCommand]
    private async Task ConfirmDeactivation()
    {
        if (SelectedSampleToDelete is null || string.IsNullOrWhiteSpace(DeactivationReason))
        {
            MessageBox.Show("A reason is required for deletion.");
            return;
        }

        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new DeactivateSampleStorageRequest(DeactivationReason);
            await _apiClient.DeactivateSampleAsync(authToken, SelectedSampleToDelete.StorageID, request);

            IsDeleteFlyoutOpen = false;
            await Search();
        }
        catch (ApiException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                MessageBox.Show("You do not have permission to perform this action. Please contact an administrator.", "Authorization Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
            else
            {
                MessageBox.Show($"An error occurred communicating with the server: {ex.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"An error occurred: {ex.Message}");
        }
    }

    [RelayCommand]
    private void ClearDraft()
    {
        try
        {
            if (File.Exists(DraftFileName))
            {
                File.Delete(DraftFileName);
                NewPatientSampleId = string.Empty;
                NewTestName = string.Empty;
                HasUnsavedDraft = false;
                MessageBox.Show("Draft cleared successfully.", "Draft Cleared", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to clear draft: {ex.Message}", "Error");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\SettingsViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using ControlzEx.Theming;
using MahApps.Metro.Theming;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using System.Windows.Media;
using Mirage.UI.Properties;

namespace Mirage.UI.ViewModels;

// We create a simple helper record to display the color names and their visual swatch in the UI.
public record AccentColor(string Name, Brush ColorBrush);

public partial class SettingsViewModel : ObservableObject
{
    [ObservableProperty]
    private AccentColor? _selectedAccent;

    [ObservableProperty]
    private string? _selectedTheme;

    public ObservableCollection<AccentColor> AccentColors { get; }
    public List<string> AppThemes { get; } = new() { "Light", "Dark" };

    public SettingsViewModel()
    {
        // Populate the list of available accent colors from the MahApps ThemeManager
        AccentColors = new ObservableCollection<AccentColor>(
            ThemeManager.Current.Themes
                .GroupBy(x => x.ColorScheme)
                .OrderBy(a => a.Key)
                .Select(a => new AccentColor(a.Key, a.First().ShowcaseBrush))
        );

        // Detect the application's current theme and set the properties so the UI is in sync
        var currentTheme = ThemeManager.Current.DetectTheme(Application.Current);
        if (currentTheme != null)
        {
            _selectedTheme = currentTheme.BaseColorScheme;
            _selectedAccent = AccentColors.FirstOrDefault(a => a.Name == currentTheme.ColorScheme);
        }
    }

    // This method is automatically called by the MVVM Toolkit when the SelectedAccent property changes.
    partial void OnSelectedAccentChanged(AccentColor? value)
    {
        if (value != null)
        {
            // Get the current theme and apply the new accent color
            var currentTheme = ThemeManager.Current.DetectTheme(Application.Current);
            if (currentTheme != null)
            {
                ThemeManager.Current.ChangeTheme(Application.Current, $"{currentTheme.BaseColorScheme}.{value.Name}");
            }
        }
    }

    // This property gets and sets the font size directly from the application settings
    public double AppFontSize
    {
        get => Properties.Settings.Default.AppFontSize;
        set
        {
            if (Properties.Settings.Default.AppFontSize != value)
            {
                Properties.Settings.Default.AppFontSize = value;
                OnPropertyChanged(); // Notify the UI that the value has changed
                Properties.Settings.Default.Save(); // Save the setting to disk
            }
        }
    }

    // This method is automatically called when the SelectedTheme property changes.
    partial void OnSelectedThemeChanged(string? value)
    {
        if (!string.IsNullOrEmpty(value))
        {
            // Get the current theme and apply the new base theme (Light/Dark)
            var currentTheme = ThemeManager.Current.DetectTheme(Application.Current);
            if (currentTheme != null)
            {
                ThemeManager.Current.ChangeTheme(Application.Current, $"{value}.{currentTheme.ColorScheme}");
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\ShiftManagementViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class ShiftManagementViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    public ObservableCollection<ShiftResponse> Shifts { get; } = new();

    [ObservableProperty]
    private ShiftResponse? _selectedShift;

    [ObservableProperty]
    private string _editShiftName = string.Empty;
    [ObservableProperty]
    private DateTime? _editStartTime;
    [ObservableProperty]
    private DateTime? _editEndTime;
    [ObservableProperty]
    private int _editGracePeriodHours;
    [ObservableProperty]
    private bool _isEditing;

    public ShiftManagementViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
        LoadShifts();
    }

    private async void LoadShifts() => await LoadShiftsAsync();

    [RelayCommand]
    private async System.Threading.Tasks.Task LoadShiftsAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var shifts = await _apiClient.GetAllShiftsAsync(authToken);
            Shifts.Clear();
            foreach (var shift in shifts) Shifts.Add(shift);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load shifts: {ex.Message}"); }
    }

    partial void OnSelectedShiftChanged(ShiftResponse? value)
    {
        if (value is not null)
        {
            IsEditing = true;
            EditShiftName = value.ShiftName;
            EditStartTime = DateTime.Today.Add(value.StartTime.ToTimeSpan());
            EditEndTime = DateTime.Today.Add(value.EndTime.ToTimeSpan());
            EditGracePeriodHours = value.GracePeriodHours;
        }
        else
        {
            IsEditing = false;
        }
    }

    [RelayCommand]
    private void NewShift()
    {
        SelectedShift = null;
        IsEditing = true;
        EditShiftName = "New Shift";
        EditStartTime = DateTime.Today.Add(new TimeSpan(8, 0, 0));
        EditEndTime = DateTime.Today.Add(new TimeSpan(16, 0, 0));
        EditGracePeriodHours = 2;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task SaveShift()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken) || string.IsNullOrWhiteSpace(EditShiftName))
        {
            MessageBox.Show("Shift Name cannot be empty.");
            return;
        }

        if (EditStartTime is null || EditEndTime is null)
        {
            MessageBox.Show("Start Time and End Time must be set.");
            return;
        }

        try
        {
            var startTime = TimeOnly.FromTimeSpan(EditStartTime.Value.TimeOfDay);
            var endTime = TimeOnly.FromTimeSpan(EditEndTime.Value.TimeOfDay);

            if (SelectedShift is null) // Creating a new shift
            {
                var request = new CreateShiftRequest(EditShiftName, startTime, endTime, EditGracePeriodHours);
                await _apiClient.CreateShiftAsync(authToken, request);
            }
            else // Updating an existing shift
            {
                var request = new UpdateShiftRequest(SelectedShift.ShiftID, EditShiftName, startTime, endTime, EditGracePeriodHours, true);
                await _apiClient.UpdateShiftAsync(authToken, SelectedShift.ShiftID, request);
            }

            IsEditing = false;
            SelectedShift = null;
            await LoadShiftsAsync();
        }
        catch (Exception ex) { MessageBox.Show($"Failed to save shift: {ex.Message}"); }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task DeleteShift()
    {
        var authToken = _authService.GetToken();
        if (SelectedShift is null || string.IsNullOrEmpty(authToken)) return;

        if (MessageBox.Show($"Are you sure you want to deactivate the '{SelectedShift.ShiftName}' shift?", "Confirm Deactivation", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
        {
            return;
        }

        try
        {
            await _apiClient.DeactivateShiftAsync(authToken, SelectedShift.ShiftID);
            await LoadShiftsAsync();
        }
        catch (Exception ex) { MessageBox.Show($"Failed to deactivate shift: {ex.Message}"); }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\SystemSettingsViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using System;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class SystemSettingsViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;
    private int _settingId; // To store the ID for updates

    [ObservableProperty]
    private int _inactivityTimeoutMinutes;

    public SystemSettingsViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task LoadSettingsAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var setting = await _apiClient.GetSettingAsync(authToken, "InactivityTimeoutMinutes");
            if (int.TryParse(setting.Description, out int timeout))
            {
                InactivityTimeoutMinutes = timeout;
                _settingId = setting.ItemID;
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load system settings: {ex.Message}", "Error");
        }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task SaveSettingsAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new UpdateAdminListItemRequest(_settingId, "InactivityTimeoutMinutes", InactivityTimeoutMinutes.ToString(), true);
            await _apiClient.UpdateListItemAsync(authToken, _settingId, request);
            MessageBox.Show("Settings saved successfully!", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to save settings: {ex.Message}", "Error");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\TaskManagementViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models; // This contains your TaskModel and Shift
using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class TaskManagementViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    // Collections for UI Binding
    public ObservableCollection<TaskModel> Tasks { get; } = new();
    public ObservableCollection<ShiftResponse> Shifts { get; } = new();

    public ObservableCollection<string> ScheduleTypes { get; } = new() { "Daily", "Weekly", "Monthly" };
    public ObservableCollection<string> DaysOfWeek { get; } = new()
    {
        "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"
    };

    // Form Properties
    [ObservableProperty]
    private string _newTaskName = string.Empty;

    [ObservableProperty]
    private ShiftResponse? _selectedShift;

    [ObservableProperty]
    private string _selectedScheduleType = "Daily";

    [ObservableProperty]
    private string? _scheduleValue; // Stores "Monday" or "15" (day of month)

    public TaskManagementViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;

        // Load data immediately upon creation
        _ = LoadDataAsync();
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task LoadDataAsync()
    {
        var token = _authService.GetToken();
        if (string.IsNullOrEmpty(token)) return;

        try
        {
            // Load Tasks and Shifts in parallel
            var tasksTask = _apiClient.GetAllTasksAsync(token);
            var shiftsTask = _apiClient.GetAllShiftsAsync(token);

            await System.Threading.Tasks.Task.WhenAll(tasksTask, shiftsTask);

            // Update UI Lists
            Tasks.Clear();
            foreach (var t in await tasksTask) Tasks.Add(t);

            Shifts.Clear();
            foreach (var s in await shiftsTask) Shifts.Add(s);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Error loading data: {ex.Message}");
        }
    }


    [RelayCommand]
    private async Task DeleteTask(TaskModel task)
    {
        if (task == null) return;

        var confirm = MessageBox.Show($"Are you sure you want to delete '{task.TaskName}'?",
                                      "Confirm Delete", MessageBoxButton.YesNo, MessageBoxImage.Warning);

        if (confirm == MessageBoxResult.Yes)
        {
            var token = _authService.GetToken();
            if (string.IsNullOrEmpty(token)) return;

            try
            {
                await _apiClient.DeactivateTaskAsync(token, task.TaskID);
                await LoadDataAsync(); // Refresh list
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Failed to delete task: {ex.Message}");
            }
        }
    }


    [RelayCommand]
    private async System.Threading.Tasks.Task SaveTask()
    {
        if (string.IsNullOrWhiteSpace(NewTaskName))
        {
            MessageBox.Show("Task Name is required.");
            return;
        }

        if (SelectedShift == null)
        {
            MessageBox.Show("Please select a Shift.");
            return;
        }

        var token = _authService.GetToken();
        if (string.IsNullOrEmpty(token)) return;

        try
        {
            // Create object based on PortalMirage.Core.Models.TaskModel
            var newTask = new TaskModel
            {
                TaskID = 0, // DB handles ID
                TaskName = NewTaskName,
                ShiftID = SelectedShift.ShiftID,
                ScheduleType = SelectedScheduleType,
                ScheduleValue = ScheduleValue,
                IsActive = true
            };

            await _apiClient.CreateTaskAsync(token, newTask);

            // Clear inputs
            NewTaskName = string.Empty;
            ScheduleValue = null;

            // Refresh list
            await LoadDataAsync();
            MessageBox.Show("Task created successfully!");
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to create task: {ex.Message}");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\ViewModels\UserManagementViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.ViewModels;

public partial class UserManagementViewModel : ObservableObject
{
    private readonly IPortalMirageApi _apiClient;
    private readonly IAuthService _authService;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(CanAssignRole))]
    [NotifyPropertyChangedFor(nameof(CanManageSelectedUser))]
    [NotifyCanExecuteChangedFor(nameof(AssignRoleCommand))]
    [NotifyCanExecuteChangedFor(nameof(ResetPasswordCommand))]
    private UserResponse? _selectedUser;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(CanAssignRole))]
    [NotifyCanExecuteChangedFor(nameof(AssignRoleCommand))]
    private RoleResponse? _selectedRoleToAssign;

    [ObservableProperty]
    private bool _isCreateUserFlyoutOpen;
    [ObservableProperty]
    private string _newUsername = string.Empty;
    [ObservableProperty]
    private string _newFullName = string.Empty;
    [ObservableProperty]
    private bool _isManageRolesFlyoutOpen;
    [ObservableProperty]
    private string _newRoleName = string.Empty;
    [ObservableProperty]
    private bool _isResetPasswordFlyoutOpen;

    public bool CanAssignRole => SelectedUser is not null && SelectedRoleToAssign is not null;
    public bool CanManageSelectedUser => SelectedUser is not null;

    public ObservableCollection<UserResponse> Users { get; } = new();
    public ObservableCollection<RoleResponse> AllRoles { get; } = new();
    public ObservableCollection<RoleResponse> SelectedUserRoles { get; } = new();

    public UserManagementViewModel(IPortalMirageApi apiClient, IAuthService authService)
    {
        _apiClient = apiClient;
        _authService = authService;
        _ = LoadDataAsync();
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task LoadDataAsync()
    {
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var users = await _apiClient.GetAllUsersAsync(authToken);
            Users.Clear();
            foreach (var user in users) Users.Add(user);

            var roles = await _apiClient.GetAllRolesAsync(authToken);
            AllRoles.Clear();
            foreach (var role in roles) AllRoles.Add(role);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load data: {ex.Message}");
        }
    }

    partial void OnSelectedUserChanged(UserResponse? value)
    {
        _ = LoadRolesForSelectedUserAsync();
    }

    private async System.Threading.Tasks.Task LoadRolesForSelectedUserAsync()
    {
        SelectedUserRoles.Clear();
        var authToken = _authService.GetToken();
        if (SelectedUser is null || string.IsNullOrEmpty(authToken)) return;

        try
        {
            var roles = await _apiClient.GetRolesForUserAsync(authToken, SelectedUser.Username);
            foreach (var role in roles) SelectedUserRoles.Add(role);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load roles for user: {ex.Message}");
        }
    }

    [RelayCommand(CanExecute = nameof(CanAssignRole))]
    private async System.Threading.Tasks.Task AssignRole()
    {
        var authToken = _authService.GetToken();
        if (SelectedUser is null || SelectedRoleToAssign is null || string.IsNullOrEmpty(authToken)) return;

        if (SelectedUserRoles.Any(r => r.RoleID == SelectedRoleToAssign.RoleID))
        {
            MessageBox.Show("User already has this role.");
            return;
        }
        try
        {
            var request = new AssignRoleRequest(SelectedUser.Username, SelectedRoleToAssign.RoleName);
            await _apiClient.AssignRoleAsync(authToken, request);
            await LoadRolesForSelectedUserAsync();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to assign role: {ex.Message}");
        }
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task RemoveRole(RoleResponse roleToRemove)
    {
        var authToken = _authService.GetToken();
        if (SelectedUser is null || roleToRemove is null || string.IsNullOrEmpty(authToken)) return;

        if (MessageBox.Show($"Are you sure you want to remove the '{roleToRemove.RoleName}' role from {SelectedUser.Username}?", "Confirm Removal", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No) return;

        try
        {
            var request = new AssignRoleRequest(SelectedUser.Username, roleToRemove.RoleName);
            await _apiClient.RemoveRoleFromUserAsync(authToken, request);
            await LoadRolesForSelectedUserAsync();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to remove role: {ex.Message}");
        }
    }

    [RelayCommand]
    private void CreateUser()
    {
        if (IsCreateUserFlyoutOpen)
        {
            IsCreateUserFlyoutOpen = false;
            return;
        }
        IsManageRolesFlyoutOpen = false;
        IsResetPasswordFlyoutOpen = false;
        NewUsername = string.Empty;
        NewFullName = string.Empty;
        IsCreateUserFlyoutOpen = true;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task ManageRoles()
    {
        if (IsManageRolesFlyoutOpen)
        {
            IsManageRolesFlyoutOpen = false;
            return;
        }
        IsCreateUserFlyoutOpen = false;
        IsResetPasswordFlyoutOpen = false;
        await LoadDataAsync();
        IsManageRolesFlyoutOpen = true;
    }

    [RelayCommand(CanExecute = nameof(CanManageSelectedUser))]
    private void ResetPassword()
    {
        if (IsResetPasswordFlyoutOpen)
        {
            IsResetPasswordFlyoutOpen = false;
            return;
        }
        IsCreateUserFlyoutOpen = false;
        IsManageRolesFlyoutOpen = false;
        IsResetPasswordFlyoutOpen = true;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task SaveNewUser(object parameter)
    {
        if (parameter is not PasswordBox passwordBox) return;
        var password = passwordBox.Password;
        var authToken = _authService.GetToken();

        if (string.IsNullOrEmpty(authToken) || string.IsNullOrWhiteSpace(NewUsername) || string.IsNullOrWhiteSpace(password) || string.IsNullOrWhiteSpace(NewFullName))
        {
            ShowMessageBox("Username, Password, and Full Name are all required.", "Missing Information", MessageBoxImage.Warning);
            return;
        }

        try
        {
            var request = new CreateUserRequest(NewUsername, password, NewFullName);
            await _apiClient.CreateUserAsync(authToken, request);

            IsCreateUserFlyoutOpen = false;
            await LoadDataAsync();
            ShowMessageBox($"User '{NewUsername}' created successfully!", "Success", MessageBoxImage.Information);
            passwordBox.Password = string.Empty;
        }
        catch (ApiException ex)
        {
            ShowMessageBox($"Failed to create user. The server responded with: {ex.StatusCode}. The username may already be taken.", "API Error", MessageBoxImage.Error);
        }
        catch (Exception ex)
        {
            ShowMessageBox($"An unexpected error occurred: {ex.Message}", "Error", MessageBoxImage.Error);
        }
    }

    [RelayCommand]
    private void CancelCreateUser()
    {
        IsCreateUserFlyoutOpen = false;
        NewUsername = string.Empty;
        NewFullName = string.Empty;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task CreateNewRole()
    {
        if (string.IsNullOrWhiteSpace(NewRoleName))
        {
            MessageBox.Show("Role name cannot be empty.", "Missing Information");
            return;
        }
        var authToken = _authService.GetToken();
        if (string.IsNullOrEmpty(authToken)) return;

        try
        {
            var request = new CreateRoleRequest(NewRoleName);
            var newRole = await _apiClient.CreateRoleAsync(authToken, request);
            AllRoles.Add(newRole);
            NewRoleName = string.Empty;
            MessageBox.Show($"Role '{newRole.RoleName}' created successfully!", "Success", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (ApiException ex)
        {
            MessageBox.Show($"Failed to create role. The server responded with: {ex.StatusCode}. The role may already exist.", "API Error");
        }
        catch (Exception ex)
        {
            MessageBox.Show($"An unexpected error occurred: {ex.Message}", "Error");
        }
    }

    [RelayCommand]
    private void CancelManageRoles()
    {
        IsManageRolesFlyoutOpen = false;
        NewRoleName = string.Empty;
    }

    [RelayCommand]
    private async System.Threading.Tasks.Task ConfirmResetPassword(object parameter)
    {
        if (parameter is not PasswordBox passwordBox) return;
        var newPassword = passwordBox.Password;
        var authToken = _authService.GetToken();

        if (SelectedUser is null || string.IsNullOrWhiteSpace(newPassword) || string.IsNullOrEmpty(authToken))
        {
            ShowMessageBox("Please enter a new password.", "Missing Information", MessageBoxImage.Warning);
            return;
        }

        try
        {
            var request = new ResetPasswordRequest(SelectedUser.Username, newPassword);
            await _apiClient.ResetPasswordAsync(authToken, request);
            IsResetPasswordFlyoutOpen = false;
            ShowMessageBox($"Password for {SelectedUser.Username} has been reset successfully.", "Success", MessageBoxImage.Information);
            passwordBox.Password = string.Empty;
        }
        catch (Exception ex)
        {
            ShowMessageBox($"Failed to reset password: {ex.Message}", "Error", MessageBoxImage.Error);
        }
    }

    [RelayCommand]
    private void CancelResetPassword()
    {
        IsResetPasswordFlyoutOpen = false;
    }

    private void ShowMessageBox(string message, string caption, MessageBoxImage image)
    {
        MessageBox.Show(message, caption, MessageBoxButton.OK, image);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\AdminView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.AdminView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:views="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">

    <UserControl.Resources>
        <!-- DataTemplates for proper MVVM View-ViewModel association -->
        <DataTemplate DataType="{x:Type viewModels:UserManagementViewModel}">
            <views:UserManagementView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:ShiftManagementViewModel}">
            <views:ShiftManagementView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:MasterListViewModel}">
            <views:MasterListView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:AuditLogViewModel}">
            <views:AuditLogView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:SystemSettingsViewModel}">
            <views:SystemSettingsView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type viewModels:TaskManagementViewModel}">
            <views:TaskManagementView />
        </DataTemplate>

        <!-- Nice styling from old code -->
        <Style x:Key="CompactTabItem" TargetType="TabItem" BasedOn="{StaticResource MahApps.Styles.TabItem}">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="16,10"/>
            <Setter Property="Margin" Value="1,0"/>
            <Setter Property="MinWidth" Value="0"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
    </UserControl.Resources>

    <Grid Margin="12">
        <Border Background="{DynamicResource MahApps.Brushes.ThemeBackground}" 
                CornerRadius="6" 
                Effect="{DynamicResource MahApps.Effects.DropShadow}">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header from old code -->
                <Border Grid.Row="0" 
                        Background="{DynamicResource MahApps.Brushes.Control.Background}"
                        CornerRadius="6,6,0,0"
                        BorderThickness="0,0,0,1"
                        BorderBrush="{DynamicResource MahApps.Brushes.Gray7}">
                    <StackPanel Orientation="Horizontal" Margin="15,8">
                        <TextBlock Text="Administration" 
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource MahApps.Brushes.Accent}"
                                   VerticalAlignment="Center"/>
                        <Rectangle Width="1" 
                                   Height="20" 
                                   Margin="15,0" 
                                   Fill="{DynamicResource MahApps.Brushes.Gray7}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="Manage system settings and configurations" 
                                   FontSize="12"
                                   Foreground="{DynamicResource MahApps.Brushes.Gray}"
                                   VerticalAlignment="Center"
                                   FontStyle="Italic"/>
                    </StackPanel>
                </Border>

                <!-- Dynamic tabs from new code -->
                <TabControl Grid.Row="1"
                            ItemsSource="{Binding TabItems}"
                            SelectedItem="{Binding SelectedTab}"
                            Style="{StaticResource MahApps.Styles.TabControl}"
                            TabStripPlacement="Top"
                            mah:TabControlHelper.UnderlineBrush="{DynamicResource MahApps.Brushes.Accent}"
                            mah:TabControlHelper.UnderlineSelectedBrush="{DynamicResource MahApps.Brushes.Accent3}"
                            mah:TabControlHelper.UnderlinePlacement="Bottom">

                    <TabControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Icon}"
                                           FontSize="16"
                                           VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <TextBlock Text="{Binding Header}" 
                                           FontSize="14" 
                                           FontWeight="SemiBold" 
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </DataTemplate>
                    </TabControl.ItemTemplate>

                    <TabControl.ContentTemplate>
                        <DataTemplate>
                            <ContentPresenter Content="{Binding ViewModel}" Margin="8" />
                        </DataTemplate>
                    </TabControl.ContentTemplate>
                </TabControl>
            </Grid>
        </Border>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\AdminView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for AdminView.xaml
    /// </summary>
    public partial class AdminView : UserControl
    {
        public AdminView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\AuditLogView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.AuditLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:converters="clr-namespace:Mirage.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1100"
             Loaded="AuditLogView_OnLoaded">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <Style x:Key="WrapTextDataGridStyle" TargetType="TextBlock">
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Padding" Value="5"/>
        </Style>
    </UserControl.Resources>

    <Grid Margin="15">
        <mah:ProgressRing IsActive="{Binding IsLoading}" Panel.ZIndex="1"/>

        <DockPanel Visibility="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">

            <TextBlock DockPanel.Dock="Top" Text="Audit Trail" FontSize="24" FontWeight="Light" Margin="0,0,0,15"/>

            <Border DockPanel.Dock="Top" Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Content="Last 7 Days" Command="{Binding LoadLogsCommand}" CommandParameter="week" Style="{DynamicResource MahApps.Styles.Button.Square.Accent}" Margin="0,0,5,0"/>
                        <Button Content="Today" Command="{Binding LoadLogsCommand}" CommandParameter="today" Style="{DynamicResource MahApps.Styles.Button.Square}" Margin="0,0,5,0"/>
                        <Button Content="Last 30 Days" Command="{Binding LoadLogsCommand}" CommandParameter="month" Style="{DynamicResource MahApps.Styles.Button.Square}" Margin="0,0,5,0"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0,0,0">
                        <TextBlock Text="Custom Range:" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,0,10,0"/>
                        <DatePicker SelectedDate="{Binding StartDate}" mah:TextBoxHelper.Watermark="Start Date" />
                        <TextBlock Text="-" VerticalAlignment="Center" Margin="8,0"/>
                        <DatePicker SelectedDate="{Binding EndDate}" mah:TextBoxHelper.Watermark="End Date" />
                        <Button Content="Search" Command="{Binding LoadLogsCommand}" CommandParameter="{x:Null}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="10,0,0,0" />
                    </StackPanel>

                    <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                        <ComboBox ItemsSource="{Binding AvailableModules}" SelectedItem="{Binding SelectedModule}" Width="160" mah:TextBoxHelper.Watermark="Filter by Module" Margin="0,0,5,0"/>
                        <ComboBox ItemsSource="{Binding AvailableActions}" SelectedItem="{Binding SelectedAction}" Width="130" mah:TextBoxHelper.Watermark="Filter by Action" Margin="0,0,5,0"/>
                        <Button Content="Clear" Command="{Binding ClearFiltersCommand}" ToolTip="Clear Filters" />

                        <Button Content="Export to CSV" 
                                Command="{Binding ExportToCsvCommand}" 
                                ToolTip="Export current view to CSV"
                                Style="{DynamicResource MahApps.Styles.Button}"
                                Margin="5,0,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>

            <DataGrid ItemsSource="{Binding Logs}"
                      IsReadOnly="True"
                      AutoGenerateColumns="False"
                      GridLinesVisibility="Horizontal"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      RowStyle="{StaticResource StandardDataGridRowStyle}" Visibility="{Binding HasNoResults, Converter={StaticResource InverseBooleanConverter}}">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Timestamp" Binding="{Binding Timestamp, StringFormat='dd/MMM/yy HH:mm'}" Width="1.2*" SortDirection="Descending"/>
                    <DataGridTextColumn Header="User" Binding="{Binding UserFullName, FallbackValue='System'}" Width="1*" />
                    <DataGridTextColumn Header="Module" Binding="{Binding ModuleName}" Width="1*" />
                    <DataGridTextColumn Header="Action" Binding="{Binding ActionType}" Width="1*" />
                    <DataGridTextColumn Header="Record ID" Binding="{Binding RecordID}" Width="0.8*" />
                    <DataGridTextColumn Header="Details" Binding="{Binding NewValue}" Width="3*" ElementStyle="{StaticResource WrapTextDataGridStyle}" />
                </DataGrid.Columns>
            </DataGrid>

            <TextBlock Text="No audit logs found for the selected criteria." 
                       HorizontalAlignment="Center" 
                       VerticalAlignment="Center"
                       FontSize="16"
                       FontStyle="Italic"
                       Foreground="{DynamicResource MahApps.Brushes.Gray5}"
                       Visibility="{Binding HasNoResults, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        </DockPanel>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\AuditLogView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class AuditLogView : UserControl
    {
        public AuditLogView()
        {
            InitializeComponent();
            // This line explicitly gets the shared AuditLogViewModel and sets it.
            this.DataContext = App.ServiceProvider?.GetRequiredService<AuditLogViewModel>();
        }

        private void AuditLogView_OnLoaded(object sender, RoutedEventArgs e)
        {
            // When the view loads, we get the ViewModel and execute the command.
            if (this.DataContext is AuditLogViewModel viewModel && viewModel.LoadLogsCommand.CanExecute("week"))
            {
                viewModel.LoadLogsCommand.Execute("week");
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\CalibrationLogView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.CalibrationLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="CalibrationLogView_OnLoaded">


    <Grid>
        <Grid Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Margin="0,0,20,0">
                <TextBlock Text="Calibration Log" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

                <Label Content="Test / Instrument Name"/>
                <ComboBox Margin="0,0,0,10" 
                          ItemsSource="{Binding TestNames}"
                          SelectedItem="{Binding SelectedTestName}"/>

                <Label Content="QC Result"/>
                <ComboBox Margin="0,0,0,10" 
                          ItemsSource="{Binding QcResults}"
                          SelectedItem="{Binding SelectedQcResult}"/>

                <Label Content="Reason / Comments (Optional)"/>
                <TextBox Margin="0,0,0,20" Height="100" TextWrapping="Wrap" AcceptsReturn="True"
                         Text="{Binding Reason}"/>

                <StackPanel Orientation="Horizontal">
                    <Button Content="Save" Width="100" Command="{Binding SaveCommand}"
                            Style="{DynamicResource MahApps.Styles.Button.Accent}"/>

                    <Button Content="Clear" Width="100" Margin="10,0,0,0" Command="{Binding ClearCommand}"/>
                </StackPanel>
            </StackPanel>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                    <DatePicker SelectedDate="{Binding StartDate}"/>
                    <Label Content="to" Margin="5,0"/>
                    <DatePicker SelectedDate="{Binding EndDate}"/>
                    <Button Content="Search" Margin="10,0,0,0" Command="{Binding LoadLogsCommand}"/>
                </StackPanel>

                <DataGrid Grid.Row="1" ItemsSource="{Binding Logs}" AutoGenerateColumns="False" IsReadOnly="True" AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Date &amp; Time" Binding="{Binding CalibrationDateTime, StringFormat='g'}" Width="*"/>
                        <DataGridTextColumn Header="Test Name" Binding="{Binding TestName}" Width="2*"/>
                        <DataGridTextColumn Header="Result" Binding="{Binding QcResult}" Width="*"/>
                        <DataGridTextColumn Header="Performed By" Binding="{Binding PerformedByUsername}" Width="*"/>

                        <DataGridTemplateColumn Header="Actions" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Delete" Background="IndianRed" Foreground="White"
                                            Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <mah:FlyoutsControl>
            <mah:Flyout Header="Confirm Deactivation" IsOpen="{Binding IsDeleteFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="Please provide a reason for deleting this entry. This action will be permanently recorded in the audit log." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Label Content="Reason for Deactivation"/>
                    <TextBox Text="{Binding DeactivationReason}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Deactivation" Command="{Binding ConfirmDeactivationCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Background="IndianRed"/>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>

        <!-- Save Status Badge -->
        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                CornerRadius="4" Padding="8,4" Margin="20"
                Opacity="0.6" Effect="{DynamicResource MahApps.Effects.DropShadow}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#E8F5E9"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="?? All Saved"/>
                            <Setter Property="Foreground" Value="#2E7D32"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                    <Setter Property="Text" Value="?? Unsaved Draft"/>
                                    <Setter Property="Foreground" Value="#E65100"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\CalibrationLogView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class CalibrationLogView : UserControl
    {
        public CalibrationLogView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<CalibrationLogViewModel>();
        }

        private void CalibrationLogView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is CalibrationLogViewModel viewModel && viewModel.LoadLogsCommand.CanExecute(null))
            {
                viewModel.LoadLogsCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\DailyTaskLogView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.DailyTaskLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:converters="clr-namespace:Mirage.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1000"
             Loaded="DailyTaskLogView_OnLoaded">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <DataTemplate x:Key="TaskItemTemplate">
            <Border BorderBrush="LightGray" BorderThickness="0,0,0,1" Padding="5">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <CheckBox Grid.Column="0" 
                              VerticalAlignment="Center"
                              IsChecked="{Binding IsChecked, Mode=TwoWay}">
                        <CheckBox.Style>
                            <Style TargetType="CheckBox" BasedOn="{StaticResource MahApps.Styles.CheckBox}">
                                <Setter Property="ToolTip">
                                    <Setter.Value>
                                        <MultiBinding StringFormat="Status: {0}">
                                            <Binding Path="Dto.Status"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="IsChecked" Value="False"/>
                                        <Setter Property="Opacity" Value="0.5"/>
                                        <Setter Property="Background" Value="LightGray"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="IsChecked" Value="False"/>
                                        <Setter Property="Opacity" Value="0.5"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Completed">
                                        <Setter Property="Foreground" Value="Green"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </CheckBox.Style>
                    </CheckBox>

                    <TextBlock Grid.Column="1" Text="{Binding TaskName}" VerticalAlignment="Center" Margin="10,0" TextWrapping="Wrap">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="ToolTip" Value="{Binding TaskName}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Setter Property="FontStyle" Value="Italic"/>
                                        <Setter Property="ToolTip" Value="Marked as Not Available"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="Foreground" Value="DarkRed"/>
                                        <Setter Property="ToolTip" Value="Task incomplete - deadline passed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Completed">
                                        <Setter Property="Foreground" Value="Green"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                        <Setter Property="ToolTip" Value="Task completed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Pending">
                                        <Setter Property="Foreground" Value="DarkBlue"/>
                                        <Setter Property="ToolTip" Value="Task pending"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <Button Grid.Column="2" Content="N/A" FontSize="10" Padding="5,2"
                            Command="{Binding DataContext.ShowNaFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding Dto}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Completed">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Daily Task Log" FontSize="36" FontWeight="Light" Margin="0,0,0,10"/>

            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,20">
                <DatePicker SelectedDate="{Binding SelectedDate}" 
                            Width="150" 
                            Margin="0,0,10,0"/>

                <Button Content="GET TASKS" 
                        Command="{Binding LoadTasksCommand}" 
                        Style="{StaticResource MahApps.Styles.Button.Square.Accent}"
                        Margin="0,0,10,0"/>

                <Button Content="SAVE CHANGES" 
                        Command="{Binding SaveChangesCommand}" 
                        Background="Green" 
                        Foreground="White" 
                        FontWeight="Bold"
                        Margin="20,0,0,0">
                    <Button.ContentTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                <ProgressBar Width="20" Height="20" Margin="5,0,0,0"
                                             IsIndeterminate="True"
                                             Visibility="{Binding DataContext.IsSaving, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>
                        </DataTemplate>
                    </Button.ContentTemplate>
                </Button>
            </StackPanel>

            <Border Grid.Row="2" 
                    Background="#40000000" 
                    Visibility="{Binding IsSaving, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Panel.ZIndex="100"
                    IsHitTestVisible="False">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <mah:ProgressRing Width="50" Height="50" 
                                      IsActive="True" 
                                      Foreground="White"/>
                    <TextBlock Text="Saving changes..." 
                               Foreground="White" 
                               FontSize="14" 
                               Margin="0,10,0,0"/>
                </StackPanel>
            </Border>

            <TabControl Grid.Row="2" mah:TabControlHelper.Underlined="TabItems">
                <TabItem Header="Morning Tasks" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding MorningTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>

                <TabItem Header="Evening Tasks" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding EveningTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>

                <TabItem Header="Night Tasks" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding NightTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
        </Grid>

        <mah:FlyoutsControl>
            <mah:Flyout Header="Reason for N/A" IsOpen="{Binding IsNaFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="{Binding SelectedTaskForNa.TaskName}" FontWeight="Bold" FontSize="18" Margin="0,0,0,10" TextWrapping="Wrap"/>

                    <Label Content="Reason"/>

                    <TextBox x:Name="NaReasonBox"
                             Text="{Binding NaReason, UpdateSourceTrigger=PropertyChanged}" 
                             Height="150" 
                             TextWrapping="Wrap" 
                             AcceptsReturn="True" 
                             VerticalScrollBarVisibility="Auto" 
                             Margin="0,0,0,5"/>

                    <TextBlock Text="{Binding Text.Length, ElementName=NaReasonBox, StringFormat='{}{0}/500 characters'}" 
                               HorizontalAlignment="Right" 
                               FontSize="10" 
                               Foreground="Gray" 
                               Margin="0,0,0,10"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancel" Margin="0,0,10,0" 
                                Command="{Binding DataContext.CloseNaFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>

                        <Button Content="Confirm N/A" Command="{Binding ConfirmNaCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        <ProgressBar Width="16" Height="16" Margin="5,0,0,0"
                                                     IsIndeterminate="True"
                                                     Visibility="{Binding DataContext.IsSavingNa, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\DailyTaskLogView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class DailyTaskLogView : UserControl
    {
        public DailyTaskLogView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<DailyTaskLogViewModel>();
        }

        private void DailyTaskLogView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is DailyTaskLogViewModel viewModel && viewModel.LoadTasksCommand.CanExecute(null))
            {
                // This now uses the CORRECT command name: LoadTasksCommand
                viewModel.LoadTasksCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\DashboardView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:converters="clr-namespace:Mirage.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">

    

    <UserControl.Resources>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:StringIsNullOrEmptyToVisibilityConverter x:Key="StringIsNullOrEmptyToVisibilityConverter"/>

        <Style x:Key="ModernCardStyle" TargetType="Button">
            <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Gray8}" />
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="15"/>
            <Setter Property="MinWidth" Value="240"/>
            <Setter Property="MinHeight" Value="180"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="12"
                                SnapsToDevicePixels="True">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="4" Direction="270" Opacity="0.15" BlurRadius="12" RenderingBias="Quality"/>
                            </Border.Effect>

                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="{DynamicResource MahApps.Brushes.ThemeBackground.Color}" Offset="0"/>
                                    <GradientStop Color="{DynamicResource MahApps.Brushes.Gray8.Color}" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>

                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <ContentPresenter Grid.Row="0" 
                                                  HorizontalAlignment="Stretch" 
                                                  VerticalAlignment="Center"
                                                  Margin="0,10,0,5"/>

                                <Border Grid.Row="1" Background="#10000000" CornerRadius="0,0,8,8" 
                                        Height="30" Margin="-1,0,-1,-1">
                                    <TextBlock Text="View Details" 
                                               Foreground="{DynamicResource MahApps.Brushes.Gray5}"
                                               FontSize="11" 
                                               FontWeight="SemiBold"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Border>
                            </Grid>
                        </Border>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Accent}"/>
                                <Setter TargetName="border" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect ShadowDepth="6" Direction="270" Opacity="0.2" BlurRadius="15"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="border" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="1.02" ScaleY="1.02"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="border" Property="RenderTransformOrigin" Value="0.5,0.5"/>
                            </Trigger>

                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.98" ScaleY="0.98"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Centered Text Styles -->
        <Style x:Key="CountTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="48"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Text}"/>
        </Style>

        <Style x:Key="LabelTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Gray6}"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>
    </UserControl.Resources>

    <Grid Margin="25">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,20">
            <TextBlock Text="&#xE80F;" 
                       FontFamily="Segoe MDL2 Assets" 
                       FontSize="28" 
                       Foreground="{DynamicResource MahApps.Brushes.Accent}"
                       VerticalAlignment="Center"
                       Margin="0,0,12,0"/>
            <TextBlock Text="Dashboard Overview" 
                       FontSize="24" 
                       FontWeight="Light" 
                       VerticalAlignment="Center"/>
        </StackPanel>

        <mah:ProgressRing Grid.Row="1" 
                          IsActive="{Binding IsLoading}" 
                          Panel.ZIndex="1"
                          Width="50" 
                          Height="50"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>

        <!-- Dashboard Cards -->
        <ItemsControl Grid.Row="1" 
                      ItemsSource="{Binding DashboardItems}"
                      Visibility="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Button Style="{StaticResource ModernCardStyle}"
                            Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                            CommandParameter="{Binding TargetView}">
                        <StackPanel VerticalAlignment="Center">
                            <Border Width="40" 
                                    Height="40" 
                                    CornerRadius="20" 
                                    Background="{Binding AccentColor}" 
                                    Margin="0,0,0,15">
                                <TextBlock Text="{Binding Icon}" 
                                           FontFamily="Segoe MDL2 Assets" 
                                           FontSize="18" 
                                           Foreground="White"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                            <TextBlock Text="{Binding Count}" Style="{StaticResource CountTextStyle}"/>
                            <TextBlock Text="{Binding Label}" Style="{StaticResource LabelTextStyle}" Margin="0,5,0,0"/>
                        </StackPanel>
                    </Button>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\DashboardView.xaml.cs
========================================
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class DashboardView : UserControl
    {
        public DashboardView()
        {
            InitializeComponent();
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\HandoverView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.HandoverView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="HandoverView_OnLoaded">


    <UserControl.Resources>
        <Style x:Key="StandardActionButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
            <Setter Property="mah:ControlsHelper.CornerRadius" Value="3"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#B0BEC5"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="2" Direction="270" Color="#CCCCCC" Opacity="0.4" BlurRadius="4"/>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="HandoverRowStyle" TargetType="DataGridRow" BasedOn="{StaticResource MahApps.Styles.DataGridRow}">
            <Style.Triggers>
                <Trigger Property="AlternationIndex" Value="1">
                    <Setter Property="Background" Value="#F9FAFB"/>
                </Trigger>

                <DataTrigger Binding="{Binding Priority}" Value="Urgent">
                    <Setter Property="Background" Value="#FFCDD2"/>
                    <Setter Property="Foreground" Value="#B71C1C"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>

                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsMouseOver, RelativeSource={RelativeSource Self}}" Value="True"/>
                        <Condition Binding="{Binding Priority}" Value="Normal"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="#E0F2F7"/>
                    <Setter Property="Foreground" Value="Black"/>
                </MultiDataTrigger>

                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsMouseOver, RelativeSource={RelativeSource Self}}" Value="True"/>
                        <Condition Binding="{Binding Priority}" Value="Urgent"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="#E57373"/>
                    <Setter Property="Foreground" Value="White"/>
                </MultiDataTrigger>

                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource Self}}" Value="True"/>
                        <Condition Binding="{Binding Priority}" Value="Normal"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Accent}" />
                    <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.IdealForegroundColor}" />
                </MultiDataTrigger>

                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource Self}}" Value="True"/>
                        <Condition Binding="{Binding Priority}" Value="Urgent"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="#C62828" />
                    <Setter Property="Foreground" Value="White" />
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Margin="0,0,20,0">
                <TextBlock Text="Handover Book" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>
                <Label Content="Priority"/>
                <ComboBox ItemsSource="{Binding Priorities}" SelectedItem="{Binding SelectedPriority}" Margin="0,0,0,10"/>
                <Label Content="Shift"/>
                <ComboBox ItemsSource="{Binding Shifts}" SelectedItem="{Binding SelectedShift}" Margin="0,0,0,10"/>
                <Label Content="New Handover Notes"/>
                <TextBox Text="{Binding NewHandoverNotes}" Height="200" 
                         TextWrapping="Wrap" AcceptsReturn="True" 
                         Margin="0,0,0,10" VerticalScrollBarVisibility="Auto"/>
                <Button Content="Submit Handover" Style="{StaticResource StandardActionButtonStyle}" Command="{Binding SubmitCommand}"/>
            </StackPanel>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <TextBlock Grid.Row="0" Text="Handovers" FontSize="24" FontWeight="Light" Margin="0,0,0,10"/>

                <Grid Grid.Row="1" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <RadioButton Content="Pending" GroupName="ViewToggle" 
                                     IsChecked="{Binding IsPendingViewActive, Mode=TwoWay}"
                                     Style="{StaticResource MahApps.Styles.ToggleButton}"/>
                        <RadioButton Content="Completed" GroupName="ViewToggle" 
                                     IsChecked="{Binding IsCompletedViewActive, Mode=TwoWay}"
                                     Style="{StaticResource MahApps.Styles.ToggleButton}" Margin="5,0,0,0"/>
                    </StackPanel>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                        <DatePicker SelectedDate="{Binding StartDate}"/>
                        <Label Content="to" Margin="5,0"/>
                        <DatePicker SelectedDate="{Binding EndDate}"/>
                        <Button Content="Search" Margin="10,0,0,0" Command="{Binding SearchCommand}"/>
                    </StackPanel>
                </Grid>

                <DataGrid Grid.Row="2" 
                          ItemsSource="{Binding PendingHandovers}" 
                          RowStyle="{StaticResource HandoverRowStyle}" 
                          AutoGenerateColumns="False" 
                          IsReadOnly="True" 
                          AlternationCount="2">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsPendingViewActive}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Given On" Binding="{Binding GivenDateTime, StringFormat='g'}" Width="*"/>
                        <DataGridTextColumn Header="Given By" Binding="{Binding GivenByUsername}" Width="*"/>
                        <DataGridTextColumn Header="Shift" Binding="{Binding Shift}" Width="Auto"/>
                        <DataGridTemplateColumn Header="Notes" Width="3*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding HandoverNotes}" TextWrapping="Wrap" Padding="5"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Actions" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <Button Content="Receive" Margin="0,0,5,0"
                                                Command="{Binding DataContext.ReceiveCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding HandoverID}"/>
                                        <Button Content="Delete" Background="IndianRed" Foreground="White"
                                                Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <DataGrid Grid.Row="2" 
                          ItemsSource="{Binding CompletedHandovers}" 
                          RowStyle="{StaticResource HandoverRowStyle}" 
                          AutoGenerateColumns="False" 
                          IsReadOnly="True" 
                          AlternationCount="2">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsCompletedViewActive}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Given On" Binding="{Binding GivenDateTime, StringFormat='g'}" Width="*"/>
                        <DataGridTextColumn Header="Given By" Binding="{Binding GivenByUsername}" Width="*"/>
                        <DataGridTextColumn Header="Received On" Binding="{Binding ReceivedDateTime, StringFormat='g'}" Width="*"/>
                        <DataGridTextColumn Header="Received By" Binding="{Binding ReceivedByUsername}" Width="*"/>
                        <DataGridTemplateColumn Header="Notes" Width="3*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding HandoverNotes}" TextWrapping="Wrap" Padding="5"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Actions" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Delete" Background="IndianRed" Foreground="White"
                                            Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                CornerRadius="4" Padding="8,4" Margin="20"
                Opacity="0.6" Effect="{DynamicResource MahApps.Effects.DropShadow}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#E8F5E9"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="?? All Saved"/>
                            <Setter Property="Foreground" Value="#2E7D32"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                    <Setter Property="Text" Value="?? Unsaved Draft"/>
                                    <Setter Property="Foreground" Value="#E65100"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>

        <mah:FlyoutsControl>
            <mah:Flyout Header="Confirm Deactivation" IsOpen="{Binding IsDeleteFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="Please provide a reason for deactivating this handover. This action will be permanently recorded in the audit log." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Label Content="Reason for Deactivation"/>
                    <TextBox Text="{Binding DeactivationReason}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Deactivation" Command="{Binding ConfirmDeactivationCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Background="IndianRed"/>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\HandoverView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class HandoverView : UserControl
    {
        public HandoverView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<HandoverViewModel>();
        }

        private void HandoverView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is HandoverViewModel viewModel && viewModel.SearchCommand.CanExecute(null))
            {
                viewModel.SearchCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\KitValidationView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.KitValidationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="KitValidationView_OnLoaded">

    <UserControl.Resources>
        <Style x:Key="StandardActionButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
            <Setter Property="mah:ControlsHelper.CornerRadius" Value="3"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#B0BEC5"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="2" Direction="270" Color="#CCCCCC" Opacity="0.4" BlurRadius="4"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#ECEFF1"/>
                    <Setter Property="BorderBrush" Value="#90A4AE"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#CFD8DC"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Margin="0,0,20,0">
                <TextBlock Text="Kit Validation" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

                <Label Content="Kit Name"/>
                <TextBox Margin="0,0,0,10" Text="{Binding KitName}"/>

                <Label Content="Lot Number"/>
                <TextBox Margin="0,0,0,10" Text="{Binding KitLotNumber}"/>

                <Label Content="Expiry Date"/>
                <DatePicker Margin="0,0,0,10" SelectedDate="{Binding KitExpiryDate}"/>

                <Label Content="Validation Status"/>
                <ComboBox Margin="0,0,0,10" ItemsSource="{Binding ValidationStatuses}" SelectedItem="{Binding SelectedValidationStatus}"/>

                <Label Content="Comments (Optional)"/>
                <TextBox Margin="0,0,0,20" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Text="{Binding Comments}"/>

                <StackPanel Orientation="Horizontal">
                    <Button Content="Save" Width="100" Style="{StaticResource StandardActionButtonStyle}" Command="{Binding SaveCommand}"/>
                    <Button Content="Clear" Width="100" Margin="10,0,0,0" Style="{StaticResource StandardActionButtonStyle}" Command="{Binding ClearCommand}"/>
                </StackPanel>
            </StackPanel>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                    <DatePicker SelectedDate="{Binding StartDate}"/>
                    <Label Content="to" Margin="5,0"/>
                    <DatePicker SelectedDate="{Binding EndDate}"/>
                    <Button Content="Search" Margin="10,0,0,0" Command="{Binding LoadLogsCommand}"/>
                </StackPanel>

                <DataGrid Grid.Row="1" ItemsSource="{Binding Logs}" AutoGenerateColumns="False" IsReadOnly="True"
                          AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Validated On" Binding="{Binding ValidationDateTime, StringFormat='g'}" Width="*"/>
                        <DataGridTextColumn Header="Kit Name" Binding="{Binding KitName}" Width="2*"/>
                        <DataGridTextColumn Header="Lot Number" Binding="{Binding KitLotNumber}" Width="*"/>
                        <DataGridTextColumn Header="Expiry" Binding="{Binding KitExpiryDate, StringFormat='d'}" Width="*"/>
                        <DataGridTextColumn Header="Status" Binding="{Binding ValidationStatus}" Width="*"/>
                        <DataGridTextColumn Header="Validated By" Binding="{Binding ValidatedByUsername}" Width="*"/>

                        <DataGridTemplateColumn Header="Actions" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Delete" Background="IndianRed" Foreground="White"
                                            Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <mah:FlyoutsControl>
            <mah:Flyout Header="Confirm Deactivation" IsOpen="{Binding IsDeleteFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="Please provide a reason for deleting this entry. This action will be permanently recorded in the audit log." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Label Content="Reason for Deactivation"/>
                    <TextBox Text="{Binding DeactivationReason}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Deactivation" Command="{Binding ConfirmDeactivationCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Background="IndianRed"/>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>

        <!-- Save Status Badge -->
        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                CornerRadius="4" Padding="8,4" Margin="20"
                Opacity="0.6" Effect="{DynamicResource MahApps.Effects.DropShadow}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#E8F5E9"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="?? All Saved"/>
                            <Setter Property="Foreground" Value="#2E7D32"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                    <Setter Property="Text" Value="?? Unsaved Draft"/>
                                    <Setter Property="Foreground" Value="#E65100"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\KitValidationView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class KitValidationView : UserControl
    {
        public KitValidationView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<KitValidationViewModel>();
        }

        private void KitValidationView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is KitValidationViewModel viewModel && viewModel.LoadLogsCommand.CanExecute(null))
            {
                viewModel.LoadLogsCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\LogbooksView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.LogbooksView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:fa="http://schemas.fontawesome.io/icons/"
             xmlns:views="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">

    <UserControl.Resources>
        <Style x:Key="LogbookTileButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
            <Setter Property="Background" Value="#E0F2F7"/>
            <Setter Property="Foreground" Value="#333333"/>
            <Setter Property="BorderBrush" Value="#B2EBF2"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="5">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Direction="270" Color="#CCCCCC" Opacity="0.6" BlurRadius="4"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#B3E5FC"/>
                    <Setter Property="BorderBrush" Value="#81D4FA"/>
                    <Setter Property="mah:ControlsHelper.ContentCharacterCasing" Value="Normal"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#81D4FA"/>
                    <Setter Property="BorderBrush" Value="#4FC3F7"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Logbooks" FontSize="36" FontWeight="Light" Margin="0,0,0,20" Foreground="#333333"/>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <UniformGrid Columns="4" Rows="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:RepeatSampleView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Repeat Sample" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:KitValidationView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Kit Validation" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:CalibrationLogView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Calibration Log" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:SampleStorageView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Sample Storage" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:HandoverView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Handover Book" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:MachineBreakdownView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Machine Breakdown" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:MediaSterilityView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Media Sterility" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:DailyTaskLogView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="?" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Daily Task Log" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>
            </UniformGrid>
        </ScrollViewer>
    </Grid>
</UserControl>




========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\LogbooksView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for LogbooksView.xaml
    /// </summary>
    public partial class LogbooksView : UserControl
    {
        public LogbooksView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\LoginView.xaml
========================================
<mah:MetroWindow x:Class="Mirage.UI.Views.LoginView"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
                 xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
                 xmlns:converters="clr-namespace:Mirage.UI.Converters"
                 mc:Ignorable="d"
                 Title="Login - Portal Mirage" Height="450" Width="800"
                 WindowStartupLocation="CenterScreen"
                 WindowStyle="None" ResizeMode="NoResize">

    <mah:MetroWindow.Resources>
        <ResourceDictionary>
            <converters:StringIsNullOrEmptyToVisibilityConverter x:Key="StringIsNullOrEmptyToVisibilityConverter"/>
            <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        </ResourceDictionary>
    </mah:MetroWindow.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0" Background="#F0F4F8">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <Image Source="/Assets/logo 2023.png" Width="250" Margin="10"/>
                <TextBlock Text="Portal Mirage" FontSize="32" FontWeight="Bold" Foreground="#005A9C" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <Grid Grid.Column="1">
            <StackPanel Width="300" 
                        HorizontalAlignment="Center" 
                        VerticalAlignment="Center"
                        IsEnabled="{Binding IsLoginInProgress, Converter={StaticResource InverseBooleanConverter}}">
                <TextBlock Text="Welcome Back" FontSize="28" FontWeight="Light" Margin="0,0,0,20"/>
                <TextBox mah:TextBoxHelper.Watermark="Username" Margin="0,10" FontSize="16"
                         Text="{Binding Username, UpdateSourceTrigger=PropertyChanged}"/>
                <PasswordBox x:Name="PasswordBox" mah:TextBoxHelper.Watermark="Password" Margin="0,10" FontSize="16"/>
                <Button Content="Login" Margin="0,20" Padding="10" FontSize="18" FontWeight="Bold" Background="#0078D7" Foreground="White"
                        Command="{Binding LoginCommand}"
                        CommandParameter="{Binding ElementName=PasswordBox}"/>
                <TextBlock Text="{Binding ErrorMessage}" Foreground="Red" TextAlignment="Center" TextWrapping="Wrap"
                           Visibility="{Binding ErrorMessage, Converter={StaticResource StringIsNullOrEmptyToVisibilityConverter}, ConverterParameter=Inverse}"/>
            </StackPanel>

            <mah:ProgressRing IsActive="{Binding IsLoginInProgress}" />
        </Grid>
    </Grid>
</mah:MetroWindow>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\LoginView.xaml.cs
========================================
using MahApps.Metro.Controls;
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;

namespace Mirage.UI.Views
{
    public partial class LoginView : MetroWindow
    {
        public LoginView()
        {
            InitializeComponent();
            // Get the shared LoginViewModel from our app's service provider
            DataContext = App.ServiceProvider?.GetRequiredService<LoginViewModel>();
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\MachineBreakdownView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.MachineBreakdownView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="MachineBreakdownView_OnLoaded">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Grid Margin="20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="350"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Margin="0,0,20,0">
                    <TextBlock Text="Machine Breakdown" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>
                    <Label Content="Machine Name"/>
                    <ComboBox ItemsSource="{Binding MachineNames}" SelectedItem="{Binding SelectedMachineName}" Margin="0,0,0,10" IsEditable="True"/>
                    <Label Content="Reason for Breakdown"/>
                    <TextBox Text="{Binding BreakdownReason}" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" VerticalScrollBarVisibility="Auto"/>
                    <Button Content="Submit Report" Command="{Binding SubmitCommand}"/>
                </StackPanel>

                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Breakdown Reports" FontSize="24" FontWeight="Light" Margin="0,0,0,10"/>

                    <Grid Grid.Row="1" Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <RadioButton Content="Pending" GroupName="ViewToggle" 
                                         IsChecked="{Binding IsPendingViewActive, Mode=TwoWay}" 
                                         Style="{StaticResource MahApps.Styles.ToggleButton}"/>
                            <RadioButton Content="Resolved" GroupName="ViewToggle" 
                                         IsChecked="{Binding IsResolvedViewActive, Mode=TwoWay}" 
                                         Style="{StaticResource MahApps.Styles.ToggleButton}" Margin="5,0,0,0"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <DatePicker SelectedDate="{Binding StartDate}"/>
                            <Label Content="to" Margin="5,0"/>
                            <DatePicker SelectedDate="{Binding EndDate}"/>
                            <Button Content="Search" Margin="10,0,0,0" Command="{Binding SearchCommand}"/>
                        </StackPanel>
                    </Grid>

                    <DataGrid Grid.Row="2" ItemsSource="{Binding PendingBreakdowns}" AutoGenerateColumns="False" IsReadOnly="True" AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                        <DataGrid.Style>
                            <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsPendingViewActive}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.Style>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Reported On" Binding="{Binding ReportedDateTime, StringFormat='g'}" Width="*"/>
                            <DataGridTextColumn Header="Reported By" Binding="{Binding ReportedByUsername}" Width="*"/>
                            <DataGridTextColumn Header="Machine" Binding="{Binding MachineName}" Width="*"/>
                            <DataGridTemplateColumn Header="Reason" Width="2*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding BreakdownReason}" TextWrapping="Wrap" Padding="5"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Actions" Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Resolve" Margin="0,0,5,0"
                                                    Command="{Binding DataContext.ShowResolveFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"/>
                                            <Button Content="Delete" Background="IndianRed" Foreground="White"
                                                    Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <DataGrid Grid.Row="2" ItemsSource="{Binding ResolvedBreakdowns}" AutoGenerateColumns="False" IsReadOnly="True" AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                        <DataGrid.Style>
                            <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsResolvedViewActive}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.Style>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Reported On" Binding="{Binding ReportedDateTime, StringFormat='g'}" Width="0.8*"/>
                            <DataGridTextColumn Header="Machine" Binding="{Binding MachineName}" Width="*"/>
                            <DataGridTextColumn Header="Resolved On" Binding="{Binding ResolvedDateTime, StringFormat='g'}" Width="0.8*"/>
                            <DataGridTextColumn Header="Resolved By" Binding="{Binding ResolvedByUsername}" Width="*"/>
                            <DataGridTextColumn Header="Notes" Binding="{Binding ResolutionNotes}" Width="1.5*"/>
                            <DataGridTextColumn Header="Downtime (Mins)" Binding="{Binding DowntimeMinutes}" Width="Auto"/>
                            <DataGridTemplateColumn Header="Actions" Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Delete" Background="IndianRed" Foreground="White"
                                                Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
        </ScrollViewer>

        <!-- Translucent badge at bottom-left (from new code) -->
        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                CornerRadius="4" Padding="8,4" Margin="20"
                Opacity="0.6" Effect="{DynamicResource MahApps.Effects.DropShadow}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#E8F5E9"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="?? All Saved"/>
                            <Setter Property="Foreground" Value="#2E7D32"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                    <Setter Property="Text" Value="?? Unsaved Draft"/>
                                    <Setter Property="Foreground" Value="#E65100"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>

        <!-- Flyouts section (from current code, fully intact) -->
        <mah:FlyoutsControl>
            <mah:Flyout Header="Resolve Breakdown" IsOpen="{Binding IsResolveFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="{Binding SelectedBreakdownToResolve.MachineName}" FontWeight="Bold" FontSize="18" Margin="0,0,0,10"/>
                    <Label Content="Resolution Notes"/>
                    <TextBox Text="{Binding ResolutionNotes}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Resolution" Command="{Binding ConfirmResolveCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}"/>
                </StackPanel>
            </mah:Flyout>

            <mah:Flyout Header="Confirm Deactivation" IsOpen="{Binding IsDeleteFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="Please provide a reason for deleting this entry. This action will be permanently recorded in the audit log." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Label Content="Reason for Deactivation"/>
                    <TextBox Text="{Binding DeactivationReason}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Deactivation" Command="{Binding ConfirmDeactivationCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Background="IndianRed"/>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\MachineBreakdownView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class MachineBreakdownView : UserControl
    {
        public MachineBreakdownView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<MachineBreakdownViewModel>();
        }

        private void MachineBreakdownView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is MachineBreakdownViewModel viewModel)
            {
                // Load both the machine names and the breakdown data
                viewModel.LoadMachineNamesCommand.Execute(null);
                viewModel.SearchCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\MasterListView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.MasterListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="900"
             Loaded="MasterListView_OnLoaded">


    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- List Selection Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <Label Content="Manage List:" FontWeight="Bold" VerticalAlignment="Center"/>
            <ComboBox ItemsSource="{Binding ListTypes}" SelectedItem="{Binding SelectedListType}" Width="200"/>
        </StackPanel>

        <!-- Main Content Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - List Items -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Search Box -->
                <TextBox Text="{Binding SearchFilter, UpdateSourceTrigger=PropertyChanged}" 
                         mah:TextBoxHelper.Watermark="Search items..." 
                         Margin="0,0,0,5"/>

                <!-- Data Grid -->
                <GroupBox Grid.Row="1" Header="List Items">
                    <DataGrid ItemsSource="{Binding FilteredItems}" 
                              SelectedItem="{Binding SelectedItem}"
                              RowStyle="{StaticResource StandardDataGridRowStyle}"
                              AutoGenerateColumns="False" 
                              IsReadOnly="True" 
                              AlternationCount="2">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Value" Binding="{Binding ItemValue}" Width="*"/>
                            <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="1.5*"/>
                            <DataGridCheckBoxColumn Header="Is Active" Binding="{Binding IsActive}" Width="Auto"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </GroupBox>
            </Grid>

            <!-- Grid Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" Background="LightGray"/>

            <!-- Right Panel - Edit Controls -->
            <StackPanel Grid.Column="2">
                <Button Content="Add New Item" Command="{Binding NewItemCommand}" Margin="0,0,0,10"/>
                <GroupBox Header="Edit Item" IsEnabled="{Binding IsEditing}">
                    <StackPanel Margin="10">
                        <Label Content="Item Value"/>
                        <TextBox Text="{Binding EditItemValue, UpdateSourceTrigger=PropertyChanged}" 
                                 Margin="0,0,0,10"/>

                        <Label Content="Description"/>
                        <TextBox Text="{Binding EditDescription, UpdateSourceTrigger=PropertyChanged}" 
                                 Margin="0,0,0,10" 
                                 Height="60" 
                                 TextWrapping="Wrap" 
                                 AcceptsReturn="True"/>

                        <mah:ToggleSwitch Content="Is Active" 
                                        IsOn="{Binding IsItemActive}" 
                                        Margin="0,0,0,20"/>

                        <Button Content="Save Changes" 
                                Command="{Binding SaveItemCommand}" 
                                Style="{DynamicResource MahApps.Styles.Button.Accent}"/>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="2" Margin="0,5,0,0">
            <StatusBarItem>
                <TextBlock Text="{Binding ItemCount, StringFormat='{}Items: {0}'}"/>
            </StatusBarItem>
            <Separator Style="{StaticResource MahApps.Styles.Separator.StatusBar}"/>
            <StatusBarItem>
                <TextBlock Text="{Binding SelectedListType, StringFormat='{}Current List: {0}'}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\MasterListView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class MasterListView : UserControl
    {
        public MasterListView()
        {
            InitializeComponent();
            // This line connects the View to its shared ViewModel
            this.DataContext = App.ServiceProvider?.GetRequiredService<MasterListViewModel>();
        }

        // This method will run when the Master List tab is shown
        private void MasterListView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is MasterListViewModel viewModel && viewModel.LoadAllItemsCommand.CanExecute(null))
            {
                viewModel.LoadAllItemsCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\MediaSterilityView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.MediaSterilityView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="MediaSterilityView_OnLoaded">


    <UserControl.Resources>
        <Style x:Key="StandardActionButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
            <Setter Property="mah:ControlsHelper.CornerRadius" Value="3"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#B0BEC5"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="2" Direction="270" Color="#CCCCCC" Opacity="0.4" BlurRadius="4"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#ECEFF1"/>
                    <Setter Property="BorderBrush" Value="#90A4AE"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#CFD8DC"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="FailedRowStyle" TargetType="DataGridRow" BasedOn="{StaticResource MahApps.Styles.DataGridRow}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding OverallStatus}" Value="Failed">
                    <Setter Property="Background" Value="#FFCDD2"/>
                    <Setter Property="Foreground" Value="#B71C1C"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Margin="0,0,20,0">
                <TextBlock Text="Media Sterility Log" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>
                <Label Content="Media Name"/>
                <ComboBox ItemsSource="{Binding MediaNames}" SelectedItem="{Binding SelectedMediaName}" Margin="0,0,0,10" IsEditable="True"/>
                <Label Content="Lot Number"/>
                <TextBox Text="{Binding MediaLotNumber}" Margin="0,0,0,10"/>
                <Label Content="Quantity"/>
                <TextBox Text="{Binding MediaQuantity}" Margin="0,0,0,10"/>
                <Label Content="Result at 37C"/>
                <ComboBox ItemsSource="{Binding GrowthResults}" SelectedItem="{Binding SelectedResult37C}" Margin="0,0,0,10"/>
                <Label Content="Result at 25C"/>
                <ComboBox ItemsSource="{Binding GrowthResults}" SelectedItem="{Binding SelectedResult25C}" Margin="0,0,0,10"/>
                <Label Content="Comments"/>
                <TextBox Text="{Binding Comments}" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,20" VerticalScrollBarVisibility="Auto"/>
                <StackPanel Orientation="Horizontal">
                    <Button Content="Save" Width="100" Style="{DynamicResource MahApps.Styles.Button.Accent}" Command="{Binding SaveCommand}"/>
                    <Button Content="Clear" Width="100" Margin="10,0,0,0" Style="{StaticResource StandardActionButtonStyle}" Command="{Binding ClearCommand}"/>
                </StackPanel>
            </StackPanel>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                    <DatePicker SelectedDate="{Binding StartDate}"/>
                    <Label Content="to" Margin="5,0"/>
                    <DatePicker SelectedDate="{Binding EndDate}"/>
                    <Button Content="Search" Margin="10,0,0,0" Command="{Binding LoadLogsCommand}"/>
                </StackPanel>
                <DataGrid Grid.Row="1" ItemsSource="{Binding Logs}" RowStyle="{StaticResource FailedRowStyle}" AutoGenerateColumns="False" IsReadOnly="True" AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Date" Binding="{Binding CheckDateTime, StringFormat='d'}" Width="*"/>
                        <DataGridTextColumn Header="Media Name" Binding="{Binding MediaName}" Width="2*"/>
                        <DataGridTextColumn Header="Lot Number" Binding="{Binding MediaLotNumber}" Width="*"/>
                        <DataGridTextColumn Header="Status" Binding="{Binding OverallStatus}" FontWeight="Bold" Width="*"/>
                        <DataGridTextColumn Header="Performed By" Binding="{Binding PerformedByUsername}" Width="*"/>
                        <DataGridTemplateColumn Header="Actions" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Delete" Background="IndianRed" Foreground="White"
                                            Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <mah:FlyoutsControl>
            <mah:Flyout Header="Confirm Deactivation" IsOpen="{Binding IsDeleteFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="Please provide a reason for deleting this entry. This action will be permanently recorded in the audit log." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Label Content="Reason for Deactivation"/>
                    <TextBox Text="{Binding DeactivationReason}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Deactivation" Command="{Binding ConfirmDeactivationCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Background="IndianRed"/>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>

        <!-- Save Status Badge -->
        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                CornerRadius="4" Padding="8,4" Margin="249,0,0,30"
                Opacity="0.6" Effect="{DynamicResource MahApps.Effects.DropShadow}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#E8F5E9"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="?? All Saved"/>
                            <Setter Property="Foreground" Value="#2E7D32"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                    <Setter Property="Text" Value="?? Unsaved Draft"/>
                                    <Setter Property="Foreground" Value="#E65100"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\MediaSterilityView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class MediaSterilityView : UserControl
    {
        public MediaSterilityView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<MediaSterilityViewModel>();
        }

        private void MediaSterilityView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is MediaSterilityViewModel viewModel && viewModel.LoadLogsCommand.CanExecute(null))
            {
                viewModel.LoadLogsCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\RepeatSampleView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.RepeatSampleView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="RepeatSampleView_OnLoaded">


    <UserControl.Resources>
        <Style x:Key="StandardActionButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
            <Setter Property="mah:ControlsHelper.CornerRadius" Value="3"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#B0BEC5"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="2" Direction="270" Color="#CCCCCC" Opacity="0.4" BlurRadius="4"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#ECEFF1"/>
                    <Setter Property="BorderBrush" Value="#90A4AE"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#CFD8DC"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Margin="0,0,20,0">
                <TextBlock Text="Repeat Sample Log" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

                <Label Content="Patient ID Card Number"/>
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0" Text="{Binding PatientIdCardNumber, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Grid.Column="1" Content="Find" Margin="5,0,0,0" Command="{Binding FindPatientCommand}"/>
                </Grid>

                <Label Content="Patient Name" Margin="0,10,0,0"/>
                <TextBox Text="{Binding PatientName}" IsReadOnly="True" Margin="0,0,0,10" FontWeight="Bold" Background="#ECEFF1"/>

                <Label Content="Reason for Repeat"/>
                <ComboBox ItemsSource="{Binding Reasons}" SelectedItem="{Binding SelectedReason}" IsEditable="True" Margin="0,0,0,10"/>

                <Label Content="Department"/>
                <ComboBox ItemsSource="{Binding Departments}" SelectedItem="{Binding SelectedDepartment}" Margin="0,0,0,10"/>

                <Label Content="Informed Person"/>
                <TextBox Text="{Binding InformedPerson}" Margin="0,0,0,20"/>

                <StackPanel Orientation="Horizontal">
                    <Button Content="Save" Width="100" Style="{DynamicResource MahApps.Styles.Button.Accent}" Command="{Binding SaveCommand}"/>
                    <Button Content="Clear" Width="100" Margin="10,0,0,0" Style="{StaticResource StandardActionButtonStyle}" Command="{Binding ClearCommand}"/>
                </StackPanel>
            </StackPanel>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                    <DatePicker SelectedDate="{Binding StartDate}"/>
                    <Label Content="to" Margin="5,0"/>
                    <DatePicker SelectedDate="{Binding EndDate}"/>
                    <Button Content="Search" Margin="10,0,0,0" Command="{Binding LoadLogsCommand}"/>
                </StackPanel>

                <DataGrid Grid.Row="1" ItemsSource="{Binding Logs}" AutoGenerateColumns="False" IsReadOnly="True"
                          AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Date" Binding="{Binding LogDateTime, StringFormat='g'}" Width="*"/>
                        <DataGridTextColumn Header="Patient Name" Binding="{Binding PatientName}" Width="1.5*"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding ReasonText}" Width="2*"/>
                        <DataGridTextColumn Header="Department" Binding="{Binding Department}" Width="*"/>
                        <DataGridTextColumn Header="Logged By" Binding="{Binding LoggedByUsername}" Width="*"/>
                        <DataGridTemplateColumn Header="Actions" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Delete" Background="IndianRed" Foreground="White"
                                            Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <mah:FlyoutsControl>
            <mah:Flyout Header="Confirm Deactivation" IsOpen="{Binding IsDeleteFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="Please provide a reason for deleting this entry. This action will be permanently recorded in the audit log." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Label Content="Reason for Deactivation"/>
                    <TextBox Text="{Binding DeactivationReason}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Deactivation" Command="{Binding ConfirmDeactivationCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Background="IndianRed"/>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>

        <!-- Save Status Badge -->
        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                CornerRadius="4" Padding="8,4" Margin="20"
                Opacity="0.6" Effect="{DynamicResource MahApps.Effects.DropShadow}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#E8F5E9"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="?? All Saved"/>
                            <Setter Property="Foreground" Value="#2E7D32"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                    <Setter Property="Text" Value="?? Unsaved Draft"/>
                                    <Setter Property="Foreground" Value="#E65100"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\RepeatSampleView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class RepeatSampleView : UserControl
    {
        public RepeatSampleView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<RepeatSampleViewModel>();
        }

        private void RepeatSampleView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is RepeatSampleViewModel viewModel && viewModel.LoadLogsCommand.CanExecute(null))
            {
                viewModel.LoadLogsCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\ReportsView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.ReportsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1000"
             Loaded="ReportsView_OnLoaded">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Reporting Engine" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

        <StackPanel Grid.Row="1">
            <ComboBox ItemsSource="{Binding AvailableReports}" 
                      SelectedItem="{Binding SelectedReport}"
                      mah:TextBoxHelper.Watermark="Select a Report to Generate"
                      FontSize="16"
                      Padding="8"
                      Margin="0,0,0,15"/>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Machine Breakdowns">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Machine Breakdown Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>
                        <ComboBox ItemsSource="{Binding MachineNames}" SelectedItem="{Binding SelectedMachineName}"
                                  mah:TextBoxHelper.Watermark="All Machines"
                                  Width="180" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding BreakdownStatusOptions}" SelectedItem="{Binding SelectedBreakdownStatus}"
                                  mah:TextBoxHelper.Watermark="All Statuses"
                                  Width="150" Margin="5,0,0,0"/>
                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Handover Summary">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Handover Summary Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>
                        <ComboBox ItemsSource="{Binding ShiftOptions}" SelectedItem="{Binding SelectedShift}" mah:TextBoxHelper.Watermark="All Shifts" Width="150" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding PriorityOptions}" SelectedItem="{Binding SelectedPriority}" mah:TextBoxHelper.Watermark="All Priorities" Width="150" Margin="5,0,0,0"/>
                        <ComboBox ItemsSource="{Binding HandoverStatusOptions}" SelectedItem="{Binding SelectedHandoverStatus}" mah:TextBoxHelper.Watermark="All Statuses" Width="150" Margin="5,0,0,0"/>
                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Kit Validation Log">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Kit Validation Log Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>
                        <ComboBox ItemsSource="{Binding KitNameOptions}" SelectedItem="{Binding SelectedKitName}" mah:TextBoxHelper.Watermark="All Kits" Width="180" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding KitStatusOptions}" SelectedItem="{Binding SelectedKitStatus}" mah:TextBoxHelper.Watermark="All Statuses" Width="150" Margin="5,0,0,0"/>
                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Repeat Sample Log">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Repeat Sample Log Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>
                        <ComboBox ItemsSource="{Binding ReasonOptions}" SelectedItem="{Binding SelectedReason}" mah:TextBoxHelper.Watermark="All Reasons" Width="180" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding DepartmentOptions}" SelectedItem="{Binding SelectedDepartment}" mah:TextBoxHelper.Watermark="All Departments" Width="150" Margin="5,0,0,0"/>
                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Daily Task Compliance">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Daily Task Compliance Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>
                        <ComboBox ItemsSource="{Binding TaskShiftOptions}" SelectedItem="{Binding SelectedTaskShift}" DisplayMemberPath="Name" mah:TextBoxHelper.Watermark="All Shifts" Width="180" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding TaskStatusOptions}" SelectedItem="{Binding SelectedTaskStatus}" mah:TextBoxHelper.Watermark="All Statuses" Width="150" Margin="5,0,0,0"/>
                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Media Sterility Log">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Media Sterility Log Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>
                        <ComboBox ItemsSource="{Binding MediaNameOptions}" SelectedItem="{Binding SelectedMediaName}" mah:TextBoxHelper.Watermark="All Media" Width="180" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding MediaStatusOptions}" SelectedItem="{Binding SelectedMediaStatus}" mah:TextBoxHelper.Watermark="All Statuses" Width="150" Margin="5,0,0,0"/>
                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Sample Storage Log">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Sample Storage Log Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>
                        <ComboBox ItemsSource="{Binding TestNameOptions}" SelectedItem="{Binding SelectedTestName}" mah:TextBoxHelper.Watermark="All Tests" Width="180" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding SampleStatusOptions}" SelectedItem="{Binding SelectedSampleStatus}" mah:TextBoxHelper.Watermark="All Statuses" Width="150" Margin="5,0,0,0"/>
                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedReport}" Value="Calibration Log">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel>
                    <TextBlock Text="Calibration Log Report" FontSize="18" FontWeight="Bold"/>
                    <Separator Margin="0,10"/>
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Date Range:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Margin="5,0"/>
                        <Label Content="to" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Margin="5,0"/>

                        <ComboBox ItemsSource="{Binding CalibrationTestNameOptions}" SelectedItem="{Binding SelectedCalibrationTestName}" mah:TextBoxHelper.Watermark="All Tests/Instruments" Width="200" Margin="20,0,0,0"/>
                        <ComboBox ItemsSource="{Binding QcResultOptions}" SelectedItem="{Binding SelectedQcResult}" mah:TextBoxHelper.Watermark="All Results" Width="150" Margin="5,0,0,0"/>

                        <Button Content="Generate Report" Command="{Binding GenerateReportCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Margin="20,0,0,0"/>
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="5,0,0,0"/>
                    </StackPanel>
                </StackPanel>
            </Border>

        </StackPanel>

        <DockPanel Grid.Row="2" LastChildFill="True">

            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                <Button Content="Export to CSV" 
                        Command="{Binding ExportToCsvCommand}"
                        Style="{DynamicResource MahApps.Styles.Button}"
                        Margin="0,0,5,0"/>
                <Button Content="Print to PDF" 
                        Command="{Binding PrintReportCommand}"
                        Style="{DynamicResource MahApps.Styles.Button.Accent}"/>
            </StackPanel>

            <Grid>
                <mah:ProgressRing IsActive="{Binding IsLoading}" Panel.ZIndex="1"/>

                <TextBlock Text="Generate a report to see the results here." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" Foreground="{DynamicResource MahApps.Brushes.Gray5}" FontStyle="Italic">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding MachineBreakdownReportData.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <DataGrid ItemsSource="{Binding MachineBreakdownReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Machine Breakdowns">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Reported On" Binding="{Binding ReportedDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Machine" Binding="{Binding MachineName}" Width="1.5*"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding BreakdownReason}" Width="2*"/>
                        <DataGridTextColumn Header="Reported By" Binding="{Binding ReportedByUsername}" Width="*"/>
                        <DataGridTextColumn Header="Resolved On" Binding="{Binding ResolvedDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Resolved By" Binding="{Binding ResolvedByUsername}" Width="*"/>
                        <DataGridTextColumn Header="Resolution" Binding="{Binding ResolutionNotes}" Width="2*"/>
                        <DataGridTextColumn Header="Downtime" Binding="{Binding ElapsedDowntimeDisplay}" Width="*" FontWeight="SemiBold"/>
                    </DataGrid.Columns>
                </DataGrid>

                <DataGrid ItemsSource="{Binding HandoverReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Handover Summary">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Given On" Binding="{Binding GivenDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Given By" Binding="{Binding GivenByUsername}" Width="*"/>
                        <DataGridTextColumn Header="Shift" Binding="{Binding Shift}" Width="*"/>
                        <DataGridTextColumn Header="Priority" Binding="{Binding Priority}" Width="*"/>
                        <DataGridTextColumn Header="Notes" Binding="{Binding HandoverNotes}" Width="3*"/>
                        <DataGridTextColumn Header="Received On" Binding="{Binding ReceivedDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Received By" Binding="{Binding ReceivedByUsername}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <DataGrid ItemsSource="{Binding KitValidationReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Kit Validation Log">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Validated On" Binding="{Binding ValidationDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Kit Name" Binding="{Binding KitName}" Width="2*"/>
                        <DataGridTextColumn Header="Lot Number" Binding="{Binding KitLotNumber}" Width="*"/>
                        <DataGridTextColumn Header="Expiry Date" Binding="{Binding KitExpiryDate, StringFormat='d'}" Width="*"/>
                        <DataGridTextColumn Header="Status" Binding="{Binding ValidationStatus}" Width="*"/>
                        <DataGridTextColumn Header="Comments" Binding="{Binding Comments}" Width="2*"/>
                        <DataGridTextColumn Header="Validated By" Binding="{Binding ValidatedByUsername}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <DataGrid ItemsSource="{Binding RepeatSampleReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Repeat Sample Log">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Logged On" Binding="{Binding LogDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Patient ID" Binding="{Binding PatientIdCardNumber}" Width="*"/>
                        <DataGridTextColumn Header="Patient Name" Binding="{Binding PatientName}" Width="1.5*"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding ReasonText}" Width="2*"/>
                        <DataGridTextColumn Header="Department" Binding="{Binding Department}" Width="*"/>
                        <DataGridTextColumn Header="Informed" Binding="{Binding InformedPerson}" Width="*"/>
                        <DataGridTextColumn Header="Logged By" Binding="{Binding LoggedByUsername}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Daily Task Compliance">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" Background="{DynamicResource MahApps.Brushes.Gray9}" CornerRadius="5" Padding="15" Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Text="Total Tasks:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding TotalTasks}" FontWeight="Bold" FontSize="16" Margin="5,0,20,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Completed:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding CompletedTasks}" FontWeight="Bold" FontSize="16" Margin="5,0,20,0" VerticalAlignment="Center" Foreground="Green"/>
                            <TextBlock Text="Compliance:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding CompletionPercentage, StringFormat=P1}" FontWeight="Bold" FontSize="16" Margin="5,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource MahApps.Brushes.Accent}"/>
                        </StackPanel>
                    </Border>
                    <DataGrid Grid.Row="1" ItemsSource="{Binding DailyTaskReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Date" Binding="{Binding LogDate, StringFormat='d'}" Width="*"/>
                            <DataGridTextColumn Header="Task Name" Binding="{Binding TaskName}" Width="2*"/>
                            <DataGridTextColumn Header="Shift" Binding="{Binding ShiftName}" Width="*"/>
                            <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*"/>
                            <DataGridTextColumn Header="Completed On" Binding="{Binding CompletedDateTime, StringFormat='g'}" Width="1.5*"/>
                            <DataGridTextColumn Header="Completed By" Binding="{Binding CompletedByUsername}" Width="*"/>
                            <DataGridTextColumn Header="Comments" Binding="{Binding Comments}" Width="2*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>

                <DataGrid ItemsSource="{Binding MediaSterilityReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Media Sterility Log">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Checked On" Binding="{Binding CheckDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Media Name" Binding="{Binding MediaName}" Width="2*"/>
                        <DataGridTextColumn Header="Lot Number" Binding="{Binding MediaLotNumber}" Width="*"/>
                        <DataGridTextColumn Header="Result 37C" Binding="{Binding Result37C}" Width="*"/>
                        <DataGridTextColumn Header="Result 25C" Binding="{Binding Result25C}" Width="*"/>
                        <DataGridTextColumn Header="Overall Status" Binding="{Binding OverallStatus}" Width="*"/>
                        <DataGridTextColumn Header="Performed By" Binding="{Binding PerformedByUsername}" Width="1.5*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <DataGrid ItemsSource="{Binding SampleStorageReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Sample Storage Log">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Stored On" Binding="{Binding StorageDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Sample ID" Binding="{Binding PatientSampleID}" Width="*"/>
                        <DataGridTextColumn Header="Test Name" Binding="{Binding TestName}" Width="1.5*"/>
                        <DataGridTextColumn Header="Stored By" Binding="{Binding StoredByUsername}" Width="*"/>
                        <DataGridTextColumn Header="Completed On" Binding="{Binding TestDoneDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Completed By" Binding="{Binding TestDoneByUsername}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <DataGrid ItemsSource="{Binding CalibrationReportData}" AutoGenerateColumns="False" IsReadOnly="True" RowStyle="{StaticResource StandardDataGridRowStyle}">
                    <DataGrid.Style>
                        <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedReport}" Value="Calibration Log">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Style>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Calibrated On" Binding="{Binding CalibrationDateTime, StringFormat='g'}" Width="1.5*"/>
                        <DataGridTextColumn Header="Test/Instrument" Binding="{Binding TestName}" Width="2*"/>
                        <DataGridTextColumn Header="QC Result" Binding="{Binding QcResult}" Width="*"/>
                        <DataGridTextColumn Header="Reason" Binding="{Binding Reason}" Width="2*"/>
                        <DataGridTextColumn Header="Performed By" Binding="{Binding PerformedByUsername}" Width="1.5*"/>
                    </DataGrid.Columns>
                </DataGrid>

            </Grid>
        </DockPanel>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\ReportsView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class ReportsView : UserControl
    {
        public ReportsView()
        {
            InitializeComponent();
            // Connect to the shared ViewModel
            this.DataContext = App.ServiceProvider?.GetRequiredService<ReportsViewModel>();
        }

        // This method runs when the Reports tab is shown
        private void ReportsView_OnLoaded(object sender, RoutedEventArgs e)
        {
            // Get the ViewModel and execute the command to load filters
            if (this.DataContext is ReportsViewModel viewModel && viewModel.LoadFilterOptionsCommand.CanExecute(null))
            {
                viewModel.LoadFilterOptionsCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\SampleStorageView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.SampleStorageView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000"
             Loaded="SampleStorageView_OnLoaded">


    <Grid>
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Sample Storage" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

            <Grid Grid.Row="1" Margin="0,0,0,10">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsPendingViewActive}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
                <StackPanel Orientation="Horizontal">
                    <Label Content="New Sample ID:" VerticalAlignment="Center"/>
                    <TextBox Text="{Binding NewPatientSampleId}" Width="150" Margin="5,0"/>
                    <Label Content="Test Name:" VerticalAlignment="Center" Margin="10,0,0,0"/>
                    <TextBox Text="{Binding NewTestName}" Width="150" Margin="5,0"/>
                    <Button Content="Add Sample" Command="{Binding AddCommand}" Margin="10,0,0,0"/>
                    <!-- Add Clear Draft Button -->
                    <Button Content="Clear Draft" Command="{Binding ClearDraftCommand}" Margin="10,0,0,0" 
                            Background="Transparent" BorderBrush="Orange" BorderThickness="1">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Grid>

            <Grid Grid.Row="2" Margin="0,0,0,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <RadioButton Content="Pending" GroupName="ViewToggle" IsChecked="{Binding IsPendingViewActive, Mode=TwoWay}" Style="{StaticResource MahApps.Styles.ToggleButton}"/>
                    <RadioButton Content="Completed" GroupName="ViewToggle" IsChecked="{Binding IsCompletedViewActive, Mode=TwoWay}" Style="{StaticResource MahApps.Styles.ToggleButton}" Margin="5,0,0,0"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                    <DatePicker SelectedDate="{Binding StartDate}"/>
                    <Label Content="to" Margin="5,0"/>
                    <DatePicker SelectedDate="{Binding EndDate}"/>
                    <Button Content="Search" Margin="10,0,0,0" Command="{Binding SearchCommand}"/>
                </StackPanel>
            </Grid>

            <DataGrid Grid.Row="3" ItemsSource="{Binding PendingSamples}" AutoGenerateColumns="False" IsReadOnly="True"
                      AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                <DataGrid.Style>
                    <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsPendingViewActive}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.Style>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Stored On" Binding="{Binding StorageDateTime, StringFormat='g'}" Width="*"/>
                    <DataGridTextColumn Header="Sample ID" Binding="{Binding PatientSampleID}" Width="2*"/>
                    <DataGridTextColumn Header="Test Name" Binding="{Binding TestName}" Width="2*"/>
                    <DataGridTextColumn Header="Stored By" Binding="{Binding StoredByUsername}" Width="*"/>
                    <DataGridTemplateColumn Header="Actions" Width="Auto">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Button Content="Mark as Done" Margin="0,0,5,0"
                                            Command="{Binding DataContext.MarkAsDoneCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding StorageID}"/>
                                    <Button Content="Delete" Background="IndianRed" Foreground="White"
                                            Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>

            <DataGrid Grid.Row="3" ItemsSource="{Binding CompletedSamples}" AutoGenerateColumns="False" IsReadOnly="True"
                      AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                <DataGrid.Style>
                    <Style TargetType="DataGrid" BasedOn="{StaticResource MahApps.Styles.DataGrid}">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsCompletedViewActive}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.Style>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Completed On" Binding="{Binding TestDoneDateTime, StringFormat='g'}" Width="*"/>
                    <DataGridTextColumn Header="Sample ID" Binding="{Binding PatientSampleID}" Width="2*"/>
                    <DataGridTextColumn Header="Test Name" Binding="{Binding TestName}" Width="2*"/>
                    <DataGridTextColumn Header="Completed By" Binding="{Binding TestDoneByUsername}" Width="*"/>
                    <DataGridTemplateColumn Header="Actions" Width="Auto">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="Delete" Background="IndianRed" Foreground="White"
                                        Command="{Binding DataContext.ShowDeleteFlyoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <mah:FlyoutsControl>
            <mah:Flyout Header="Confirm Deactivation" IsOpen="{Binding IsDeleteFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="Please provide a reason for deleting this entry. This action will be permanently recorded in the audit log." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Label Content="Reason for Deactivation"/>
                    <TextBox Text="{Binding DeactivationReason}" Height="150" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10"/>
                    <Button Content="Confirm Deactivation" Command="{Binding ConfirmDeactivationCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}" Background="IndianRed"/>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>

        <!-- DRAFT STATUS BADGE -->
        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                CornerRadius="4" Padding="8,4" Margin="20"
                Opacity="0.6" Effect="{DynamicResource MahApps.Effects.DropShadow}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#E8F5E9"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="?? All Saved"/>
                            <Setter Property="Foreground" Value="#2E7D32"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasUnsavedDraft}" Value="True">
                                    <Setter Property="Text" Value="?? Unsaved Draft"/>
                                    <Setter Property="Foreground" Value="#E65100"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\SampleStorageView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class SampleStorageView : UserControl
    {
        public SampleStorageView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<SampleStorageViewModel>();
        }

        private void SampleStorageView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is SampleStorageViewModel viewModel && viewModel.SearchCommand.CanExecute(null))
            {
                viewModel.SearchCommand.Execute(null);
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\SettingsView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.SettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:converters="clr-namespace:Mirage.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">

    <UserControl.DataContext>
        <viewModels:SettingsViewModel/>
    </UserControl.DataContext>

    <UserControl.Resources>
        <converters:ThemeToBooleanConverter x:Key="ThemeToBooleanConverter"/>
    </UserControl.Resources>

    <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="30">
            <TextBlock Text="Settings" FontSize="36" FontWeight="Light" Margin="0,0,0,25"/>

            <GroupBox Header="Appearance"
                      mah:HeaderedControlHelper.HeaderFontSize="18"
                      Padding="15">
                <StackPanel>
                    <mah:ToggleSwitch OnContent="Dark" OffContent="Light"
                                      IsOn="{Binding SelectedTheme, Converter={StaticResource ThemeToBooleanConverter}}"
                                      Margin="0,5,0,20"/>

                    <Label Content="Accent Color"/>
                    <ListBox ItemsSource="{Binding AccentColors}"
                             SelectedItem="{Binding SelectedAccent}"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="5">
                                    <Rectangle Width="20" Height="20" Fill="{Binding ColorBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </StackPanel>
            </GroupBox>

            <!-- REPLACED: Font Size GroupBox with enabled version -->
            <GroupBox Header="Font Size"
                      mah:HeaderedControlHelper.HeaderFontSize="18"
                      Padding="15" Margin="0,20,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <Slider Grid.Column="0" 
                            Minimum="12" Maximum="18"
                            TickFrequency="1" IsSnapToTickEnabled="True"
                            Value="{Binding AppFontSize, Mode=TwoWay}"/>

                    <TextBlock Grid.Column="1"
                               Text="{Binding AppFontSize}"
                               FontWeight="Bold"
                               Width="30"
                               TextAlignment="Center"
                               VerticalAlignment="Center"
                               Margin="10,0,0,0"/>
                </Grid>
            </GroupBox>

        </StackPanel>
    </ScrollViewer>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\SettingsView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for SettingsView.xaml
    /// </summary>
    public partial class SettingsView : UserControl
    {
        public SettingsView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\ShiftManagementView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.ShiftManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="900"
             Loaded="ShiftManagementView_OnLoaded">

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="1*"/>
        </Grid.ColumnDefinitions>

        <GroupBox Grid.Column="0" Header="Defined Shifts">
            <DataGrid ItemsSource="{Binding Shifts}" 
                      SelectedItem="{Binding SelectedShift}" 
                      AutoGenerateColumns="False" 
                      IsReadOnly="True">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Name" 
                                        Binding="{Binding ShiftName}" 
                                        Width="*"/>
                    <DataGridTextColumn Header="Start Time" 
                                        Binding="{Binding StartTime, StringFormat='{}{0:hh\\:mm tt}'}" 
                                        Width="Auto"/>
                    <DataGridTextColumn Header="End Time" 
                                        Binding="{Binding EndTime, StringFormat='{}{0:hh\\:mm tt}'}" 
                                        Width="Auto"/>
                    <DataGridTextColumn Header="Grace (Hrs)" 
                                        Binding="{Binding GracePeriodHours}" 
                                        Width="Auto"/>
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>

        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" Background="LightGray"/>

        <StackPanel Grid.Column="2">
            <Button Content="Add New Shift" 
                    Command="{Binding NewShiftCommand}" 
                    Margin="0,0,0,10"/>

            <Button Content="Deactivate Selected" 
                    Command="{Binding DeleteShiftCommand}" 
                    Background="IndianRed" 
                    Foreground="White" 
                    Margin="0,0,0,10">
                <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button}">
                        <Setter Property="IsEnabled" Value="True"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedShift}" Value="{x:Null}">
                                <Setter Property="IsEnabled" Value="False"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <GroupBox Header="Edit Shift" IsEnabled="{Binding IsEditing}">
                <StackPanel Margin="10">
                    <Label Content="Shift Name"/>
                    <TextBox Text="{Binding EditShiftName, UpdateSourceTrigger=PropertyChanged}" 
                             Margin="0,0,0,10"/>

                    <Label Content="Start Time"/>
                    <mah:TimePicker SelectedDateTime="{Binding EditStartTime, Mode=TwoWay}" 
                                    Margin="0,0,0,10"/>

                    <Label Content="End Time"/>
                    <mah:TimePicker SelectedDateTime="{Binding EditEndTime, Mode=TwoWay}" 
                                    Margin="0,0,0,10"/>

                    <Label Content="Grace Period (Hours)"/>
                    <mah:NumericUpDown Value="{Binding EditGracePeriodHours}" 
                                       Minimum="0" 
                                       Maximum="12" 
                                       Margin="0,0,0,20"/>

                    <Button Content="Save Changes" 
                            Command="{Binding SaveShiftCommand}" 
                            Style="{DynamicResource MahApps.Styles.Button.Accent}"/>
                </StackPanel>
            </GroupBox>
        </StackPanel>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\ShiftManagementView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;             // Required for RoutedEventArgs
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class ShiftManagementView : UserControl
    {
        public ShiftManagementView()
        {
            InitializeComponent();
            // Connect the View to the ViewModel
            this.DataContext = App.ServiceProvider?.GetRequiredService<ShiftManagementViewModel>();
        }

        // This runs every time the tab becomes visible
        private void ShiftManagementView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is ShiftManagementViewModel viewModel)
            {
                // Force a refresh of the list from the database
                if (viewModel.LoadShiftsCommand.CanExecute(null))
                {
                    viewModel.LoadShiftsCommand.Execute(null);
                }
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\SystemSettingsView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.SystemSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             Loaded="SystemSettingsView_OnLoaded">

    <Grid Margin="10">
        <GroupBox Header="Session Management" Width="400" HorizontalAlignment="Left">
            <StackPanel Margin="10">
                <TextBlock Text="Automatic Logout" FontWeight="Bold" />
                <TextBlock Text="Set the number of minutes of inactivity before the user is automatically logged out." TextWrapping="Wrap" Margin="0,5,0,10"/>

                <mah:NumericUpDown Value="{Binding InactivityTimeoutMinutes}"
                                   Minimum="5"
                                   Maximum="120"
                                   StringFormat="N0"
                                   Margin="0,0,0,20"/>

                <Button Content="Save Settings"
                        Command="{Binding SaveSettingsAsyncCommand}"
                        Style="{DynamicResource MahApps.Styles.Button.Accent}"
                        HorizontalAlignment="Left"/>
            </StackPanel>
        </GroupBox>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\SystemSettingsView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class SystemSettingsView : UserControl
    {
        public SystemSettingsView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<SystemSettingsViewModel>();
        }

        private void SystemSettingsView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is SystemSettingsViewModel viewModel && viewModel.LoadSettingsCommand.CanExecute(null)) // Use LoadSettingsCommand
            {
                viewModel.LoadSettingsCommand.Execute(null); // Use LoadSettingsCommand
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\TaskManagementView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.TaskManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="900"
             Loaded="TaskManagementView_OnLoaded">

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="1*"/>
        </Grid.ColumnDefinitions>

        <GroupBox Grid.Column="0" Header="Daily Task Definitions">
            <DataGrid ItemsSource="{Binding Tasks}" AutoGenerateColumns="False" IsReadOnly="True"
                      RowStyle="{StaticResource StandardDataGridRowStyle}">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Task Name" Binding="{Binding TaskName}" Width="2*"/>
                    <DataGridTextColumn Header="Schedule" Binding="{Binding ScheduleType}" Width="*"/>
                    <DataGridTextColumn Header="Value" Binding="{Binding ScheduleValue}" Width="*"/>
                    <DataGridTextColumn Header="Shift ID" Binding="{Binding ShiftID}" Width="*"/>
                    <DataGridCheckBoxColumn Header="Active" Binding="{Binding IsActive}" Width="50"/>

                    <!-- New Actions Column -->
                    <DataGridTemplateColumn Header="Actions" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="Delete" 
                                        Background="IndianRed" 
                                        Foreground="White"
                                        Command="{Binding DataContext.DeleteTaskCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>

        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" Background="LightGray"/>

        <StackPanel Grid.Column="2" Margin="10,0,0,0">
            <TextBlock Text="Add New Task" FontSize="18" FontWeight="Bold" Margin="0,0,0,15"/>

            <Label Content="Task Name"/>
            <TextBox Text="{Binding NewTaskName}" Margin="0,0,0,10"/>

            <Label Content="Assign to Shift"/>
            <ComboBox ItemsSource="{Binding Shifts}" 
                      SelectedItem="{Binding SelectedShift}"
                      DisplayMemberPath="ShiftName"
                      Margin="0,0,0,10"/>

            <Label Content="Schedule Type"/>
            <ComboBox ItemsSource="{Binding ScheduleTypes}" 
                      SelectedItem="{Binding SelectedScheduleType}"
                      Margin="0,0,0,10"/>

            <Label Content="Schedule Value (Optional)"/>
            <ComboBox ItemsSource="{Binding DaysOfWeek}" 
                      SelectedItem="{Binding ScheduleValue}"
                      mah:TextBoxHelper.Watermark="Select Day (if Weekly)"
                      Margin="0,0,0,20"/>

            <Button Content="Create Task" 
                    Command="{Binding SaveTaskCommand}" 
                    Style="{DynamicResource MahApps.Styles.Button.Accent}"/>
        </StackPanel>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\TaskManagementView.xaml.cs
========================================
using Mirage.UI.ViewModels;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for TaskManagementView.xaml
    /// </summary>
    public partial class TaskManagementView : UserControl
    {
        public TaskManagementView()
        {
            InitializeComponent();
        }

        private void TaskManagementView_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (this.DataContext is TaskManagementViewModel viewModel)
            {
                // Triggers the data load every time you open the tab
                if (viewModel.LoadDataCommand.CanExecute(null))
                {
                    viewModel.LoadDataCommand.Execute(null);
                }
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\UserManagementView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.UserManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">

    

    <UserControl.Resources>
        <Style x:Key="StandardDataGridRowStyle" TargetType="DataGridRow" BasedOn="{StaticResource MahApps.Styles.DataGridRow}">
            <Style.Triggers>
                <Trigger Property="AlternationIndex" Value="1">
                    <Setter Property="Background" Value="#F9FAFB"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#E0F2F7"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Accent}"/>
                    <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.IdealForegroundColor}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <mah:FlyoutsControl Panel.ZIndex="1">
            <mah:Flyout Header="Create New User" 
                        IsOpen="{Binding IsCreateUserFlyoutOpen}" 
                        Position="Right" 
                        Width="400"
                        Background="{DynamicResource MahApps.Brushes.ThemeBackground}">
                <StackPanel Margin="20">
                    <Label Content="Username"/>
                    <TextBox Text="{Binding NewUsername}" Margin="0,0,0,10"/>

                    <Label Content="Password"/>
                    <PasswordBox x:Name="NewPasswordBox" Margin="0,0,0,10"/>

                    <Label Content="Full Name"/>
                    <TextBox Text="{Binding NewFullName}" Margin="0,0,0,20"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Save User" 
                                Command="{Binding SaveNewUserCommand}"
                                CommandParameter="{Binding ElementName=NewPasswordBox}" 
                                Style="{DynamicResource MahApps.Styles.Button.Accent}"
                                Width="120"/>
                        <Button Content="Cancel" 
                                Command="{Binding CancelCreateUserCommand}"
                                Margin="10,0,0,0"
                                Width="100"/>
                    </StackPanel>
                </StackPanel>
            </mah:Flyout>

            <mah:Flyout Header="Manage System Roles"
                        IsOpen="{Binding IsManageRolesFlyoutOpen}"
                        Position="Right"
                        Width="400"
                        Background="{DynamicResource MahApps.Brushes.ThemeBackground}">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <GroupBox Grid.Row="0" Header="Existing Roles">
                        <ListBox ItemsSource="{Binding AllRoles}" 
                                 DisplayMemberPath="RoleName" 
                                 Height="200"/>
                    </GroupBox>

                    <GroupBox Grid.Row="1" Header="Create New Role" Margin="0,15,0,0">
                        <StackPanel Margin="10">
                            <TextBox Text="{Binding NewRoleName, UpdateSourceTrigger=PropertyChanged}"
                                     mah:TextBoxHelper.Watermark="Enter new role name"
                                     Margin="0,0,0,10"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Create Role"
                                        Command="{Binding CreateNewRoleCommand}"
                                        Style="{DynamicResource MahApps.Styles.Button.Accent}"
                                        Width="120"/>
                                <Button Content="Cancel"
                                        Command="{Binding CancelManageRolesCommand}"
                                        Margin="10,0,0,0"
                                        Width="100"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                </Grid>
            </mah:Flyout>

            <mah:Flyout Header="Reset Password"
                        IsOpen="{Binding IsResetPasswordFlyoutOpen}"
                        Position="Right" 
                        Width="400" 
                        Background="{DynamicResource MahApps.Brushes.ThemeBackground}">
                <StackPanel Margin="20">
                    <TextBlock Text="You are resetting the password for:" Margin="0,0,0,2"/>
                    <TextBlock Text="{Binding SelectedUser.FullName}" FontWeight="Bold" FontSize="16" Margin="0,0,0,15"/>

                    <Label Content="New Password"/>
                    <PasswordBox x:Name="ResetPasswordBox" Margin="0,0,0,20"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Confirm Reset"
                                Command="{Binding ConfirmResetPasswordCommand}"
                                CommandParameter="{Binding ElementName=ResetPasswordBox}" 
                                Style="{DynamicResource MahApps.Styles.Button.Accent}"
                                Background="IndianRed"
                                Width="120"/>
                        <Button Content="Cancel"
                                Margin="10,0,0,0"
                                Width="100"
                                Command="{Binding CancelResetPasswordCommand}"/>
                    </StackPanel>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>

        <Grid Margin="20" Panel.ZIndex="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="20"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                    <Button Content="Create New User" 
                            Command="{Binding CreateUserCommand}"
                            Style="{DynamicResource MahApps.Styles.Button.Accent}"/>
                    <Button Content="Manage Roles" 
                            Margin="10,0,0,0" 
                            Command="{Binding ManageRolesCommand}"/>
                </StackPanel>
                <GroupBox Grid.Row="1" Header="Users">
                    <DataGrid ItemsSource="{Binding Users}"
                              SelectedItem="{Binding SelectedUser}"
                              RowStyle="{StaticResource StandardDataGridRowStyle}"
                              AutoGenerateColumns="False" 
                              IsReadOnly="True" 
                              AlternationCount="2">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="User ID" Binding="{Binding UserID}" Width="Auto"/>
                            <DataGridTextColumn Header="Username" Binding="{Binding Username}" Width="*"/>
                            <DataGridTextColumn Header="Full Name" Binding="{Binding FullName}" Width="2*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </GroupBox>
            </Grid>

            <StackPanel Grid.Column="2">
                <GroupBox Header="Manage Selected User">
                    <StackPanel Margin="10">
                        <TextBlock Text="{Binding SelectedUser.FullName, FallbackValue='No user selected', TargetNullValue='No user selected'}" 
                                   FontWeight="Bold"
                                   TextWrapping="Wrap"/>
                        <TextBlock Text="{Binding SelectedUser.Username, StringFormat='Username: {0}'}" 
                                   Margin="0,5,0,0"/>
                        <Label Content="Current Roles:" Margin="0,10,0,0"/>
                        <ListBox ItemsSource="{Binding SelectedUserRoles}" 
                                 Height="80" 
                                 Margin="0,5,0,0"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" 
                                                   Text="{Binding RoleName}" 
                                                   VerticalAlignment="Center"/>
                                        <Button Grid.Column="1" 
                                                Content="Remove" 
                                                FontSize="10"
                                                Margin="5,0,0,0"
                                                Command="{Binding DataContext.RemoveRoleCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                CommandParameter="{Binding}"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </StackPanel>
                </GroupBox>

                <GroupBox Header="Assign New Role" Margin="0,10,0,0">
                    <StackPanel Margin="10">
                        <Label Content="Select a Role:"/>
                        <ComboBox ItemsSource="{Binding AllRoles}" 
                                  SelectedItem="{Binding SelectedRoleToAssign}" 
                                  DisplayMemberPath="RoleName" 
                                  Margin="0,0,0,10"/>
                        <Button Content="Assign Role" 
                                Command="{Binding AssignRoleCommand}" 
                                IsEnabled="{Binding CanAssignRole}"
                                Style="{DynamicResource MahApps.Styles.Button.Accent}"/>
                    </StackPanel>
                </GroupBox>

                <Button Content="Reset Password" 
                        Margin="0,20,0,0" 
                        Command="{Binding ResetPasswordCommand}"
                        IsEnabled="{Binding CanManageSelectedUser}"
                        Style="{DynamicResource MahApps.Styles.Button.Danger}"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Views\UserManagementView.xaml.cs
========================================
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.ViewModels;
using System.Windows.Controls;

namespace Mirage.UI.Views
{
    public partial class UserManagementView : UserControl
    {
        public UserManagementView()
        {
            InitializeComponent();
            this.DataContext = App.ServiceProvider?.GetRequiredService<UserManagementViewModel>();
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\App.xaml
========================================
<Application x:Class="Mirage.UI.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Mirage.UI"
             xmlns:p="clr-namespace:Mirage.UI.Properties"
             >
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Controls.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Fonts.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Themes/Light.Blue.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Global Font Size Styles -->
            <Style TargetType="TextBlock">
                <Setter Property="FontSize" Value="{Binding Source={x:Static p:Settings.Default}, Path=AppFontSize, Mode=OneWay}"/>
            </Style>
            <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button}">
                <Setter Property="FontSize" Value="{Binding Source={x:Static p:Settings.Default}, Path=AppFontSize, Mode=OneWay}"/>
            </Style>
            <Style TargetType="Label" BasedOn="{StaticResource MahApps.Styles.Label}">
                <Setter Property="FontSize" Value="{Binding Source={x:Static p:Settings.Default}, Path=AppFontSize, Mode=OneWay}"/>
            </Style>

            <!-- Existing Custom Styles -->
            <Style x:Key="WrapTextDataGridStyle" TargetType="TextBlock">
                <Setter Property="TextWrapping" Value="Wrap"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="Padding" Value="5"/>
            </Style>

            <Style x:Key="StandardDataGridRowStyle" TargetType="DataGridRow" BasedOn="{StaticResource MahApps.Styles.DataGridRow}">
                <Style.Triggers>
                    <Trigger Property="AlternationIndex" Value="1">
                        <Setter Property="Background" Value="#F9FAFB"/>
                    </Trigger>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="#E0F2F7"/>
                    </Trigger>
                    <Trigger Property="IsSelected" Value="True">
                        <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Accent}"/>
                        <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.IdealForegroundColor}"/>
                    </Trigger>
                </Style.Triggers>
            </Style>

        </ResourceDictionary>
    </Application.Resources>
</Application>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\App.xaml.cs
========================================
using QuestPDF.Infrastructure;
using Mirage.UI.Services;
using Mirage.UI.ViewModels;
using Mirage.UI.Views;
using Microsoft.Extensions.DependencyInjection;
using Refit;
using System;
using System.Globalization;
using System.Threading;
using System.Windows;
using System.Windows.Markup;

namespace Mirage.UI
{
    public partial class App : Application
    {
        private static Mutex? _mutex = null; // <-- ADD THIS LINE

        public static IServiceProvider? ServiceProvider { get; private set; }

        protected override void OnStartup(StartupEventArgs e)
        {
            // --- SINGLE INSTANCE CHECK ---
            const string appName = "MiragePortal-9A8B7C6D-5E4F-4G3H-2I1J-K0L9M8N7O6P5";
            _mutex = new Mutex(true, appName, out bool createdNew);

            if (!createdNew)
            {
                // Another instance is already running.
                MessageBox.Show("Project Mirage is already running.", "Application Already Running", MessageBoxButton.OK, MessageBoxImage.Information);
                Application.Current.Shutdown();
                return; // Exit the startup process
            }
            // ---------------------------

            base.OnStartup(e);

            // --- ADD QUESTPDF LICENSE ---
            QuestPDF.Settings.License = LicenseType.Community;
            // ----------------------------

            // Set the custom date format for the entire application
            var cultureInfo = new CultureInfo("en-GB");
            var customCulture = (CultureInfo)cultureInfo.Clone();
            customCulture.DateTimeFormat.ShortDatePattern = "dd/MMM/yy";
            Thread.CurrentThread.CurrentCulture = customCulture;
            Thread.CurrentThread.CurrentUICulture = customCulture;
            FrameworkElement.LanguageProperty.OverrideMetadata(
                typeof(FrameworkElement),
                new FrameworkPropertyMetadata(XmlLanguage.GetLanguage(customCulture.IetfLanguageTag))
            );

            // Configure our services for dependency injection
            var serviceCollection = new ServiceCollection();
            ConfigureServices(serviceCollection);
            ServiceProvider = serviceCollection.BuildServiceProvider();

            // Manually open the Login window
            var loginView = ServiceProvider.GetRequiredService<LoginView>();
            loginView.Show();
        }

        private void ConfigureServices(IServiceCollection services)
        {
            // --- Central Services ---
            services.AddSingleton<IAuthService, AuthService>();

            // --- API Clients ---
            // Main PortalMirage API
            //5288 for local dev for now - to be replaced with proper config management later (7210 was in use before https)
            services.AddRefitClient<IPortalMirageApi>()
                    .ConfigureHttpClient(c => c.BaseAddress = new Uri("http://localhost:5288"));

            // External Patient Info API
            services.AddRefitClient<PatientInfo.Api.Sdk.IPatientInfoApi>()
                    .ConfigureHttpClient(c => c.BaseAddress = new Uri("http://localhost:5104"));
            // Add this line to register your new PDF service
            services.AddSingleton<IPdfExportService, PdfExportService>();

            // --- ViewModels (Registered as Singletons to preserve state) ---
            services.AddSingleton<MainViewModel>();
            services.AddSingleton<LoginViewModel>(); // Critical - was missing
            services.AddSingleton<DashboardViewModel>();
            services.AddSingleton<LogbooksViewModel>();
            services.AddSingleton<ReportsViewModel>();
            services.AddSingleton<AdminViewModel>();
            services.AddSingleton<SettingsViewModel>();
            services.AddSingleton<UserManagementViewModel>();
            services.AddSingleton<ShiftManagementViewModel>();
            services.AddSingleton<MasterListViewModel>();
            services.AddSingleton<AuditLogViewModel>();
            services.AddSingleton<CalibrationLogViewModel>();
            services.AddSingleton<KitValidationViewModel>();
            services.AddSingleton<SampleStorageViewModel>();
            services.AddSingleton<HandoverViewModel>();
            services.AddSingleton<MachineBreakdownViewModel>();
            services.AddSingleton<MediaSterilityViewModel>();
            services.AddSingleton<RepeatSampleViewModel>();
            services.AddSingleton<DailyTaskLogViewModel>();
            services.AddSingleton<IInactivityService, InactivityService>();
            services.AddSingleton<SystemSettingsViewModel>();
            services.AddSingleton<TaskManagementViewModel>();
            services.AddTransient<TaskManagementView>();

            // --- Views (Registered as Transient so a new one is created each time) ---
            services.AddTransient<LoginView>();
            services.AddTransient<MainWindow>();

            // Additional Views for complete coverage
            services.AddTransient<DashboardView>();
            services.AddTransient<HandoverView>();
            services.AddTransient<MachineBreakdownView>();
            services.AddTransient<DailyTaskLogView>();
            services.AddTransient<SampleStorageView>();
            services.AddTransient<AuditLogView>();
            services.AddTransient<CalibrationLogView>();
            services.AddTransient<KitValidationView>();
            services.AddTransient<MediaSterilityView>();
            services.AddTransient<RepeatSampleView>();
            services.AddTransient<UserManagementView>();
            services.AddTransient<ShiftManagementView>();
            services.AddTransient<MasterListView>();
            services.AddTransient<AdminView>();
            services.AddTransient<LogbooksView>();
            services.AddTransient<ReportsView>();
            services.AddTransient<SettingsView>();
        }

        protected override void OnExit(ExitEventArgs e)
        {
            // Clean up service provider
            (ServiceProvider as IDisposable)?.Dispose();

            // Release the mutex
            _mutex?.ReleaseMutex();
            _mutex?.Dispose();

            base.OnExit(e);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\AssemblyInfo.cs
========================================
using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\MainWindow.xaml
========================================
<mah:MetroWindow x:Class="Mirage.UI.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:Mirage.UI"
    xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
    xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
    mc:Ignorable="d"
    Title="Portal Mirage" Height="720" Width="1280"
    WindowStartupLocation="CenterScreen"
    TitleCharacterCasing="Normal">

    <mah:HamburgerMenu
        x:Name="HamburgerMenuControl"
        DisplayMode="CompactInline"
        IsPaneOpen="True"
        ItemsSource="{Binding MenuItems}"
        OptionsItemsSource="{Binding OptionsMenuItems}"
        SelectedItem="{Binding SelectedMenuItem}"
        SelectedOptionsItem="{Binding SelectedOptionsMenuItem}">

        <mah:HamburgerMenu.ItemTemplate>
            <DataTemplate>
                <Grid Height="48">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48" />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" 
                               Text="{Binding Icon}"
                               FontSize="20" 
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Center" />
                    <TextBlock Grid.Column="1" VerticalAlignment="Center" FontSize="16" Text="{Binding Label}" />
                </Grid>
            </DataTemplate>
        </mah:HamburgerMenu.ItemTemplate>

        <mah:HamburgerMenu.OptionsItemTemplate>
            <DataTemplate>
                <Grid Height="48">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48" />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" 
                               Text="{Binding Icon}"
                               FontSize="20" 
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Center" />
                    <TextBlock Grid.Column="1" VerticalAlignment="Center" FontSize="16" Text="{Binding Label}" />
                </Grid>
            </DataTemplate>
        </mah:HamburgerMenu.OptionsItemTemplate>

        <mah:HamburgerMenu.Content>
            <Grid>
                <ContentControl Content="{Binding CurrentView}" />

                <TextBlock Text="{Binding CurrentUser.FullName}"
                           IsHitTestVisible="False"
                           FontSize="12"
                           FontWeight="Normal"
                           Opacity="0.3"
                           VerticalAlignment="Bottom"
                           HorizontalAlignment="Right"
                           Margin="0,0,10,5"/>
            </Grid>
        </mah:HamburgerMenu.Content>

    </mah:HamburgerMenu>
</mah:MetroWindow>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\MainWindow.xaml.cs
========================================
using MahApps.Metro.Controls;
using Microsoft.Extensions.DependencyInjection;
using Mirage.UI.Services;
using Mirage.UI.ViewModels;
using System.Windows.Input;

namespace Mirage.UI
{
    public partial class MainWindow : MetroWindow
    {
        private readonly IInactivityService _inactivityService;

        // The constructor now receives the InactivityService and MainViewModel
        public MainWindow(IInactivityService inactivityService, MainViewModel viewModel)
        {
            InitializeComponent();

            // Store the service
            _inactivityService = inactivityService;

            // Assign the ViewModel to the DataContext
            this.DataContext = viewModel;

            // Hook into the events to detect user activity
            this.PreviewMouseMove += MainWindow_PreviewInput;
            this.PreviewKeyDown += MainWindow_PreviewInput;
        }

        // This single method handles both mouse and keyboard events
        private void MainWindow_PreviewInput(object sender, InputEventArgs e)
        {
            // When the user is active, we reset the timer in our service
            _inactivityService.ResetTimer();
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI\Mirage.UI.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.0.0" />
    <PackageReference Include="MahApps.Metro" Version="2.4.10" />
    <PackageReference Include="Microsoft.Xaml.Behaviors.Wpf" Version="1.1.135" />
    <PackageReference Include="QuestPDF" Version="2025.7.2" />
    <PackageReference Include="Refit.HttpClientFactory" Version="8.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\PatientInfo.Api.Sdk\PatientInfo.Api.Sdk.csproj" />
    <ProjectReference Include="..\PortalMirage.Core\PortalMirage.Core.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="Properties\Settings.Designer.cs">
      <DesignTimeSharedInput>True</DesignTimeSharedInput>
      <AutoGen>True</AutoGen>
      <DependentUpon>Settings.settings</DependentUpon>
    </Compile>
  </ItemGroup>

  <ItemGroup>
    <None Update="Properties\Settings.settings">
      <Generator>SettingsSingleFileGenerator</Generator>
      <LastGenOutput>Settings.Designer.cs</LastGenOutput>
    </None>
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Services\IPortalMirageApi.cs
========================================
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace Mirage.UI.Services;

public interface IPortalMirageApi
{
    // === Login ===
    [Post("/api/auth/login")]
    Task<LoginResponse> LoginAsync([Body] LoginRequest loginRequest);

    // === Calibration Log ===
    [Post("/api/calibrationlogs")]
    Task<CalibrationLogResponse> CreateCalibrationLogAsync([Header("Authorization")] string token, [Body] CreateCalibrationLogRequest request);

    [Get("/api/calibrationlogs")]
    Task<List<CalibrationLogResponse>> GetCalibrationLogsAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    // === Kit Validation ===
    [Post("/api/kitvalidations")]
    Task<KitValidationResponse> CreateKitValidationAsync([Header("Authorization")] string token, [Body] CreateKitValidationRequest request);

    [Get("/api/kitvalidations")]
    Task<List<KitValidationResponse>> GetKitValidationsAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    // === Sample Storage ===
    [Post("/api/samplestorage")]
    Task<SampleStorageResponse> CreateSampleAsync([Header("Authorization")] string token, [Body] CreateSampleStorageRequest request);

    [Get("/api/samplestorage/pending")]
    Task<List<SampleStorageResponse>> GetPendingSamplesAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Put("/api/samplestorage/{id}/done")]
    Task MarkSampleAsDoneAsync([Header("Authorization")] string token, int id);

    // ... inside the IPortalMirageApi interface ...

    [Get("/api/samplestorage/completed")]
    Task<List<SampleStorageResponse>> GetCompletedSamplesAsync([Header("Authorization")] string token, [Query] DateTime startDate, [Query] DateTime endDate);

    [Delete("/api/samplestorage/{id}")]
    Task DeactivateSampleAsync([Header("Authorization")] string token, int id);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\ViewModels\CalibrationLogViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.Windows;
using PortalMirage.Core.Dtos;

namespace Mirage.UI.ViewModels;

public partial class CalibrationLogViewModel : ObservableObject
{
    // This will hold our token for API calls
    // In a real app, this would be stored more securely.
    public static string? AuthToken { get; set; }

    private readonly IPortalMirageApi _apiClient;

    // Properties for the data entry form
    [ObservableProperty]
    private string? _selectedTestName;

    [ObservableProperty]
    private string? _selectedQcResult;

    [ObservableProperty]
    private string? _reason;

    // Properties for the search and data grid
    [ObservableProperty]
    private DateTime _startDate = DateTime.Today;

    [ObservableProperty]
    private DateTime _endDate = DateTime.Today;

    public ObservableCollection<CalibrationLogResponse> Logs { get; } = new();

    // Options for the ComboBoxes
    public ObservableCollection<string> TestNames { get; } = new();
    public ObservableCollection<string> QcResults { get; } = new();


    public CalibrationLogViewModel()
    {
        _apiClient = RestService.For<IPortalMirageApi>("https://localhost:7210");

        // Populate the dropdown lists with options
        // Later, this could come from the API
        TestNames.Add("Vitros 250");
        TestNames.Add("Abbott Architect");
        TestNames.Add("Glucose Meter QC");

        QcResults.Add("Passed");
        QcResults.Add("Failed");

        // Load today's logs automatically
        LoadLogsCommand.Execute(null);
    }

    [RelayCommand]
    private async Task LoadLogs()
    {
        if (string.IsNullOrEmpty(AuthToken)) return;
        try
        {
            var logs = await _apiClient.GetCalibrationLogsAsync(AuthToken, StartDate, EndDate);
            Logs.Clear();
            foreach (var log in logs)
            {
                Logs.Add(log);
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to load logs: {ex.Message}");
        }
    }

    [RelayCommand]
    private async Task Save()
    {
        if (string.IsNullOrEmpty(AuthToken) || string.IsNullOrEmpty(SelectedTestName) || string.IsNullOrEmpty(SelectedQcResult))
        {
            MessageBox.Show("Test Name and QC Result are required.");
            return;
        }

        try
        {
            var request = new CreateCalibrationLogRequest(SelectedTestName, SelectedQcResult, Reason);
            await _apiClient.CreateCalibrationLogAsync(AuthToken, request);

            // Success! Clear the form and reload the grid
            Clear();
            await LoadLogs();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Failed to save log: {ex.Message}");
        }
    }

    [RelayCommand]
    private void Clear()
    {
        SelectedTestName = null;
        SelectedQcResult = null;
        Reason = string.Empty;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\ViewModels\KitValidationViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.Windows;
using System.Xml.Linq;
using PortalMirage.Core.Dtos;

namespace Mirage.UI.ViewModels;

public partial class KitValidationViewModel : ObservableObject
{
    public static string? AuthToken { get; set; }
    private readonly IPortalMirageApi _apiClient;

    [ObservableProperty] private string _kitName = string.Empty;
    [ObservableProperty] private string _kitLotNumber = string.Empty;
    [ObservableProperty] private DateTime? _kitExpiryDate = DateTime.Today.AddMonths(6);
    [ObservableProperty] private string? _selectedValidationStatus;
    [ObservableProperty] private string? _comments;

    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;

    public ObservableCollection<KitValidationResponse> Logs { get; } = new();
    public ObservableCollection<string> ValidationStatuses { get; } = new();

    public KitValidationViewModel()
    {
        _apiClient = RestService.For<IPortalMirageApi>("https://localhost:7210");
        ValidationStatuses.Add("Accepted");
        ValidationStatuses.Add("Rejected");
        LoadLogsCommand.Execute(null);
    }

    [RelayCommand]
    private async Task LoadLogs()
    {
        if (string.IsNullOrEmpty(AuthToken)) return;
        try
        {
            var logs = await _apiClient.GetKitValidationsAsync(AuthToken, StartDate, EndDate);
            Logs.Clear();
            foreach (var log in logs) Logs.Add(log);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load logs: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task Save()
    {
        if (string.IsNullOrEmpty(AuthToken) || string.IsNullOrEmpty(KitName) || string.IsNullOrEmpty(KitLotNumber) || KitExpiryDate is null || string.IsNullOrEmpty(SelectedValidationStatus))
        {
            MessageBox.Show("All fields except comments are required.");
            return;
        }
        try
        {
            var request = new CreateKitValidationRequest(KitName, KitLotNumber, KitExpiryDate.Value, SelectedValidationStatus, Comments);
            await _apiClient.CreateKitValidationAsync(AuthToken, request);
            Clear();
            await LoadLogs();
        }
        catch (Exception ex) { MessageBox.Show($"Failed to save log: {ex.Message}"); }
    }

    [RelayCommand]
    private void Clear()
    {
        KitName = string.Empty;
        KitLotNumber = string.Empty;
        KitExpiryDate = DateTime.Today.AddMonths(6);
        SelectedValidationStatus = null;
        Comments = string.Empty;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\ViewModels\LoginViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using Refit;
using System;
using System.Threading.Tasks;
using System.Windows;
using PortalMirage.Core.Dtos;

namespace Mirage.UI.ViewModels;

public partial class LoginViewModel : ObservableObject
{
    [ObservableProperty]
    private string _username = string.Empty;

    [ObservableProperty]
    private string _errorMessage = string.Empty;

    public Action<Window>? CloseWindowAction { get; set; }

    [RelayCommand]
    private async Task Login(object? parameter)
    {
        if (parameter is not System.Windows.Controls.PasswordBox passwordBox) return;
        var password = passwordBox.Password;

        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(password))
        {
            ErrorMessage = "Username and password are required.";
            return;
        }

        ErrorMessage = string.Empty;

        try
        {
            var apiClient = RestService.For<IPortalMirageApi>("https://localhost:7210");
            var loginRequest = new LoginRequest(Username, password);
            var loginResponse = await apiClient.LoginAsync(loginRequest);
            CalibrationLogViewModel.AuthToken = $"Bearer {loginResponse.Token}";
            KitValidationViewModel.AuthToken = $"Bearer {loginResponse.Token}"; // Add this line
            SampleStorageViewModel.AuthToken = $"Bearer {loginResponse.Token}"; // Add this line
            // If we get here, login was successful!
            // We'll store the token and user info later.

            // Open the main window
            var mainWindow = new MainWindow();
            mainWindow.Show();

            // Close the login window
            var loginWindow = Application.Current.Windows[0];
            CloseWindowAction?.Invoke(loginWindow);

        }
        catch (ApiException ex)
        {
            // Handle API errors (like 401 Unauthorized)
            ErrorMessage = $"Login failed. Please check your credentials. (Error: {ex.StatusCode})";
        }
        catch (Exception ex)
        {
            // Handle other errors (like network issues)
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\ViewModels\MainViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using Mirage.UI.Views;
using System;
using System.Collections.ObjectModel;
using CommunityToolkit.Mvvm.Input;

namespace Mirage.UI.ViewModels;

public partial class MainViewModel : ObservableObject
{
    [ObservableProperty]
    private object? _currentView;

    [ObservableProperty]
    private NavigationItem? _selectedMenuItem;

    public ObservableCollection<NavigationItem> MenuItems { get; } = new();
    public ObservableCollection<NavigationItem> OptionsMenuItems { get; } = new();

    public MainViewModel()
    {
        // Main navigation items
        MenuItems.Add(new NavigationItem("??", "Dashboard", typeof(DashboardView)));
        MenuItems.Add(new NavigationItem("??", "Logbooks", typeof(LogbooksView)));
        MenuItems.Add(new NavigationItem("??", "Reports", typeof(ReportsView)));
        MenuItems.Add(new NavigationItem("???", "Admin", typeof(AdminView)));

        // Bottom navigation items
        OptionsMenuItems.Add(new NavigationItem("??", "Settings", typeof(SettingsView)));

        // Set the default starting page
        SelectedMenuItem = MenuItems[0];
    }

    partial void OnSelectedMenuItemChanged(NavigationItem? value)
    {
        if (value?.DestinationViewModel is not null)
        {
            // Create an instance of the page and set it as the current view
            CurrentView = Activator.CreateInstance(value.DestinationViewModel);
        }
    }

    [RelayCommand]
    private void NavigateTo(Type destination)
    {
        if (destination is not null)
        {
            CurrentView = Activator.CreateInstance(destination);
            SelectedMenuItem = null; // Add this line to de-select the main menu
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\ViewModels\NavigationItem.cs
========================================
using System;

namespace Mirage.UI.ViewModels;

public record NavigationItem(string Icon, string Label, Type DestinationViewModel);


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\ViewModels\SampleStorageViewModel.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Mirage.UI.Services;
using PortalMirage.Core.Dtos;
using Refit;
using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;

namespace Mirage.UI.ViewModels;

public partial class SampleStorageViewModel : ObservableObject
{
    public static string? AuthToken { get; set; }
    private readonly IPortalMirageApi _apiClient;

    [ObservableProperty] private string _newPatientSampleId = string.Empty;
    [ObservableProperty] private string _newTestName = string.Empty;
    [ObservableProperty] private DateTime _startDate = DateTime.Today;
    [ObservableProperty] private DateTime _endDate = DateTime.Today;

    [ObservableProperty] private string _activeView = "Pending"; // To control which grid is visible

    public ObservableCollection<SampleStorageResponse> PendingSamples { get; } = new();
    public ObservableCollection<SampleStorageResponse> CompletedSamples { get; } = new();

    public SampleStorageViewModel()
    {
        _apiClient = RestService.For<IPortalMirageApi>("https://localhost:7210");
        LoadPendingCommand.Execute(null);
    }

    [RelayCommand]
    private async Task LoadPending()
    {
        if (string.IsNullOrEmpty(AuthToken)) return;
        try
        {
            var samples = await _apiClient.GetPendingSamplesAsync(AuthToken, StartDate, EndDate);
            PendingSamples.Clear();
            foreach (var sample in samples) PendingSamples.Add(sample);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load pending samples: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task LoadCompleted()
    {
        if (string.IsNullOrEmpty(AuthToken)) return;
        try
        {
            var samples = await _apiClient.GetCompletedSamplesAsync(AuthToken, StartDate, EndDate);
            CompletedSamples.Clear();
            foreach (var sample in samples) CompletedSamples.Add(sample);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to load completed samples: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task Add()
    {
        // ... (Add method remains the same)
        if (string.IsNullOrEmpty(AuthToken) || string.IsNullOrEmpty(NewPatientSampleId) || string.IsNullOrEmpty(NewTestName))
        {
            MessageBox.Show("Patient Sample ID and Test Name are required.");
            return;
        }
        try
        {
            var request = new CreateSampleStorageRequest(NewPatientSampleId, NewTestName);
            await _apiClient.CreateSampleAsync(AuthToken, request);
            NewPatientSampleId = string.Empty;
            NewTestName = string.Empty;
            await LoadPending();
        }
        catch (Exception ex) { MessageBox.Show($"Failed to add sample: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task MarkAsDone(int storageId)
    {
        // ... (MarkAsDone method remains the same)
        if (string.IsNullOrEmpty(AuthToken)) return;
        try
        {
            await _apiClient.MarkSampleAsDoneAsync(AuthToken, storageId);
            var itemToRemove = PendingSamples.FirstOrDefault(s => s.StorageID == storageId);
            if (itemToRemove != null) PendingSamples.Remove(itemToRemove);
        }
        catch (Exception ex) { MessageBox.Show($"Failed to mark as done: {ex.Message}"); }
    }

    [RelayCommand]
    private async Task Delete(int storageId)
    {
        if (string.IsNullOrEmpty(AuthToken)) return;
        if (MessageBox.Show("Are you sure you want to delete this entry? This action will be logged.", "Confirm Delete", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.No)
        {
            return;
        }
        try
        {
            await _apiClient.DeactivateSampleAsync(AuthToken, storageId);
            // Refresh whichever list is active
            if (ActiveView == "Pending") await LoadPending();
            else await LoadCompleted();
        }
        catch (Exception ex) { MessageBox.Show($"Failed to delete entry: {ex.Message}"); }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\AdminView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.AdminView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Admin Page" FontSize="48" FontWeight="Bold" 
               HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\AdminView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for AdminView.xaml
    /// </summary>
    public partial class AdminView : UserControl
    {
        public AdminView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\CalibrationLogView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.CalibrationLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">

    <UserControl.DataContext>
        <viewModels:CalibrationLogViewModel/>
    </UserControl.DataContext>

    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Column="0" Margin="0,0,20,0">
            <TextBlock Text="Calibration Log" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

            <Label Content="Test / Instrument Name"/>
            <ComboBox Margin="0,0,0,10" 
                      ItemsSource="{Binding TestNames}"
                      SelectedItem="{Binding SelectedTestName}"/>

            <Label Content="QC Result"/>
            <ComboBox Margin="0,0,0,10" 
                      ItemsSource="{Binding QcResults}"
                      SelectedItem="{Binding SelectedQcResult}"/>

            <Label Content="Reason / Comments (Optional)"/>
            <TextBox Margin="0,0,0,20" Height="100" TextWrapping="Wrap" AcceptsReturn="True"
                     Text="{Binding Reason}"/>

            <StackPanel Orientation="Horizontal">
                <Button Content="Save" Width="100" Command="{Binding SaveCommand}"
                        Style="{DynamicResource MahApps.Styles.Button.Accent}"/>

                <Button Content="Clear" Width="100" Margin="10,0,0,0" Command="{Binding ClearCommand}"/>
            </StackPanel>
        </StackPanel>

        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                <DatePicker SelectedDate="{Binding StartDate}"/>
                <Label Content="to" Margin="5,0"/>
                <DatePicker SelectedDate="{Binding EndDate}"/>
                <Button Content="Search" Margin="10,0,0,0" Command="{Binding LoadLogsCommand}"/>
            </StackPanel>

            <DataGrid Grid.Row="1" ItemsSource="{Binding Logs}" AutoGenerateColumns="False" IsReadOnly="True"
                      AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Date &amp; Time" Binding="{Binding CalibrationDateTime, StringFormat='g'}" Width="*"/>
                    <DataGridTextColumn Header="Test Name" Binding="{Binding TestName}" Width="2*"/>
                    <DataGridTextColumn Header="Result" Binding="{Binding QcResult}" Width="*"/>
                    <DataGridTextColumn Header="Performed By" Binding="{Binding PerformedByUsername}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\CalibrationLogView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for CalibrationLogView.xaml
    /// </summary>
    public partial class CalibrationLogView : UserControl
    {
        public CalibrationLogView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\DailyTaskLogView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.DailyTaskLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Daily Task Log Page" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\DailyTaskLogView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for DailyTaskLogView.xaml
    /// </summary>
    public partial class DailyTaskLogView : UserControl
    {
        public DailyTaskLogView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\DashboardView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Dashboard Page" FontSize="48" FontWeight="Bold" 
               HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\DashboardView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for DashboardView.xaml
    /// </summary>
    public partial class DashboardView : UserControl
    {
        public DashboardView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\HandoverView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.HandoverView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Handover Page" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\HandoverView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for HandoverView.xaml
    /// </summary>
    public partial class HandoverView : UserControl
    {
        public HandoverView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\KitValidationView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.KitValidationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">
    <UserControl.DataContext>
        <viewModels:KitValidationViewModel/>
    </UserControl.DataContext>

    <UserControl.Resources>
        <Style x:Key="StandardActionButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
            <Setter Property="mah:ControlsHelper.CornerRadius" Value="3"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#B0BEC5"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="2" Direction="270" Color="#CCCCCC" Opacity="0.4" BlurRadius="4"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#ECEFF1"/>
                    <Setter Property="BorderBrush" Value="#90A4AE"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#CFD8DC"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Column="0" Margin="0,0,20,0">
            <TextBlock Text="Kit Validation" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

            <Label Content="Kit Name"/>
            <TextBox Margin="0,0,0,10" Text="{Binding KitName}"/>

            <Label Content="Lot Number"/>
            <TextBox Margin="0,0,0,10" Text="{Binding KitLotNumber}"/>

            <Label Content="Expiry Date"/>
            <DatePicker Margin="0,0,0,10" SelectedDate="{Binding KitExpiryDate}"/>

            <Label Content="Validation Status"/>
            <ComboBox Margin="0,0,0,10" ItemsSource="{Binding ValidationStatuses}" SelectedItem="{Binding SelectedValidationStatus}"/>

            <Label Content="Comments (Optional)"/>
            <TextBox Margin="0,0,0,20" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Text="{Binding Comments}"/>

            <StackPanel Orientation="Horizontal">
                <Button Content="Save" Width="100" Style="{StaticResource StandardActionButtonStyle}" Command="{Binding SaveCommand}"/>
                <Button Content="Clear" Width="100" Margin="10,0,0,0" Style="{StaticResource StandardActionButtonStyle}" Command="{Binding ClearCommand}"/>
            </StackPanel>
        </StackPanel>

        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                <DatePicker SelectedDate="{Binding StartDate}"/>
                <Label Content="to" Margin="5,0"/>
                <DatePicker SelectedDate="{Binding EndDate}"/>
                <Button Content="Search" Margin="10,0,0,0" Command="{Binding LoadLogsCommand}"/>
            </StackPanel>

            <DataGrid Grid.Row="1" ItemsSource="{Binding Logs}" AutoGenerateColumns="False" IsReadOnly="True"
                      AlternationCount="2" AlternatingRowBackground="#F9FAFB">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Validated On" Binding="{Binding ValidationDateTime, StringFormat='g'}" Width="*"/>
                    <DataGridTextColumn Header="Kit Name" Binding="{Binding KitName}" Width="2*"/>
                    <DataGridTextColumn Header="Lot Number" Binding="{Binding KitLotNumber}" Width="*"/>
                    <DataGridTextColumn Header="Expiry" Binding="{Binding KitExpiryDate, StringFormat='d'}" Width="*"/>
                    <DataGridTextColumn Header="Status" Binding="{Binding ValidationStatus}" Width="*"/>
                    <DataGridTextColumn Header="Validated By" Binding="{Binding ValidatedByUsername}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\KitValidationView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for KitValidationView.xaml
    /// </summary>
    public partial class KitValidationView : UserControl
    {
        public KitValidationView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\LogbooksView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.LogbooksView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:fa="http://schemas.fontawesome.io/icons/"
             xmlns:views="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">

    <UserControl.Resources>
        <Style x:Key="LogbookTileButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
            <Setter Property="Background" Value="#E0F2F7"/>
            <Setter Property="Foreground" Value="#333333"/>
            <Setter Property="BorderBrush" Value="#B2EBF2"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="5">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="2" Direction="270" Color="#CCCCCC" Opacity="0.6" BlurRadius="4"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#B3E5FC"/>
                    <Setter Property="BorderBrush" Value="#81D4FA"/>
                    <Setter Property="mah:ControlsHelper.ContentCharacterCasing" Value="Normal"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#81D4FA"/>
                    <Setter Property="BorderBrush" Value="#4FC3F7"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Logbooks" FontSize="36" FontWeight="Light" Margin="0,0,0,20" Foreground="#333333"/>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <UniformGrid Columns="4" Rows="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:RepeatSampleView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Repeat Sample" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:KitValidationView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Kit Validation" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:CalibrationLogView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Calibration Log" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:SampleStorageView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Sample Storage" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:HandoverView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Handover Book" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:MachineBreakdownView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Machine Breakdown" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:MediaSterilityView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="??" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Media Sterility" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource LogbookTileButtonStyle}" Margin="10"
                        Command="{Binding DataContext.NavigateToCommand, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}}"
                        CommandParameter="{x:Type views:DailyTaskLogView}">
                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="?" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Daily Task Log" FontSize="16" HorizontalAlignment="Center" Margin="0,10,0,0" Foreground="#333333"/>
                    </StackPanel>
                </Button>
            </UniformGrid>
        </ScrollViewer>
    </Grid>
</UserControl>




========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\LogbooksView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for LogbooksView.xaml
    /// </summary>
    public partial class LogbooksView : UserControl
    {
        public LogbooksView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\LoginView.xaml
========================================
<mah:MetroWindow x:Class="Mirage.UI.Views.LoginView"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
                 xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
                 mc:Ignorable="d"
                 Title="Login - Portal Mirage" Height="450" Width="800"
                 WindowStartupLocation="CenterScreen"
                 WindowStyle="None" ResizeMode="NoResize">

    <mah:MetroWindow.DataContext>
        <viewModels:LoginViewModel/>
    </mah:MetroWindow.DataContext>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0" Background="#F0F4F8">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <Image Source="/Assets/logo 2023.png" Width="250" Margin="10"/>
                <TextBlock Text="Portal Mirage" FontSize="32" FontWeight="Bold" Foreground="#005A9C" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <Grid Grid.Column="1">
            <StackPanel Width="300" HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="Welcome Back" FontSize="28" FontWeight="Light" Margin="0,0,0,20"/>
                <TextBox mah:TextBoxHelper.Watermark="Username" Margin="0,10" FontSize="16"
                         Text="{Binding Username, UpdateSourceTrigger=PropertyChanged}"/>
                <PasswordBox x:Name="PasswordBox" mah:TextBoxHelper.Watermark="Password" Margin="0,10" FontSize="16"/>
                <Button Content="Login" Margin="0,20" Padding="10" FontSize="18" FontWeight="Bold" Background="#0078D7" Foreground="White"
                        Command="{Binding LoginCommand}"
                        CommandParameter="{Binding ElementName=PasswordBox}"/>
                <TextBlock Text="{Binding ErrorMessage}" Foreground="Red" TextAlignment="Center" 
                           Visibility="{Binding ErrorMessage, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>
        </Grid>
    </Grid>
</mah:MetroWindow>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\LoginView.xaml.cs
========================================
using MahApps.Metro.Controls;
using Mirage.UI.ViewModels;
using System.Windows;

namespace Mirage.UI.Views
{
    public partial class LoginView : MetroWindow
    {
        public LoginView()
        {
            InitializeComponent();
            if (DataContext is LoginViewModel vm)
            {
                vm.CloseWindowAction = (window) => window.Close();
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\MachineBreakdownView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.MachineBreakdownView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Machine Breakdown Page" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\MachineBreakdownView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for MachineBreakdownView.xaml
    /// </summary>
    public partial class MachineBreakdownView : UserControl
    {
        public MachineBreakdownView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\MediaSterilityView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.MediaSterilityView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Media Sterility Page" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\MediaSterilityView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for MediaSterilityView.xaml
    /// </summary>
    public partial class MediaSterilityView : UserControl
    {
        public MediaSterilityView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\RepeatSampleView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.RepeatSampleView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Repeat Sample Page" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\RepeatSampleView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for RepeatSampleView.xaml
    /// </summary>
    public partial class RepeatSampleView : UserControl
    {
        public RepeatSampleView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\ReportsView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.ReportsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Reports Page" FontSize="48" FontWeight="Bold" 
               HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\ReportsView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for ReportsView.xaml
    /// </summary>
    public partial class ReportsView : UserControl
    {
        public ReportsView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\SampleStorageView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.SampleStorageView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">
    <UserControl.DataContext>
        <viewModels:SampleStorageViewModel/>
    </UserControl.DataContext>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Sample Storage" FontSize="36" FontWeight="Light" Margin="0,0,0,20"/>

        <Grid Grid.Row="1" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal">
                <Label Content="New Sample ID:" VerticalAlignment="Center"/>
                <TextBox Text="{Binding NewPatientSampleId}" Width="150" Margin="5,0"/>
                <Label Content="Test Name:" VerticalAlignment="Center" Margin="10,0,0,0"/>
                <TextBox Text="{Binding NewTestName}" Width="150" Margin="5,0"/>
                <Button Content="Add Sample" Command="{Binding AddCommand}" Margin="10,0,0,0"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <DatePicker SelectedDate="{Binding StartDate}"/>
                <Label Content="to" Margin="5,0"/>
                <DatePicker SelectedDate="{Binding EndDate}"/>
                <Button Content="Search" Margin="10,0,0,0" Command="{Binding LoadPendingCommand}"/>
            </StackPanel>
        </Grid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,10">
            <RadioButton Content="Pending" GroupName="ViewToggle" IsChecked="{Binding ActiveView, ConverterParameter=Pending, Converter={StaticResource MahApps.Converters.StringToBooleanConverter}}"
                         Style="{StaticResource MahApps.Styles.ToggleButton}" Command="{Binding LoadPendingCommand}"/>
            <RadioButton Content="Completed" GroupName="ViewToggle" IsChecked="{Binding ActiveView, ConverterParameter=Completed, Converter={StaticResource MahApps.Converters.StringToBooleanConverter}}"
                         Style="{StaticResource MahApps.Styles.ToggleButton}" Margin="5,0,0,0" Command="{Binding LoadCompletedCommand}"/>
        </StackPanel>

        <DataGrid Grid.Row="3" ItemsSource="{Binding PendingSamples}" AutoGenerateColumns="False" IsReadOnly="True"
                  AlternationCount="2" AlternatingRowBackground="#F9FAFB"
                  Visibility="{Binding ActiveView, ConverterParameter=Pending, Converter={StaticResource MahApps.Converters.StringToVisibilityConverter}}">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Stored On" Binding="{Binding StorageDateTime, StringFormat='g'}" Width="*"/>
                <DataGridTextColumn Header="Sample ID" Binding="{Binding PatientSampleID}" Width="2*"/>
                <DataGridTextColumn Header="Test Name" Binding="{Binding TestName}" Width="2*"/>
                <DataGridTextColumn Header="Stored By" Binding="{Binding StoredByUsername}" Width="*"/>
                <DataGridTemplateColumn Header="Actions" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="Mark as Done" Margin="0,0,5,0"
                                        Command="{Binding DataContext.MarkAsDoneCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding StorageID}"/>
                                <Button Content="Delete" Background="IndianRed" Foreground="White"
                                        Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding StorageID}"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <DataGrid Grid.Row="3" ItemsSource="{Binding CompletedSamples}" AutoGenerateColumns="False" IsReadOnly="True"
                  AlternationCount="2" AlternatingRowBackground="#F9FAFB"
                  Visibility="{Binding ActiveView, ConverterParameter=Completed, Converter={StaticResource MahApps.Converters.StringToVisibilityConverter}}">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Completed On" Binding="{Binding TestDoneDateTime, StringFormat='g'}" Width="*"/>
                <DataGridTextColumn Header="Sample ID" Binding="{Binding PatientSampleID}" Width="2*"/>
                <DataGridTextColumn Header="Test Name" Binding="{Binding TestName}" Width="2*"/>
                <DataGridTextColumn Header="Completed By" Binding="{Binding TestDoneByUserID}" Width="*"/>
                <DataGridTemplateColumn Header="Actions" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Content="Delete" Background="IndianRed" Foreground="White"
                                    Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                    CommandParameter="{Binding StorageID}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</UserControl>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\SampleStorageView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for SampleStorageView.xaml
    /// </summary>
    public partial class SampleStorageView : UserControl
    {
        public SampleStorageView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\SettingsView.xaml
========================================
<UserControl x:Class="Mirage.UI.Views.SettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <TextBlock Text="Settings Page" FontSize="48" FontWeight="Bold" 
               HorizontalAlignment="Center" VerticalAlignment="Center"/>
    </Grid>
</UserControl>



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Views\SettingsView.xaml.cs
========================================
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace Mirage.UI.Views
{
    /// <summary>
    /// Interaction logic for SettingsView.xaml
    /// </summary>
    public partial class SettingsView : UserControl
    {
        public SettingsView()
        {
            InitializeComponent();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\App.xaml
========================================
<Application x:Class="Mirage.UI.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Mirage.UI"
             StartupUri="Views/LoginView.xaml">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Controls.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Fonts.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Converters.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Themes/Light.Blue.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Application.Resources>
</Application>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\App.xaml.cs
========================================
using System.Configuration;
using System.Data;
using System.Windows;

namespace Mirage.UI
{
    /// <summary>
    /// Interaction logic for App.xaml
    /// </summary>
    public partial class App : Application
    {
    }

}



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\AssemblyInfo.cs
========================================
using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]



========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\MainWindow.xaml
========================================
<mah:MetroWindow x:Class="Mirage.UI.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:Mirage.UI"
    xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
    xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
    mc:Ignorable="d"
    Title="Portal Mirage" Height="720" Width="1280"
    WindowStartupLocation="CenterScreen"
    TitleCharacterCasing="Normal">

    <mah:MetroWindow.DataContext>
        <viewModels:MainViewModel />
    </mah:MetroWindow.DataContext>

    <mah:HamburgerMenu
        x:Name="HamburgerMenuControl"
        DisplayMode="CompactInline"
        IsPaneOpen="True"
        ItemsSource="{Binding MenuItems}"
        OptionsItemsSource="{Binding OptionsMenuItems}"
        SelectedItem="{Binding SelectedMenuItem}">

        <mah:HamburgerMenu.ItemTemplate>
            <DataTemplate>
                <Grid Height="48">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48" />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" FontSize="22" HorizontalAlignment="Center" VerticalAlignment="Center" Text="{Binding Icon}" />
                    <TextBlock Grid.Column="1" VerticalAlignment="Center" FontSize="16" Text="{Binding Label}" />
                </Grid>
            </DataTemplate>
        </mah:HamburgerMenu.ItemTemplate>

        <mah:HamburgerMenu.OptionsItemTemplate>
            <DataTemplate>
                <Grid Height="48">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48" />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" FontSize="22" HorizontalAlignment="Center" VerticalAlignment="Center" Text="{Binding Icon}" />
                    <TextBlock Grid.Column="1" VerticalAlignment="Center" FontSize="16" Text="{Binding Label}" />
                </Grid>
            </DataTemplate>
        </mah:HamburgerMenu.OptionsItemTemplate>

        <mah:HamburgerMenu.Content>
            <ContentControl Content="{Binding CurrentView}" />
        </mah:HamburgerMenu.Content>
    </mah:HamburgerMenu>
</mah:MetroWindow>


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\MainWindow.xaml.cs
========================================
using MahApps.Metro.Controls;

namespace Mirage.UI
{
    public partial class MainWindow : MetroWindow
    {
        public MainWindow()
        {
            InitializeComponent();
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\Mirage.UI_old\Mirage.UI.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
  </PropertyGroup>

  <ItemGroup>
    <None Remove="Assets\logo 2023.png" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.4.0" />
    <PackageReference Include="MahApps.Metro" Version="2.4.10" />
    <PackageReference Include="Refit.HttpClientFactory" Version="8.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\PatientInfo.Api.Sdk\PatientInfo.Api.Sdk.csproj" />
    <ProjectReference Include="..\PortalMirage.Core\PortalMirage.Core.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Resource Include="Assets\logo 2023.png" />
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\Controllers\PatientInfoController.cs
========================================
using Microsoft.AspNetCore.Mvc;
using PatientInfo.Api.Dtos;
using PatientInfo.Api.Services;

namespace PatientInfo.Api.Controllers;

[ApiController]
[Route("/api/[controller]")]
public class PatientInfoController : ControllerBase
{
    private ILogger<PatientInfoController> _logger;
    private readonly IPatientInfoService _patientInfoService;

    public PatientInfoController(ILogger<PatientInfoController> logger, IPatientInfoService patientInfoService)
    {
        _logger = logger;
        _patientInfoService = patientInfoService;
    }

    [HttpPost("getbyhospitalnumber")]
    public ActionResult<PatientInfoDto> GetByHospitalNumber([FromBody] HospitalNumber hospitalNumber)
    {
        _logger.LogInformation("GetByHospitalNumber called with {HospitalNumber}", hospitalNumber.Value);
        var patientInfo = _patientInfoService.GetByHospitalNumber(hospitalNumber);
        if (patientInfo == null)
        {
            return NotFound();
        }
        return Ok(patientInfo);
    }

    [HttpPost("getbynationalId")]
    public ActionResult<PatientInfoDto> GetByNationalID([FromBody] NationalId hospitalNumber)
    {
        _logger.LogInformation("GetByNationalID called with {NationalId}", hospitalNumber.Value);
        var patientInfo = _patientInfoService.GetByNationalID(hospitalNumber);
        if (patientInfo == null)
        {
            return NotFound();
        }
        return Ok(patientInfo);
    }

}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\Dtos\HospitalNumber.cs
========================================
namespace PatientInfo.Api.Dtos;

public record HospitalNumber (int Value);



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\Dtos\NationalId.cs
========================================
namespace PatientInfo.Api.Dtos;

public record NationalId (string Value);



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\Dtos\PatientInfoDto.cs
========================================
namespace PatientInfo.Api.Dtos;

public class PatientInfoDto
{
    public string? NationalID { get; set; }
    public string? HospitalNumber { get; set; }
    public string? PatientName { get; set; }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\Services\IPatientInfoService.cs
========================================
using PatientInfo.Api.Controllers;
using PatientInfo.Api.Dtos;

namespace PatientInfo.Api.Services;

public interface IPatientInfoService
{
    PatientInfoDto? GetByHospitalNumber(HospitalNumber hospitalNumber);
    PatientInfoDto? GetByNationalID(NationalId nationalId);
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\Services\PatientInfoService.cs
========================================
using PatientInfo.Api.Controllers;
using PatientInfo.Api.Dtos;

namespace PatientInfo.Api.Services;

public class PatientInfoService : IPatientInfoService
{
    private List<PatientInfoDto> _demoData;

    public PatientInfoService()
    {
        _demoData = [
            new PatientInfoDto { NationalID = "A111111", HospitalNumber = "1111", PatientName = "John Doe" },
            new PatientInfoDto { NationalID = "A222222", HospitalNumber = "2222", PatientName = "Jane Smith" }
        ];
    }
    public PatientInfoDto? GetByHospitalNumber(HospitalNumber hospitalNumber)
    {
        return _demoData.FirstOrDefault(p => p.HospitalNumber == hospitalNumber.Value.ToString());
    }

    public PatientInfoDto? GetByNationalID(NationalId nationalId)
    {
        return _demoData.FirstOrDefault(p => p.NationalID == nationalId.Value);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\PatientInfo.Api.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api\Program.cs
========================================
using PatientInfo.Api.Services;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddTransient<IPatientInfoService, PatientInfoService>();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

app.UseAuthorization();

app.MapControllers();

app.Run();



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api.Sdk\Models\HospitalNumber.cs
========================================
namespace PatientInfo.Api.Sdk.Models;

/// <summary>
/// Represents the request body for getting a patient by hospital number.
/// </summary>
public record HospitalNumber(int Value);





========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api.Sdk\Models\NationalId.cs
========================================
namespace PatientInfo.Api.Sdk.Models;

/// <summary>
/// Represents the request body for getting a patient by national ID.
/// </summary>
public record NationalId(string? Value);





========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api.Sdk\Models\PatientInfoDto.cs
========================================
namespace PatientInfo.Api.Sdk.Models;

/// <summary>
/// Represents the patient information returned by the API.
/// </summary>
public record PatientInfoDto
(
    string? NationalID,
    string? HospitalNumber,
    string? PatientName
);





========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api.Sdk\IPatientInfoApi.cs
========================================
using PatientInfo.Api.Sdk.Models;
using Refit;

namespace PatientInfo.Api.Sdk;

/// <summary>
/// Refit interface for interacting with the PatientInfo API.
/// </summary>
public interface IPatientInfoApi
{
    /// <summary>
    /// Retrieves patient information using their hospital number.
    /// </summary>
    /// <param name="hospitalNumber">The hospital number payload.</param>
    /// <returns>A PatientInfoDto object.</returns>
    [Post("/api/PatientInfo/getbyhospitalnumber")]
    Task<PatientInfoDto> GetByHospitalNumberAsync([Body] HospitalNumber hospitalNumber);

    /// <summary>
    /// Retrieves patient information using their national ID.
    /// </summary>
    /// <param name="nationalId">The national ID payload.</param>
    /// <returns>A PatientInfoDto object.</returns>
    [Post("/api/PatientInfo/getbynationalId")]
    Task<PatientInfoDto> GetByNationalIdAsync([Body] NationalId nationalId);
}





========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api.Sdk\PatientInfo.Api.Sdk.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Refit" Version="8.0.0" />
    <PackageReference Include="Refit.HttpClientFactory" Version="8.0.0" />
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\PatientInfo.Api.Sdk\ServiceCollectionExtensions.cs
========================================
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Refit;

namespace PatientInfo.Api.Sdk;

public static class ServiceCollectionExtensions
{
    /// <summary>
    /// Adds and configures the PatientInfo API client to the service collection.
    /// </summary>
    /// <param name="services">The IServiceCollection to add the client to.</param>
    /// <param name="configuration">The application configuration, used to retrieve the API base URL.</param>
    /// <returns>The IServiceCollection for chaining.</returns>
    /// <exception cref="InvalidOperationException">Thrown if the API base URL is not configured.</exception>
    public static IServiceCollection AddPatientInfoApiClient(this IServiceCollection services, IConfiguration configuration)
    {
        // Get the base URL from configuration (e.g., appsettings.json)
        var baseUrl = configuration["PatientInfoApi:BaseUrl"];

        if (string.IsNullOrWhiteSpace(baseUrl))
        {
            throw new InvalidOperationException(
                "The Base URL for the Patient Info API is not configured. " +
                "Please set 'PatientInfoApi:BaseUrl' in your configuration."
            );
        }

        // Add the Refit client to the dependency injection container
        services.AddRefitClient<IPatientInfoApi>()
                .ConfigureHttpClient(c => c.BaseAddress = new Uri(baseUrl));

        return services;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\AdminController.cs
========================================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Admin")] // Secure the entire controller for Admins
    public class AdminController(
        IUserService userService,
        IRoleService roleService,
        IUserRoleService userRoleService,
        IAuditLogService auditLogService) : ControllerBase
    {
        private readonly IAuditLogService _auditLogService = auditLogService;

        [HttpPost("users/create")]
        public async Task<IActionResult> CreateUser([FromBody] CreateUserRequest request)
        {
            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var newUser = await userService.RegisterUserAsync(request.Username, request.Password, request.FullName, actorUserId);

            if (newUser is null)
            {
                return BadRequest("Username is already taken.");
            }

            var userResponse = new UserResponse(newUser.UserID, newUser.Username, newUser.FullName);
            return CreatedAtAction(nameof(GetAllUsers), new { }, userResponse);
        }

        [HttpGet("users")]
        public async Task<ActionResult<IEnumerable<UserResponse>>> GetAllUsers()
        {
            var users = await userService.GetAllUsersAsync();
            var response = users.Select(u => new UserResponse(u.UserID, u.Username, u.FullName));
            return Ok(response);
        }

        [HttpGet("roles")]
        public async Task<ActionResult<IEnumerable<RoleResponse>>> GetAllRoles()
        {
            var roles = await roleService.GetAllRolesAsync();
            var response = roles.Select(r => new RoleResponse(r.RoleID, r.RoleName));
            return Ok(response);
        }

        [HttpPost("roles")] // NEW ENDPOINT
        public async Task<IActionResult> CreateRole([FromBody] CreateRoleRequest request)
        {
            var newRole = await roleService.CreateRoleAsync(request.RoleName);
            if (newRole is null)
            {
                return BadRequest("A role with this name already exists.");
            }
            var response = new RoleResponse(newRole.RoleID, newRole.RoleName);
            return CreatedAtAction(nameof(GetAllRoles), response);
        }

        [HttpGet("users/{username}/roles")]
        public async Task<ActionResult<IEnumerable<RoleResponse>>> GetRolesForUser(string username)
        {
            var roles = await userRoleService.GetRolesForUserAsync(username);
            var response = roles.Select(r => new RoleResponse(r.RoleID, r.RoleName));
            return Ok(response);
        }

        [HttpPost("users/reset-password")]
        public async Task<IActionResult> ResetPassword([FromBody] ResetPasswordRequest request)
        {
            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await userService.ResetPasswordAsync(request.Username, request.NewPassword, actorUserId);

            if (!success)
            {
                return NotFound("User not found.");
            }

            // The audit log is now handled by the service, so we don't need to log it here.
            return Ok("Password has been reset successfully.");
        }

        [HttpPost("assign-role")]
        public async Task<IActionResult> AssignRole([FromBody] AssignRoleRequest request)
        {
            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await userRoleService.AssignRoleToUserAsync(request.Username, request.RoleName, actorUserId);

            if (!success)
            {
                return BadRequest("Failed to assign role. Check if user and role exist.");
            }

            return Ok("Role assigned successfully.");
        }

        [HttpPost("remove-role")]
        public async Task<IActionResult> RemoveRoleFromUser([FromBody] AssignRoleRequest request)
        {
            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await userRoleService.RemoveRoleFromUserAsync(request.Username, request.RoleName, actorUserId);
            if (!success)
            {
                return BadRequest("Failed to remove role from user.");
            }
            return Ok("Role removed successfully.");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\AdminListsController.cs
========================================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/admin/lists")]
    [Authorize(Roles = "Admin")]
    public class AdminListsController(IAdminListService adminListService) : ControllerBase
    {
        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var items = await adminListService.GetAllAsync();
            return Ok(items);
        }

        [HttpGet("types")]
        public IActionResult GetListTypes()
        {
            // This hard-coded list is the single source of truth for our list types.
            var listTypes = new List<string>
            {
                "MachineName",
                "TestName",
                "KitName",
                "MediaName",
                "RepeatReason",
                "Department"
            };
            return Ok(listTypes.OrderBy(t => t));
        }

        [HttpGet("{listType}")]
        public async Task<IActionResult> GetByType(string listType)
        {
            var items = await adminListService.GetByTypeAsync(listType);
            return Ok(items);
        }

        [HttpPost]
        public async Task<IActionResult> Create([FromBody] CreateAdminListItemRequest request)
        {
            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!); // Get admin's ID
            var newItem = new AdminListItem
            {
                ListType = request.ListType,
                ItemValue = request.ItemValue,
                Description = request.Description,
                IsActive = true
            };
            var createdItem = await adminListService.CreateAsync(newItem, actorUserId); // Pass the ID
            return Ok(createdItem);
        }


        [HttpGet("setting/{itemValue}")]
        public async Task<IActionResult> GetSetting(string itemValue)
        {
            var setting = await adminListService.GetItemAsync("SystemSetting", itemValue);
            if (setting == null)
            {
                return NotFound();
            }
            return Ok(setting);
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] UpdateAdminListItemRequest request)
        {
            if (id != request.ItemID) return BadRequest("ID mismatch");

            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!); // Get admin's ID
            var itemToUpdate = new AdminListItem
            {
                ItemID = request.ItemID,
                ItemValue = request.ItemValue,
                Description = request.Description,
                IsActive = request.IsActive,
                ListType = "" // ListType is not updated, so it can be empty here
            };

            var updatedItem = await adminListService.UpdateAsync(itemToUpdate, actorUserId); // Pass the ID
            return Ok(updatedItem);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\AuditLogsController.cs
========================================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business.Abstractions;
using System;
using System.Threading.Tasks;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/auditlogs")]
    [Authorize(Roles = "Admin")]
    public class AuditLogsController(IAuditLogService auditLogService) : ControllerBase
    {
        [HttpGet]
        public async Task<IActionResult> GetByDateRange([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var logs = await auditLogService.GetByDateRangeAsync(startDate, endDate);
            return Ok(logs);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\AuthController.cs
========================================
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Core.Dtos; // This is the new, correct location
using PortalMirage.Business.Abstractions;
using Task = System.Threading.Tasks.Task;


namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController(IUserService userService, IJwtTokenGenerator jwtTokenGenerator) : ControllerBase
    {
        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] RegisterUserRequest request)
        {
            var newUser = await userService.RegisterUserAsync(request.Username, request.Password, request.FullName, null);

            if (newUser is null)
            {
                return BadRequest("Username is already taken.");
            }

            var userResponse = new UserResponse(newUser.UserID, newUser.Username, newUser.FullName);
            return Ok(userResponse);
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequest request)
        {
            var user = await userService.ValidateCredentialsAsync(request.Username, request.Password);

            if (user is null)
            {
                return Unauthorized("Invalid username or password.");
            }

            // Call the new async method with 'await'
            var token = await jwtTokenGenerator.GenerateTokenAsync(user);
            var userResponse = new UserResponse(user.UserID, user.Username, user.FullName);

            return Ok(new LoginResponse(token, userResponse));
        }
        
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\CalibrationLogsController.cs
========================================
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using System.Linq;
using PortalMirage.Core.Dtos;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class CalibrationLogsController(ICalibrationLogService calibrationLogService, IUserService userService) : ControllerBase
    {
        // ADD THIS ENTIRE METHOD
        [HttpPost]
        public async Task<ActionResult<CalibrationLogResponse>> Create([FromBody] CreateCalibrationLogRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var logToCreate = new CalibrationLog
            {
                TestName = request.TestName,
                QcResult = request.QcResult,
                Reason = request.Reason,
                PerformedByUserID = userId
            };

            var newLog = await calibrationLogService.CreateAsync(logToCreate);
            var user = await userService.GetUserByIdAsync(userId);
            var response = new CalibrationLogResponse(
                newLog.CalibrationID,
                newLog.TestName,
                newLog.QcResult,
                newLog.Reason,
                newLog.CalibrationDateTime,
                newLog.PerformedByUserID,
                user?.FullName ?? "Unknown"
            );
            return Ok(response);
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<CalibrationLogResponse>>> GetLogsByDateRange([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var logs = await calibrationLogService.GetByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            var response = logs.Select(log => new CalibrationLogResponse(
                log.CalibrationID,
                log.TestName,
                log.QcResult,
                log.Reason,
                log.CalibrationDateTime,
                log.PerformedByUserID,
                users.TryGetValue(log.PerformedByUserID, out var user) ? user.FullName : "Unknown"
            ));

            return Ok(response);
        }

        [HttpPut("{id}/deactivate")]
        public async Task<IActionResult> Deactivate(int id, [FromBody] DeactivateCalibrationLogRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await calibrationLogService.DeactivateAsync(id, userId, request.Reason);
            if (!success)
            {
                return NotFound("Log not found or already deactivated.");
            }
            return Ok("Log deactivated successfully.");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\DailyTaskLogsController.cs
========================================
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Core.Dtos;
using PortalMirage.Business.Abstractions;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/dailytasklogs")]
    [Authorize]
    public class DailyTaskLogsController(IDailyTaskLogService dailyTaskLogService) : ControllerBase
    {
        [HttpGet]
        public async Task<IActionResult> GetForDate([FromQuery] DateTime date)
        {
            var tasks = await dailyTaskLogService.GetTasksForDateAsync(date);
            return Ok(tasks);
        }

        [HttpPut("{id}/extend")]
        [Authorize(Roles = "Admin")] // Only Admins can extend deadlines
        public async Task<IActionResult> ExtendDeadline(long id, [FromBody] ExtendTaskDeadlineRequest request)
        {
            var adminUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var updatedLog = await dailyTaskLogService.ExtendTaskDeadlineAsync(id, request.NewDeadline, request.Reason, adminUserId);

            if (updatedLog is null)
            {
                return NotFound("Task log not found or could not be extended.");
            }

            return Ok(updatedLog);
        }

        [HttpPut("{id}/status")]
        public async Task<IActionResult> UpdateStatus(long id, [FromBody] UpdateTaskStatusRequest request)
        {
            // --- CRASH PROOF WRAPPER ---
            try
            {
                // 1. TRUST THE CLIENT: Use the ID sent from the App
                int userId = request.UserId;

                // 2. FALLBACK: Only look at token if Client sent 0
                if (userId <= 0)
                {
                    // Safe lookup that won't crash
                    var claimId = User.FindFirstValue(ClaimTypes.NameIdentifier)
                                  ?? User.FindFirstValue("sub")
                                  ?? User.FindFirstValue("id");

                    if (!string.IsNullOrEmpty(claimId))
                    {
                        int.TryParse(claimId, out userId);
                    }
                }

                // 3. FINAL VALIDATION
                if (userId <= 0)
                {
                    // This message will appear in your App if ID is missing
                    return BadRequest("Server Error: User ID could not be identified from Request or Token.");
                }

                // 4. EXECUTE SERVICE
                var updatedTaskLog = await dailyTaskLogService.UpdateTaskStatusAsync(id, request.Status, userId, request.Comment);

                if (updatedTaskLog is null)
                {
                    return NotFound($"Task log with ID {id} not found.");
                }

                return Ok(updatedTaskLog);
            }
            catch (Exception ex)
            {
                // 5. CATCH THE ERROR: Return the specific error message instead of '500'
                return StatusCode(500, $"CRITICAL FAILURE: {ex.Message} \n\n Stack Trace: {ex.StackTrace}");
            }
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\DashboardController.cs
========================================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business.Abstractions;
using System.Threading.Tasks;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class DashboardController(IDashboardService dashboardService) : ControllerBase
    {
        [HttpGet("summary")]
        public async Task<IActionResult> GetSummary()
        {
            var summary = await dashboardService.GetSummaryAsync();
            return Ok(summary);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\HandoversController.cs
========================================
using System.Linq;
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Core.Dtos;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class HandoversController(IHandoverService handoverService, IUserService userService) : ControllerBase
    {
        [HttpPost]
        public async Task<ActionResult<HandoverResponse>> Create([FromBody] CreateHandoverRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var handoverToCreate = new Handover
            {
                HandoverNotes = request.HandoverNotes,
                Priority = request.Priority,
                Shift = request.Shift,
                GivenByUserID = userId
            };

            var newHandover = await handoverService.CreateAsync(handoverToCreate);
            var user = await userService.GetUserByIdAsync(userId);
            var response = MapToResponse(newHandover, user?.FullName ?? "Unknown", null);
            return Ok(response);
        }

        [HttpGet("pending")]
        public async Task<ActionResult<IEnumerable<HandoverResponse>>> GetPending([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var handovers = await handoverService.GetPendingAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            var response = handovers.Select(h => MapToResponse(h,
                users.TryGetValue(h.GivenByUserID, out var givenByUser) ? givenByUser.FullName : "Unknown",
                null // No one has received a pending item yet
            ));
            return Ok(response);
        }

        [HttpGet("completed")]
        public async Task<ActionResult<IEnumerable<HandoverResponse>>> GetCompleted([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var handovers = await handoverService.GetCompletedAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            var response = handovers.Select(h => MapToResponse(h,
                users.TryGetValue(h.GivenByUserID, out var givenByUser) ? givenByUser.FullName : "Unknown",
                h.ReceivedByUserID.HasValue && users.TryGetValue(h.ReceivedByUserID.Value, out var receivedByUser) ? receivedByUser.FullName : null
            ));
            return Ok(response);
        }

        [HttpPut("{id}/receive")]
        public async Task<IActionResult> MarkAsReceived(int id)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await handoverService.MarkAsReceivedAsync(id, userId);

            if (!success)
            {
                return NotFound("Handover not found or already received.");
            }
            return Ok("Handover marked as received.");
        }

        [HttpPut("{id}/deactivate")]
        public async Task<IActionResult> Deactivate(int id, [FromBody] DeactivateHandoverRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var handover = await handoverService.GetByIdAsync(id);

            if (handover is null) return NotFound();

            // Business Rule: If handover is already completed, only an Admin can deactivate it
            if (handover.IsReceived && !User.IsInRole("Admin"))
            {
                return Forbid("Only Admins can deactivate a completed handover.");
            }

            var success = await handoverService.DeactivateAsync(id, userId, request.Reason);
            if (!success)
            {
                return NotFound("Handover not found or already deactivated.");
            }
            return Ok("Handover deactivated successfully.");
        }

        private static HandoverResponse MapToResponse(Handover h, string givenBy, string? receivedBy)
        {
            return new HandoverResponse(h.HandoverID, h.HandoverNotes, h.Priority, h.Shift, h.GivenDateTime, h.GivenByUserID, givenBy, h.IsReceived, h.ReceivedDateTime, h.ReceivedByUserID, receivedBy);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\KitValidationsController.cs
========================================
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using System.Linq;
using PortalMirage.Core.Dtos;
using System.Threading.Tasks; // Add this using
using System.Collections.Generic; // Add this using
using System; // Add this using

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class KitValidationsController(IKitValidationService kitValidationService, IUserService userService) : ControllerBase
    {
        // ADD THIS ENTIRE METHOD
        [HttpPost]
        public async Task<ActionResult<KitValidationResponse>> Create([FromBody] CreateKitValidationRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var logToCreate = new KitValidation
            {
                KitName = request.KitName,
                KitLotNumber = request.KitLotNumber,
                KitExpiryDate = request.KitExpiryDate,
                ValidationStatus = request.ValidationStatus,
                Comments = request.Comments,
                ValidatedByUserID = userId
            };

            var newLog = await kitValidationService.CreateAsync(logToCreate);
            var user = await userService.GetUserByIdAsync(userId);
            var response = new KitValidationResponse(
                newLog.ValidationID,
                newLog.KitName,
                newLog.KitLotNumber,
                newLog.KitExpiryDate,
                newLog.ValidationStatus,
                newLog.Comments,
                newLog.ValidationDateTime,
                newLog.ValidatedByUserID,
                user?.FullName ?? "Unknown"
            );
            return Ok(response);
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<KitValidationResponse>>> GetByDateRange([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var logs = await kitValidationService.GetByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            var response = logs.Select(log => new KitValidationResponse(
                log.ValidationID,
                log.KitName,
                log.KitLotNumber,
                log.KitExpiryDate,
                log.ValidationStatus,
                log.Comments,
                log.ValidationDateTime,
                log.ValidatedByUserID,
                users.TryGetValue(log.ValidatedByUserID, out var user) ? user.FullName : "Unknown"
            ));

            return Ok(response);
        }

        [HttpPut("{id}/deactivate")]
        public async Task<IActionResult> Deactivate(int id, [FromBody] DeactivateKitValidationRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await kitValidationService.DeactivateAsync(id, userId, request.Reason);
            if (!success)
            {
                return NotFound("Log not found or already deactivated.");
            }
            return Ok("Log deactivated successfully.");
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\MachineBreakdownsController.cs
========================================
using System.Linq;
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Core.Dtos;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class MachineBreakdownsController(IMachineBreakdownService machineBreakdownService, IUserService userService) : ControllerBase
    {
        [HttpPost]
        public async Task<ActionResult<MachineBreakdownResponse>> Create([FromBody] CreateMachineBreakdownRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var breakdownToCreate = new MachineBreakdown
            {
                MachineName = request.MachineName,
                BreakdownReason = request.BreakdownReason,
                ReportedByUserID = userId
            };
            var newBreakdown = await machineBreakdownService.CreateAsync(breakdownToCreate);
            var user = await userService.GetUserByIdAsync(userId);
            var response = MapToResponse(newBreakdown, user?.FullName ?? "Unknown", null);
            return Ok(response);
        }

        [HttpGet("pending")]
        public async Task<ActionResult<IEnumerable<MachineBreakdownResponse>>> GetPending([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var breakdowns = await machineBreakdownService.GetPendingByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);
            var response = breakdowns.Select(b => MapToResponse(b,
                users.TryGetValue(b.ReportedByUserID, out var reportedByUser) ? reportedByUser.FullName : "Unknown",
                null));
            return Ok(response);
        }

        [HttpGet("resolved")]
        public async Task<ActionResult<IEnumerable<MachineBreakdownResponse>>> GetResolved([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var breakdowns = await machineBreakdownService.GetResolvedByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            var response = breakdowns.Select(b =>
            {
                var reportedBy = users.TryGetValue(b.ReportedByUserID, out var rbu) ? rbu.FullName : "Unknown";

                string? resolvedBy = null;
                if (b.ResolvedByUserID.HasValue && users.TryGetValue(b.ResolvedByUserID.Value, out var rsu))
                {
                    resolvedBy = rsu.FullName;
                }

                return MapToResponse(b, reportedBy, resolvedBy);
            });

            return Ok(response);
        }

        [HttpPut("{id}/deactivate")]
        public async Task<IActionResult> Deactivate(int id, [FromBody] DeactivateMachineBreakdownRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var breakdown = await machineBreakdownService.GetByIdAsync(id);

            if (breakdown is null) return NotFound();

            // Business Rule: If breakdown is already resolved, only an Admin can deactivate it
            if (breakdown.IsResolved && !User.IsInRole("Admin"))
            {
                return Forbid("Only Admins can deactivate a resolved issue.");
            }

            var success = await machineBreakdownService.DeactivateAsync(id, userId, request.Reason);
            if (!success)
            {
                return NotFound("Breakdown not found or already deactivated.");
            }
            return Ok("Breakdown deactivated successfully.");
        }

        [HttpPut("{id}/resolve")]
        public async Task<IActionResult> MarkAsResolved(int id, [FromBody] ResolveBreakdownRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await machineBreakdownService.MarkAsResolvedAsync(id, userId, request.ResolutionNotes);

            if (!success)
            {
                return NotFound("Breakdown not found or already resolved.");
            }

            return Ok("Breakdown marked as resolved.");
        }

        private static MachineBreakdownResponse MapToResponse(MachineBreakdown breakdown, string reportedByUsername, string? resolvedByUsername)
        {
            return new MachineBreakdownResponse(
                breakdown.BreakdownID, breakdown.MachineName, breakdown.BreakdownReason,
                breakdown.ReportedDateTime, breakdown.ReportedByUserID, reportedByUsername,
                breakdown.IsResolved, breakdown.ResolvedDateTime, breakdown.ResolvedByUserID,
                resolvedByUsername, breakdown.ResolutionNotes, breakdown.DowntimeMinutes);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\MediaSterilityChecksController.cs
========================================
using System.Linq;
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Core.Dtos;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class MediaSterilityChecksController(
        IMediaSterilityCheckService sterilityCheckService,
        IUserService userService) : ControllerBase
    {
        [HttpPost]
        public async Task<ActionResult<MediaSterilityCheckResponse>> Create([FromBody] CreateMediaSterilityCheckRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var logToCreate = new MediaSterilityCheck
            {
                MediaName = request.MediaName,
                MediaLotNumber = request.MediaLotNumber,
                MediaQuantity = request.MediaQuantity,
                Result37C = request.Result37C,
                Result25C = request.Result25C,
                Comments = request.Comments,
                PerformedByUserID = userId,
                OverallStatus = ""
            };

            var newLog = await sterilityCheckService.CreateAsync(logToCreate);
            var user = await userService.GetUserByIdAsync(userId);
            var response = MapToResponse(newLog, user?.FullName ?? "Unknown");
            return Ok(response);
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<MediaSterilityCheckResponse>>> GetByDateRange([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var logs = await sterilityCheckService.GetByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);
            var response = logs.Select(log => MapToResponse(log,
                users.TryGetValue(log.PerformedByUserID, out var user) ? user.FullName : "Unknown"));
            return Ok(response);
        }

        [HttpPut("{id}/deactivate")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> Deactivate(int id, [FromBody] DeactivateMediaSterilityCheckRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await sterilityCheckService.DeactivateAsync(id, userId, request.Reason);
            if (!success)
            {
                return NotFound("Log not found or already deactivated.");
            }
            return Ok("Log deactivated successfully.");
        }

        private static MediaSterilityCheckResponse MapToResponse(MediaSterilityCheck log, string username)
        {
            return new MediaSterilityCheckResponse(
                log.SterilityCheckID, log.MediaName, log.MediaLotNumber, log.MediaQuantity,
                log.Result37C, log.Result25C, log.OverallStatus, log.Comments,
                log.CheckDateTime, log.PerformedByUserID, username);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\RepeatSamplesController.cs
========================================
using System.Linq;
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Core.Dtos;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using System.Threading.Tasks;
using System;
using System.Collections.Generic;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/repeatsamples")]
    [Authorize]
    public class RepeatSamplesController(
        IRepeatSampleLogService repeatSampleLogService,
        IUserService userService) : ControllerBase
    {
        [HttpPost]
        public async Task<ActionResult<RepeatSampleResponse>> Create([FromBody] CreateRepeatSampleRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);

            var logToCreate = new RepeatSampleLog
            {
                PatientIdCardNumber = request.PatientIdCardNumber,
                PatientName = request.PatientName,
                ReasonText = request.ReasonText,
                InformedPerson = request.InformedPerson,
                Department = request.Department,
                LoggedByUserID = userId
            };

            var newLog = await repeatSampleLogService.CreateAsync(logToCreate);
            var user = await userService.GetUserByIdAsync(userId);
            var response = MapToResponse(newLog, user?.FullName ?? "Unknown");

            return Ok(response);
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<RepeatSampleResponse>>> GetByDateRange([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var logs = await repeatSampleLogService.GetByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            var response = logs.Select(log => MapToResponse(log,
                users.TryGetValue(log.LoggedByUserID, out var user) ? user.FullName : "Unknown"));

            return Ok(response);
        }

        [HttpPut("{id}/deactivate")]
        [Authorize(Roles = "Admin")] // Only Admins can deactivate
        public async Task<IActionResult> Deactivate(int id, [FromBody] DeactivateRepeatSampleRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await repeatSampleLogService.DeactivateAsync(id, userId, request.Reason);
            if (!success)
            {
                return NotFound("Log not found or already deactivated.");
            }
            return Ok("Log deactivated successfully.");
        }

        private static RepeatSampleResponse MapToResponse(RepeatSampleLog log, string username)
        {
            return new RepeatSampleResponse(
                log.RepeatID,
                log.PatientIdCardNumber,
                log.PatientName,
                log.ReasonText,
                log.InformedPerson,
                log.Department,
                log.LogDateTime,
                log.LoggedByUserID,
                username);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\ReportsController.cs
========================================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business.Abstractions;
using System;
using System.Threading.Tasks;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize] // All reports require the user to be logged in
    public class ReportsController(IReportService reportService) : ControllerBase
    {
        [HttpGet("machine-breakdowns")]
        public async Task<IActionResult> GetMachineBreakdownReport(
            [FromQuery] DateTime startDate,
            [FromQuery] DateTime endDate,
            [FromQuery] string? machineName,
            [FromQuery] string? status)
        {
            var reportData = await reportService.GetMachineBreakdownReportAsync(startDate, endDate, machineName, status);
            return Ok(reportData);
        }
        [HttpGet("kit-validations")] // ADD THIS NEW ENDPOINT
        public async Task<IActionResult> GetKitValidationReport(
        [FromQuery] DateTime startDate,
        [FromQuery] DateTime endDate,
        [FromQuery] string? kitName,
        [FromQuery] string? status)
        {
            var reportData = await reportService.GetKitValidationReportAsync(startDate, endDate, kitName, status);
            return Ok(reportData);
        }



        [HttpGet("handovers")] // ADD THIS NEW ENDPOINT
        public async Task<IActionResult> GetHandoverReport(
            [FromQuery] DateTime startDate,
            [FromQuery] DateTime endDate,
            [FromQuery] string? shift,
            [FromQuery] string? priority,
            [FromQuery] string? status)
        {
            var reportData = await reportService.GetHandoverReportAsync(startDate, endDate, shift, priority, status);
            return Ok(reportData);
        }

        [HttpGet("media-sterility")] // ADD THIS NEW ENDPOINT
        public async Task<IActionResult> GetMediaSterilityReport(
    [FromQuery] DateTime startDate,
    [FromQuery] DateTime endDate,
    [FromQuery] string? mediaName,
    [FromQuery] string? status)
        {
            var reportData = await reportService.GetMediaSterilityReportAsync(startDate, endDate, mediaName, status);
            return Ok(reportData);
        }


        [HttpGet("calibrations")] // ADD THIS NEW ENDPOINT
        public async Task<IActionResult> GetCalibrationReport(
    [FromQuery] DateTime startDate,
    [FromQuery] DateTime endDate,
    [FromQuery] string? testName,
    [FromQuery] string? qcResult)
        {
            var reportData = await reportService.GetCalibrationReportAsync(startDate, endDate, testName, qcResult);
            return Ok(reportData);
        }

        [HttpGet("sample-storage")] // ADD THIS NEW ENDPOINT
        public async Task<IActionResult> GetSampleStorageReport(
    [FromQuery] DateTime startDate,
    [FromQuery] DateTime endDate,
    [FromQuery] string? testName,
    [FromQuery] string? status)
        {
            var reportData = await reportService.GetSampleStorageReportAsync(startDate, endDate, testName, status);
            return Ok(reportData);
        }

        [HttpGet("repeat-samples")] // ADD THIS NEW ENDPOINT
        public async Task<IActionResult> GetRepeatSampleReport(
             [FromQuery] DateTime startDate,
             [FromQuery] DateTime endDate,
             [FromQuery] string? reason,
             [FromQuery] string? department)
        {
            var reportData = await reportService.GetRepeatSampleReportAsync(startDate, endDate, reason, department);
            return Ok(reportData);
        }
        [HttpGet("daily-task-compliance")] // ADD THIS NEW ENDPOINT
        public async Task<IActionResult> GetDailyTaskComplianceReport(
    [FromQuery] DateTime startDate,
    [FromQuery] DateTime endDate,
    [FromQuery] int? shiftId,
    [FromQuery] string? status)
        {
            var reportData = await reportService.GetDailyTaskComplianceReportAsync(startDate, endDate, shiftId, status);
            return Ok(reportData);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\SampleStorageController.cs
========================================
using System.Linq;
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Core.Dtos;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/samplestorage")]
    [Authorize]
    public class SampleStorageController(ISampleStorageService sampleStorageService, IUserService userService) : ControllerBase
    {
        [HttpPost]
        public async Task<ActionResult<SampleStorageResponse>> Create([FromBody] CreateSampleStorageRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var logToCreate = new SampleStorage { PatientSampleID = request.PatientSampleID, TestName = request.TestName, StoredByUserID = userId };
            var newLog = await sampleStorageService.CreateAsync(logToCreate);
            var user = await userService.GetUserByIdAsync(userId);

            // This is the corrected line
            var response = MapToResponse(newLog, user?.FullName ?? "Unknown", null);

            return Ok(response);
        }

        [HttpGet("pending")]
        public async Task<ActionResult<IEnumerable<SampleStorageResponse>>> GetPending([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var logs = await sampleStorageService.GetPendingByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            // This is the corrected line
            var response = logs.Select(log => MapToResponse(log,
                users.TryGetValue(log.StoredByUserID, out var user) ? user.FullName : "Unknown",
                null));

            return Ok(response);
        }

        [HttpGet("completed")]
        public async Task<ActionResult<IEnumerable<SampleStorageResponse>>> GetCompleted([FromQuery] DateTime startDate, [FromQuery] DateTime endDate)
        {
            var logs = await sampleStorageService.GetCompletedByDateRangeAsync(startDate, endDate);
            var users = (await userService.GetAllUsersAsync()).ToDictionary(u => u.UserID);

            var response = logs.Select(log => MapToResponse(
                log,
                users.TryGetValue(log.StoredByUserID, out var storedByUser) ? storedByUser.FullName : "Unknown",
                log.TestDoneByUserID.HasValue && users.TryGetValue(log.TestDoneByUserID.Value, out var doneByUser) ? doneByUser.FullName : null
                ));

            return Ok(response);
        }

        [HttpPut("{id}/done")]
        public async Task<IActionResult> MarkAsDone(int id)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await sampleStorageService.MarkAsDoneAsync(id, userId);

            if (!success)
            {
                return NotFound("Sample not found or already completed.");
            }

            return Ok("Sample marked as done.");
        }

        // Replace the Deactivate method (it's now a PUT, not a DELETE)
        [HttpPut("{id}/deactivate")]
        public async Task<IActionResult> Deactivate(int id, [FromBody] DeactivateSampleStorageRequest request)
        {
            var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var success = await sampleStorageService.DeactivateAsync(id, userId, request.Reason);
            if (!success)
            {
                return NotFound("Sample not found or already deactivated.");
            }
            return Ok("Sample entry deactivated successfully.");
        }

        private static SampleStorageResponse MapToResponse(SampleStorage log, string storedByUsername, string? doneByUsername)
        {
            return new SampleStorageResponse(
                log.StorageID,
                log.PatientSampleID,
                log.TestName,
                log.StorageDateTime,
                log.StoredByUserID,
                storedByUsername,
                log.IsTestDone,
                log.TestDoneDateTime,
                log.TestDoneByUserID,
                doneByUsername);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\ShiftsController.cs
========================================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System.Security.Claims;
using System.Threading.Tasks;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Admin")]
    public class ShiftsController(IShiftService shiftService) : ControllerBase
    {
        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var shifts = await shiftService.GetAllAsync();
            return Ok(shifts);
        }

        [HttpPost]
        public async Task<IActionResult> Create([FromBody] CreateShiftRequest request)
        {
            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var newShift = new Shift
            {
                ShiftName = request.ShiftName,
                StartTime = request.StartTime,
                EndTime = request.EndTime,
                GracePeriodHours = request.GracePeriodHours,
                IsActive = true
            };
            var createdShift = await shiftService.CreateAsync(newShift, actorUserId);
            return Ok(createdShift);
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, [FromBody] UpdateShiftRequest request)
        {
            if (id != request.ShiftID) return BadRequest("ID mismatch");

            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            var shiftToUpdate = await shiftService.GetByIdAsync(id);
            if (shiftToUpdate is null) return NotFound();

            shiftToUpdate.ShiftName = request.ShiftName;
            shiftToUpdate.StartTime = request.StartTime;
            shiftToUpdate.EndTime = request.EndTime;
            shiftToUpdate.GracePeriodHours = request.GracePeriodHours;
            shiftToUpdate.IsActive = request.IsActive;

            var updatedShift = await shiftService.UpdateAsync(shiftToUpdate, actorUserId);
            return Ok(updatedShift);
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> Deactivate(int id)
        {
            var actorUserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
            await shiftService.DeactivateAsync(id, actorUserId);
            return NoContent();
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\TasksController.cs
========================================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PortalMirage.Data.Abstractions;
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;
using TaskModel = PortalMirage.Core.Models.TaskModel; // Specific alias to avoid conflict

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Admin")] // Only Admins can define master tasks
    public class TasksController(ITaskRepository taskRepository) : ControllerBase
    {
        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var tasks = await taskRepository.GetAllAsync();
            return Ok(tasks);
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> Deactivate(int id)
        {
            await taskRepository.DeactivateAsync(id);
            return NoContent();
        }

        [HttpPost]
        public async Task<IActionResult> Create([FromBody] TaskModel task)
        {
            // The UI will send the ShiftID and ScheduleType
            var createdTask = await taskRepository.CreateAsync(task);
            return Ok(createdTask);
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Controllers\WeatherForecastController.cs
========================================
using Microsoft.AspNetCore.Mvc;

namespace PortalMirage.Api.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class WeatherForecastController : ControllerBase
    {
        private static readonly string[] Summaries = new[]
        {
            "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
        };

        private readonly ILogger<WeatherForecastController> _logger;

        public WeatherForecastController(ILogger<WeatherForecastController> logger)
        {
            _logger = logger;
        }

        [HttpGet(Name = "GetWeatherForecast")]
        public IEnumerable<WeatherForecast> Get()
        {
            return Enumerable.Range(1, 5).Select(index => new WeatherForecast
            {
                Date = DateOnly.FromDateTime(DateTime.Now.AddDays(index)),
                TemperatureC = Random.Shared.Next(-20, 55),
                Summary = Summaries[Random.Shared.Next(Summaries.Length)]
            })
            .ToArray();
        }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\PortalMirage.Api.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Dapper" Version="2.1.66" />
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="8.0.0" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.5.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\PortalMirage.Business\PortalMirage.Business.csproj" />
    <ProjectReference Include="..\PortalMirage.Core\PortalMirage.Core.csproj" />
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\Program.cs
========================================
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using Microsoft.OpenApi.Models;
using Dapper; // Add this using line


var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();

// Configure Swagger to use JWT Bearer authentication
builder.Services.AddSwaggerGen(options =>
{
    options.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        In = ParameterLocation.Header,
        Description = "Please enter a valid token",
        Name = "Authorization",
        Type = SecuritySchemeType.Http,
        BearerFormat = "JWT",
        Scheme = "Bearer"
    });
    options.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            new string[]{}
        }
    });
});

// =================================================================
//  Add Your Services to the Container (Dependency Injection)
// =================================================================
// 1. Add Configuration and JWT Authentication
var jwtSettings = builder.Configuration.GetSection("Jwt");

builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
}).AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = jwtSettings["Issuer"],
        ValidAudience = jwtSettings["Audience"],
        NameClaimType = System.Security.Claims.ClaimTypes.Name,
        RoleClaimType = System.Security.Claims.ClaimTypes.Role,
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtSettings["Key"]!))
    };
});

// 2. Add the Connection Factory
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection")!;
builder.Services.AddSingleton<PortalMirage.Data.Abstractions.IDbConnectionFactory>(_ =>
    new PortalMirage.Data.SqlConnectionFactory(connectionString));

// 3. Add the Repositories (DAL)
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IUserRepository, PortalMirage.Data.UserRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.ICalibrationLogRepository, PortalMirage.Data.CalibrationLogRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IKitValidationRepository, PortalMirage.Data.KitValidationRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.ISampleStorageRepository, PortalMirage.Data.SampleStorageRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IHandoverRepository, PortalMirage.Data.HandoverRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IMachineBreakdownRepository, PortalMirage.Data.MachineBreakdownRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IMediaSterilityCheckRepository, PortalMirage.Data.MediaSterilityCheckRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.ITaskRepository, PortalMirage.Data.TaskRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IDailyTaskLogRepository, PortalMirage.Data.DailyTaskLogRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IRepeatSampleLogRepository, PortalMirage.Data.RepeatSampleLogRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IShiftRepository, PortalMirage.Data.ShiftRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IAdminListRepository, PortalMirage.Data.AdminListRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IAuditLogRepository, PortalMirage.Data.AuditLogRepository>(); // ADDED IN CORRECT PLACE
builder.Services.AddScoped<PortalMirage.Data.Abstractions.ISampleStorageRepository, PortalMirage.Data.SampleStorageRepository>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IReportService, PortalMirage.Business.ReportService>(); // ADD THIS LINE



// ... (all your other repositories)
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IRoleRepository, PortalMirage.Data.RoleRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IUserRoleRepository, PortalMirage.Data.UserRoleRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IPermissionRepository, PortalMirage.Data.PermissionRepository>();
builder.Services.AddScoped<PortalMirage.Data.Abstractions.IRolePermissionRepository, PortalMirage.Data.RolePermissionRepository>();

// =================================================================

// =================================================================

// 4. Add the Services (BLL)
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IUserService, PortalMirage.Business.UserService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.ICalibrationLogService, PortalMirage.Business.CalibrationLogService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IKitValidationService, PortalMirage.Business.KitValidationService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.ISampleStorageService, PortalMirage.Business.SampleStorageService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IHandoverService, PortalMirage.Business.HandoverService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IMachineBreakdownService, PortalMirage.Business.MachineBreakdownService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IMediaSterilityCheckService, PortalMirage.Business.MediaSterilityCheckService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IDailyTaskLogService, PortalMirage.Business.DailyTaskLogService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IRepeatSampleLogService, PortalMirage.Business.RepeatSampleLogService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IShiftService, PortalMirage.Business.ShiftService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IAdminListService, PortalMirage.Business.AdminListService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IDashboardService, PortalMirage.Business.DashboardService>(); // ADD THIS LINE


// ... (all your other services)
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IRoleService, PortalMirage.Business.RoleService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IUserRoleService, PortalMirage.Business.UserRoleService>();
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IRolePermissionService, PortalMirage.Business.RolePermissionService>();

// AUDIT LOG SERVICE - ADD THIS LINE
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IAuditLogService, PortalMirage.Business.AuditLogService>();

builder.Services.AddSingleton<PortalMirage.Business.ITimeProvider, PortalMirage.Business.SystemTimeProvider>();
// Add our new token generator service
builder.Services.AddScoped<PortalMirage.Business.Abstractions.IJwtTokenGenerator, PortalMirage.Business.JwtTokenGenerator>();
// =================================================================

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

app.UseAuthentication(); // This line has been added
app.UseAuthorization();

app.MapControllers();

app.Run();


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Api\WeatherForecast.cs
========================================
namespace PortalMirage.Api
{
    public class WeatherForecast
    {
        public DateOnly Date { get; set; }

        public int TemperatureC { get; set; }

        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);

        public string? Summary { get; set; }
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IAdminListService.cs
========================================
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IAdminListService
{
    Task<IEnumerable<AdminListItem>> GetAllAsync();
    Task<IEnumerable<AdminListItem>> GetByTypeAsync(string listType);

    // Updated methods with actorUserId parameter for audit logging
    Task<AdminListItem> CreateAsync(AdminListItem item, int actorUserId);
    Task<AdminListItem> UpdateAsync(AdminListItem item, int actorUserId);

    Task<AdminListItem?> GetItemAsync(string listType, string itemValue);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IAuditLogService.cs
========================================
using PortalMirage.Core.Dtos;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions
{
    public interface IAuditLogService
    {
        /// <summary>
        /// Creates a new audit log entry in the database.
        /// </summary>
        Task LogAsync(int? userId, string actionType, string moduleName, string? recordId = null, string? fieldName = null, string? oldValue = null, string? newValue = null);

        /// <summary>
        /// Retrieves a collection of audit logs within a specified date range for display.
        /// </summary>
        Task<IEnumerable<AuditLogDto>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\ICalibrationLogService.cs
========================================
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface ICalibrationLogService
{
    Task<CalibrationLog> CreateAsync(CalibrationLog calibrationLog);
    Task<IEnumerable<CalibrationLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<bool> DeactivateAsync(int logId, int userId, string reason); // Add this line
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IDailyTaskLogService.cs
========================================
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IDailyTaskLogService
{
    Task<IEnumerable<TaskLogDetailDto>> GetTasksForDateAsync(DateTime date);
    Task<TaskLogDetailDto?> UpdateTaskStatusAsync(long logId, string status, int userId, string? comment);
    Task<DailyTaskLog?> ExtendTaskDeadlineAsync(long logId, DateTime newDeadline, string reason, int adminUserId);
    Task<DailyTaskLog?> MarkAsNotApplicableAsync(long logId, int userId, string reason);
    Task<DailyTaskLog?> OverrideLockAsync(long logId, DateTime overrideUntil, string reason, int adminUserId);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IDashboardService.cs
========================================
using PortalMirage.Core.Dtos;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IDashboardService
{
    Task<DashboardSummaryDto> GetSummaryAsync();
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IHandoverService.cs
========================================
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IHandoverService
{
    Task<Handover> CreateAsync(Handover handover);
    Task<IEnumerable<Handover>> GetPendingAsync(DateTime startDate, DateTime endDate); // Add date parameters
    Task<IEnumerable<Handover>> GetCompletedAsync(DateTime startDate, DateTime endDate); // Add this new method
    Task<bool> MarkAsReceivedAsync(int handoverId, int userId);

    Task<bool> DeactivateAsync(int handoverId, int userId, string reason);

    Task<Handover?> GetByIdAsync(int handoverId);

}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IJwtTokenGenerator.cs
========================================
using PortalMirage.Core.Models;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IJwtTokenGenerator
{
    Task<string> GenerateTokenAsync(User user);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IKitValidationService.cs
========================================
using PortalMirage.Core.Models;

namespace PortalMirage.Business.Abstractions;

public interface IKitValidationService
{
    Task<KitValidation> CreateAsync(KitValidation kitValidation);
    Task<IEnumerable<KitValidation>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);

    Task<bool> DeactivateAsync(int validationId, int userId, string reason);

}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IMachineBreakdownService.cs
========================================
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IMachineBreakdownService
{
    Task<MachineBreakdown> CreateAsync(MachineBreakdown breakdown);
    Task<IEnumerable<MachineBreakdown>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<IEnumerable<MachineBreakdown>> GetResolvedByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<MachineBreakdown?> GetByIdAsync(int breakdownId); // This was missing
    Task<bool> MarkAsResolvedAsync(int breakdownId, int userId, string resolutionNotes);
    Task<bool> DeactivateAsync(int breakdownId, int userId, string reason); // This is new
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IMediaSterilityCheckService.cs
========================================
using PortalMirage.Core.Models;

namespace PortalMirage.Business.Abstractions;

public interface IMediaSterilityCheckService
{
    Task<MediaSterilityCheck> CreateAsync(MediaSterilityCheck sterilityCheck);
    Task<IEnumerable<MediaSterilityCheck>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);

    Task<bool> DeactivateAsync(int checkId, int userId, string reason);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IRepeatSampleLogService.cs
========================================
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IRepeatSampleLogService
{
    Task<RepeatSampleLog> CreateAsync(RepeatSampleLog repeatSampleLog);
    Task<IEnumerable<RepeatSampleLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<bool> DeactivateAsync(int repeatId, int userId, string reason);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IReportService.cs
========================================
using PortalMirage.Core.Dtos;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IReportService
{
    Task<IEnumerable<MachineBreakdownReportDto>> GetMachineBreakdownReportAsync(DateTime startDate, DateTime endDate, string? machineName, string? status);
    Task<IEnumerable<HandoverReportDto>> GetHandoverReportAsync(DateTime startDate, DateTime endDate, string? shift, string? priority, string? status);
    Task<IEnumerable<KitValidationReportDto>> GetKitValidationReportAsync(DateTime startDate, DateTime endDate, string? kitName, string? status);
    Task<IEnumerable<RepeatSampleReportDto>> GetRepeatSampleReportAsync(DateTime startDate, DateTime endDate, string? reason, string? department);
    Task<DailyTaskComplianceReportDto> GetDailyTaskComplianceReportAsync(DateTime startDate, DateTime endDate, int? shiftId, string? status);

    Task<IEnumerable<MediaSterilityReportDto>> GetMediaSterilityReportAsync(DateTime startDate, DateTime endDate, string? mediaName, string? status); // ADD THIS

    Task<IEnumerable<SampleStorageReportDto>> GetSampleStorageReportAsync(DateTime startDate, DateTime endDate, string? testName, string? status);

    Task<IEnumerable<CalibrationReportDto>> GetCalibrationReportAsync(DateTime startDate, DateTime endDate, string? testName, string? qcResult); // ADD THIS
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IRolePermissionService.cs
========================================
namespace PortalMirage.Business.Abstractions;

public interface IRolePermissionService
{
    Task<bool> AssignPermissionToRoleAsync(string roleName, string permissionName);
    Task<bool> RemovePermissionFromRoleAsync(string roleName, string permissionName);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IRoleService.cs
========================================
using PortalMirage.Core.Models;

namespace PortalMirage.Business.Abstractions;

public interface IRoleService
{
    Task<IEnumerable<Role>> GetAllRolesAsync();
    Task<Role?> CreateRoleAsync(string roleName);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\ISampleStorageService.cs
========================================
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface ISampleStorageService
{
    Task<SampleStorage> CreateAsync(SampleStorage sampleStorage);
    Task<IEnumerable<SampleStorage>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<IEnumerable<SampleStorage>> GetCompletedByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<bool> MarkAsDoneAsync(int storageId, int userId);
    Task<bool> DeactivateAsync(int storageId, int userId, string reason); // This is the corrected signature
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IShiftService.cs
========================================
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IShiftService
{
    Task<IEnumerable<Shift>> GetAllAsync();
    Task<Shift?> GetByIdAsync(int shiftId);
    Task<Shift> CreateAsync(Shift shift, int actorUserId); // Add actorUserId
    Task<Shift> UpdateAsync(Shift shift, int actorUserId); // Add actorUserId
    System.Threading.Tasks.Task DeactivateAsync(int shiftId, int actorUserId); // Add actorUserId
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IUserRoleService.cs
========================================
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IUserRoleService
{
    Task<bool> AssignRoleToUserAsync(string username, string roleName, int actorUserId); // Add actorUserId
    Task<bool> RemoveRoleFromUserAsync(string username, string roleName, int actorUserId); // Add actorUserId
    Task<IEnumerable<Role>> GetRolesForUserAsync(string username);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Abstractions\IUserService.cs
========================================
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business.Abstractions;

public interface IUserService
{
    Task<User?> RegisterUserAsync(string username, string password, string fullName, int? actorUserId); // Add actorUserId
    Task<User?> ValidateCredentialsAsync(string username, string password);
    Task<IEnumerable<User>> GetAllUsersAsync();
    Task<User?> GetUserByIdAsync(int userId);
    Task<bool> ResetPasswordAsync(string username, string newPassword, int actorUserId); // Add actorUserId
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\AdminListService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class AdminListService(
    IAdminListRepository adminListRepository,
    IAuditLogService auditLogService) : IAdminListService
{
    public async Task<IEnumerable<AdminListItem>> GetAllAsync()
    {
        return await adminListRepository.GetAllAsync();
    }

    public async Task<IEnumerable<AdminListItem>> GetByTypeAsync(string listType)
    {
        return await adminListRepository.GetByTypeAsync(listType);
    }

    public async Task<AdminListItem> CreateAsync(AdminListItem item, int actorUserId)
    {
        var createdItem = await adminListRepository.CreateAsync(item);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: actorUserId,
            actionType: "Create",
            moduleName: "AdminList",
            recordId: createdItem.ItemID.ToString(),
            newValue: $"List '{createdItem.ListType}' - Added new item '{createdItem.ItemValue}'"
        );

        return createdItem;
    }

    public async Task<AdminListItem?> GetItemAsync(string listType, string itemValue)
    {
        return await adminListRepository.GetItemAsync(listType, itemValue);
    }

    public async Task<AdminListItem> UpdateAsync(AdminListItem item, int actorUserId)
    {
        var updatedItem = await adminListRepository.UpdateAsync(item);

        // ADDED: Log the update event
        await auditLogService.LogAsync(
            userId: actorUserId,
            actionType: "Update",
            moduleName: "AdminList",
            recordId: updatedItem.ItemID.ToString(),
            newValue: $"List '{updatedItem.ListType}' - Updated item '{updatedItem.ItemValue}' (IsActive: {updatedItem.IsActive})"
        );

        return updatedItem;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\AuditLogService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class AuditLogService(IAuditLogRepository auditLogRepository) : IAuditLogService
{
    // Your existing method
    public async System.Threading.Tasks.Task LogAsync(int? userId, string actionType, string moduleName, string? recordId = null, string? fieldName = null, string? oldValue = null, string? newValue = null)
    {
        var logEntry = new AuditLog
        {
            UserID = userId,
            ActionType = actionType,
            ModuleName = moduleName,
            RecordID = recordId,
            FieldName = fieldName,
            OldValue = oldValue,
            NewValue = newValue
        };
        await auditLogRepository.CreateAsync(logEntry);
    }

    // The new method we are adding
    public async Task<IEnumerable<AuditLogDto>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await auditLogRepository.GetByDateRangeAsync(startDate, endDate);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\CalibrationLogService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class CalibrationLogService(
    ICalibrationLogRepository calibrationLogRepository,
    IAuditLogService auditLogService) : ICalibrationLogService
{
    public async Task<CalibrationLog> CreateAsync(CalibrationLog calibrationLog)
    {
        // In the future, any business rules (like validation) would go here.
        // For now, we pass it directly to the repository.
        var newLog = await calibrationLogRepository.CreateAsync(calibrationLog);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: newLog.PerformedByUserID,
            actionType: "Create",
            moduleName: "CalibrationLog",
            recordId: newLog.CalibrationID.ToString(),
            newValue: $"Test: {newLog.TestName}, Result: {newLog.QcResult}"
        );

        return newLog;
    }

    public async Task<IEnumerable<CalibrationLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await calibrationLogRepository.GetByDateRangeAsync(startDate, endDate);
    }

    public async Task<bool> DeactivateAsync(int logId, int userId, string reason)
    {
        var success = await calibrationLogRepository.DeactivateAsync(logId, userId, reason);
        if (success)
        {
            await auditLogService.LogAsync(userId, "Deactivate", "CalibrationLog", logId.ToString(), newValue: reason);
        }
        return success;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\Class1.cs
========================================
namespace PortalMirage.Business
{
    public class Class1
    {

    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\DailyTaskLogService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using TaskModel = PortalMirage.Core.Models.TaskModel;
using PortalMirage.Core.Models;

namespace PortalMirage.Business;

public class DailyTaskLogService(
    ITaskRepository taskRepository,
    IDailyTaskLogRepository dailyTaskLogRepository,
    IShiftRepository shiftRepository,
    IUserRepository userRepository,
    IAuditLogService auditLogService,
    ITimeProvider timeProvider) : IDailyTaskLogService
{
    #region Constants
    public static class TaskStatuses
    {
        public const string Pending = "Pending";
        public const string Complete = "Complete";
        public const string Incomplete = "Incomplete";
        public const string NotApplicable = "NotApplicable";
    }

    public static class AuditActions
    {
        public const string UpdateStatus = "UpdateStatus";
        public const string ExtendDeadline = "ExtendDeadline";
        public const string MarkAsNA = "MarkAsNA";
        public const string OverrideLock = "OverrideLock";
        public const string AutoLock = "AutoLock";
    }

    public static class ScheduleTypes
    {
        public const string Daily = "Daily";
        public const string Weekly = "Weekly";
        public const string Monthly = "Monthly";
    }
    #endregion

    public async Task<IEnumerable<TaskLogDetailDto>> GetTasksForDateAsync(DateTime date)
    {
        if (date.Date > timeProvider.Today)
            throw new ArgumentException("Cannot get tasks for future dates", nameof(date));

        await LockExpiredTasks(date);

        var existingLogs = (await dailyTaskLogRepository.GetForDateAsync(date)).ToList();

        if (!existingLogs.Any())
        {
            existingLogs = await CreateDailyLogsForDate(date);
        }

        return await MapToTaskLogDetailDtos(existingLogs);
    }

    public async Task<TaskLogDetailDto?> UpdateTaskStatusAsync(long logId, string status, int userId, string? comment = null)
    {
        // Validate input
        if (!IsValidStatus(status))
            throw new ArgumentException($"Invalid status: {status}", nameof(status));

        if (userId <= 0)
            throw new ArgumentException("Invalid user ID", nameof(userId));

        var updatedLog = await dailyTaskLogRepository.UpdateStatusAsync(logId, status, userId, comment);
        if (updatedLog is null)
            return null;

        // ADDED: Enhanced audit logging with more descriptive message
        await auditLogService.LogAsync(
            userId: userId,
            actionType: AuditActions.UpdateStatus,
            moduleName: "DailyTaskLog",
            recordId: logId.ToString(),
            newValue: $"Status set to '{status}'. Comment: {comment ?? "N/A"}"
        );

        return await MapToTaskLogDetailDto(updatedLog, userId);
    }

    public async Task<DailyTaskLog?> ExtendTaskDeadlineAsync(long logId, DateTime newDeadline, string reason, int adminUserId)
    {
        if (newDeadline <= timeProvider.Now)
            throw new ArgumentException("New deadline must be in the future", nameof(newDeadline));

        if (string.IsNullOrWhiteSpace(reason))
            throw new ArgumentException("Reason is required", nameof(reason));

        var extendedLog = await dailyTaskLogRepository.ExtendDeadlineAsync(logId, newDeadline, reason, adminUserId);
        if (extendedLog is not null)
        {
            // This was already here and is correct
            await auditLogService.LogAsync(
                adminUserId,
                AuditActions.ExtendDeadline,
                nameof(DailyTaskLog),
                logId.ToString(),
                newValue: $"Deadline extended to {newDeadline:yyyy-MM-dd HH:mm} for reason: {reason}");
        }
        return extendedLog;
    }

    public async Task<DailyTaskLog?> MarkAsNotApplicableAsync(long logId, int userId, string reason)
    {
        if (string.IsNullOrWhiteSpace(reason))
            throw new ArgumentException("Reason is required", nameof(reason));

        var updatedLog = await dailyTaskLogRepository.UpdateStatusAsync(logId, TaskStatuses.NotApplicable, userId, reason);
        if (updatedLog is not null)
        {
            await auditLogService.LogAsync(
                userId,
                AuditActions.MarkAsNA,
                nameof(DailyTaskLog),
                logId.ToString(),
                newValue: $"Marked as Not Applicable: {reason}");
        }
        return updatedLog;
    }

    public async Task<DailyTaskLog?> OverrideLockAsync(long logId, DateTime overrideUntil, string reason, int adminUserId)
    {
        if (overrideUntil <= timeProvider.Now)
            throw new ArgumentException("Override must be in the future", nameof(overrideUntil));

        if (string.IsNullOrWhiteSpace(reason))
            throw new ArgumentException("Reason is required", nameof(reason));

        var updatedLog = await dailyTaskLogRepository.OverrideLockAsync(logId, overrideUntil, reason, adminUserId);
        if (updatedLog is not null)
        {
            // This was already here and is correct
            await auditLogService.LogAsync(
                adminUserId,
                AuditActions.OverrideLock,
                nameof(DailyTaskLog),
                logId.ToString(),
                newValue: $"Lock override until {overrideUntil:yyyy-MM-dd HH:mm} for reason: {reason}");
        }
        return updatedLog;
    }

    #region Private Methods
    private async Task<List<DailyTaskLog>> CreateDailyLogsForDate(DateTime date)
    {
        var logs = new List<DailyTaskLog>();
        var allScheduledTasks = await taskRepository.GetAllAsync();
        var tasksForToday = allScheduledTasks.Where(task => IsTaskScheduledForToday(task, date)).ToList();

        foreach (var task in tasksForToday)
        {
            var newLog = new DailyTaskLog
            {
                TaskID = task.TaskID,
                LogDate = date.Date,
                Status = TaskStatuses.Pending
            };
            var createdLog = await dailyTaskLogRepository.CreateAsync(newLog);
            logs.Add(createdLog);
        }

        return logs;
    }

    // FIX 1: Explicitly used System.Threading.Tasks.Task to resolve ambiguity.
    private async System.Threading.Tasks.Task LockExpiredTasks(DateTime forDate)
    {
        if (forDate.Date > timeProvider.Today) return;

        var allShifts = await shiftRepository.GetAllAsync();
        var pendingLogs = (await dailyTaskLogRepository.GetForDateAsync(forDate))
            .Where(log => log.Status == TaskStatuses.Pending).ToList();

        if (!pendingLogs.Any()) return;

        var allTasks = (await taskRepository.GetAllAsync()).ToDictionary(t => t.TaskID);

        foreach (var log in pendingLogs)
        {
            if (!allTasks.TryGetValue(log.TaskID, out var task) || !task.ShiftID.HasValue)
                continue;

            var shift = allShifts.FirstOrDefault(s => s.ShiftID == task.ShiftID.Value);
            if (shift is null) continue;

            var shiftEndTimeOnDate = forDate.Date + shift.EndTime.ToTimeSpan();
            var lockTime = shiftEndTimeOnDate.AddHours(shift.GracePeriodHours);

            if (log.LockOverrideUntil.HasValue && log.LockOverrideUntil.Value > timeProvider.Now)
                continue;

            if (timeProvider.Now > lockTime)
            {
                await dailyTaskLogRepository.UpdateStatusAsync(
                    log.LogID,
                    TaskStatuses.Incomplete,
                    null,
                    "Automatically locked due to expired deadline");

                await auditLogService.LogAsync(
                    0, // System user
                    AuditActions.AutoLock,
                    nameof(DailyTaskLog),
                    log.LogID.ToString(),
                    newValue: $"Automatically locked at {timeProvider.Now:yyyy-MM-dd HH:mm} - deadline was {lockTime:yyyy-MM-dd HH:mm}");
            }
        }
    }

    private bool IsTaskScheduledForToday(TaskModel task, DateTime date)
    {
        var dateOnly = DateOnly.FromDateTime(date);
        return task.ScheduleType switch
        {
            ScheduleTypes.Daily => true,
            ScheduleTypes.Weekly => task.ScheduleValue.Equals(dateOnly.DayOfWeek.ToString(), StringComparison.OrdinalIgnoreCase),
            ScheduleTypes.Monthly => int.TryParse(task.ScheduleValue, out int day) && day == dateOnly.Day,
            _ => false
        };
    }

    private async Task<IEnumerable<TaskLogDetailDto>> MapToTaskLogDetailDtos(IEnumerable<DailyTaskLog> logs)
    {
        var logList = logs.ToList();
        if (!logList.Any()) return Enumerable.Empty<TaskLogDetailDto>();

        var taskIds = logList.Select(l => l.TaskID).Distinct();
        var userIds = logList.Where(l => l.CompletedByUserID.HasValue)
                           .Select(l => l.CompletedByUserID.Value)
                           .Distinct();

        var tasks = (await taskRepository.GetByIdsAsync(taskIds)).ToDictionary(t => t.TaskID);
        var users = (await userRepository.GetByIdsAsync(userIds)).ToDictionary(u => u.UserID);

        // === CRITICAL CHANGE: Load ALL Shifts (Morning, Evening, Night, etc.) ===
        // This allows us to look up the name by ID later
        var shifts = (await shiftRepository.GetAllAsync()).ToDictionary(s => s.ShiftID);

        return logList.Select(log => MapToTaskLogDetailDto(log, tasks, users, shifts));
    }

    private async Task<TaskLogDetailDto> MapToTaskLogDetailDto(DailyTaskLog log, int? completedByUserId = null)
    {
        var task = await taskRepository.GetByIdAsync(log.TaskID);
        var user = completedByUserId.HasValue ? await userRepository.GetByIdAsync(completedByUserId.Value) : null;

        // Load shifts to get shift name
        var shifts = (await shiftRepository.GetAllAsync()).ToDictionary(s => s.ShiftID);
        string categoryName = "Uncategorized";

        if (task != null && task.ShiftID.HasValue && shifts.TryGetValue(task.ShiftID.Value, out var shift))
        {
            categoryName = shift.ShiftName;
        }

        return new TaskLogDetailDto
        {
            LogID = log.LogID,
            TaskName = task?.TaskName ?? "Unknown Task",
            TaskCategory = categoryName, // Now uses actual shift name instead of ID
            Status = log.Status,
            CompletedDateTime = log.CompletedDateTime,
            CompletedByUserID = log.CompletedByUserID,
            CompletedByUsername = user?.FullName ?? "Unknown User",
            Comments = log.Comments,
            LockOverrideUntil = log.LockOverrideUntil
        };
    }

    // FIX 2: Changed Dictionary key from 'int' to 'long' to match the TaskID type.
    private TaskLogDetailDto MapToTaskLogDetailDto(
        DailyTaskLog log,
        Dictionary<int, TaskModel> tasks,
        Dictionary<int, User> users,
        Dictionary<int, Shift> shifts)  // Added shifts parameter
    {
        var task = tasks.TryGetValue(log.TaskID, out var t) ? t : null;
        var user = log.CompletedByUserID.HasValue && users.TryGetValue(log.CompletedByUserID.Value, out var u) ? u : null;

        // === CRITICAL CHANGE: Get Actual Name from Database ===
        // If the shift is "Night" in the DB, this variable becomes "Night"
        string categoryName = "Uncategorized";
        if (task != null && task.ShiftID.HasValue && shifts.TryGetValue(task.ShiftID.Value, out var shift))
        {
            categoryName = shift.ShiftName;
        }

        return new TaskLogDetailDto
        {
            LogID = log.LogID,
            TaskName = task?.TaskName ?? "Unknown Task",
            TaskCategory = categoryName, // Sends "Morning", "Evening", or "Night" dynamically
            Status = log.Status,
            CompletedDateTime = log.CompletedDateTime,
            CompletedByUserID = log.CompletedByUserID,
            CompletedByUsername = user?.FullName ?? "Unknown User",
            Comments = log.Comments,
            LockOverrideUntil = log.LockOverrideUntil
        };
    }

    // Keep the old method for backward compatibility (if needed elsewhere)
    private TaskLogDetailDto MapToTaskLogDetailDto(DailyTaskLog log, Dictionary<int, TaskModel> tasks, Dictionary<int, User> users)
    {
        // Call the new method with empty shifts dictionary
        return MapToTaskLogDetailDto(log, tasks, users, new Dictionary<int, Shift>());
    }

    private bool IsValidStatus(string status)
    {
        var validStatuses = new[] { TaskStatuses.Pending, TaskStatuses.Complete, TaskStatuses.Incomplete, TaskStatuses.NotApplicable };
        return validStatuses.Contains(status);
    }
    #endregion
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\DashboardService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Dtos;
using PortalMirage.Data.Abstractions;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class DashboardService : IDashboardService
{
    private readonly IHandoverRepository _handoverRepository;
    private readonly IMachineBreakdownRepository _machineBreakdownRepository;
    private readonly IDailyTaskLogRepository _dailyTaskLogRepository;
    private readonly ISampleStorageRepository _sampleStorageRepository; // 1. ADD THIS FIELD
    private readonly ITimeProvider _timeProvider;

    public DashboardService(
        IHandoverRepository handoverRepository,
        IMachineBreakdownRepository machineBreakdownRepository,
        IDailyTaskLogRepository dailyTaskLogRepository,
        ISampleStorageRepository sampleStorageRepository, // 2. ADD THIS PARAMETER
        ITimeProvider timeProvider)
    {
        _handoverRepository = handoverRepository;
        _machineBreakdownRepository = machineBreakdownRepository;
        _dailyTaskLogRepository = dailyTaskLogRepository;
        _sampleStorageRepository = sampleStorageRepository; // 3. ADD THIS ASSIGNMENT
        _timeProvider = timeProvider;
    }

    public async Task<DashboardSummaryDto> GetSummaryAsync()
    {
        var handoversTask = _handoverRepository.GetPendingCountAsync();
        var breakdownsTask = _machineBreakdownRepository.GetPendingCountAsync();
        var tasksTask = _dailyTaskLogRepository.GetPendingCountForDateAsync(_timeProvider.Today);
        var samplesTask = _sampleStorageRepository.GetPendingCountAsync(); // 4. ADD THIS TASK

        await Task.WhenAll(handoversTask, breakdownsTask, tasksTask, samplesTask); // 5. AWAIT THE NEW TASK

        return new DashboardSummaryDto(
            PendingHandoversCount: await handoversTask,
            UnresolvedBreakdownsCount: await breakdownsTask,
            PendingDailyTasksCount: await tasksTask,
            PendingSamplesCount: await samplesTask // 6. ADD THE NEW COUNT TO THE DTO
        );
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\HandoverService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Threading.Tasks;
using System;
using System.Collections.Generic;

namespace PortalMirage.Business;

public class HandoverService(
    IHandoverRepository handoverRepository,
    IAuditLogService auditLogService) : IHandoverService
{
    public async Task<Handover> CreateAsync(Handover handover)
    {
        var newHandover = await handoverRepository.CreateAsync(handover);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: newHandover.GivenByUserID,
            actionType: "Create",
            moduleName: "Handover",
            recordId: newHandover.HandoverID.ToString(),
            newValue: newHandover.HandoverNotes
        );

        return newHandover;
    }

    public async Task<IEnumerable<Handover>> GetPendingAsync(DateTime startDate, DateTime endDate)
    {
        return await handoverRepository.GetPendingAsync(startDate, endDate);
    }

    public async Task<IEnumerable<Handover>> GetCompletedAsync(DateTime startDate, DateTime endDate)
    {
        return await handoverRepository.GetCompletedAsync(startDate, endDate);
    }

    public async Task<bool> MarkAsReceivedAsync(int handoverId, int userId)
    {
        // Business Rule: Ensure the handover exists before trying to update it.
        var handover = await handoverRepository.GetByIdAsync(handoverId);
        if (handover is null)
        {
            return false; // Handover not found
        }

        // Business Rule: Don't re-mark an already received handover.
        if (handover.IsReceived)
        {
            return true; // Already received, so the state is correct.
        }

        var success = await handoverRepository.MarkAsReceivedAsync(handoverId, userId);
        if (success)
        {
            // ADDED: Log the receive event
            await auditLogService.LogAsync(
                userId: userId,
                actionType: "Receive",
                moduleName: "Handover",
                recordId: handoverId.ToString()
            );
        }
        return success;
    }

    public async Task<bool> DeactivateAsync(int handoverId, int userId, string reason)
    {
        // First, we check if the handover exists to avoid errors
        var handover = await handoverRepository.GetByIdAsync(handoverId);
        if (handover is null)
        {
            return false; // Handover not found
        }

        var success = await handoverRepository.DeactivateAsync(handoverId, userId, reason);
        if (success)
        {
            // If deactivation was successful, we create an audit log entry
            await auditLogService.LogAsync(userId, "Deactivate", "Handover", handoverId.ToString(), newValue: reason);
        }
        return success;
    }

    public async Task<Handover?> GetByIdAsync(int handoverId)
    {
        return await handoverRepository.GetByIdAsync(handoverId);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\JwtTokenGenerator.cs
========================================
using System.Collections.Generic;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;

namespace PortalMirage.Business;

public class JwtTokenGenerator(IConfiguration configuration, IUserRepository userRepository) : IJwtTokenGenerator
{
    public async Task<string> GenerateTokenAsync(User user)
    {
        var jwtSettings = configuration.GetSection("Jwt");
        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtSettings["Key"]!));

        var claims = new List<Claim>
        {
            new(ClaimTypes.NameIdentifier, user.UserID.ToString()),
            new(ClaimTypes.Name, user.Username),
            new(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
        };

        // Fetch and add role claims to the token
        var roles = await userRepository.GetUserRolesAsync(user.UserID);
        foreach (var role in roles)
        {
            claims.Add(new Claim(ClaimTypes.Role, role));
        }

        var token = new JwtSecurityToken(
            issuer: jwtSettings["Issuer"],
            audience: jwtSettings["Audience"],
            claims: claims,
            expires: DateTime.UtcNow.AddHours(8),
            signingCredentials: new SigningCredentials(key, SecurityAlgorithms.HmacSha256)
        );

        return new JwtSecurityTokenHandler().WriteToken(token);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\KitValidationService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using System.Threading.Tasks;
using System;

namespace PortalMirage.Business;

public class KitValidationService(
    IKitValidationRepository kitValidationRepository,
    IAuditLogService auditLogService) : IKitValidationService
{
    public async Task<KitValidation> CreateAsync(KitValidation kitValidation)
    {
        // In the future, any business rules (like checking for duplicate lot numbers) would go here.
        var newValidation = await kitValidationRepository.CreateAsync(kitValidation);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: newValidation.ValidatedByUserID,
            actionType: "Create",
            moduleName: "KitValidation",
            recordId: newValidation.ValidationID.ToString(),
            newValue: $"Kit: {newValidation.KitName}, Lot: {newValidation.KitLotNumber}, Status: {newValidation.ValidationStatus}"
        );

        return newValidation;
    }

    public async Task<IEnumerable<KitValidation>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await kitValidationRepository.GetByDateRangeAsync(startDate, endDate);
    }

    public async Task<bool> DeactivateAsync(int validationId, int userId, string reason)
    {
        var success = await kitValidationRepository.DeactivateAsync(validationId, userId, reason);
        if (success)
        {
            await auditLogService.LogAsync(userId, "Deactivate", "KitValidation", validationId.ToString(), newValue: reason);
        }
        return success;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\MachineBreakdownService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class MachineBreakdownService(
    IMachineBreakdownRepository machineBreakdownRepository,
    IAuditLogService auditLogService) : IMachineBreakdownService
{
    public async Task<MachineBreakdown> CreateAsync(MachineBreakdown breakdown)
    {
        var newBreakdown = await machineBreakdownRepository.CreateAsync(breakdown);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: newBreakdown.ReportedByUserID,
            actionType: "Create",
            moduleName: "MachineBreakdown",
            recordId: newBreakdown.BreakdownID.ToString(),
            newValue: $"Machine: {newBreakdown.MachineName}, Reason: {newBreakdown.BreakdownReason}"
        );

        return newBreakdown;
    }

    public async Task<IEnumerable<MachineBreakdown>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await machineBreakdownRepository.GetPendingByDateRangeAsync(startDate, endDate);
    }

    public async Task<bool> MarkAsResolvedAsync(int breakdownId, int userId, string resolutionNotes)
    {
        // Business Rule: Check if the breakdown record exists.
        var breakdown = await machineBreakdownRepository.GetByIdAsync(breakdownId);
        if (breakdown is null)
        {
            return false; // Record not found.
        }

        // Business Rule: Don't re-mark an already resolved issue.
        if (breakdown.IsResolved)
        {
            return true; // Already resolved, so the state is correct.
        }

        var success = await machineBreakdownRepository.MarkAsResolvedAsync(breakdownId, userId, resolutionNotes);
        if (success)
        {
            // ADDED: Log the resolve event
            await auditLogService.LogAsync(
                userId: userId,
                actionType: "Resolve",
                moduleName: "MachineBreakdown",
                recordId: breakdownId.ToString(),
                newValue: resolutionNotes
            );
        }
        return success;
    }

    public async Task<IEnumerable<MachineBreakdown>> GetResolvedByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await machineBreakdownRepository.GetResolvedByDateRangeAsync(startDate, endDate);
    }

    public async Task<MachineBreakdown?> GetByIdAsync(int breakdownId)
    {
        return await machineBreakdownRepository.GetByIdAsync(breakdownId);
    }

    public async Task<bool> DeactivateAsync(int breakdownId, int userId, string reason)
    {
        var success = await machineBreakdownRepository.DeactivateAsync(breakdownId, userId, reason);
        if (success)
        {
            await auditLogService.LogAsync(userId, "Deactivate", "MachineBreakdown", breakdownId.ToString(), newValue: reason);
        }
        return success;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\MediaSterilityCheckService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class MediaSterilityCheckService(
    IMediaSterilityCheckRepository sterilityCheckRepository,
    IAuditLogService auditLogService) : IMediaSterilityCheckService
{
    public async Task<MediaSterilityCheck> CreateAsync(MediaSterilityCheck sterilityCheck)
    {
        // Business Rule: Automatically determine the overall status.
        if (sterilityCheck.Result25C.Equals("Growth Seen", StringComparison.OrdinalIgnoreCase) ||
            sterilityCheck.Result37C.Equals("Growth Seen", StringComparison.OrdinalIgnoreCase))
        {
            sterilityCheck.OverallStatus = "Failed";
        }
        else
        {
            sterilityCheck.OverallStatus = "Passed";
        }

        var newCheck = await sterilityCheckRepository.CreateAsync(sterilityCheck);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: newCheck.PerformedByUserID,
            actionType: "Create",
            moduleName: "MediaSterilityCheck",
            recordId: newCheck.SterilityCheckID.ToString(),
            newValue: $"Media: {newCheck.MediaName}, Lot: {newCheck.MediaLotNumber}, Status: {newCheck.OverallStatus}"
        );

        return newCheck;
    }

    public async Task<IEnumerable<MediaSterilityCheck>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await sterilityCheckRepository.GetByDateRangeAsync(startDate, endDate);
    }

    public async Task<bool> DeactivateAsync(int checkId, int userId, string reason)
    {
        var success = await sterilityCheckRepository.DeactivateAsync(checkId, userId, reason);
        if (success)
        {
            await auditLogService.LogAsync(userId, "Deactivate", "MediaSterilityCheck", checkId.ToString(), newValue: reason);
        }
        return success;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\PortalMirage.Business.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Abstractions" Version="8.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\PortalMirage.Core\PortalMirage.Core.csproj" />
    <ProjectReference Include="..\PortalMirage.Data\PortalMirage.Data.csproj" />
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\RepeatSampleLogService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class RepeatSampleLogService(
    IRepeatSampleLogRepository repeatSampleLogRepository,
    IAuditLogService auditLogService) : IRepeatSampleLogService
{
    public async Task<RepeatSampleLog> CreateAsync(RepeatSampleLog repeatSampleLog)
    {
        var newLog = await repeatSampleLogRepository.CreateAsync(repeatSampleLog);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: newLog.LoggedByUserID,
            actionType: "Create",
            moduleName: "RepeatSampleLog",
            recordId: newLog.RepeatID.ToString(),
            newValue: $"Patient: {newLog.PatientName}, Reason: {newLog.ReasonText}"
        );

        return newLog;
    }

    public async Task<IEnumerable<RepeatSampleLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await repeatSampleLogRepository.GetByDateRangeAsync(startDate, endDate);
    }

    public async Task<bool> DeactivateAsync(int repeatId, int userId, string reason)
    {
        var success = await repeatSampleLogRepository.DeactivateAsync(repeatId, userId, reason);
        if (success)
        {
            await auditLogService.LogAsync(userId, "Deactivate", "RepeatSampleLog", repeatId.ToString(), newValue: reason);
        }
        return success;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\ReportService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Dtos;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class ReportService : IReportService
{
    private readonly IMachineBreakdownRepository _machineBreakdownRepository;
    private readonly IHandoverRepository _handoverRepository;
    private readonly IKitValidationRepository _kitValidationRepository;
    private readonly IRepeatSampleLogRepository _repeatSampleLogRepository;
    private readonly IDailyTaskLogRepository _dailyTaskLogRepository;
    private readonly IMediaSterilityCheckRepository _mediaSterilityCheckRepository;
    private readonly ISampleStorageRepository _sampleStorageRepository;
    private readonly ICalibrationLogRepository _calibrationLogRepository;

    public ReportService(
        IMachineBreakdownRepository machineBreakdownRepository,
        IHandoverRepository handoverRepository,
        IKitValidationRepository kitValidationRepository,
        IRepeatSampleLogRepository repeatSampleLogRepository,
        IDailyTaskLogRepository dailyTaskLogRepository,
        IMediaSterilityCheckRepository mediaSterilityCheckRepository,
        ISampleStorageRepository sampleStorageRepository,
        ICalibrationLogRepository calibrationLogRepository) // 1. INJECT REPO
    {
        _machineBreakdownRepository = machineBreakdownRepository;
        _handoverRepository = handoverRepository;
        _kitValidationRepository = kitValidationRepository;
        _repeatSampleLogRepository = repeatSampleLogRepository;
        _dailyTaskLogRepository = dailyTaskLogRepository;
        _mediaSterilityCheckRepository = mediaSterilityCheckRepository;
        _sampleStorageRepository = sampleStorageRepository;
        _calibrationLogRepository = calibrationLogRepository;
    }

    public async Task<DailyTaskComplianceReportDto> GetDailyTaskComplianceReportAsync(DateTime startDate, DateTime endDate, int? shiftId, string? status)
    {
        var items = (await _dailyTaskLogRepository.GetComplianceReportDataAsync(startDate, endDate, shiftId, status)).ToList();
        var completedCount = items.Count(i => i.Status == "Completed");
        return new DailyTaskComplianceReportDto(items, items.Count, completedCount);
    }

    public async Task<IEnumerable<HandoverReportDto>> GetHandoverReportAsync(DateTime startDate, DateTime endDate, string? shift, string? priority, string? status)
    {
        return await _handoverRepository.GetReportDataAsync(startDate, endDate, shift, priority, status);
    }

    public async Task<IEnumerable<KitValidationReportDto>> GetKitValidationReportAsync(DateTime startDate, DateTime endDate, string? kitName, string? status)
    {
        return await _kitValidationRepository.GetReportDataAsync(startDate, endDate, kitName, status);
    }

    public async Task<IEnumerable<MachineBreakdownReportDto>> GetMachineBreakdownReportAsync(DateTime startDate, DateTime endDate, string? machineName, string? status)
    {
        return await _machineBreakdownRepository.GetReportDataAsync(startDate, endDate, machineName, status);
    }

    public async Task<IEnumerable<RepeatSampleReportDto>> GetRepeatSampleReportAsync(DateTime startDate, DateTime endDate, string? reason, string? department)
    {
        return await _repeatSampleLogRepository.GetReportDataAsync(startDate, endDate, reason, department);
    }

    public async Task<IEnumerable<MediaSterilityReportDto>> GetMediaSterilityReportAsync(DateTime startDate, DateTime endDate, string? mediaName, string? status)
    {
        return await _mediaSterilityCheckRepository.GetReportDataAsync(startDate, endDate, mediaName, status);
    }

    public async Task<IEnumerable<SampleStorageReportDto>> GetSampleStorageReportAsync(DateTime startDate, DateTime endDate, string? testName, string? status)
    {
        return await _sampleStorageRepository.GetReportDataAsync(startDate, endDate, testName, status);
    }

    // 2. ADD NEW METHOD
    public async Task<IEnumerable<CalibrationReportDto>> GetCalibrationReportAsync(DateTime startDate, DateTime endDate, string? testName, string? qcResult)
    {
        return await _calibrationLogRepository.GetReportDataAsync(startDate, endDate, testName, qcResult);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\RolePermissionService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Data.Abstractions;
using Task = System.Threading.Tasks.Task;

namespace PortalMirage.Business;

public class RolePermissionService(
    IRoleRepository roleRepository,
    IPermissionRepository permissionRepository,
    IRolePermissionRepository rolePermissionRepository) : IRolePermissionService
{
    public async Task<bool> AssignPermissionToRoleAsync(string roleName, string permissionName)
    {
        var roles = await roleRepository.GetAllAsync();
        var role = roles.FirstOrDefault(r => r.RoleName.Equals(roleName, StringComparison.OrdinalIgnoreCase));

        var permissions = await permissionRepository.GetAllAsync();
        var permission = permissions.FirstOrDefault(p => p.PermissionName.Equals(permissionName, StringComparison.OrdinalIgnoreCase));

        if (role is null || permission is null)
        {
            return false;
        }

        await rolePermissionRepository.AssignPermissionToRoleAsync(role.RoleID, permission.PermissionID);
        return true;
    }

    public async Task<bool> RemovePermissionFromRoleAsync(string roleName, string permissionName)
    {
        var roles = await roleRepository.GetAllAsync();
        var role = roles.FirstOrDefault(r => r.RoleName.Equals(roleName, StringComparison.OrdinalIgnoreCase));

        var permissions = await permissionRepository.GetAllAsync();
        var permission = permissions.FirstOrDefault(p => p.PermissionName.Equals(permissionName, StringComparison.OrdinalIgnoreCase));

        if (role is null || permission is null)
        {
            return false;
        }

        await rolePermissionRepository.RemovePermissionFromRoleAsync(role.RoleID, permission.PermissionID);
        return true;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\RoleService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using Task = System.Threading.Tasks.Task;

namespace PortalMirage.Business;

public class RoleService(IRoleRepository roleRepository) : IRoleService
{
    public async Task<IEnumerable<Role>> GetAllRolesAsync()
    {
        return await roleRepository.GetAllAsync();
    }

    public async Task<Role?> CreateRoleAsync(string roleName)
    {
        // 1. Business Rule: Check if a role with the same name already exists (ignoring case)
        var existingRoles = await roleRepository.GetAllAsync();
        if (existingRoles.Any(r => r.RoleName.Equals(roleName, StringComparison.OrdinalIgnoreCase)))
        {
            // Role name is already taken, creation fails.
            return null;
        }

        // 2. If the name is unique, create the new role object
        var roleToCreate = new Role { RoleName = roleName };

        // 3. Pass the new role to the data layer to be saved
        var createdRole = await roleRepository.CreateAsync(roleToCreate);

        return createdRole;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\SampleStorageService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class SampleStorageService(
    ISampleStorageRepository sampleStorageRepository,
    IAuditLogService auditLogService) : ISampleStorageService
{
    public async Task<SampleStorage> CreateAsync(SampleStorage sampleStorage)
    {
        var newSample = await sampleStorageRepository.CreateAsync(sampleStorage);

        // ADDED: Log the creation event
        await auditLogService.LogAsync(
            userId: newSample.StoredByUserID,
            actionType: "Create",
            moduleName: "SampleStorage",
            recordId: newSample.StorageID.ToString(),
            newValue: $"Sample ID: {newSample.PatientSampleID}, Test: {newSample.TestName}"
        );

        return newSample;
    }

    public async Task<IEnumerable<SampleStorage>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await sampleStorageRepository.GetPendingByDateRangeAsync(startDate, endDate);
    }

    public async Task<IEnumerable<SampleStorage>> GetCompletedByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        return await sampleStorageRepository.GetCompletedByDateRangeAsync(startDate, endDate);
    }

    public async Task<bool> MarkAsDoneAsync(int storageId, int userId)
    {
        // 1. Business Rule: First, check if the sample exists.
        var sample = await sampleStorageRepository.GetByIdAsync(storageId);
        if (sample is null)
        {
            return false; // Can't update something that doesn't exist.
        }

        // 2. Business Rule: Check if it's already marked as done.
        if (sample.IsTestDone)
        {
            return true; // Already done, so the operation is technically successful.
        }

        // 3. If it exists and is not done, then update it.
        var success = await sampleStorageRepository.MarkAsDoneAsync(storageId, userId);
        if (success)
        {
            // ADDED: Log the "test done" event
            await auditLogService.LogAsync(
                userId: userId,
                actionType: "Update",
                moduleName: "SampleStorage",
                recordId: storageId.ToString(),
                newValue: "Marked as Test Done"
            );
        }
        return success;
    }

    public async Task<bool> DeactivateAsync(int storageId, int userId, string reason)
    {
        var success = await sampleStorageRepository.DeactivateAsync(storageId, userId, reason);
        if (success)
        {
            await auditLogService.LogAsync(userId, "Deactivate", "SampleStorage", storageId.ToString(), newValue: reason);
        }
        return success;
    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\ShiftService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Business;

public class ShiftService(IShiftRepository shiftRepository, IAuditLogService auditLogService) : IShiftService
{
    public async Task<IEnumerable<Shift>> GetAllAsync()
    {
        return await shiftRepository.GetAllAsync();
    }

    public async Task<Shift?> GetByIdAsync(int shiftId)
    {
        return await shiftRepository.GetByIdAsync(shiftId);
    }

    public async Task<Shift> CreateAsync(Shift shift, int actorUserId)
    {
        // In the future, we could add business logic here,
        // like preventing overlapping shift times.
        var createdShift = await shiftRepository.CreateAsync(shift);
        await auditLogService.LogAsync(actorUserId, "Create", "ShiftManagement", createdShift.ShiftID.ToString(), newValue: $"Created shift '{createdShift.ShiftName}'");
        return createdShift;
    }

    public async Task<Shift> UpdateAsync(Shift shift, int actorUserId)
    {
        var updatedShift = await shiftRepository.UpdateAsync(shift);
        await auditLogService.LogAsync(actorUserId, "Update", "ShiftManagement", updatedShift.ShiftID.ToString(), newValue: $"Updated shift '{updatedShift.ShiftName}' (IsActive: {updatedShift.IsActive})");
        return updatedShift;
    }

    public async System.Threading.Tasks.Task DeactivateAsync(int shiftId, int actorUserId)
    {
        var shift = await shiftRepository.GetByIdAsync(shiftId);
        await shiftRepository.DeactivateAsync(shiftId);
        await auditLogService.LogAsync(actorUserId, "Deactivate", "ShiftManagement", shiftId.ToString(), newValue: $"Deactivated shift '{shift?.ShiftName}'");
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\TimeProvider.cs
========================================
using System;
namespace PortalMirage.Business;

public interface ITimeProvider { DateTime Now { get; } DateTime Today { get; } }
public class SystemTimeProvider : ITimeProvider { public DateTime Now => DateTime.Now; public DateTime Today => DateTime.Today; }


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\UserRoleService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using Task = System.Threading.Tasks.Task;

namespace PortalMirage.Business;

public class UserRoleService(
    IUserRepository userRepository,
    IRoleRepository roleRepository,
    IUserRoleRepository userRoleRepository,
    IAuditLogService auditLogService) : IUserRoleService
{
    public async Task<bool> AssignRoleToUserAsync(string username, string roleName, int actorUserId)
    {
        // 1. Find the user and role by their names to get their IDs
        var user = await userRepository.GetByUsernameAsync(username);
        var roles = await roleRepository.GetAllAsync();
        var role = roles.FirstOrDefault(r => r.RoleName.Equals(roleName, StringComparison.OrdinalIgnoreCase));

        // 2. Business Rule: Ensure both user and role exist
        if (user is null || role is null)
        {
            return false; // Cannot assign if either doesn't exist
        }

        // 3. If they exist, create the link
        await userRoleRepository.AssignRoleToUserAsync(user.UserID, role.RoleID);
        await auditLogService.LogAsync(actorUserId, "Update", "UserManagement", user.UserID.ToString(), newValue: $"Assigned role '{role.RoleName}' to user '{username}'");
        return true;
    }

    public async Task<IEnumerable<Role>> GetRolesForUserAsync(string username)
    {
        return await userRoleRepository.GetRolesForUserAsync(username); // You will need to create this repository method
    }

    public async Task<bool> RemoveRoleFromUserAsync(string username, string roleName, int actorUserId)
    {
        var user = await userRepository.GetByUsernameAsync(username);
        var roles = await roleRepository.GetAllAsync();
        var role = roles.FirstOrDefault(r => r.RoleName.Equals(roleName, StringComparison.OrdinalIgnoreCase));

        if (user is null || role is null)
        {
            return false;
        }

        await userRoleRepository.RemoveRoleFromUserAsync(user.UserID, role.RoleID);
        await auditLogService.LogAsync(actorUserId, "Update", "UserManagement", user.UserID.ToString(), newValue: $"Removed role '{role.RoleName}' from user '{username}'");
        return true;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Business\UserService.cs
========================================
using PortalMirage.Business.Abstractions;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using Task = System.Threading.Tasks.Task;

namespace PortalMirage.Business;

public class UserService(IUserRepository userRepository, IAuditLogService auditLogService) : IUserService
{
    public async Task<User?> RegisterUserAsync(string username, string password, string fullName, int? actorUserId)
    {
        var existingUser = await userRepository.GetByUsernameAsync(username);
        if (existingUser is not null)
        {
            return null;
        }

        var passwordHash = BCrypt.Net.BCrypt.HashPassword(password);

        var userToCreate = new User
        {
            Username = username,
            PasswordHash = passwordHash,
            FullName = fullName,
            IsActive = true
        };

        var createdUser = await userRepository.CreateAsync(userToCreate);

        // Only log if an actor ID is provided (i.e., an admin is creating the user)
        if (actorUserId.HasValue)
        {
            await auditLogService.LogAsync(actorUserId.Value, "Create", "UserManagement", createdUser.UserID.ToString(), newValue: $"Created new user '{createdUser.Username}'");
        }

        return createdUser;
    }

    public async Task<User?> ValidateCredentialsAsync(string username, string password)
    {
        var user = await userRepository.GetByUsernameAsync(username);
        if (user is null)
        {
            return null;
        }

        if (!BCrypt.Net.BCrypt.Verify(password, user.PasswordHash))
        {
            return null;
        }

        return user;
    }

    public async Task<User?> GetUserByIdAsync(int userId)
    {
        return await userRepository.GetByIdAsync(userId);
    }

    public async Task<IEnumerable<User>> GetAllUsersAsync()
    {
        return await userRepository.GetAllAsync();
    }

    public async Task<bool> ResetPasswordAsync(string username, string newPassword, int actorUserId)
    {
        var user = await userRepository.GetByUsernameAsync(username);
        if (user is null)
        {
            return false;
        }

        var newPasswordHash = BCrypt.Net.BCrypt.HashPassword(newPassword);
        var success = await userRepository.UpdatePasswordHashAsync(user.UserID, newPasswordHash);

        if (success)
        {
            // Correctly logs the ID of the admin who performed the action
            await auditLogService.LogAsync(
                userId: actorUserId,
                actionType: "ResetPassword",
                moduleName: "UserManagement",
                recordId: user.UserID.ToString(),
                newValue: $"Password reset for user '{username}'."
            );
        }
        return success;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\AdminDtos.cs
========================================
namespace PortalMirage.Core.Dtos;

// This is the missing class causing the error
public record AssignRoleRequest(string Username, string RoleName);



// This is used by your GetAllRoles endpoint
public record RoleResponse(int RoleID, string RoleName);

// Request for an admin to create a new user
public record CreateUserRequest(string Username, string Password, string FullName);


public record CreateRoleRequest(string RoleName); // ADD THIS RECORD

public record ResetPasswordRequest(string Username, string NewPassword); // ADD THIS


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\AdminListDtos.cs
========================================
namespace PortalMirage.Core.Dtos;

public record AdminListItemDto(int ItemID, string ListType, string ItemValue, string? Description, bool IsActive);
public record CreateAdminListItemRequest(string ListType, string ItemValue, string? Description);
public record UpdateAdminListItemRequest(int ItemID, string ItemValue, string? Description, bool IsActive);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\AuditLogDto.cs
========================================
using System;

namespace PortalMirage.Core.Dtos;

public record AuditLogDto(
    long AuditID,
    int? UserID,
    string? UserFullName, // Joined from Users table
    DateTime Timestamp,
    string ActionType,
    string? ModuleName,
    string? RecordID,
    string? FieldName,
    string? OldValue,
    string? NewValue
);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\AuthDtos.cs
========================================
namespace PortalMirage.Core.Dtos;

public record LoginRequest(string Username, string Password);
public record UserResponse(int UserId, string Username, string FullName);
public record LoginResponse(string Token, UserResponse User);
public record RegisterUserRequest(string Username, string Password, string FullName);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\CalibrationLogDtos.cs
========================================
using System;
namespace PortalMirage.Core.Dtos;

public record CreateCalibrationLogRequest(string TestName, string QcResult, string? Reason);

public record DeactivateCalibrationLogRequest(string Reason);

public record CalibrationLogResponse(int CalibrationID, string TestName, string QcResult, string? Reason, DateTime CalibrationDateTime, int PerformedByUserID, string PerformedByUsername);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\DailyTaskLogAdminDtos.cs
========================================
using System;
namespace PortalMirage.Core.Dtos;
public record ExtendTaskDeadlineRequest(DateTime NewDeadline, string Reason);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\DailyTaskLogDtos.cs
========================================
namespace PortalMirage.Core.Dtos
{
    public class UpdateTaskStatusRequest
    {
        // 1. Add UserId so we can pass it to the strict backend
        public int UserId { get; set; }

        public string Status { get; set; } = string.Empty;
        public string? Comment { get; set; }

        // 2. Add an Empty Constructor (Required for 'new Request { ... }' syntax)
        public UpdateTaskStatusRequest() { }

        // 3. Keep the old constructor to prevent breaking other code (optional but safe)
        public UpdateTaskStatusRequest(string status, string? comment)
        {
            Status = status;
            Comment = comment;
        }
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\DashboardDtos.cs
========================================
namespace PortalMirage.Core.Dtos;

public record DashboardSummaryDto(
    int PendingHandoversCount,
    int UnresolvedBreakdownsCount,
    int PendingDailyTasksCount,  
    int PendingSamplesCount // ADD THIS LINE
);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\HandoverDtos.cs
========================================
using System;

namespace PortalMirage.Core.Dtos;

public record CreateHandoverRequest(string HandoverNotes, string Priority, string Shift);

public record DeactivateHandoverRequest(string Reason);
public record HandoverResponse(
    int HandoverID,
    string HandoverNotes,
    string Priority,
    string Shift,
    DateTime GivenDateTime,
    int GivenByUserID,
    string GivenByUsername,
    bool IsReceived,
    DateTime? ReceivedDateTime,
    int? ReceivedByUserID,
    string? ReceivedByUsername);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\KitValidationDtos.cs
========================================
using System;
namespace PortalMirage.Core.Dtos;

public record CreateKitValidationRequest(string KitName, string KitLotNumber, DateTime KitExpiryDate, string ValidationStatus, string? Comments);
public record KitValidationResponse(int ValidationID, string KitName, string KitLotNumber, DateTime KitExpiryDate, string ValidationStatus, string? Comments, DateTime ValidationDateTime, int ValidatedByUserID, string ValidatedByUsername);

public record DeactivateKitValidationRequest(string Reason);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\MachineBreakdownDtos.cs
========================================
using System;
namespace PortalMirage.Core.Dtos;

public record CreateMachineBreakdownRequest(string MachineName, string BreakdownReason);

public record ResolveBreakdownRequest(string ResolutionNotes);

public record DeactivateMachineBreakdownRequest(string Reason);

public record MachineBreakdownResponse(
    int BreakdownID,
    string MachineName,
    string BreakdownReason,
    DateTime ReportedDateTime,
    int ReportedByUserID,
    string ReportedByUsername,
    bool IsResolved,
    DateTime? ResolvedDateTime,
    int? ResolvedByUserID,
    string? ResolvedByUsername,
    string? ResolutionNotes,      // Add this line
    int? DowntimeMinutes);        // Add this line


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\MediaSterilityDtos.cs
========================================
using System;
namespace PortalMirage.Core.Dtos;

public record CreateMediaSterilityCheckRequest(
    string MediaName,
    string MediaLotNumber,
    string? MediaQuantity,
    string Result37C,
    string Result25C,
    string? Comments);

public record DeactivateMediaSterilityCheckRequest(string Reason);

public record MediaSterilityCheckResponse(
    int SterilityCheckID,
    string MediaName,
    string MediaLotNumber,
    string? MediaQuantity,
    string Result37C,
    string Result25C,
    string OverallStatus,
    string? Comments,
    DateTime CheckDateTime,
    int PerformedByUserID,
    string PerformedByUsername);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\RepeatSampleDtos.cs
========================================
using System;

namespace PortalMirage.Core.Dtos;

public record CreateRepeatSampleRequest(
    string PatientIdCardNumber,
    string PatientName,
    string? ReasonText,
    string? InformedPerson,
    string? Department);

public record DeactivateRepeatSampleRequest(string Reason);

public record RepeatSampleResponse(
    int RepeatID,
    string? PatientIdCardNumber,
    string PatientName,
    string? ReasonText,
    string? InformedPerson,
    string? Department,
    DateTime LogDateTime,
    int LoggedByUserID,
    string LoggedByUsername);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\ReportDtos.cs
========================================
using CommunityToolkit.Mvvm.ComponentModel;
using System;

namespace PortalMirage.Core.Dtos;

public partial class MachineBreakdownReportDto : ObservableObject
{
    public DateTime ReportedDateTime { get; set; }
    public string MachineName { get; set; }
    public string BreakdownReason { get; set; }
    public string ReportedByUsername { get; set; }
    public bool IsResolved { get; set; }
    public DateTime? ResolvedDateTime { get; set; }
    public string? ResolvedByUsername { get; set; }
    public string? ResolutionNotes { get; set; }
    public int? DowntimeMinutes { get; set; }

    public string ElapsedDowntimeDisplay
    {
        get
        {
            if (IsResolved)
            {
                return $"{DowntimeMinutes} mins";
            }
            else
            {
                var elapsed = DateTime.Now - ReportedDateTime;
                if (elapsed.Days > 0) return $"{elapsed.Days}d {elapsed.Hours}h";
                if (elapsed.Hours > 0) return $"{elapsed.Hours}h {elapsed.Minutes}m";
                return $"{elapsed.Minutes}m";
            }
        }
    }

    // This method is now correctly placed INSIDE the class
    public void UpdateCalculatedProperties()
    {
        OnPropertyChanged(nameof(ElapsedDowntimeDisplay));
    }
}

public record HandoverReportDto(
    DateTime GivenDateTime,
    string GivenByUsername,
    string Shift,
    string Priority,
    string HandoverNotes,
    bool IsReceived,
    DateTime? ReceivedDateTime,
    string? ReceivedByUsername
);
public record KitValidationReportDto(
    DateTime ValidationDateTime,
    string KitName,
    string KitLotNumber,
    DateTime KitExpiryDate,
    string ValidationStatus,
    string? Comments,
    string ValidatedByUsername
);

public record DailyTaskComplianceReportItemDto(
    DateTime LogDate,
    string TaskName,
    string ShiftName,
    string Status,
    DateTime? CompletedDateTime,
    string? CompletedByUsername,
    string? Comments
);

public record DailyTaskComplianceReportDto(
    List<DailyTaskComplianceReportItemDto> Items,
    int TotalTasks,
    int CompletedTasks
);

public record RepeatSampleReportDto(
    DateTime LogDateTime,
    string? PatientIdCardNumber,
    string PatientName,
    string? ReasonText,
    string? Department,
    string? InformedPerson,
    string LoggedByUsername
);

public record MediaSterilityReportDto(
    DateTime CheckDateTime,
    string MediaName,
    string MediaLotNumber,
    string? MediaQuantity,
    string Result37C,
    string Result25C,
    string OverallStatus,
    string? Comments,
    string PerformedByUsername
);

public record SampleStorageReportDto(
    DateTime StorageDateTime,
    string PatientSampleID,
    string TestName,
    string StoredByUsername,
    bool IsTestDone,
    DateTime? TestDoneDateTime,
    string? TestDoneByUsername
);

public record CalibrationReportDto(
    DateTime CalibrationDateTime,
    string TestName,
    string QcResult,
    string? Reason,
    string PerformedByUsername
);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\SampleStorageDtos.cs
========================================
using System;

namespace PortalMirage.Core.Dtos;

public record CreateSampleStorageRequest(string PatientSampleID, string TestName);

public record DeactivateSampleStorageRequest(string Reason);

public record SampleStorageResponse(
    int StorageID,
    string PatientSampleID,
    string TestName,
    DateTime StorageDateTime,
    int StoredByUserID,
    string StoredByUsername,
    bool IsTestDone,
    DateTime? TestDoneDateTime,
    int? TestDoneByUserID,
    string? TestDoneByUsername); // Add this nullable property


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Dtos\ShiftDtos.cs
========================================
using System;

namespace PortalMirage.Core.Dtos;

public record ShiftResponse(
    int ShiftID,
    string ShiftName,
    TimeOnly StartTime,
    TimeOnly EndTime,
    int GracePeriodHours,
    bool IsActive);

public record CreateShiftRequest(
    string ShiftName,
    TimeOnly StartTime,
    TimeOnly EndTime,
    int GracePeriodHours);

public record UpdateShiftRequest(
    int ShiftID, // This was the missing property
    string ShiftName,
    TimeOnly StartTime,
    TimeOnly EndTime,
    int GracePeriodHours,
    bool IsActive);


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\AdminListItem.cs
========================================
namespace PortalMirage.Core.Models;

public record AdminListItem
{
    public int ItemID { get; init; }
    public required string ListType { get; set; }
    public required string ItemValue { get; set; }
    public bool IsActive { get; set; }

    public string? Description { get; set; } // Add this line
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\AuditLog.cs
========================================
namespace PortalMirage.Core.Models;

public record AuditLog
{
    public long AuditID { get; init; }
    public int? UserID { get; set; } // Nullable, as some system events might not have a user
    public DateTime Timestamp { get; init; }
    public required string ActionType { get; set; }
    public string? ModuleName { get; set; }
    public string? RecordID { get; set; }
    public string? FieldName { get; set; }
    public string? OldValue { get; set; }
    public string? NewValue { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\CalibrationLog.cs
========================================
namespace PortalMirage.Core.Models;

public record CalibrationLog
{
    public int CalibrationID { get; init; }
    public required string TestName { get; set; }
    public required string QcResult { get; set; }
    public string? Reason { get; set; }
    public DateTime CalibrationDateTime { get; init; }
    public int PerformedByUserID { get; set; }

    public bool IsActive { get; set; }
    public string? DeactivationReason { get; set; }
    public int? DeactivatedByUserID { get; set; }
    public DateTime? DeactivationDateTime { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\DailyTaskLog.cs
========================================
using System;
namespace PortalMirage.Core.Models;
public record DailyTaskLog
{
    public long LogID { get; init; }
    public int TaskID { get; set; }
    public DateTime LogDate { get; set; }
    public required string Status { get; set; }
    public string? Comments { get; set; }
    public int? CompletedByUserID { get; set; }
    public DateTime? CompletedDateTime { get; set; }
    public DateTime? LockOverrideUntil { get; set; }
    public string? LockOverrideReason { get; set; }
    public int? LockOverrideByUserID { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\Handover.cs
========================================
namespace PortalMirage.Core.Models;

public record Handover
{
    public int HandoverID { get; init; }
    public required string HandoverNotes { get; set; }
    public DateTime GivenDateTime { get; init; }
    public int GivenByUserID { get; set; }
    public bool IsReceived { get; set; }
    public DateTime? ReceivedDateTime { get; set; }
    public int? ReceivedByUserID { get; set; }

    public required string Priority { get; set; } // Add this
    public required string Shift { get; set; }    // Add this

    public bool IsActive { get; set; }
    public string? DeactivationReason { get; set; }
    public int? DeactivatedByUserID { get; set; }
    public DateTime? DeactivationDateTime { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\KitValidation.cs
========================================
namespace PortalMirage.Core.Models;

public record KitValidation
{
    public int ValidationID { get; init; }
    public required string KitName { get; set; }
    public required string KitLotNumber { get; set; }
    public DateTime KitExpiryDate { get; set; }
    public required string ValidationStatus { get; set; }
    public string? Comments { get; set; }
    public DateTime ValidationDateTime { get; init; }
    public int ValidatedByUserID { get; set; }

    public bool IsActive { get; set; }
    public string? DeactivationReason { get; set; }
    public int? DeactivatedByUserID { get; set; }
    public DateTime? DeactivationDateTime { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\MachineBreakdown.cs
========================================
namespace PortalMirage.Core.Models;

public record MachineBreakdown
{
    public int BreakdownID { get; init; }
    public required string MachineName { get; set; }
    public required string BreakdownReason { get; set; }
    public DateTime ReportedDateTime { get; init; }
    public int ReportedByUserID { get; set; }
    public bool IsResolved { get; set; }
    public DateTime? ResolvedDateTime { get; set; }
    public int? ResolvedByUserID { get; set; }
    public string? ResolutionNotes { get; set; }
    public int? DowntimeMinutes { get; set; }

    // New properties for deactivation
    public bool IsActive { get; set; }
    public string? DeactivationReason { get; set; }
    public int? DeactivatedByUserID { get; set; }
    public DateTime? DeactivationDateTime { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\MediaSterilityCheck.cs
========================================
namespace PortalMirage.Core.Models;

public record MediaSterilityCheck
{
    public int SterilityCheckID { get; init; }
    public required string MediaName { get; set; }
    public required string MediaLotNumber { get; set; }
    public string? MediaQuantity { get; set; }
    public required string Result37C { get; set; }
    public required string Result25C { get; set; }
    public required string OverallStatus { get; set; }
    public string? Comments { get; set; }
    public DateTime CheckDateTime { get; init; }
    public int PerformedByUserID { get; set; }

    public bool IsActive { get; set; }
    public string? DeactivationReason { get; set; }
    public int? DeactivatedByUserID { get; set; }
    public DateTime? DeactivationDateTime { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\Permission.cs
========================================
namespace PortalMirage.Core.Models;

public record Permission
{
    public int PermissionID { get; init; }
    public required string PermissionName { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\RepeatSampleLog.cs
========================================
using System;

namespace PortalMirage.Core.Models;

public record RepeatSampleLog
{
    public int RepeatID { get; init; }
    public string? PatientIdCardNumber { get; set; }
    public required string PatientName { get; set; }
    public string? ReasonText { get; set; }
    public string? InformedPerson { get; set; }
    public string? Department { get; set; }
    public DateTime LogDateTime { get; init; }
    public int LoggedByUserID { get; set; }
    public bool IsActive { get; set; }
    public string? DeactivationReason { get; set; }
    public int? DeactivatedByUserID { get; set; }
    public DateTime? DeactivationDateTime { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\Role.cs
========================================
namespace PortalMirage.Core.Models;

public record Role
{
    public int RoleID { get; init; }
    public required string RoleName { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\RolePermission.cs
========================================
namespace PortalMirage.Core.Models;

public record RolePermission
{
    public int RoleID { get; set; }
    public int PermissionID { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\SampleStorage.cs
========================================
namespace PortalMirage.Core.Models;

public record SampleStorage
{
    public int StorageID { get; init; }
    public required string PatientSampleID { get; set; }

    public required string TestName { get; set; } // Add this line
    public DateTime StorageDateTime { get; init; }
    public int StoredByUserID { get; set; }
    public bool IsTestDone { get; set; }
    public DateTime? TestDoneDateTime { get; set; }
    public int? TestDoneByUserID { get; set; }

    public bool IsActive { get; set; } // Add this line

    public string? DeactivationReason { get; set; }
    public int? DeactivatedByUserID { get; set; }
    public DateTime? DeactivationDateTime { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\Shift.cs
========================================
using System;

namespace PortalMirage.Core.Models;

public record Shift
{
    public int ShiftID { get; init; }
    public required string ShiftName { get; set; }
    public TimeOnly StartTime { get; set; }
    public TimeOnly EndTime { get; set; }
    public int GracePeriodHours { get; set; }
    public bool IsActive { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\TaskLogDetailDto.cs
========================================
using System;
namespace PortalMirage.Core.Models;

public record TaskLogDetailDto
{
    public long LogID { get; init; }
    public required string TaskName { get; init; }
    public required string TaskCategory { get; init; }
    public required string Status { get; init; }
    public DateTime? CompletedDateTime { get; init; }
    public int? CompletedByUserID { get; init; }
    public string? CompletedByUsername { get; set; }
    public string? Comments { get; set; }
    public DateTime? LockOverrideUntil { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\TaskModel.cs
========================================
namespace PortalMirage.Core.Models;

// Renamed to TaskModel to avoid conflict with System.Threading.Tasks.Task
public record TaskModel
{
    public int TaskID { get; init; }
    public required string TaskName { get; set; }
    public int? ShiftID { get; set; }
    public required string ScheduleType { get; set; }
    public string? ScheduleValue { get; set; }
    public bool IsActive { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\User.cs
========================================
namespace PortalMirage.Core.Models;

public record User
{
    public int UserID { get; init; }
    public required string Username { get; set; }
    public required string PasswordHash { get; set; }
    public required string FullName { get; set; }
    public bool IsActive { get; set; }
    public DateTime CreatedAt { get; init; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Models\UserRole.cs
========================================
namespace PortalMirage.Core.Models;

public record UserRole
{
    public int UserID { get; set; }
    public int RoleID { get; set; }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\Class1.cs
========================================
namespace PortalMirage.Core
{
    public class Class1
    {

    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Core\PortalMirage.Core.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.0.0" />
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IAdminListRepository.cs
========================================
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface IAdminListRepository
{
    Task<IEnumerable<AdminListItem>> GetAllAsync();
    Task<IEnumerable<AdminListItem>> GetByTypeAsync(string listType);
    Task<AdminListItem> CreateAsync(AdminListItem item);
    Task<AdminListItem> UpdateAsync(AdminListItem item);

    Task<AdminListItem?> GetItemAsync(string listType, string itemValue);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IAuditLogRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models; // Add this using statement
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface IAuditLogRepository
{
    // This is the new method for retrieving logs
    Task<IEnumerable<AuditLogDto>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);

    // This is the missing method that the AuditLogService needs
    System.Threading.Tasks.Task CreateAsync(AuditLog logEntry);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\ICalibrationLogRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;

namespace PortalMirage.Data.Abstractions;

public interface ICalibrationLogRepository
{
    Task<CalibrationLog> CreateAsync(CalibrationLog calibrationLog);
    Task<IEnumerable<CalibrationLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);

    Task<bool> DeactivateAsync(int logId, int userId, string reason);

    Task<IEnumerable<CalibrationReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? testName, string? qcResult); // ADD THIS

}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IDailyTaskLogRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface IDailyTaskLogRepository
{
    Task<DailyTaskLog> CreateAsync(DailyTaskLog log);
    Task<IEnumerable<DailyTaskLog>> GetForDateAsync(DateTime date);
    Task<DailyTaskLog?> UpdateStatusAsync(long logId, string status, int? userId, string? comment);
    Task<DailyTaskLog?> ExtendDeadlineAsync(long logId, DateTime newDeadline, string reason, int adminUserId);
    Task<DailyTaskLog?> OverrideLockAsync(long logId, DateTime overrideUntil, string reason, int adminUserId);
    Task<IEnumerable<DailyTaskComplianceReportItemDto>> GetComplianceReportDataAsync(DateTime startDate, DateTime endDate, int? shiftId, string? status); // ADD THIS
    Task<int> GetPendingCountForDateAsync(DateTime date); // ADD THIS LINE
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IDbConnectionFactory.cs
========================================
using System.Data;

namespace PortalMirage.Data.Abstractions;

public interface IDbConnectionFactory
{
    Task<IDbConnection> CreateConnectionAsync();
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IHandoverRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface IHandoverRepository
{
    Task<Handover> CreateAsync(Handover handover);
    Task<IEnumerable<Handover>> GetPendingAsync(DateTime startDate, DateTime endDate);
    Task<IEnumerable<Handover>> GetCompletedAsync(DateTime startDate, DateTime endDate);
    Task<Handover?> GetByIdAsync(int handoverId);
    Task<bool> MarkAsReceivedAsync(int handoverId, int userId);
    Task<bool> DeactivateAsync(int handoverId, int userId, string reason);

    Task<int> GetPendingCountAsync(); // ADD THIS LINE

    Task<IEnumerable<HandoverReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? shift, string? priority, string? status); // ADD THIS LINE


}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IKitValidationRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;

namespace PortalMirage.Data.Abstractions;

public interface IKitValidationRepository
{
    Task<KitValidation> CreateAsync(KitValidation kitValidation);
    Task<IEnumerable<KitValidation>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);

    Task<bool> DeactivateAsync(int validationId, int userId, string reason);

    Task<IEnumerable<KitValidationReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? kitName, string? status); // ADD THIS

}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IMachineBreakdownRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface IMachineBreakdownRepository
{
    Task<MachineBreakdown> CreateAsync(MachineBreakdown breakdown);
    Task<IEnumerable<MachineBreakdown>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<IEnumerable<MachineBreakdown>> GetResolvedByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<MachineBreakdown?> GetByIdAsync(int breakdownId); // This was missing
    Task<bool> MarkAsResolvedAsync(int breakdownId, int userId, string resolutionNotes);
    Task<bool> DeactivateAsync(int breakdownId, int userId, string reason); // This is new

    Task<int> GetPendingCountAsync(); // ADD THIS LINE

    Task<IEnumerable<MachineBreakdownReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? machineName, string? status); // ADD THIS LINE
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IMediaSterilityCheckRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;

namespace PortalMirage.Data.Abstractions;

public interface IMediaSterilityCheckRepository
{
    Task<MediaSterilityCheck> CreateAsync(MediaSterilityCheck sterilityCheck);
    Task<IEnumerable<MediaSterilityCheck>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<bool> DeactivateAsync(int checkId, int userId, string reason);

    Task<IEnumerable<MediaSterilityReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? mediaName, string? status);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IPermissionRepository.cs
========================================
using PortalMirage.Core.Models;

namespace PortalMirage.Data.Abstractions;

public interface IPermissionRepository
{
    Task<IEnumerable<Permission>> GetAllAsync();
    Task<Permission> CreateAsync(Permission permission);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IRepeatSampleLogRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface IRepeatSampleLogRepository
{
    Task<RepeatSampleLog> CreateAsync(RepeatSampleLog repeatSampleLog);
    Task<IEnumerable<RepeatSampleLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<bool> DeactivateAsync(int repeatId, int userId, string reason);

    Task<IEnumerable<RepeatSampleReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? reason, string? department); // ADD THIS
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IRolePermissionRepository.cs
========================================
namespace PortalMirage.Data.Abstractions;

public interface IRolePermissionRepository
{
    Task AssignPermissionToRoleAsync(int roleId, int permissionId);
    Task RemovePermissionFromRoleAsync(int roleId, int permissionId);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IRoleRepository.cs
========================================
using PortalMirage.Core.Models;

namespace PortalMirage.Data.Abstractions;

public interface IRoleRepository
{
    Task<IEnumerable<Role>> GetAllAsync();
    Task<Role> CreateAsync(Role role);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\ISampleStorageRepository.cs
========================================
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface ISampleStorageRepository
{
    Task<SampleStorage> CreateAsync(SampleStorage sampleStorage);
    Task<IEnumerable<SampleStorage>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<IEnumerable<SampleStorage>> GetCompletedByDateRangeAsync(DateTime startDate, DateTime endDate);
    Task<SampleStorage?> GetByIdAsync(int storageId);
    Task<bool> MarkAsDoneAsync(int storageId, int userId);
    Task<bool> DeactivateAsync(int storageId, int userId, string reason); // This is the corrected signature

    Task<int> GetPendingCountAsync(); // ADD THIS LINE

    Task<IEnumerable<SampleStorageReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? testName, string? status);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IShiftRepository.cs
========================================
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data.Abstractions;

public interface IShiftRepository
{
    Task<IEnumerable<Shift>> GetAllAsync();
    Task<Shift?> GetByIdAsync(int shiftId);
    Task<Shift> CreateAsync(Shift shift);
    Task<Shift> UpdateAsync(Shift shift);

    System.Threading.Tasks.Task DeactivateAsync(int shiftId);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\ITaskRepository.cs
========================================
using PortalMirage.Core.Models;
using System.Collections.Generic;
using System.Threading.Tasks;


namespace PortalMirage.Data.Abstractions;

public interface ITaskRepository
{
    Task<IEnumerable<TaskModel>> GetAllAsync();
    Task<TaskModel> CreateAsync(TaskModel task);
    Task<IEnumerable<TaskModel>> GetByIdsAsync(IEnumerable<int> taskIds);
    Task<TaskModel?> GetByIdAsync(int taskId);

    Task DeactivateAsync(int taskId);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IUserRepository.cs
========================================
using PortalMirage.Core.Models;

namespace PortalMirage.Data.Abstractions;

public interface IUserRepository
{
    Task<User?> GetByUsernameAsync(string username);
    Task<User> CreateAsync(User user);

    Task<User?> GetByIdAsync(int userId);

    Task<IEnumerable<User>> GetAllAsync(); // Add this line

    Task<IEnumerable<string>> GetUserRolesAsync(int userId);


    Task<IEnumerable<User>> GetByIdsAsync(IEnumerable<int> userIds);
    Task<bool> UpdatePasswordHashAsync(int userId, string newPasswordHash); // ADD THIS LINE
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Abstractions\IUserRoleRepository.cs
========================================
using PortalMirage.Core.Models;

namespace PortalMirage.Data.Abstractions;

public interface IUserRoleRepository
{
    System.Threading.Tasks.Task AssignRoleToUserAsync(int userId, int roleId);
    System.Threading.Tasks.Task RemoveRoleFromUserAsync(int userId, int roleId);

    System.Threading.Tasks.Task<IEnumerable<Role>> GetRolesForUserAsync(string username);
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\AdminListRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class AdminListRepository(IDbConnectionFactory connectionFactory) : IAdminListRepository
{
    public async Task<IEnumerable<AdminListItem>> GetAllAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM AdminListItems ORDER BY ListType, ItemValue";
        return await connection.QueryAsync<AdminListItem>(sql);
    }

    public async Task<IEnumerable<AdminListItem>> GetByTypeAsync(string listType)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM AdminListItems WHERE ListType = @ListType ORDER BY ItemValue";
        return await connection.QueryAsync<AdminListItem>(sql, new { ListType = listType });
    }

    public async Task<AdminListItem> CreateAsync(AdminListItem item)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO AdminListItems (ListType, ItemValue, Description, IsActive)
                           OUTPUT INSERTED.*
                           VALUES (@ListType, @ItemValue, @Description, @IsActive);
                           """;
        return await connection.QuerySingleAsync<AdminListItem>(sql, item);
    }

    public async Task<AdminListItem> UpdateAsync(AdminListItem item)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE AdminListItems
                           SET ItemValue = @ItemValue,
                               Description = @Description,
                               IsActive = @IsActive
                           OUTPUT INSERTED.*
                           WHERE ItemID = @ItemID;
                           """;
        return await connection.QuerySingleAsync<AdminListItem>(sql, item);
    }

    public async Task<AdminListItem?> GetItemAsync(string listType, string itemValue)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM AdminListItems WHERE ListType = @ListType AND ItemValue = @ItemValue";
        return await connection.QuerySingleOrDefaultAsync<AdminListItem>(sql, new { ListType = listType, ItemValue = itemValue });
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\AuditLogRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class AuditLogRepository(IDbConnectionFactory connectionFactory) : IAuditLogRepository
{
    public async Task<IEnumerable<AuditLogDto>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        const string sql = """
                           SELECT 
                               a.AuditID, a.UserID, u.FullName AS UserFullName, a.Timestamp,
                               a.ActionType, a.ModuleName, a.RecordID, a.FieldName,
                               a.OldValue, a.NewValue
                           FROM AuditLog a
                           LEFT JOIN Users u ON a.UserID = u.UserID
                           WHERE a.Timestamp >= @StartDate AND a.Timestamp < @InclusiveEndDate
                           ORDER BY a.Timestamp DESC;
                           """;
        return await connection.QueryAsync<AuditLogDto>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async System.Threading.Tasks. Task CreateAsync(AuditLog logEntry)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO AuditLog (UserID, ActionType, ModuleName, RecordID, FieldName, OldValue, NewValue)
                           VALUES (@UserID, @ActionType, @ModuleName, @RecordID, @FieldName, @OldValue, @NewValue);
                           """;
        await connection.ExecuteAsync(sql, logEntry);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\CalibrationLogRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Core.Dtos;
using PortalMirage.Data.Abstractions;
using System.Text;

namespace PortalMirage.Data;

public class CalibrationLogRepository(IDbConnectionFactory connectionFactory) : ICalibrationLogRepository
{
    public async Task<CalibrationLog> CreateAsync(CalibrationLog calibrationLog)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO CalibrationLogs (TestName, QcResult, Reason, PerformedByUserID)
                           OUTPUT INSERTED.*
                           VALUES (@TestName, @QcResult, @Reason, @PerformedByUserID);
                           """;
        return await connection.QuerySingleAsync<CalibrationLog>(sql, calibrationLog);
    }

    public async Task<bool> DeactivateAsync(int logId, int userId, string reason)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE CalibrationLogs SET IsActive = 0, DeactivationReason = @Reason, 
                           DeactivatedByUserID = @UserId, DeactivationDateTime = GETDATE()
                           WHERE CalibrationID = @LogId AND IsActive = 1;
                           """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { LogId = logId, UserId = userId, Reason = reason });
        return rowsAffected > 0;
    }

    public async Task<IEnumerable<CalibrationLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();

        // This adjusts the end date to be the start of the *next* day, 
        // ensuring we capture everything within the selected end date.
        var inclusiveEndDate = endDate.Date.AddDays(1);

        const string sql = "SELECT * FROM CalibrationLogs WHERE IsActive = 1 AND CalibrationDateTime >= @StartDate AND CalibrationDateTime < @InclusiveEndDate ORDER BY CalibrationDateTime DESC";

        return await connection.QueryAsync<CalibrationLog>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<IEnumerable<CalibrationReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? testName, string? qcResult)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                c.CalibrationDateTime,
                c.TestName,
                c.QcResult,
                c.Reason,
                u.FullName AS PerformedByUsername
            FROM CalibrationLogs c
            LEFT JOIN Users u ON c.PerformedByUserID = u.UserID
            WHERE c.IsActive = 1 
              AND c.CalibrationDateTime >= @StartDate 
              AND c.CalibrationDateTime < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (!string.IsNullOrEmpty(testName) && testName != "All")
        {
            sqlBuilder.Append(" AND c.TestName = @TestName");
            parameters.Add("TestName", testName);
        }

        if (!string.IsNullOrEmpty(qcResult) && qcResult != "All")
        {
            sqlBuilder.Append(" AND c.QcResult = @QcResult");
            parameters.Add("QcResult", qcResult);
        }

        sqlBuilder.Append(" ORDER BY c.CalibrationDateTime DESC;");

        return await connection.QueryAsync<CalibrationReportDto>(sqlBuilder.ToString(), parameters);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\Class1.cs
========================================
namespace PortalMirage.Data
{
    public class Class1
    {

    }
}



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\DailyTaskLogRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using PortalMirage.Core.Dtos;
using System.Text;

namespace PortalMirage.Data;

public class DailyTaskLogRepository(IDbConnectionFactory connectionFactory) : IDailyTaskLogRepository
{
    public async Task<DailyTaskLog> CreateAsync(DailyTaskLog log)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO DailyTaskLogs (TaskID, LogDate, Status, CompletedByUserID, CompletedDateTime, Comments)
                           OUTPUT INSERTED.*
                           VALUES (@TaskID, @LogDate, @Status, @CompletedByUserID, @CompletedDateTime, @Comments);
                           """;
        return await connection.QuerySingleAsync<DailyTaskLog>(sql, log);
    }

    public async Task<IEnumerable<DailyTaskLog>> GetForDateAsync(DateTime date)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM DailyTaskLogs WHERE LogDate = @Date";
        return await connection.QueryAsync<DailyTaskLog>(sql, new { Date = date.Date });
    }

    public async Task<DailyTaskLog?> UpdateStatusAsync(long logId, string status, int? userId, string? comment)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var completedTime = status == "Completed" ? (DateTime?)DateTime.UtcNow : null;
        const string sql = """
                           UPDATE DailyTaskLogs
                           SET Status = @Status, 
                               CompletedByUserID = @UserId, 
                               CompletedDateTime = @CompletedTime,
                               Comments = @Comment
                           OUTPUT INSERTED.*
                           WHERE LogID = @LogId;
                           """;
        return await connection.QuerySingleOrDefaultAsync<DailyTaskLog>(sql, new
        {
            LogId = logId,
            Status = status,
            UserId = userId,
            Comment = comment,
            CompletedTime = completedTime
        });
    }

    public async Task<DailyTaskLog?> ExtendDeadlineAsync(long logId, DateTime newDeadline, string reason, int adminUserId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE DailyTaskLogs
                           SET Status = 'Pending',
                               LockOverrideUntil = @NewDeadline,
                               LockOverrideReason = @Reason,
                               LockOverrideByUserID = @AdminUserId
                           OUTPUT INSERTED.*
                           WHERE LogID = @LogId;
                           """;
        return await connection.QuerySingleOrDefaultAsync<DailyTaskLog>(sql, new
        {
            LogId = logId,
            NewDeadline = newDeadline,
            Reason = reason,
            AdminUserId = adminUserId
        });
    }

    public async Task<int> GetPendingCountForDateAsync(DateTime date)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = @"
            SELECT COUNT(dtl.LogID)
            FROM DailyTaskLogs dtl
            INNER JOIN Tasks t ON dtl.TaskID = t.TaskID
            INNER JOIN Shifts s ON t.ShiftID = s.ShiftID
            WHERE dtl.LogDate = @Date 
              AND dtl.Status = 'Pending'
              AND (
                dtl.LockOverrideUntil IS NULL OR dtl.LockOverrideUntil < GETDATE()
              )
              AND DATEADD(hour, s.GracePeriodHours, CAST(dtl.LogDate AS DATETIME) + CAST(s.EndTime AS DATETIME)) > GETDATE();
        ";
        return await connection.ExecuteScalarAsync<int>(sql, new { Date = date.Date });
    }

    public async Task<DailyTaskLog?> OverrideLockAsync(long logId, DateTime overrideUntil, string reason, int adminUserId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                       UPDATE DailyTaskLogs
                       SET Status = 'Pending',
                           LockOverrideUntil = @OverrideUntil,
                           LockOverrideReason = @Reason,
                           LockOverrideByUserID = @AdminUserId
                       OUTPUT INSERTED.*
                       WHERE LogID = @LogId;
                       """;
        return await connection.QuerySingleOrDefaultAsync<DailyTaskLog>(sql, new
        {
            LogId = logId,
            OverrideUntil = overrideUntil,
            Reason = reason,
            AdminUserId = adminUserId
        });
    }

    public async Task<IEnumerable<DailyTaskComplianceReportItemDto>> GetComplianceReportDataAsync(DateTime startDate, DateTime endDate, int? shiftId, string? status)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                dtl.LogDate,
                t.TaskName,
                s.ShiftName,
                dtl.Status,
                dtl.CompletedDateTime,
                u.FullName AS CompletedByUsername,
                dtl.Comments
            FROM DailyTaskLogs dtl
            INNER JOIN Tasks t ON dtl.TaskID = t.TaskID
            LEFT JOIN Shifts s ON t.ShiftID = s.ShiftID
            LEFT JOIN Users u ON dtl.CompletedByUserID = u.UserID
            WHERE dtl.LogDate >= @StartDate AND dtl.LogDate < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (shiftId.HasValue)
        {
            sqlBuilder.Append(" AND t.ShiftID = @ShiftID");
            parameters.Add("ShiftID", shiftId.Value);
        }

        if (!string.IsNullOrEmpty(status) && status != "All")
        {
            sqlBuilder.Append(" AND dtl.Status = @Status");
            parameters.Add("Status", status);
        }

        sqlBuilder.Append(" ORDER BY dtl.LogDate, s.StartTime;");

        return await connection.QueryAsync<DailyTaskComplianceReportItemDto>(sqlBuilder.ToString(), parameters);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\HandoverRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Core.Dtos;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class HandoverRepository(IDbConnectionFactory connectionFactory) : IHandoverRepository
{
    public async Task<Handover> CreateAsync(Handover handover)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO Handovers (HandoverNotes, Priority, Shift, GivenByUserID)
                           OUTPUT INSERTED.*
                           VALUES (@HandoverNotes, @Priority, @Shift, @GivenByUserID);
                           """;
        return await connection.QuerySingleAsync<Handover>(sql, handover);
    }
    public async Task<int> GetPendingCountAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        // This SQL now correctly filters for today's date
        const string sql = @"
            SELECT COUNT(*) FROM Handovers 
            WHERE IsReceived = 0 AND IsActive = 1 
            AND GivenDateTime >= CAST(GETDATE() AS DATE) 
            AND GivenDateTime < DATEADD(day, 1, CAST(GETDATE() AS DATE))";
        return await connection.ExecuteScalarAsync<int>(sql);
    }
    public async Task<IEnumerable<Handover>> GetPendingAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = "SELECT * FROM Handovers WHERE IsReceived = 0 AND IsActive = 1 AND GivenDateTime >= @StartDate AND GivenDateTime < @InclusiveEndDate ORDER BY GivenDateTime DESC";
        return await connection.QueryAsync<Handover>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<IEnumerable<Handover>> GetCompletedAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = "SELECT * FROM Handovers WHERE IsReceived = 1 AND IsActive = 1 AND GivenDateTime >= @StartDate AND GivenDateTime < @InclusiveEndDate ORDER BY GivenDateTime DESC";
        return await connection.QueryAsync<Handover>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<Handover?> GetByIdAsync(int handoverId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Handovers WHERE HandoverID = @HandoverId";
        return await connection.QuerySingleOrDefaultAsync<Handover>(sql, new { HandoverId = handoverId });
    }

    public async Task<IEnumerable<HandoverReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? shift, string? priority, string? status)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                h.GivenDateTime,
                givenBy.FullName AS GivenByUsername,
                h.Shift,
                h.Priority,
                h.HandoverNotes,
                h.IsReceived,
                h.ReceivedDateTime,
                receivedBy.FullName AS ReceivedByUsername
            FROM Handovers h
            LEFT JOIN Users givenBy ON h.GivenByUserID = givenBy.UserID
            LEFT JOIN Users receivedBy ON h.ReceivedByUserID = receivedBy.UserID
            WHERE h.IsActive = 1
              AND h.GivenDateTime >= @StartDate 
              AND h.GivenDateTime < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (!string.IsNullOrEmpty(shift) && shift != "All")
        {
            sqlBuilder.Append(" AND h.Shift = @Shift");
            parameters.Add("Shift", shift);
        }

        if (!string.IsNullOrEmpty(priority) && priority != "All")
        {
            sqlBuilder.Append(" AND h.Priority = @Priority");
            parameters.Add("Priority", priority);
        }

        if (!string.IsNullOrEmpty(status))
        {
            if (status == "Pending") sqlBuilder.Append(" AND h.IsReceived = 0");
            else if (status == "Received") sqlBuilder.Append(" AND h.IsReceived = 1");
        }

        sqlBuilder.Append(" ORDER BY h.GivenDateTime DESC;");

        return await connection.QueryAsync<HandoverReportDto>(sqlBuilder.ToString(), parameters);
    }

    public async Task<bool> MarkAsReceivedAsync(int handoverId, int userId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE Handovers 
                           SET IsReceived = 1, ReceivedByUserID = @UserId, ReceivedDateTime = GETDATE() 
                           WHERE HandoverID = @HandoverId AND IsReceived = 0;
                           """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { HandoverId = handoverId, UserId = userId });
        return rowsAffected > 0;
    }

    public async Task<bool> DeactivateAsync(int handoverId, int userId, string reason)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE Handovers SET IsActive = 0, DeactivationReason = @Reason, 
                           DeactivatedByUserID = @UserId, DeactivationDateTime = GETDATE()
                           WHERE HandoverID = @HandoverId AND IsActive = 1;
                           """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { HandoverId = handoverId, UserId = userId, Reason = reason });
        return rowsAffected > 0;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\KitValidationRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Core.Dtos;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class KitValidationRepository(IDbConnectionFactory connectionFactory) : IKitValidationRepository
{
    public async Task<KitValidation> CreateAsync(KitValidation kitValidation)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO KitValidations (KitName, KitLotNumber, KitExpiryDate, ValidationStatus, Comments, ValidatedByUserID)
                           OUTPUT INSERTED.*
                           VALUES (@KitName, @KitLotNumber, @KitExpiryDate, @ValidationStatus, @Comments, @ValidatedByUserID);
                           """;
        return await connection.QuerySingleAsync<KitValidation>(sql, kitValidation);
    }

    // This is the single, correct version of the method
    public async Task<IEnumerable<KitValidation>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();

        // This adjusts the end date to be the start of the *next* day, 
        // ensuring we capture everything within the selected end date.
        var inclusiveEndDate = endDate.Date.AddDays(1);

        const string sql = "SELECT * FROM KitValidations WHERE IsActive = 1 AND ValidationDateTime >= @StartDate AND ValidationDateTime < @InclusiveEndDate ORDER BY ValidationDateTime DESC";

        return await connection.QueryAsync<KitValidation>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<IEnumerable<KitValidationReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? kitName, string? status)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                kv.ValidationDateTime,
                kv.KitName,
                kv.KitLotNumber,
                kv.KitExpiryDate,
                kv.ValidationStatus,
                kv.Comments,
                u.FullName AS ValidatedByUsername
            FROM KitValidations kv
            LEFT JOIN Users u ON kv.ValidatedByUserID = u.UserID
            WHERE kv.IsActive = 1 
              AND kv.ValidationDateTime >= @StartDate 
              AND kv.ValidationDateTime < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (!string.IsNullOrEmpty(kitName) && kitName != "All")
        {
            sqlBuilder.Append(" AND kv.KitName = @KitName");
            parameters.Add("KitName", kitName);
        }

        if (!string.IsNullOrEmpty(status) && status != "All")
        {
            sqlBuilder.Append(" AND kv.ValidationStatus = @Status");
            parameters.Add("Status", status);
        }

        sqlBuilder.Append(" ORDER BY kv.ValidationDateTime DESC;");

        return await connection.QueryAsync<KitValidationReportDto>(sqlBuilder.ToString(), parameters);
    }

    public async Task<bool> DeactivateAsync(int validationId, int userId, string reason)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE KitValidations SET IsActive = 0, DeactivationReason = @Reason, 
                           DeactivatedByUserID = @UserId, DeactivationDateTime = GETDATE()
                           WHERE ValidationID = @ValidationId AND IsActive = 1;
                           """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { ValidationId = validationId, UserId = userId, Reason = reason });
        return rowsAffected > 0;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\MachineBreakdownRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Dtos;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class MachineBreakdownRepository(IDbConnectionFactory connectionFactory) : IMachineBreakdownRepository
{
    public async Task<MachineBreakdown> CreateAsync(MachineBreakdown breakdown)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO MachineBreakdowns (MachineName, BreakdownReason, ReportedByUserID)
                           OUTPUT INSERTED.*
                           VALUES (@MachineName, @BreakdownReason, @ReportedByUserID);
                           """;
        return await connection.QuerySingleAsync<MachineBreakdown>(sql, breakdown);
    }

    public async Task<int> GetPendingCountAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        // This SQL now correctly counts ALL unresolved breakdowns from all time.
        const string sql = "SELECT COUNT(*) FROM MachineBreakdowns WHERE IsResolved = 0 AND IsActive = 1";
        return await connection.ExecuteScalarAsync<int>(sql);
    }

    public async Task<IEnumerable<MachineBreakdown>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = """
                           SELECT * FROM MachineBreakdowns 
                           WHERE IsResolved = 0 AND IsActive = 1 
                           AND ReportedDateTime >= @StartDate AND ReportedDateTime < @InclusiveEndDate 
                           ORDER BY ReportedDateTime DESC
                           """;
        return await connection.QueryAsync<MachineBreakdown>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<MachineBreakdown?> GetByIdAsync(int breakdownId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM MachineBreakdowns WHERE BreakdownID = @BreakdownId AND IsActive = 1";
        return await connection.QuerySingleOrDefaultAsync<MachineBreakdown>(sql, new { BreakdownId = breakdownId });
    }

    public async Task<bool> MarkAsResolvedAsync(int breakdownId, int userId, string resolutionNotes)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                       UPDATE MachineBreakdowns 
                       SET IsResolved = 1, 
                           ResolvedByUserID = @UserId, 
                           ResolvedDateTime = GETDATE(),
                           ResolutionNotes = @ResolutionNotes,
                           DowntimeMinutes = DATEDIFF(minute, ReportedDateTime, GETDATE())
                       WHERE BreakdownID = @BreakdownId AND IsResolved = 0;
                       """;
        var rowsAffected = await connection.ExecuteAsync(sql, new
        {
            BreakdownId = breakdownId,
            UserId = userId,
            ResolutionNotes = resolutionNotes
        });
        return rowsAffected > 0;
    }

    public async Task<IEnumerable<MachineBreakdown>> GetResolvedByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = """
                       SELECT * FROM MachineBreakdowns 
                       WHERE IsResolved = 1 AND IsActive = 1 
                       AND ReportedDateTime >= @StartDate AND ReportedDateTime < @InclusiveEndDate 
                       ORDER BY ReportedDateTime DESC
                       """;
        return await connection.QueryAsync<MachineBreakdown>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<bool> DeactivateAsync(int breakdownId, int userId, string reason)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                       UPDATE MachineBreakdowns SET IsActive = 0, DeactivationReason = @Reason, 
                       DeactivatedByUserID = @UserId, DeactivationDateTime = GETDATE()
                       WHERE BreakdownID = @BreakdownId AND IsActive = 1;
                       """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { BreakdownId = breakdownId, UserId = userId, Reason = reason });
        return rowsAffected > 0;
    }

    public async Task<IEnumerable<MachineBreakdownReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? machineName, string? status)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                mb.ReportedDateTime,
                mb.MachineName,
                mb.BreakdownReason,
                reporter.FullName AS ReportedByUsername,
                mb.IsResolved,
                mb.ResolvedDateTime,
                resolver.FullName AS ResolvedByUsername,
                mb.ResolutionNotes,
                mb.DowntimeMinutes
            FROM MachineBreakdowns mb
            LEFT JOIN Users reporter ON mb.ReportedByUserID = reporter.UserID
            LEFT JOIN Users resolver ON mb.ResolvedByUserID = resolver.UserID
            WHERE mb.IsActive = 1 
              AND mb.ReportedDateTime >= @StartDate 
              AND mb.ReportedDateTime < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (!string.IsNullOrEmpty(machineName))
        {
            sqlBuilder.Append(" AND mb.MachineName = @MachineName");
            parameters.Add("MachineName", machineName);
        }

        if (!string.IsNullOrEmpty(status))
        {
            if (status == "Pending")
            {
                sqlBuilder.Append(" AND mb.IsResolved = 0");
            }
            else if (status == "Resolved")
            {
                sqlBuilder.Append(" AND mb.IsResolved = 1");
            }
        }

        sqlBuilder.Append(" ORDER BY mb.ReportedDateTime DESC;");

        return await connection.QueryAsync<MachineBreakdownReportDto>(sqlBuilder.ToString(), parameters);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\MediaSterilityCheckRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Core.Dtos;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class MediaSterilityCheckRepository(IDbConnectionFactory connectionFactory) : IMediaSterilityCheckRepository
{
    public async Task<MediaSterilityCheck> CreateAsync(MediaSterilityCheck sterilityCheck)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO MediaSterilityChecks (MediaName, MediaLotNumber, MediaQuantity, Result37C, Result25C, OverallStatus, Comments, PerformedByUserID)
                           OUTPUT INSERTED.*
                           VALUES (@MediaName, @MediaLotNumber, @MediaQuantity, @Result37C, @Result25C, @OverallStatus, @Comments, @PerformedByUserID);
                           """;
        return await connection.QuerySingleAsync<MediaSterilityCheck>(sql, sterilityCheck);
    }

    public async Task<IEnumerable<MediaSterilityCheck>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = "SELECT * FROM MediaSterilityChecks WHERE IsActive = 1 AND CheckDateTime >= @StartDate AND CheckDateTime < @InclusiveEndDate ORDER BY CheckDateTime DESC";
        return await connection.QueryAsync<MediaSterilityCheck>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<bool> DeactivateAsync(int checkId, int userId, string reason)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE MediaSterilityChecks SET IsActive = 0, DeactivationReason = @Reason, 
                           DeactivatedByUserID = @UserId, DeactivationDateTime = GETDATE()
                           WHERE SterilityCheckID = @CheckId AND IsActive = 1;
                           """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { CheckId = checkId, UserId = userId, Reason = reason });
        return rowsAffected > 0;
    }

    public async Task<IEnumerable<MediaSterilityReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? mediaName, string? status)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                m.CheckDateTime,
                m.MediaName,
                m.MediaLotNumber,
                m.MediaQuantity,
                m.Result37C,
                m.Result25C,
                m.OverallStatus,
                m.Comments,
                u.FullName AS PerformedByUsername
            FROM MediaSterilityChecks m
            LEFT JOIN Users u ON m.PerformedByUserID = u.UserID
            WHERE m.IsActive = 1 
              AND m.CheckDateTime >= @StartDate 
              AND m.CheckDateTime < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (!string.IsNullOrEmpty(mediaName) && mediaName != "All")
        {
            sqlBuilder.Append(" AND m.MediaName = @MediaName");
            parameters.Add("MediaName", mediaName);
        }

        if (!string.IsNullOrEmpty(status) && status != "All")
        {
            sqlBuilder.Append(" AND m.OverallStatus = @Status");
            parameters.Add("Status", status);
        }

        sqlBuilder.Append(" ORDER BY m.CheckDateTime DESC;");

        return await connection.QueryAsync<MediaSterilityReportDto>(sqlBuilder.ToString(), parameters);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\PermissionRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;

namespace PortalMirage.Data;

public class PermissionRepository(IDbConnectionFactory connectionFactory) : IPermissionRepository
{
    public async Task<IEnumerable<Permission>> GetAllAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT PermissionID, PermissionName FROM Permissions";
        return await connection.QueryAsync<Permission>(sql);
    }

    public async Task<Permission> CreateAsync(Permission permission)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO Permissions (PermissionName)
                           OUTPUT INSERTED.PermissionID, INSERTED.PermissionName
                           VALUES (@PermissionName);
                           """;
        var newPermission = await connection.QuerySingleAsync<Permission>(sql, permission);
        return newPermission;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\PortalMirage.Data.csproj
========================================
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Dapper" Version="2.1.66" />
    <PackageReference Include="Microsoft.Data.SqlClient" Version="6.1.1" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\PortalMirage.Core\PortalMirage.Core.csproj" />
  </ItemGroup>

</Project>



========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\RepeatSampleLogRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using PortalMirage.Core.Dtos;
using System.Text;

namespace PortalMirage.Data;

public class RepeatSampleLogRepository(IDbConnectionFactory connectionFactory) : IRepeatSampleLogRepository
{
    public async Task<RepeatSampleLog> CreateAsync(RepeatSampleLog repeatSampleLog)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO RepeatSampleLog (PatientIdCardNumber, PatientName, ReasonText, InformedPerson, Department, LoggedByUserID)
                           OUTPUT INSERTED.*
                           VALUES (@PatientIdCardNumber, @PatientName, @ReasonText, @InformedPerson, @Department, @LoggedByUserID);
                           """;
        return await connection.QuerySingleAsync<RepeatSampleLog>(sql, repeatSampleLog);
    }

    public async Task<IEnumerable<RepeatSampleLog>> GetByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = "SELECT * FROM RepeatSampleLog WHERE IsActive = 1 AND LogDateTime >= @StartDate AND LogDateTime < @InclusiveEndDate ORDER BY LogDateTime DESC";
        return await connection.QueryAsync<RepeatSampleLog>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<IEnumerable<RepeatSampleReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? reason, string? department)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                r.LogDateTime,
                r.PatientIdCardNumber,
                r.PatientName,
                r.ReasonText,
                r.Department,
                r.InformedPerson,
                u.FullName AS LoggedByUsername
            FROM RepeatSampleLog r
            LEFT JOIN Users u ON r.LoggedByUserID = u.UserID
            WHERE r.IsActive = 1 
              AND r.LogDateTime >= @StartDate 
              AND r.LogDateTime < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (!string.IsNullOrEmpty(reason) && reason != "All")
        {
            sqlBuilder.Append(" AND r.ReasonText = @Reason");
            parameters.Add("Reason", reason);
        }

        if (!string.IsNullOrEmpty(department) && department != "All")
        {
            sqlBuilder.Append(" AND r.Department = @Department");
            parameters.Add("Department", department);
        }

        sqlBuilder.Append(" ORDER BY r.LogDateTime DESC;");

        return await connection.QueryAsync<RepeatSampleReportDto>(sqlBuilder.ToString(), parameters);
    }

    public async Task<bool> DeactivateAsync(int repeatId, int userId, string reason)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE RepeatSampleLog SET IsActive = 0, DeactivationReason = @Reason, 
                           DeactivatedByUserID = @UserId, DeactivationDateTime = GETDATE()
                           WHERE RepeatID = @RepeatId AND IsActive = 1;
                           """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { RepeatId = repeatId, UserId = userId, Reason = reason });
        return rowsAffected > 0;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\RolePermissionRepository.cs
========================================
using Dapper;
using PortalMirage.Data.Abstractions;

namespace PortalMirage.Data;

public class RolePermissionRepository(IDbConnectionFactory connectionFactory) : IRolePermissionRepository
{
    public async Task AssignPermissionToRoleAsync(int roleId, int permissionId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "INSERT INTO RolePermissions (RoleID, PermissionID) VALUES (@RoleId, @PermissionId);";
        await connection.ExecuteAsync(sql, new { RoleId = roleId, PermissionId = permissionId });
    }

    public async Task RemovePermissionFromRoleAsync(int roleId, int permissionId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "DELETE FROM RolePermissions WHERE RoleID = @RoleId AND PermissionID = @PermissionId;";
        await connection.ExecuteAsync(sql, new { RoleId = roleId, PermissionId = permissionId });
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\RoleRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;

namespace PortalMirage.Data;

public class RoleRepository(IDbConnectionFactory connectionFactory) : IRoleRepository
{
    public async Task<IEnumerable<Role>> GetAllAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT RoleID, RoleName FROM Roles";
        return await connection.QueryAsync<Role>(sql);
    }

    public async Task<Role> CreateAsync(Role role)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO Roles (RoleName)
                           OUTPUT INSERTED.RoleID, INSERTED.RoleName
                           VALUES (@RoleName);
                           """;
        var newRole = await connection.QuerySingleAsync<Role>(sql, role);
        return newRole;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\SampleStorageRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Core.Dtos;
using PortalMirage.Data.Abstractions;
using System.Text;

namespace PortalMirage.Data;

public class SampleStorageRepository(IDbConnectionFactory connectionFactory) : ISampleStorageRepository
{
    // Replace the CreateAsync method with this new version
    public async Task<SampleStorage> CreateAsync(SampleStorage sampleStorage)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                       INSERT INTO SampleStorage (PatientSampleID, TestName, StoredByUserID)
                       OUTPUT INSERTED.*
                       VALUES (@PatientSampleID, @TestName, @StoredByUserID);
                       """;
        return await connection.QuerySingleAsync<SampleStorage>(sql, sampleStorage);
    }

    public async Task<int> GetPendingCountAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        // CORRECTED QUERY: Removed the date filter
        const string sql = @"
        SELECT COUNT(*) FROM SampleStorage 
        WHERE IsTestDone = 0 
          AND IsActive = 1";
        return await connection.ExecuteScalarAsync<int>(sql);
    }

    public async Task<IEnumerable<SampleStorage>> GetPendingByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = """
                           SELECT * FROM SampleStorage 
                           WHERE IsTestDone = 0 AND IsActive = 1 
                           AND StorageDateTime >= @StartDate AND StorageDateTime < @InclusiveEndDate 
                           ORDER BY StorageDateTime DESC
                           """;
        return await connection.QueryAsync<SampleStorage>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<IEnumerable<SampleStorage>> GetCompletedByDateRangeAsync(DateTime startDate, DateTime endDate)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);
        const string sql = """
                       SELECT * FROM SampleStorage 
                       WHERE IsTestDone = 1 AND IsActive = 1
                       AND StorageDateTime >= @StartDate AND StorageDateTime < @InclusiveEndDate 
                       ORDER BY StorageDateTime DESC
                       """;
        return await connection.QueryAsync<SampleStorage>(sql, new { StartDate = startDate.Date, InclusiveEndDate = inclusiveEndDate });
    }

    public async Task<SampleStorage?> GetByIdAsync(int storageId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM SampleStorage WHERE StorageID = @StorageId";
        return await connection.QuerySingleOrDefaultAsync<SampleStorage>(sql, new { StorageId = storageId });
    }

    public async Task<bool> MarkAsDoneAsync(int storageId, int userId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           UPDATE SampleStorage 
                           SET IsTestDone = 1, TestDoneByUserID = @UserId, TestDoneDateTime = GETDATE() 
                           WHERE StorageID = @StorageId AND IsTestDone = 0;
                           """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { StorageId = storageId, UserId = userId });
        return rowsAffected > 0;
    }

    // Replace the DeactivateAsync method
    public async Task<bool> DeactivateAsync(int storageId, int userId, string reason)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                       UPDATE SampleStorage 
                       SET IsActive = 0, 
                           DeactivationReason = @Reason,
                           DeactivatedByUserID = @UserId,
                           DeactivationDateTime = GETDATE()
                       WHERE StorageID = @StorageId AND IsActive = 1;
                       """;
        var rowsAffected = await connection.ExecuteAsync(sql, new { StorageId = storageId, UserId = userId, Reason = reason });
        return rowsAffected > 0;
    }

    public async Task<IEnumerable<SampleStorageReportDto>> GetReportDataAsync(DateTime startDate, DateTime endDate, string? testName, string? status)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        var inclusiveEndDate = endDate.Date.AddDays(1);

        var sqlBuilder = new StringBuilder(@"
            SELECT 
                ss.StorageDateTime,
                ss.PatientSampleID,
                ss.TestName,
                u_stored.FullName AS StoredByUsername,
                ss.IsTestDone,
                ss.TestDoneDateTime,
                u_done.FullName AS TestDoneByUsername
            FROM SampleStorage ss
            LEFT JOIN Users u_stored ON ss.StoredByUserID = u_stored.UserID
            LEFT JOIN Users u_done ON ss.TestDoneByUserID = u_done.UserID
            WHERE ss.IsActive = 1 
              AND ss.StorageDateTime >= @StartDate 
              AND ss.StorageDateTime < @InclusiveEndDate
        ");

        var parameters = new DynamicParameters();
        parameters.Add("StartDate", startDate.Date);
        parameters.Add("InclusiveEndDate", inclusiveEndDate);

        if (!string.IsNullOrEmpty(testName) && testName != "All")
        {
            sqlBuilder.Append(" AND ss.TestName = @TestName");
            parameters.Add("TestName", testName);
        }

        if (!string.IsNullOrEmpty(status))
        {
            if (status == "Pending") sqlBuilder.Append(" AND ss.IsTestDone = 0");
            else if (status == "Test Done") sqlBuilder.Append(" AND ss.IsTestDone = 1");
        }

        sqlBuilder.Append(" ORDER BY ss.StorageDateTime DESC;");

        return await connection.QueryAsync<SampleStorageReportDto>(sqlBuilder.ToString(), parameters);
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\ShiftRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System;
using System.Collections.Generic;
using System.Data;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class ShiftRepository(IDbConnectionFactory connectionFactory) : IShiftRepository
{
    // === 1. READ ALL ===
    public async Task<IEnumerable<Shift>> GetAllAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Shifts WHERE IsActive = 1";

        // Use dynamic to read raw values
        var rows = await connection.QueryAsync<dynamic>(sql);
        var shifts = new List<Shift>();

        foreach (var row in rows)
        {
            // Manual mapping - simple and explicit
            shifts.Add(MapRowToShift(row));
        }

        return shifts;
    }

    // === 2. READ BY ID ===
    public async Task<Shift?> GetByIdAsync(int shiftId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Shifts WHERE ShiftID = @ShiftId";

        var row = await connection.QuerySingleOrDefaultAsync<dynamic>(sql, new { ShiftId = shiftId });

        if (row == null) return null;

        return MapRowToShift(row);
    }

    // === 3. CREATE ===
    public async Task<Shift> CreateAsync(Shift shift)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
            INSERT INTO Shifts (ShiftName, StartTime, EndTime, GracePeriodHours, IsActive)
            OUTPUT INSERTED.ShiftID
            VALUES (@ShiftName, @StartTime, @EndTime, @GracePeriodHours, @IsActive);
            """;

        // Explicitly convert TimeOnly -> TimeSpan for SQL
        var parameters = new
        {
            shift.ShiftName,
            StartTime = shift.StartTime.ToTimeSpan(),
            EndTime = shift.EndTime.ToTimeSpan(),
            shift.GracePeriodHours,
            shift.IsActive
        };

        var newId = await connection.ExecuteScalarAsync<int>(sql, parameters);
        return shift with { ShiftID = newId };
    }

    // === 4. UPDATE ===
    public async Task<Shift> UpdateAsync(Shift shift)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
            UPDATE Shifts
            SET ShiftName = @ShiftName,
                StartTime = @StartTime,
                EndTime = @EndTime,
                GracePeriodHours = @GracePeriodHours,
                IsActive = @IsActive
            WHERE ShiftID = @ShiftID;
            """;

        var parameters = new
        {
            shift.ShiftID,
            shift.ShiftName,
            StartTime = shift.StartTime.ToTimeSpan(),
            EndTime = shift.EndTime.ToTimeSpan(),
            shift.GracePeriodHours,
            shift.IsActive
        };

        await connection.ExecuteAsync(sql, parameters);
        return shift;
    }

    // === 5. DEACTIVATE ===
    public async System.Threading.Tasks.Task DeactivateAsync(int shiftId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "UPDATE Shifts SET IsActive = 0 WHERE ShiftID = @ShiftId";
        await connection.ExecuteAsync(sql, new { ShiftId = shiftId });
    }

    // === HELPER: Centralized Mapping Logic ===
    private Shift MapRowToShift(dynamic row)
    {
        return new Shift
        {
            ShiftID = (int)row.ShiftID,
            ShiftName = (string)row.ShiftName,
            // Safe conversion logic
            StartTime = ParseTime(row.StartTime),
            EndTime = ParseTime(row.EndTime),
            GracePeriodHours = row.GracePeriodHours != null ? (int)row.GracePeriodHours : 2,
            IsActive = row.IsActive != null && Convert.ToBoolean(row.IsActive)
        };
    }

    // === HELPER: Safe Time Conversion ===
    private TimeOnly ParseTime(object value)
    {
        if (value == null) return TimeOnly.MinValue;

        // Standard SQL Time maps to TimeSpan
        if (value is TimeSpan ts)
            return TimeOnly.FromTimeSpan(ts);

        // Legacy SQL DateTime maps to DateTime
        if (value is DateTime dt)
            return TimeOnly.FromDateTime(dt);

        // Fallback for strings
        if (TimeSpan.TryParse(value.ToString(), out var parsedTs))
            return TimeOnly.FromTimeSpan(parsedTs);

        return TimeOnly.MinValue;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\SqlConnectionFactory.cs
========================================
using System.Data;
using Microsoft.Data.SqlClient;
using PortalMirage.Data.Abstractions;

namespace PortalMirage.Data;

public class SqlConnectionFactory(string connectionString) : IDbConnectionFactory
{
    public async Task<IDbConnection> CreateConnectionAsync()
    {
        var connection = new SqlConnection(connectionString);
        await connection.OpenAsync();
        return connection;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\TaskRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using System.Threading.Tasks;


namespace PortalMirage.Data;

public class TaskRepository(IDbConnectionFactory connectionFactory) : ITaskRepository
{
    public async Task<IEnumerable<TaskModel>> GetAllAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Tasks WHERE IsActive = 1";
        return await connection.QueryAsync<TaskModel>(sql);
    }

    public async System.Threading.Tasks.Task DeactivateAsync(int taskId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "UPDATE Tasks SET IsActive = 0 WHERE TaskID = @TaskId";
        await connection.ExecuteAsync(sql, new { TaskId = taskId });
    }

    public async Task<TaskModel> CreateAsync(TaskModel task)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO Tasks (TaskName, ShiftID, ScheduleType, ScheduleValue, IsActive)
                           OUTPUT INSERTED.*
                           VALUES (@TaskName, @ShiftID, @ScheduleType, @ScheduleValue, @IsActive);
                           """;
        return await connection.QuerySingleAsync<TaskModel>(sql, task);
    }
    public async Task<TaskModel?> GetByIdAsync(int taskId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Tasks WHERE TaskID = @TaskId";
        return await connection.QuerySingleOrDefaultAsync<TaskModel>(sql, new { TaskId = taskId });
    }

    public async Task<IEnumerable<TaskModel>> GetByIdsAsync(IEnumerable<int> taskIds)
    {
        if (!taskIds.Any()) return Enumerable.Empty<TaskModel>();
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Tasks WHERE TaskID IN @TaskIds";
        return await connection.QueryAsync<TaskModel>(sql, new { TaskIds = taskIds });
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\UserRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class UserRepository(IDbConnectionFactory connectionFactory) : IUserRepository
{
    public async Task<User?> GetByUsernameAsync(string username)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT UserID, Username, PasswordHash, FullName, IsActive, CreatedAt FROM Users WHERE Username = @Username";
        return await connection.QuerySingleOrDefaultAsync<User>(sql, new { Username = username });
    }

    public async Task<IEnumerable<User>> GetByIdsAsync(IEnumerable<int> userIds)
    {
        if (!userIds.Any()) return Enumerable.Empty<User>();
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Users WHERE UserID IN @UserIds";
        return await connection.QueryAsync<User>(sql, new { UserIds = userIds });
    }

    public async Task<IEnumerable<string>> GetUserRolesAsync(int userId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           SELECT r.RoleName 
                           FROM Roles r
                           INNER JOIN UserRoles ur ON r.RoleID = ur.RoleID
                           WHERE ur.UserID = @UserId
                           """;
        return await connection.QueryAsync<string>(sql, new { UserId = userId });
    }

    public async Task<User> CreateAsync(User user)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           INSERT INTO Users (Username, PasswordHash, FullName, IsActive)
                           OUTPUT INSERTED.UserID, INSERTED.Username, INSERTED.PasswordHash, INSERTED.FullName, INSERTED.IsActive, INSERTED.CreatedAt
                           VALUES (@Username, @PasswordHash, @FullName, @IsActive);
                           """;
        var newUser = await connection.QuerySingleAsync<User>(sql, user);
        return newUser;
    }

    public async Task<User?> GetByIdAsync(int userId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT * FROM Users WHERE UserID = @UserId";
        return await connection.QuerySingleOrDefaultAsync<User>(sql, new { UserId = userId });
    }

    public async Task<IEnumerable<User>> GetAllAsync()
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "SELECT UserID, Username, FullName, IsActive, CreatedAt FROM Users";
        return await connection.QueryAsync<User>(sql);
    }

    public async Task<bool> UpdatePasswordHashAsync(int userId, string newPasswordHash)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "UPDATE Users SET PasswordHash = @NewPasswordHash WHERE UserID = @UserId";
        var rowsAffected = await connection.ExecuteAsync(sql, new { UserId = userId, NewPasswordHash = newPasswordHash });
        return rowsAffected > 0;
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\PortalMirage.Data\UserRoleRepository.cs
========================================
using Dapper;
using PortalMirage.Core.Models;
using PortalMirage.Data.Abstractions;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace PortalMirage.Data;

public class UserRoleRepository(IDbConnectionFactory connectionFactory) : IUserRoleRepository
{
    public async System.Threading.Tasks.Task AssignRoleToUserAsync(int userId, int roleId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "INSERT INTO UserRoles (UserID, RoleID) VALUES (@UserId, @RoleId);";
        await connection.ExecuteAsync(sql, new { UserId = userId, RoleId = roleId });
    }

    public async System.Threading.Tasks.Task RemoveRoleFromUserAsync(int userId, int roleId)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = "DELETE FROM UserRoles WHERE UserID = @UserId AND RoleID = @RoleId;";
        await connection.ExecuteAsync(sql, new { UserId = userId, RoleId = roleId });
    }

    public async System.Threading.Tasks.Task<IEnumerable<Role>> GetRolesForUserAsync(string username)
    {
        using var connection = await connectionFactory.CreateConnectionAsync();
        const string sql = """
                           SELECT r.*
                           FROM Roles r
                           INNER JOIN UserRoles ur ON r.RoleID = ur.RoleID
                           INNER JOIN Users u ON ur.UserID = u.UserID
                           WHERE u.Username = @Username
                           """;
        return await connection.QueryAsync<Role>(sql, new { Username = username });
    }
}


========================================
FILE: C:\Users\admin\source\repos\Mirage\auto logout q.sql
========================================
USE MirageDB;
GO

-- Insert the setting only if it doesn't already exist
IF NOT EXISTS (SELECT 1 FROM AdminListItems WHERE ListType = 'SystemSetting' AND ItemValue = 'InactivityTimeoutMinutes')
BEGIN
    INSERT INTO AdminListItems (ListType, ItemValue, Description, IsActive)
    VALUES ('SystemSetting', 'InactivityTimeoutMinutes', '15', 1); -- The '15' in Description is the timeout in minutes
END
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\shift query 2.sql
========================================
USE MirageDB;
GO

-- 1. Force all existing shifts to be Active (Visible)
UPDATE Shifts
SET IsActive = 1
WHERE IsActive IS NULL OR IsActive = 0;

-- 2. Ensure GracePeriodHours has a valid value (required by C# code)
UPDATE Shifts
SET GracePeriodHours = 2
WHERE GracePeriodHours IS NULL;

-- 3. Verify the data is now correct
SELECT * FROM Shifts;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\shift query1.sql
========================================
USE MirageDB;
GO

-- 1. Check if the conflicting column 'TaskCategory' exists
IF EXISTS (SELECT * FROM sys.columns WHERE Name = N'TaskCategory' AND Object_ID = Object_ID(N'Tasks'))
BEGIN
    -- Option A: Make it nullable (Safe option, keeps old data)
    ALTER TABLE Tasks ALTER COLUMN TaskCategory NVARCHAR(50) NULL;
    
    -- Option B: Drop it completely (Cleaner, if you don't need old category data)
    -- ALTER TABLE Tasks DROP COLUMN TaskCategory;
END
GO

-- 2. Verification: Check table structure
SELECT * FROM Tasks;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\shifts query schema.sql
========================================
USE MirageDB;
GO

-- 1. Check if Shifts table exists; if NOT, create it entirely
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Shifts')
BEGIN
    CREATE TABLE Shifts (
        ShiftID INT IDENTITY(1,1) PRIMARY KEY,
        ShiftName NVARCHAR(100) NOT NULL UNIQUE,
        StartTime TIME NOT NULL,
        EndTime TIME NOT NULL,
        GracePeriodHours INT NOT NULL DEFAULT 2,
        IsActive BIT NOT NULL DEFAULT 1
    );
END
ELSE
BEGIN
    -- 2. If table EXISTS, check for missing columns and add them
    
    -- Check for GracePeriodHours
    IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'GracePeriodHours' AND Object_ID = Object_ID(N'Shifts'))
    BEGIN
        ALTER TABLE Shifts ADD GracePeriodHours INT NOT NULL DEFAULT 2;
    END

    -- Check for IsActive
    IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'IsActive' AND Object_ID = Object_ID(N'Shifts'))
    BEGIN
        ALTER TABLE Shifts ADD IsActive BIT NOT NULL DEFAULT 1;
    END
END
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\SQLQuery3.sql
========================================
USE MirageDB;
GO

-- 1. Add 'GracePeriodHours' column if it is missing
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'GracePeriodHours' AND Object_ID = Object_ID(N'Shifts'))
BEGIN
    ALTER TABLE Shifts ADD GracePeriodHours INT NOT NULL DEFAULT 2;
END
GO

-- 2. Add 'IsActive' column if it is missing
IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'IsActive' AND Object_ID = Object_ID(N'Shifts'))
BEGIN
    ALTER TABLE Shifts ADD IsActive BIT NOT NULL DEFAULT 1;
END
GO

-- 3. FIX THE DATA: Make sure old shifts are visible
-- This updates any record where IsActive is NULL or 0 to be 1 (Active)
UPDATE Shifts
SET IsActive = 1
WHERE IsActive IS NULL OR IsActive = 0;

-- 4. FIX THE DATA: Ensure Grace Period has a valid value
UPDATE Shifts
SET GracePeriodHours = 2
WHERE GracePeriodHours IS NULL;
GO

-- 5. Verification: Show the fixed data
SELECT * FROM Shifts;
GO


========================================
FILE: C:\Users\admin\source\repos\Mirage\updated audit index lg.sql
========================================
USE MirageDB;
GO

-- Create an index on the Timestamp column to keep queries fast
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_AuditLog_Timestamp' AND object_id = OBJECT_ID('dbo.AuditLog'))
BEGIN
    CREATE NONCLUSTERED INDEX IX_AuditLog_Timestamp
    ON dbo.AuditLog (Timestamp DESC);
END
GO


