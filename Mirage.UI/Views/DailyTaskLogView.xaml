<UserControl x:Class="Mirage.UI.Views.DailyTaskLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Mirage.UI.Views"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:viewModels="clr-namespace:Mirage.UI.ViewModels"
             xmlns:converters="clr-namespace:Mirage.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1000"
             Loaded="DailyTaskLogView_OnLoaded">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:BooleanAndConverter x:Key="BooleanAndConverter"/>

        <DataTemplate x:Key="TaskItemTemplate">
            <Border BorderBrush="LightGray" BorderThickness="0,0,0,1" Padding="5">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <CheckBox Grid.Column="0" 
                              VerticalAlignment="Center"
                              IsChecked="{Binding IsChecked, Mode=TwoWay}">
                        <CheckBox.Style>
                            <Style TargetType="CheckBox" BasedOn="{StaticResource MahApps.Styles.CheckBox}">
                                <Setter Property="ToolTip">
                                    <Setter.Value>
                                        <MultiBinding StringFormat="Status: {0}">
                                            <Binding Path="Dto.Status"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="IsChecked" Value="False"/>
                                        <Setter Property="Opacity" Value="0.5"/>
                                        <Setter Property="Background" Value="LightGray"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="IsChecked" Value="False"/>
                                        <Setter Property="Opacity" Value="0.5"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Completed">
                                        <Setter Property="Foreground" Value="Green"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </CheckBox.Style>
                    </CheckBox>

                    <TextBlock Grid.Column="1" Text="{Binding TaskName}" VerticalAlignment="Center" Margin="10,0" TextWrapping="Wrap">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="ToolTip" Value="{Binding TaskName}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Setter Property="FontStyle" Value="Italic"/>
                                        <Setter Property="ToolTip" Value="Marked as Not Available"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="Foreground" Value="DarkRed"/>
                                        <Setter Property="ToolTip" Value="Task incomplete - deadline passed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Completed">
                                        <Setter Property="Foreground" Value="Green"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                        <Setter Property="ToolTip" Value="Task completed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Pending">
                                        <Setter Property="Foreground" Value="DarkBlue"/>
                                        <Setter Property="ToolTip" Value="Task pending"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <Button Grid.Column="2" Content="N/A" FontSize="10" Padding="5,2" Margin="0,0,5,0"
                            Command="{Binding DataContext.ShowNaFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding Dto}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Completed">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Extend Button (Admin Only) - Fixed Grid.Column to 3 -->
                    <Button Grid.Column="3" Content="EXTEND" FontSize="10" Padding="5,2" Margin="5,0,0,0"
                            Background="#CC0000" Foreground="White" FontWeight="Bold"
                            Command="{Binding DataContext.ShowExtendFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding Dto}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
                                <Setter Property="Visibility" Value="Collapsed"/>

                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding DataContext.IsAdmin, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True"/>
                                            <Condition Binding="{Binding Dto.Status}" Value="Incomplete"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>

                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding DataContext.IsAdmin, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True"/>
                                            <Condition Binding="{Binding Dto.Status}" Value="Pending"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Daily Task Log" FontSize="36" FontWeight="Light" Margin="0,0,0,10"/>

            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,20">
                <DatePicker SelectedDate="{Binding SelectedDate}" 
                            Width="150" 
                            Margin="0,0,10,0"/>

                <Button Content="GET TASKS" 
                        Command="{Binding LoadTasksCommand}" 
                        Style="{StaticResource MahApps.Styles.Button.Square.Accent}"
                        Margin="0,0,10,0"/>

                <Button Content="SAVE CHANGES" 
                        Command="{Binding SaveChangesCommand}" 
                        Background="Green" 
                        Foreground="White" 
                        FontWeight="Bold"
                        Margin="20,0,0,0">
                    <Button.ContentTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                <ProgressBar Width="20" Height="20" Margin="5,0,0,0"
                                             IsIndeterminate="True"
                                             Visibility="{Binding DataContext.IsSaving, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>
                        </DataTemplate>
                    </Button.ContentTemplate>
                </Button>
            </StackPanel>

            <Border Grid.Row="2" 
                    Background="#40000000" 
                    Visibility="{Binding IsSaving, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Panel.ZIndex="100"
                    IsHitTestVisible="False">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <mah:ProgressRing Width="50" Height="50" 
                                      IsActive="True" 
                                      Foreground="White"/>
                    <TextBlock Text="Saving changes..." 
                               Foreground="White" 
                               FontSize="14" 
                               Margin="0,10,0,0"/>
                </StackPanel>
            </Border>

            <TabControl Grid.Row="2" mah:TabControlHelper.Underlined="TabItems">
                <TabItem Header="Morning Tasks" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding MorningTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>

                <TabItem Header="Evening Tasks" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding EveningTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>

                <TabItem Header="Night Tasks" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding NightTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
        </Grid>

        <mah:FlyoutsControl>
            <!-- Existing N/A Flyout -->
            <mah:Flyout Header="Reason for N/A" IsOpen="{Binding IsNaFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="{Binding SelectedTaskForNa.TaskName}" FontWeight="Bold" FontSize="18" Margin="0,0,0,10" TextWrapping="Wrap"/>

                    <Label Content="Reason"/>

                    <TextBox x:Name="NaReasonBox"
                             Text="{Binding NaReason, UpdateSourceTrigger=PropertyChanged}" 
                             Height="150" 
                             TextWrapping="Wrap" 
                             AcceptsReturn="True" 
                             VerticalScrollBarVisibility="Auto" 
                             Margin="0,0,0,5"/>

                    <TextBlock Text="{Binding Text.Length, ElementName=NaReasonBox, StringFormat='{}{0}/500 characters'}" 
                               HorizontalAlignment="Right" 
                               FontSize="10" 
                               Foreground="Gray" 
                               Margin="0,0,0,10"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancel" Margin="0,0,10,0" 
                                Command="{Binding DataContext.CloseNaFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>

                        <Button Content="Confirm N/A" Command="{Binding ConfirmNaCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        <ProgressBar Width="16" Height="16" Margin="5,0,0,0"
                                                     IsIndeterminate="True"
                                                     Visibility="{Binding DataContext.IsSavingNa, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </mah:Flyout>

            <!-- B. Add Extend Deadline Flyout (Admin Only) -->
            <mah:Flyout Header="Extend Deadline (Admin)" IsOpen="{Binding IsExtendFlyoutOpen}" Position="Right" Width="400" Theme="Inverse">
                <StackPanel Margin="20">
                    <TextBlock Text="Extend Grace Period" FontSize="20" FontWeight="Bold" Margin="0,0,0,20"/>

                    <Label Content="Extend by (Hours):" FontWeight="Bold"/>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <Slider Minimum="1" Maximum="8" Interval="1" IsSnapToTickEnabled="True" 
                                Value="{Binding ExtensionHours}" Width="250" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ExtensionHours, StringFormat='{} +{0} Hrs'}" 
                                   FontSize="16" FontWeight="Bold" VerticalAlignment="Center" Margin="10,0,0,0"/>
                    </StackPanel>

                    <Label Content="Reason for Override (Mandatory):" FontWeight="Bold"/>
                    <TextBox Text="{Binding ExtensionReason, UpdateSourceTrigger=PropertyChanged}" 
                             Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,20"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancel" Margin="0,0,10,0" 
                                Command="{Binding CloseExtendFlyoutCommand}"/>

                        <Button Content="Confirm Extension" 
                                Command="{Binding ConfirmExtendCommand}" 
                                Style="{StaticResource MahApps.Styles.Button.Square.Accent}">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        <ProgressBar Width="16" Height="16" Margin="5,0,0,0"
                                                     IsIndeterminate="True"
                                                     Visibility="{Binding DataContext.IsSavingExtension, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>
    </Grid>
</UserControl>