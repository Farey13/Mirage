<UserControl x:Class="Mirage.UI.Views.DailyTaskLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:converters="clr-namespace:Mirage.UI.Converters"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1000"
             Loaded="DailyTaskLogView_OnLoaded">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:BooleanAndConverter x:Key="BooleanAndConverter"/>

        <DataTemplate x:Key="TaskItemTemplate">
            <Border BorderBrush="LightGray" BorderThickness="0,0,0,1" Padding="5">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <CheckBox Grid.Column="0" 
                              VerticalAlignment="Center"
                              IsChecked="{Binding IsChecked, Mode=TwoWay}"
                              IsEnabled="{Binding IsEditable}"
                              ToolTip="{Binding AuditTooltip}">
                        <CheckBox.Style>
                            <Style TargetType="CheckBox" BasedOn="{StaticResource MahApps.Styles.CheckBox}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Complete">
                                        <Setter Property="Foreground" Value="Green"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="Foreground" Value="DarkRed"/>
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="IsChecked" Value="False"/>
                                        <Setter Property="Opacity" Value="0.5"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="IsChecked" Value="False"/>
                                        <Setter Property="Opacity" Value="0.5"/>
                                        <Setter Property="Background" Value="LightGray"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </CheckBox.Style>
                    </CheckBox>

                    <TextBlock Grid.Column="1" Text="{Binding TaskName}" 
                               VerticalAlignment="Center" Margin="10,0" TextWrapping="Wrap"
                               ToolTip="{Binding AuditTooltip}">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Setter Property="FontStyle" Value="Italic"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="Foreground" Value="DarkRed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Complete">
                                        <Setter Property="Foreground" Value="Green"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Pending">
                                        <Setter Property="Foreground" Value="DarkBlue"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <Button Grid.Column="2" Content="N/A" FontSize="10" Padding="5,2" Margin="0,0,5,0"
                            Command="{Binding DataContext.ShowNaFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding Dto}"
                            Visibility="{Binding IsEditable, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Not Available">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Incomplete">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Dto.Status}" Value="Complete">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Extend Button (Admin Only) - UPDATED with simplified triggers using IsAdminUser -->
                    <Button Grid.Column="3" Content="EXTEND" FontSize="10" Padding="5,2"
                            Background="#CC0000" Foreground="White" FontWeight="Bold"
                            Command="{Binding DataContext.ShowExtendFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding Dto}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Flat}">
                                <Setter Property="Visibility" Value="Collapsed"/>

                                <Style.Triggers>

                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsAdminUser}" Value="True"/>
                                            <Condition Binding="{Binding Dto.Status}" Value="Pending"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>

                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsAdminUser}" Value="True"/>
                                            <Condition Binding="{Binding IsLocked}" Value="True"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>

                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Title -->
            <TextBlock Grid.Row="0" Text="Daily Task Log" FontSize="36" FontWeight="Light" Margin="0,0,0,10"/>

            <!-- NEW: Dashboard Grid -->
            <Border Grid.Row="1" Background="#F5F5F5" Padding="15" Margin="0,0,0,20" CornerRadius="5">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel>
                        <TextBlock Text="{Binding ShiftInfoText}" FontWeight="Bold" FontSize="14"/>
                        <TextBlock Text="Ensure tasks are verified." FontSize="12" Foreground="Gray"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0">
                        <TextBlock Text="{Binding PendingCount}" FontSize="24" FontWeight="Bold" Foreground="#CC0000"/>
                        <TextBlock Text=" Pending" VerticalAlignment="Center" Margin="5,0,0,0" FontSize="14"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Show Pending" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <mah:ToggleSwitch IsOn="{Binding ShowPendingOnly}"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- UPDATED: Control Panel with Navigation -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,20">
                <!-- NEW: Previous Day Button -->
                <Button Content="&lt;" Command="{Binding PreviousDayCommand}" 
                        Width="40" Margin="0,0,5,0" 
                        Style="{StaticResource MahApps.Styles.Button.Square.Accent}"/>

                <DatePicker SelectedDate="{Binding SelectedDate}" 
                            Width="150" 
                            Margin="0,0,5,0"/>

                <!-- NEW: Next Day Button -->
                <Button Content="&gt;" Command="{Binding NextDayCommand}" 
                        Width="40" Margin="0,0,15,0" 
                        Style="{StaticResource MahApps.Styles.Button.Square.Accent}"/>

                <Button Content="REFRESH" 
                        Command="{Binding LoadTasksCommand}"
                        Margin="0,0,10,0"/>

                <Button Content="SAVE CHANGES" 
                        Command="{Binding SaveChangesCommand}" 
                        Background="Green" 
                        Foreground="White" 
                        FontWeight="Bold"
                        Margin="20,0,0,0">
                    <Button.ContentTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                <ProgressBar Width="20" Height="20" Margin="5,0,0,0"
                                             IsIndeterminate="True"
                                             Visibility="{Binding DataContext.IsSaving, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>
                        </DataTemplate>
                    </Button.ContentTemplate>
                </Button>
            </StackPanel>

            <!-- Saving Overlay -->
            <Border Grid.Row="3" 
                    Background="#40000000" 
                    Visibility="{Binding IsSaving, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Panel.ZIndex="100"
                    IsHitTestVisible="False">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <mah:ProgressRing Width="50" Height="50" 
                                      IsActive="True" 
                                      Foreground="White"/>
                    <TextBlock Text="Saving changes..." 
                               Foreground="White" 
                               FontSize="14" 
                               Margin="0,10,0,0"/>
                </StackPanel>
            </Border>

            <!-- Tasks Tab Control -->
            <TabControl Grid.Row="3" mah:TabControlHelper.Underlined="TabItems">
                <TabItem Header="Morning" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding MorningTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>

                <TabItem Header="Evening" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding EveningTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>

                <TabItem Header="Night" FontSize="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding NightTasks}" ItemTemplate="{StaticResource TaskItemTemplate}"/>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
        </Grid>

        <!-- Flyouts -->
        <mah:FlyoutsControl>
            <!-- N/A Flyout -->
            <mah:Flyout Header="Reason for N/A" IsOpen="{Binding IsNaFlyoutOpen}" Position="Right" Width="400">
                <StackPanel Margin="20">
                    <TextBlock Text="{Binding SelectedTaskForNa.TaskName}" FontWeight="Bold" FontSize="18" Margin="0,0,0,10" TextWrapping="Wrap"/>

                    <Label Content="Reason"/>

                    <TextBox x:Name="NaReasonBox"
                             Text="{Binding NaReason, UpdateSourceTrigger=PropertyChanged}" 
                             Height="150" 
                             TextWrapping="Wrap" 
                             AcceptsReturn="True" 
                             VerticalScrollBarVisibility="Auto" 
                             Margin="0,0,0,5"/>

                    <TextBlock Text="{Binding Text.Length, ElementName=NaReasonBox, StringFormat='{}{0}/500 characters'}" 
                               HorizontalAlignment="Right" 
                               FontSize="10" 
                               Foreground="Gray" 
                               Margin="0,0,0,10"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancel" Margin="0,0,10,0" 
                                Command="{Binding DataContext.CloseNaFlyoutCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>

                        <Button Content="Confirm N/A" Command="{Binding ConfirmNaCommand}" Style="{DynamicResource MahApps.Styles.Button.Accent}">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        <ProgressBar Width="16" Height="16" Margin="5,0,0,0"
                                                     IsIndeterminate="True"
                                                     Visibility="{Binding DataContext.IsSavingNa, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </mah:Flyout>

            <!-- Extend Deadline Flyout (Admin Only) -->
            <mah:Flyout Header="Extend Deadline (Admin)" IsOpen="{Binding IsExtendFlyoutOpen}" Position="Right" Width="400" Theme="Inverse">
                <StackPanel Margin="20">
                    <TextBlock Text="Extend Grace Period" FontSize="20" FontWeight="Bold" Margin="0,0,0,20"/>

                    <Label Content="Extend by (Hours):" FontWeight="Bold"/>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <Slider Minimum="1" Maximum="8" Interval="1" IsSnapToTickEnabled="True" 
                                Value="{Binding ExtensionHours}" Width="250" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ExtensionHours, StringFormat='{} +{0} Hrs'}" 
                                   FontSize="16" FontWeight="Bold" VerticalAlignment="Center" Margin="10,0,0,0"/>
                    </StackPanel>

                    <Label Content="Reason for Override (Mandatory):" FontWeight="Bold"/>
                    <TextBox Text="{Binding ExtensionReason, UpdateSourceTrigger=PropertyChanged}" 
                             Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,20"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancel" Margin="0,0,10,0" 
                                Command="{Binding CloseExtendFlyoutCommand}"/>

                        <Button Content="Confirm Extension" 
                                Command="{Binding ConfirmExtendCommand}" 
                                Style="{StaticResource MahApps.Styles.Button.Square.Accent}">
                            <Button.ContentTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        <ProgressBar Width="16" Height="16" Margin="5,0,0,0"
                                                     IsIndeterminate="True"
                                                     Visibility="{Binding DataContext.IsSavingExtension, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </Button.ContentTemplate>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </mah:Flyout>
        </mah:FlyoutsControl>
    </Grid>
</UserControl>